<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ختم التسجيل — Scroll Signup</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: {
              950: "#070A12",
              900: "#0B1020",
              800: "#121A33",
              700: "#1B2750",
            },
            parchment: {
              50: "#FBF5E7",
              100: "#F6EBD2",
              200: "#EFE0B8",
              300: "#E7D39B",
              400: "#D9BC6F",
              500: "#C7A14A",
            },
            seal: {
              600: "#D63A3A",
              700: "#C52C2C",
              800: "#A32121",
            },
            chakra: {
              wind: "#66F2D5",
              fire: "#FF7A5A",
              water: "#66B7FF",
              lightning: "#FFD166",
              earth: "#A7D46F",
            }
          },
          boxShadow: {
            ink: "0 18px 60px rgba(7,10,18,.55)",
            soft: "0 12px 40px rgba(7,10,18,.35)",
            glow: "0 0 0 1px rgba(102,183,255,.35), 0 0 32px rgba(102,183,255,.22)",
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --bg0: #070A12;
      --bg1: #0B1020;
      --paper: #F6EBD2;
      --paper2:#EFE0B8;
      --ink: #0B1020;
      --ink2:#121A33;
      --seal:#C52C2C;

      --auraA: #66B7FF; /* default water-ish */
      --auraB: #66F2D5;

      --motion-mult: 1;
    }

    /* Respect prefers-reduced-motion */
    @media (prefers-reduced-motion: reduce){
      :root{ --motion-mult: 0; }
      *{ animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; scroll-behavior: auto !important; }
    }
    body.reduce-motion{
      --motion-mult: 0;
    }

    /* Arabic-friendly typography */
    html, body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Tahoma, Arial, "Noto Naskh Arabic", "Noto Kufi Arabic", sans-serif;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(102,183,255,.14), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(255,122,90,.10), transparent 50%),
        radial-gradient(1100px 900px at 75% 90%, rgba(102,242,213,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: #F3F6FF;
    }

    /* Chakra pulse ring (focus/hover) */
    .chakra-ring{
      position: relative;
      isolation:isolate;
    }
    .chakra-ring:focus-within::after,
    .chakra-ring:hover::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 30% 20%, rgba(102,183,255,.28), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(102,242,213,.22), transparent 50%);
      filter: blur(10px);
      z-index:-1;
      opacity: 1;
      transform: scale(1);
      transition: opacity .35s ease, transform .35s ease;
    }
    .chakra-ring::after{
      opacity: 0;
      transform: scale(.98);
    }

    /* Scroll paper texture + ink seep */
    .scroll-paper{
      background:
        radial-gradient(160px 120px at 20% 30%, rgba(11,16,32,.10), transparent 60%),
        radial-gradient(220px 140px at 80% 70%, rgba(11,16,32,.10), transparent 62%),
        radial-gradient(280px 180px at 40% 85%, rgba(11,16,32,.08), transparent 65%),
        repeating-linear-gradient(90deg, rgba(11,16,32,.035) 0 1px, transparent 1px 8px),
        repeating-linear-gradient(0deg, rgba(11,16,32,.02) 0 1px, transparent 1px 14px),
        linear-gradient(180deg, var(--paper), var(--paper2));
      border: 1px solid rgba(11,16,32,.14);
      box-shadow:
        0 26px 70px rgba(7,10,18,.55),
        inset 0 1px 0 rgba(255,255,255,.55);
      position: relative;
      overflow: hidden;
    }
    .scroll-paper::before{
      /* subtle ink seep */
      content:"";
      position:absolute;
      inset:-60px -80px -80px -60px;
      background:
        radial-gradient(240px 180px at 15% 30%, rgba(11,16,32,.10), transparent 65%),
        radial-gradient(320px 220px at 85% 25%, rgba(11,16,32,.08), transparent 60%),
        radial-gradient(420px 280px at 60% 90%, rgba(11,16,32,.06), transparent 64%);
      filter: blur(12px);
      opacity: .9;
      pointer-events:none;
      mix-blend-mode: multiply;
    }
    .scroll-paper::after{
      /* paper fiber noise-ish */
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(11,16,32,.12), transparent 60%),
        radial-gradient(1px 1px at 40% 35%, rgba(11,16,32,.10), transparent 60%),
        radial-gradient(1px 1px at 70% 25%, rgba(11,16,32,.10), transparent 60%),
        radial-gradient(1px 1px at 80% 70%, rgba(11,16,32,.10), transparent 60%),
        radial-gradient(1px 1px at 25% 80%, rgba(11,16,32,.08), transparent 60%);
      opacity:.18;
      pointer-events:none;
      mix-blend-mode:multiply;
    }

    /* Scroll rods */
    .rod{
      background: linear-gradient(180deg, #1b223c, #0b1020);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(7,10,18,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .rod::after{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 999px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.07), transparent 45%),
        radial-gradient(80px 30px at 50% 20%, rgba(255,255,255,.08), transparent 65%);
      pointer-events:none;
    }

    /* Brush strokes */
    .brush-stroke{
      position: absolute;
      left: -20%;
      right: -20%;
      height: 10px;
      background: linear-gradient(90deg, transparent, rgba(11,16,32,.18), rgba(11,16,32,.10), transparent);
      filter: blur(.2px);
      opacity: .9;
      transform: translateX(-20%);
      animation: brushMove calc(4.2s * var(--motion-mult)) ease-in-out infinite;
    }
    .brush-stroke.s2{ top: 38%; height: 14px; opacity: .6; animation-duration: calc(5.3s * var(--motion-mult)); }
    .brush-stroke.s3{ top: 64%; height: 12px; opacity: .5; animation-duration: calc(6.1s * var(--motion-mult)); }
    @keyframes brushMove{
      0%,100%{ transform: translateX(-18%) skewX(-8deg); }
      50%{ transform: translateX(18%) skewX(8deg); }
    }

    /* Chakra orb pulse */
    .chakra-orb{
      width: 120px;
      height: 120px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 30%),
        radial-gradient(circle at 60% 70%, rgba(255,255,255,.18), transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(102,183,255,.65), rgba(102,242,213,.25) 55%, rgba(7,10,18,0) 70%);
      filter: drop-shadow(0 14px 28px rgba(7,10,18,.35));
      position: relative;
    }
    .chakra-orb::after{
      content:"";
      position:absolute;
      inset:-12px;
      border-radius: 999px;
      background:
        radial-gradient(circle, rgba(102,183,255,.22), transparent 62%),
        radial-gradient(circle, rgba(102,242,213,.18), transparent 66%);
      filter: blur(6px);
      opacity: .9;
      animation: orbPulse calc(2.2s * var(--motion-mult)) ease-in-out infinite;
    }
    @keyframes orbPulse{
      0%,100%{ transform: scale(.98); opacity: .65; }
      50%{ transform: scale(1.05); opacity: .95; }
    }

    /* Speed lines overlay (used on section open) */
    .speedlines{
      pointer-events:none;
      position:absolute;
      inset:-40px;
      background:
        repeating-linear-gradient(135deg, rgba(7,10,18,.0) 0 10px, rgba(7,10,18,.08) 10px 11px, rgba(7,10,18,.0) 11px 24px);
      opacity: 0;
      transform: translateX(18%) translateY(-6%);
      filter: blur(.5px);
    }
    .speedlines.play{
      animation: speedFlash calc(.72s * var(--motion-mult)) ease-out 1;
    }
    @keyframes speedFlash{
      0%{ opacity: 0; }
      25%{ opacity: .55; }
      70%{ opacity: .22; }
      100%{ opacity: 0; }
    }

    /* Ink swipe transition overlay */
    #inkSwipe{
      position: fixed;
      inset: -20vh -20vw;
      z-index: 60;
      pointer-events: none;
      opacity: 0;
      transform: translateX(120%);
      filter: blur(.2px);
      background:
        radial-gradient(120px 120px at 10% 30%, rgba(7,10,18,.55), transparent 70%),
        radial-gradient(160px 160px at 40% 60%, rgba(7,10,18,.40), transparent 70%),
        radial-gradient(120px 120px at 70% 30%, rgba(7,10,18,.45), transparent 72%),
        linear-gradient(90deg, rgba(7,10,18,0), rgba(7,10,18,.78), rgba(7,10,18,.55), rgba(7,10,18,0));
      mix-blend-mode: multiply;
    }
    #inkSwipe.play{
      opacity: 1;
      animation: inkSwipe calc(.62s * var(--motion-mult)) ease-in-out 1;
    }
    @keyframes inkSwipe{
      0%{ transform: translateX(120%) skewX(-10deg); opacity: 0; }
      25%{ opacity: 1; }
      50%{ transform: translateX(0%) skewX(-6deg); }
      85%{ opacity: 1; }
      100%{ transform: translateX(-140%) skewX(10deg); opacity: 0; }
    }

    /* Accordion smooth open/close */
    .acc-panel{
      overflow: hidden;
      max-height: 0px;
      opacity: .0;
      transform: translateY(-4px);
      transition: max-height .45s ease, opacity .35s ease, transform .35s ease;
    }
    .acc-panel.open{
      opacity: 1;
      transform: translateY(0);
    }

    /* Speech bubble error */
    .bubble{
      position: relative;
      background: rgba(7,10,18,.82);
      border: 1px solid rgba(102,183,255,.28);
      box-shadow: 0 14px 40px rgba(7,10,18,.55);
    }
    .bubble::after{
      content:"";
      position:absolute;
      width: 12px;
      height: 12px;
      background: rgba(7,10,18,.82);
      border-left: 1px solid rgba(102,183,255,.28);
      border-bottom: 1px solid rgba(102,183,255,.28);
      transform: rotate(45deg);
      bottom: -7px;
      inset-inline-start: 22px;
    }

    /* Seal stamp animation */
    .stamp{
      transform: rotate(-10deg) scale(.9);
      opacity: 0;
      filter: drop-shadow(0 14px 24px rgba(7,10,18,.45));
    }
    .stamp.play{
      animation: stampHit calc(.62s * var(--motion-mult)) cubic-bezier(.2,.9,.15,1.2) 1 forwards;
    }
    @keyframes stampHit{
      0%{ transform: rotate(-14deg) scale(2.2); opacity: 0; }
      55%{ transform: rotate(-10deg) scale(.95); opacity: 1; }
      75%{ transform: rotate(-10deg) scale(1.02); opacity: 1; }
      100%{ transform: rotate(-10deg) scale(1); opacity: 1; }
    }

    /* Aura frame helper (for preview containers) */
    .aura-frame{
      --a: var(--auraA);
      --b: var(--auraB);
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 36%),
        radial-gradient(circle at 70% 75%, rgba(255,255,255,.10), transparent 40%),
        linear-gradient(135deg, color-mix(in oklab, var(--a) 55%, transparent), color-mix(in oklab, var(--b) 55%, transparent));
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 0 28px color-mix(in oklab, var(--a) 25%, transparent);
      position: relative;
      isolation: isolate;
    }
    .aura-frame::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      background:
        radial-gradient(circle, color-mix(in oklab, var(--a) 22%, transparent), transparent 60%),
        radial-gradient(circle, color-mix(in oklab, var(--b) 20%, transparent), transparent 64%);
      filter: blur(10px);
      opacity: .85;
      z-index:-1;
    }

    /* Headband overlay (generic) */
    .headband-overlay{
      position:absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 82%;
      height: 28%;
      border-radius: 999px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02)),
        linear-gradient(90deg, rgba(11,16,32,.42), rgba(11,16,32,.22));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 10px 24px rgba(7,10,18,.35);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
      pointer-events:none;
    }
    .headband-overlay::after{
      /* metal plate without symbol */
      content:"";
      position:absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: 40%;
      height: 70%;
      border-radius: 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.06)),
        radial-gradient(60px 20px at 30% 30%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.14);
    }

    /* Toggle switch */
    .switch{
      width: 44px; height: 26px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      position: relative;
      transition: background .2s ease, border-color .2s ease;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      width: 20px; height: 20px;
      border-radius: 999px;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      inset-inline-start: 3px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 18px rgba(7,10,18,.35);
      transition: inset-inline-start .2s ease, background .2s ease;
    }
    .switch.on{
      background: rgba(102,183,255,.18);
      border-color: rgba(102,183,255,.30);
    }
    .switch.on::after{
      inset-inline-start: 21px;
      background: rgba(102,242,213,.95);
    }

    /* Small badge */
    .badge{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    /* Field states */
    .field{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      outline: none;
      transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .field:focus{
      border-color: rgba(102,183,255,.45);
      box-shadow: 0 0 0 4px rgba(102,183,255,.16);
      background: rgba(255,255,255,.08);
    }
    .field.invalid{
      border-color: rgba(214,58,58,.55);
      box-shadow: 0 0 0 4px rgba(214,58,58,.14);
    }

    /* Sticky CTA safe-area */
    .safe-bottom{
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
    }

    /* Direction-aware spacing fix for input icons */
    [dir="rtl"] .icon-infield{ left: 12px; right: auto; }
    [dir="ltr"] .icon-infield{ right: 12px; left: auto; }

    /* Canvas crisp */
    canvas{ image-rendering: auto; }
  </style>
</head>

<body class="min-h-screen">
  <div id="inkSwipe"></div>

  <!-- Top bar -->
  <header class="mx-auto w-full max-w-6xl px-4 pt-5">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="chakra-orb hidden sm:block"></div>
        <div>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center gap-2 rounded-full badge px-3 py-1 text-xs text-white/80">
              <span class="h-2 w-2 rounded-full bg-seal-600"></span>
              ختم تسجيل — Scroll Signup
            </span>
            <span id="progressPill" class="hidden sm:inline-flex items-center gap-2 rounded-full badge px-3 py-1 text-xs text-white/70">
              <span id="progressCount">0</span>/<span>3</span> أقسام مطلوبة
            </span>
          </div>
          <h1 class="mt-2 text-2xl sm:text-3xl font-semibold tracking-tight">
            أنشئ حسابك… بطريقة <span class="text-parchment-200">سكرول</span> وحبر
          </h1>
          <p class="mt-1 text-sm text-white/70 max-w-xl">
            واجهة نينجا حديثة: أقسام تنفتح بسلاسة، وهالة تشاكرا عند التفاعل، وختم عند الإنهاء — بدون أي رموز/شخصيات رسمية.
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2 sm:gap-3">
        <button id="dirBtn" class="chakra-ring rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/7 active:scale-[.98] transition">
          RTL ↔ LTR
        </button>

        <div class="hidden sm:flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2">
          <span class="text-xs text-white/70">تقليل الحركة</span>
          <button id="motionSwitch" class="switch" aria-label="تقليل الحركة"></button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto w-full max-w-6xl px-4 pb-28 sm:pb-16 pt-6">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
      <!-- Left: Scroll Scene -->
      <aside class="order-1 lg:order-none">
        <div class="relative lg:sticky lg:top-6 rounded-3xl p-3 sm:p-5 bg-white/4 border border-white/10 shadow-ink">
          <div class="relative overflow-hidden rounded-2xl">
            <div class="speedlines" id="speedlines"></div>

            <div class="relative px-4 sm:px-6 py-4 sm:py-6">
              <!-- Rods -->
              <div class="absolute inset-x-3 sm:inset-x-6 -top-2 h-7 rounded-full rod"></div>
              <div class="absolute inset-x-3 sm:inset-x-6 -bottom-2 h-7 rounded-full rod"></div>

              <!-- Paper -->
              <div class="scroll-paper rounded-2xl pt-10 pb-10 px-5 sm:px-7 min-h-[320px] sm:min-h-[420px]">
                <div class="brush-stroke s1" style="top:18%"></div>
                <div class="brush-stroke s2"></div>
                <div class="brush-stroke s3"></div>

                <div class="relative z-10">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <p class="text-ink-900/80 text-xs font-semibold tracking-wide">
                        سجلّك الشخصي يُكتب الآن…
                      </p>
                      <h2 class="mt-2 text-ink-950 text-xl sm:text-2xl font-semibold tracking-tight">
                        سكرول البداية
                      </h2>
                      <p class="mt-2 text-sm text-ink-900/70 leading-relaxed">
                        كل قسم هو “ختم” صغير. افتح/أغلق الأقسام بسلاسة، واختر أفتارك من dojo أو ارفعه واقتصه بالحبر.
                      </p>
                    </div>

                    <!-- Mini seal preview -->
                    <div class="shrink-0">
                      <div class="rounded-2xl bg-ink-900/90 border border-ink-800/50 px-3 py-2 shadow-soft">
                        <div class="text-[10px] text-white/60">حالة الختم</div>
                        <div class="mt-1 flex items-center gap-2">
                          <span id="sealStateDot" class="h-2 w-2 rounded-full bg-white/25"></span>
                          <span id="sealStateText" class="text-xs text-white/75">غير مكتمل</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Live Ninja Card preview -->
                  <div class="mt-6 rounded-2xl border border-ink-900/15 bg-white/45 backdrop-blur px-4 py-4">
                    <div class="flex items-center justify-between gap-3">
                      <div class="flex items-center gap-3">
                        <div class="relative aura-frame h-14 w-14 p-[2px]" id="miniAvatarFrame">
                          <div class="relative h-full w-full rounded-full bg-ink-900/85 overflow-hidden grid place-items-center">
                            <div id="miniAvatar" class="w-full h-full grid place-items-center text-white/70">
                              <span class="text-[10px]">Avatar</span>
                            </div>
                            <div id="miniHeadband" class="headband-overlay hidden"></div>
                          </div>
                        </div>
                        <div>
                          <div id="miniName" class="text-ink-950 font-semibold leading-tight">اسمك هنا</div>
                          <div class="mt-0.5 flex items-center gap-2">
                            <span id="miniUser" class="text-ink-900/70 text-xs">@username</span>
                            <span id="miniAura" class="text-[10px] badge rounded-full px-2 py-0.5 text-ink-900/70">Aura: Water</span>
                          </div>
                        </div>
                      </div>
                      <div class="text-ink-900/60 text-xs">
                        <span class="font-semibold">ID</span> • <span id="miniId">—</span>
                      </div>
                    </div>

                    <div class="mt-4 grid grid-cols-3 gap-2 text-[11px] text-ink-900/70">
                      <div class="rounded-xl border border-ink-900/10 bg-white/60 px-3 py-2">
                        <div class="text-[10px] text-ink-900/55">Archetype</div>
                        <div id="miniArch" class="font-semibold text-ink-950">—</div>
                      </div>
                      <div class="rounded-xl border border-ink-900/10 bg-white/60 px-3 py-2">
                        <div class="text-[10px] text-ink-900/55">Path</div>
                        <div id="miniPath" class="font-semibold text-ink-950">—</div>
                      </div>
                      <div class="rounded-xl border border-ink-900/10 bg-white/60 px-3 py-2">
                        <div class="text-[10px] text-ink-900/55">Follow</div>
                        <div id="miniFollow" class="font-semibold text-ink-950">0/2</div>
                      </div>
                    </div>

                    <div class="mt-4 rounded-xl border border-ink-900/10 bg-white/55 px-3 py-2 text-[11px] text-ink-900/70 leading-relaxed">
                      <span class="font-semibold text-ink-950">نصيحة:</span>
                      عند الضغط على “ختم التسجيل”، سيظهر ختم أحمر عام وبطاقة هوية جاهزة.
                    </div>
                  </div>

                  <div class="mt-6 flex flex-wrap items-center gap-2">
                    <span class="text-[10px] badge rounded-full px-3 py-1 text-ink-900/70">حبر • سكرول • تشاكرا</span>
                    <span class="text-[10px] badge rounded-full px-3 py-1 text-ink-900/70">Ink Swipe انتقال</span>
                    <span class="text-[10px] badge rounded-full px-3 py-1 text-ink-900/70">Seal Stamp حفظ</span>
                  </div>
                </div>
              </div>

              <!-- Footer note -->
              <div class="mt-4 px-2 text-xs text-white/60">
                * لا صور خارجية • لا مكتبات • Vanilla JS • RTL افتراضي
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Right: Form card -->
      <section class="order-2">
        <div class="rounded-3xl bg-white/4 border border-white/10 shadow-ink overflow-hidden">
          <div class="px-5 sm:px-6 py-5 border-b border-white/10">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h2 class="text-lg sm:text-xl font-semibold">نموذج التسجيل</h2>
                <p class="mt-1 text-sm text-white/70">أقسام سكرول — افتح الذي تحتاجه فقط.</p>
              </div>
              <div class="hidden sm:flex items-center gap-2">
                <span class="badge rounded-full px-3 py-1 text-xs text-white/70">مطلوب: 3</span>
                <span class="badge rounded-full px-3 py-1 text-xs text-white/70">اختياري: 2</span>
              </div>
            </div>

            <!-- Mobile motion toggle -->
            <div class="sm:hidden mt-4 flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
              <div>
                <div class="text-sm font-semibold">تقليل الحركة</div>
                <div class="text-xs text-white/65">يحترم إعداد النظام أيضاً</div>
              </div>
              <button id="motionSwitchMobile" class="switch" aria-label="تقليل الحركة"></button>
            </div>
          </div>

          <form id="signupForm" class="px-4 sm:px-6 py-4 sm:py-6 space-y-3">
            <!-- SECTION: Account -->
            <div class="rounded-2xl border border-white/10 bg-white/3 overflow-hidden" data-section="account">
              <button type="button" class="acc-btn w-full flex items-center justify-between gap-3 px-4 py-4 text-left">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-2xl bg-white/6 border border-white/10 grid place-items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="opacity-90">
                      <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.6" />
                      <path d="M4.5 20.2c1.8-3.5 4.7-5.2 7.5-5.2s5.7 1.7 7.5 5.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">A) الحساب</span>
                      <span class="badge rounded-full px-2.5 py-1 text-[11px] text-white/75">مطلوب</span>
                      <span id="ok_account" class="hidden text-[11px] rounded-full px-2 py-1 bg-emerald-500/12 border border-emerald-400/20 text-emerald-200">مكتمل</span>
                    </div>
                    <p class="mt-0.5 text-xs text-white/65">الاسم + البريد + كلمة المرور (مع قوة وإظهار/إخفاء)</p>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <span id="hint_account" class="text-xs text-white/55 hidden sm:inline">افتح</span>
                  <svg class="acc-chevron h-5 w-5 text-white/70 transition" viewBox="0 0 24 24" fill="none">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </button>

              <div class="acc-panel px-4 pb-4" id="panel_account">
                <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-xs text-white/70 mb-1" for="fullName">الاسم</label>
                      <input id="fullName" name="fullName" class="field w-full rounded-xl px-3 py-2.5 text-sm text-white placeholder:text-white/35" placeholder="اكتب اسمك" autocomplete="name" />
                      <div id="err_fullName" class="mt-1 text-xs text-seal-600 hidden">الاسم مطلوب.</div>
                    </div>

                    <div>
                      <label class="block text-xs text-white/70 mb-1" for="email">البريد الإلكتروني</label>
                      <input id="email" name="email" dir="ltr" class="field w-full rounded-xl px-3 py-2.5 text-sm text-white placeholder:text-white/35" placeholder="you@domain.com" autocomplete="email" />
                      <div id="err_email" class="mt-1 text-xs text-seal-600 hidden">أدخل بريدًا صحيحًا.</div>
                    </div>

                    <div class="sm:col-span-2">
                      <label class="block text-xs text-white/70 mb-1" for="password">كلمة المرور</label>
                      <div class="relative">
                        <input id="password" name="password" dir="ltr" type="password" class="field w-full rounded-xl px-3 py-2.5 text-sm text-white placeholder:text-white/35 pr-12" placeholder="••••••••" autocomplete="new-password" />
                        <button type="button" id="togglePw" class="icon-infield absolute top-1/2 -translate-y-1/2 rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/75 hover:bg-white/8 active:scale-[.98] transition">
                          إظهار
                        </button>
                      </div>

                      <div class="mt-2 flex items-center gap-3">
                        <div class="flex-1">
                          <div class="h-2 rounded-full bg-white/10 overflow-hidden">
                            <div id="pwBar" class="h-full w-0 rounded-full bg-white/30 transition-[width] duration-300"></div>
                          </div>
                          <div class="mt-1 flex items-center justify-between">
                            <span id="pwLabel" class="text-xs text-white/60">قوة كلمة المرور</span>
                            <span id="pwScore" class="text-xs text-white/55">0/4</span>
                          </div>
                        </div>
                        <button type="button" id="accountNext" class="rounded-xl border border-white/10 bg-white/6 px-3 py-2 text-xs text-white/80 hover:bg-white/8 active:scale-[.98] transition">
                          ختم هذا القسم
                        </button>
                      </div>

                      <!-- Speech bubble error -->
                      <div id="accountBubble" class="bubble mt-3 rounded-2xl px-4 py-3 text-sm text-white/85 hidden">
                        <div class="flex items-start gap-2">
                          <span class="mt-0.5 inline-block h-2 w-2 rounded-full bg-seal-600"></span>
                          <div>
                            <div class="font-semibold">ملاحظة من السِكرول</div>
                            <div id="accountBubbleText" class="mt-0.5 text-sm text-white/75 leading-relaxed">
                              —
                            </div>
                          </div>
                        </div>
                      </div>

                      <div id="err_password" class="mt-2 text-xs text-seal-600 hidden">
                        كلمة المرور: 8 أحرف على الأقل + تنوّع بسيط (حرف/رقم/رمز).
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SECTION: Ninja ID -->
            <div class="rounded-2xl border border-white/10 bg-white/3 overflow-hidden" data-section="ninjaid">
              <button type="button" class="acc-btn w-full flex items-center justify-between gap-3 px-4 py-4 text-left">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-2xl bg-white/6 border border-white/10 grid place-items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="opacity-90">
                      <path d="M7 7h10v10H7z" stroke="currentColor" stroke-width="1.6" />
                      <path d="M9 11h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                      <path d="M9 14h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">B) Ninja ID</span>
                      <span class="badge rounded-full px-2.5 py-1 text-[11px] text-white/75">مطلوب</span>
                      <span id="ok_ninjaid" class="hidden text-[11px] rounded-full px-2 py-1 bg-emerald-500/12 border border-emerald-400/20 text-emerald-200">مكتمل</span>
                    </div>
                    <p class="mt-0.5 text-xs text-white/65">username + تحقق توفر (async) + لقب اختياري</p>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <span id="hint_ninjaid" class="text-xs text-white/55 hidden sm:inline">افتح</span>
                  <svg class="acc-chevron h-5 w-5 text-white/70 transition" viewBox="0 0 24 24" fill="none">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </button>

              <div class="acc-panel px-4 pb-4" id="panel_ninjaid">
                <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-xs text-white/70 mb-1" for="username">اسم المستخدم (Ninja Handle)</label>
                      <div class="relative">
                        <input id="username" name="username" dir="ltr" class="field w-full rounded-xl px-3 py-2.5 text-sm text-white placeholder:text-white/35 pr-10" placeholder="@shadow-runner" autocomplete="username" />
                        <div class="absolute top-1/2 -translate-y-1/2 icon-infield">
                          <div id="userStatusIcon" class="h-7 w-7 grid place-items-center rounded-lg border border-white/10 bg-white/5">
                            <span class="text-[10px] text-white/60">…</span>
                          </div>
                        </div>
                      </div>
                      <div class="mt-1 flex items-center justify-between gap-2">
                        <div id="userStatusText" class="text-xs text-white/60" aria-live="polite">اكتب اسمًا للتحقق</div>
                        <div id="userStatusTag" class="text-[10px] hidden rounded-full px-2 py-0.5 border"></div>
                      </div>
                      <div id="err_username" class="mt-1 text-xs text-seal-600 hidden">اسم المستخدم مطلوب ويجب أن يكون 3 أحرف/أرقام على الأقل.</div>
                    </div>

                    <div>
                      <label class="block text-xs text-white/70 mb-1" for="nickname">اللقب (اختياري)</label>
                      <input id="nickname" name="nickname" class="field w-full rounded-xl px-3 py-2.5 text-sm text-white placeholder:text-white/35" placeholder="مثلاً: كاتب السِكرول" />
                      <div class="mt-1 text-xs text-white/55">يظهر على بطاقة الهوية.</div>
                    </div>

                    <div class="sm:col-span-2 flex items-center justify-between gap-3 pt-1">
                      <div class="text-xs text-white/60">
                        تلميح: تجنّب الكلمات العامة مثل <span class="text-white/80 font-semibold">admin</span> أو <span class="text-white/80 font-semibold">support</span>.
                      </div>
                      <button type="button" id="ninjaidNext" class="rounded-xl border border-white/10 bg-white/6 px-3 py-2 text-xs text-white/80 hover:bg-white/8 active:scale-[.98] transition">
                        ختم هذا القسم
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SECTION: Avatar Dojo -->
            <div class="rounded-2xl border border-white/10 bg-white/3 overflow-hidden" data-section="avatar">
              <button type="button" class="acc-btn w-full flex items-center justify-between gap-3 px-4 py-4 text-left">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-2xl bg-white/6 border border-white/10 grid place-items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="opacity-90">
                      <path d="M12 3l3 6 6 .8-4.4 4.3 1.1 6-5.7-3-5.7 3 1.1-6L3 9.8 9 9l3-6Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">C) Avatar Dojo</span>
                      <span class="badge rounded-full px-2.5 py-1 text-[11px] text-white/75">مطلوب</span>
                      <span id="ok_avatar" class="hidden text-[11px] rounded-full px-2 py-1 bg-emerald-500/12 border border-emerald-400/20 text-emerald-200">مكتمل</span>
                    </div>
                    <p class="mt-0.5 text-xs text-white/65">Archetypes SVG + Headband overlay + Upload/Crop/Ink outline + Aura</p>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <span id="hint_avatar" class="text-xs text-white/55 hidden sm:inline">افتح</span>
                  <svg class="acc-chevron h-5 w-5 text-white/70 transition" viewBox="0 0 24 24" fill="none">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </button>

              <div class="acc-panel px-4 pb-4" id="panel_avatar">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                  <!-- Left: Controls -->
                  <div class="lg:col-span-3 space-y-3">
                    <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4">
                      <div class="flex items-center justify-between gap-3">
                        <div>
                          <div class="text-sm font-semibold">اختيار Archetype (مقترحات)</div>
                          <div class="text-xs text-white/60 mt-0.5">وجوه abstract SVG — بدون صور أو رموز محمية.</div>
                        </div>
                        <div class="text-[10px] badge rounded-full px-2.5 py-1 text-white/70">انقر للاختيار</div>
                      </div>

                      <div id="archetypeGrid" class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <!-- injected by JS -->
                      </div>
                    </div>

                    <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4">
                      <div class="flex items-center justify-between gap-3">
                        <div>
                          <div class="text-sm font-semibold">رفع صورة + قص (Drag + Zoom)</div>
                          <div class="text-xs text-white/60 mt-0.5">اقتصاص داخل Canvas، مع “Ink outline” وخيار Aura.</div>
                        </div>
                        <label class="rounded-xl border border-white/10 bg-white/6 px-3 py-2 text-xs text-white/80 hover:bg-white/8 active:scale-[.98] transition cursor-pointer">
                          رفع صورة
                          <input id="avatarUpload" type="file" accept="image/*" class="hidden" />
                        </label>
                      </div>

                      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="rounded-2xl border border-white/10 bg-ink-900/35 p-3">
                          <div class="text-xs text-white/70 mb-2">منطقة القص</div>
                          <div class="rounded-2xl border border-white/10 bg-ink-950/30 overflow-hidden">
                            <canvas id="cropCanvas" width="320" height="320" class="w-full h-auto block"></canvas>
                          </div>

                          <div class="mt-3 flex items-center justify-between gap-2">
                            <div class="flex-1">
                              <div class="text-[11px] text-white/60">Zoom</div>
                              <input id="zoom" type="range" min="1" max="3" step="0.01" value="1.2" class="w-full" />
                            </div>
                            <button type="button" id="applyCrop" class="rounded-xl border border-white/10 bg-white/6 px-3 py-2 text-xs text-white/85 hover:bg-white/8 active:scale-[.98] transition">
                              تطبيق القص
                            </button>
                          </div>

                          <div class="mt-2 text-[11px] text-white/55">
                            اسحب الصورة داخل الإطار. استخدم Zoom للتكبير.
                          </div>
                        </div>

                        <div class="rounded-2xl border border-white/10 bg-white/3 p-3 space-y-3">
                          <div class="flex items-center justify-between gap-2">
                            <div>
                              <div class="text-xs font-semibold text-white/85">Ink outline</div>
                              <div class="text-[11px] text-white/55">حافة حبرية بسيطة (Canvas mock)</div>
                            </div>
                            <button type="button" id="outlineSwitch" class="switch" aria-label="Ink outline"></button>
                          </div>

                          <div class="flex items-center justify-between gap-2">
                            <div>
                              <div class="text-xs font-semibold text-white/85">Headband overlay</div>
                              <div class="text-[11px] text-white/55">إكسسوار عام بدون أي رمز</div>
                            </div>
                            <button type="button" id="headbandSwitch" class="switch" aria-label="Headband overlay"></button>
                          </div>

                          <div>
                            <div class="text-xs font-semibold text-white/85">Aura</div>
                            <div class="mt-2 grid grid-cols-5 gap-2">
                              <button type="button" class="auraBtn rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-[11px] text-white/80 hover:bg-white/8 transition" data-aura="wind">Wind</button>
                              <button type="button" class="auraBtn rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-[11px] text-white/80 hover:bg-white/8 transition" data-aura="fire">Fire</button>
                              <button type="button" class="auraBtn rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-[11px] text-white/80 hover:bg-white/8 transition" data-aura="water">Water</button>
                              <button type="button" class="auraBtn rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-[11px] text-white/80 hover:bg-white/8 transition" data-aura="lightning">⚡</button>
                              <button type="button" class="auraBtn rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-[11px] text-white/80 hover:bg-white/8 transition" data-aura="earth">Earth</button>
                            </div>
                            <div class="mt-2 text-[11px] text-white/55">يغيّر ألوان الإطار والوهج.</div>
                          </div>

                          <div class="pt-1 flex items-center justify-between gap-3">
                            <div class="text-xs text-white/60">
                              مطلوب اختيار Avatar (Archetype أو Upload).
                            </div>
                            <button type="button" id="avatarNext" class="rounded-xl border border-white/10 bg-white/6 px-3 py-2 text-xs text-white/80 hover:bg-white/8 active:scale-[.98] transition">
                              ختم هذا القسم
                            </button>
                          </div>

                          <div id="err_avatar" class="text-xs text-seal-600 hidden">اختر Archetype أو ارفع صورة ثم طبّق القص.</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Right: Preview -->
                  <div class="lg:col-span-2">
                    <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4">
                      <div class="flex items-center justify-between gap-3">
                        <div>
                          <div class="text-sm font-semibold">المعاينة</div>
                          <div class="text-xs text-white/60 mt-0.5">هذا ما سيظهر على بطاقة الهوية.</div>
                        </div>
                        <span id="avatarModeTag" class="text-[10px] badge rounded-full px-2.5 py-1 text-white/70">—</span>
                      </div>

                      <div class="mt-4 flex flex-col items-center">
                        <div class="relative aura-frame h-40 w-40 p-[3px]" id="avatarFrame">
                          <div class="relative h-full w-full rounded-full bg-ink-900/80 overflow-hidden grid place-items-center">
                            <div id="avatarPreview" class="w-full h-full grid place-items-center text-white/70">
                              <span class="text-xs">اختر Avatar</span>
                            </div>
                            <div id="headbandOverlayPreview" class="headband-overlay hidden"></div>
                          </div>
                        </div>

                        <div class="mt-3 text-center">
                          <div class="text-sm font-semibold" id="previewName">—</div>
                          <div class="mt-0.5 text-xs text-white/65" id="previewHandle">@—</div>
                          <div class="mt-2 inline-flex items-center gap-2">
                            <span class="text-[10px] badge rounded-full px-2.5 py-1 text-white/70" id="previewArch">Archetype: —</span>
                            <span class="text-[10px] badge rounded-full px-2.5 py-1 text-white/70" id="previewAura">Aura: Water</span>
                          </div>
                        </div>

                        <div class="mt-4 w-full rounded-2xl border border-white/10 bg-ink-900/35 p-3">
                          <div class="text-xs text-white/70">ملاحظة Dojo</div>
                          <p class="mt-1 text-[11px] text-white/60 leading-relaxed">
                            لإحساس “حبر/سكرول” أكثر: فعّل Ink outline، واختر Aura تناسب شخصيتك. الإكسسوار العام (headband) بلا رموز.
                          </p>
                        </div>
                      </div>
                    </div>

                    <!-- Optional quick toggles -->
                    <div class="mt-3 rounded-2xl border border-white/10 bg-white/3 p-4">
                      <div class="text-sm font-semibold">اختصارات</div>
                      <div class="mt-2 flex flex-wrap gap-2">
                        <button type="button" class="quickOpen rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/8 transition" data-open="follow">فتح Follow</button>
                        <button type="button" class="quickOpen rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/8 transition" data-open="interests">فتح Interests</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SECTION: Follow (Optional) -->
            <div class="rounded-2xl border border-white/10 bg-white/3 overflow-hidden" data-section="follow">
              <button type="button" class="acc-btn w-full flex items-center justify-between gap-3 px-4 py-4 text-left">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-2xl bg-white/6 border border-white/10 grid place-items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="opacity-90">
                      <path d="M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.6"/>
                      <path d="M6.5 20c1.5-2.8 3.8-4.2 5.9-4.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                      <path d="M14.5 16.5h7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                      <path d="M18 13v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">D) Follow</span>
                      <span class="badge rounded-full px-2.5 py-1 text-[11px] text-white/65">اختياري</span>
                      <span id="followCountTag" class="text-[11px] rounded-full px-2 py-1 bg-white/6 border border-white/10 text-white/75">0/2</span>
                    </div>
                    <p class="mt-0.5 text-xs text-white/65">اتبع 2 فقط — Cards مع toggle + بحث</p>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <span id="hint_follow" class="text-xs text-white/55 hidden sm:inline">افتح</span>
                  <svg class="acc-chevron h-5 w-5 text-white/70 transition" viewBox="0 0 24 24" fill="none">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </button>

              <div class="acc-panel px-4 pb-4" id="panel_follow">
                <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4">
                  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                    <div>
                      <div class="text-sm font-semibold">اقتراحات للمتابعة</div>
                      <div class="text-xs text-white/60 mt-0.5">اختر شخصين كحد أقصى (يمكنك تعديلها لاحقًا).</div>
                    </div>
                    <input id="followSearch" class="field rounded-xl px-3 py-2 text-sm text-white placeholder:text-white/35 sm:w-64" placeholder="بحث..." />
                  </div>

                  <div id="followGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <!-- injected by JS -->
                  </div>

                  <div class="mt-3 text-[11px] text-white/55">
                    <span class="font-semibold text-white/75">قاعدة:</span> إذا اخترت 2، سيتم تعطيل الباقي مؤقتًا.
                  </div>
                </div>
              </div>
            </div>

            <!-- SECTION: Interests (Optional) -->
            <div class="rounded-2xl border border-white/10 bg-white/3 overflow-hidden" data-section="interests">
              <button type="button" class="acc-btn w-full flex items-center justify-between gap-3 px-4 py-4 text-left">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-2xl bg-white/6 border border-white/10 grid place-items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="opacity-90">
                      <path d="M4 7h16M4 12h10M4 17h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">E) Interests</span>
                      <span class="badge rounded-full px-2.5 py-1 text-[11px] text-white/65">اختياري</span>
                    </div>
                    <p class="mt-0.5 text-xs text-white/65">Chips: genres + types + Ninja Path (3 اختيارات فقط)</p>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <span id="hint_interests" class="text-xs text-white/55 hidden sm:inline">افتح</span>
                  <svg class="acc-chevron h-5 w-5 text-white/70 transition" viewBox="0 0 24 24" fill="none">
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </button>

              <div class="acc-panel px-4 pb-4" id="panel_interests">
                <div class="chakra-ring rounded-2xl bg-white/4 border border-white/10 p-4 space-y-4">
                  <div>
                    <div class="text-sm font-semibold">Genres</div>
                    <div id="genreChips" class="mt-2 flex flex-wrap gap-2"></div>
                  </div>

                  <div>
                    <div class="text-sm font-semibold">Types</div>
                    <div id="typeChips" class="mt-2 flex flex-wrap gap-2"></div>
                  </div>

                  <div>
                    <div class="text-sm font-semibold">Ninja Path</div>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                      <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/4 px-3 py-3 hover:bg-white/6 transition">
                        <input type="radio" name="path" value="Balanced" class="accent-white/80" />
                        <div class="mt-1 text-sm font-semibold">Balanced</div>
                        <div class="text-xs text-white/60 mt-0.5">ثبات + تعلم سريع</div>
                      </label>
                      <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/4 px-3 py-3 hover:bg-white/6 transition">
                        <input type="radio" name="path" value="Swift" class="accent-white/80" />
                        <div class="mt-1 text-sm font-semibold">Swift</div>
                        <div class="text-xs text-white/60 mt-0.5">حركة + رد فعل</div>
                      </label>
                      <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/4 px-3 py-3 hover:bg-white/6 transition">
                        <input type="radio" name="path" value="Arcane" class="accent-white/80" />
                        <div class="mt-1 text-sm font-semibold">Arcane</div>
                        <div class="text-xs text-white/60 mt-0.5">تركيز + تقنيات</div>
                      </label>
                    </div>
                  </div>

                  <div class="rounded-2xl border border-white/10 bg-ink-900/30 px-3 py-3 text-[11px] text-white/60 leading-relaxed">
                    هذه الاختيارات تساعدنا في اقتراح مجتمعات الأنمي/الكوميكس المناسبة — ويمكن تعديلها لاحقًا.
                  </div>
                </div>
              </div>
            </div>

            <!-- Footer actions (desktop/tablet) -->
            <div class="hidden sm:flex items-center justify-between gap-3 pt-2">
              <div class="text-xs text-white/55">
                بالضغط على “ختم التسجيل” أنت توافق على تجربة سكرول ممتعة ✦
              </div>
              <button type="submit" id="submitBtn"
                      class="chakra-ring inline-flex items-center gap-2 rounded-2xl border border-white/10 bg-white/7 px-4 py-3 text-sm font-semibold text-white/90 hover:bg-white/10 active:scale-[.99] transition disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-seal-700/20 border border-seal-600/25">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2l3.2 6.8 7.3 1-5.3 5.1 1.3 7.1L12 18.7 5.5 22l1.3-7.1-5.3-5.1 7.3-1L12 2Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                  </svg>
                </span>
                ختم التسجيل
                <span id="submitSpinner" class="hidden">
                  <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </span>
              </button>
            </div>
          </form>
        </div>
      </section>
    </div>
  </main>

  <!-- Sticky bottom CTA (mobile) -->
  <div class="sm:hidden fixed inset-x-0 bottom-0 z-40 safe-bottom">
    <div class="mx-auto max-w-6xl px-4">
      <div class="rounded-2xl border border-white/10 bg-ink-900/75 backdrop-blur px-3 py-3 shadow-ink">
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-semibold">جاهز للختم؟</div>
            <div class="text-xs text-white/60 truncate">أكمل الأقسام المطلوبة فقط: Account + Ninja ID + Avatar</div>
          </div>
          <button id="submitBtnMobile"
                  class="chakra-ring inline-flex items-center gap-2 rounded-2xl border border-white/10 bg-white/8 px-4 py-3 text-sm font-semibold text-white/90 hover:bg-white/10 active:scale-[.99] transition">
            ختم
            <span id="submitSpinnerMobile" class="hidden">
              <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-ink-950/70 backdrop-blur-sm"></div>

    <div class="relative mx-auto max-w-xl px-4 pt-16 pb-10">
      <div class="rounded-3xl border border-white/10 bg-white/6 shadow-ink overflow-hidden">
        <div class="px-6 py-5 border-b border-white/10">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-xl font-semibold">تم ختم التسجيل!</h3>
              <p class="mt-1 text-sm text-white/70">مرحبًا بك… بطاقتك جاهزة.</p>
            </div>
            <button id="closeSuccess" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/8 transition">
              إغلاق
            </button>
          </div>
        </div>

        <div class="px-6 py-6">
          <div class="relative">
            <!-- Stamp (generic, no symbols) -->
            <div class="absolute -top-8 -right-2">
              <div id="stamp" class="stamp">
                <svg width="120" height="120" viewBox="0 0 120 120" fill="none" aria-hidden="true">
                  <defs>
                    <filter id="inkBlur" x="-30%" y="-30%" width="160%" height="160%">
                      <feGaussianBlur stdDeviation="0.4"/>
                    </filter>
                  </defs>
                  <circle cx="60" cy="60" r="44" stroke="rgba(197,44,44,.85)" stroke-width="6" filter="url(#inkBlur)"/>
                  <circle cx="60" cy="60" r="34" stroke="rgba(197,44,44,.55)" stroke-width="3" stroke-dasharray="4 6"/>
                  <path d="M34 62c10 10 42 10 52 0" stroke="rgba(197,44,44,.85)" stroke-width="5" stroke-linecap="round"/>
                  <path d="M40 48c6-6 34-6 40 0" stroke="rgba(197,44,44,.65)" stroke-width="4" stroke-linecap="round"/>
                  <text x="60" y="78" text-anchor="middle" font-size="14" fill="rgba(197,44,44,.9)" font-family="ui-sans-serif, system-ui">SEALED</text>
                </svg>
              </div>
            </div>

            <!-- Ninja Card -->
            <div class="scroll-paper rounded-3xl p-5 sm:p-6 text-ink-950">
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-center gap-3">
                  <div class="relative aura-frame h-16 w-16 p-[2px]" id="cardAvatarFrame">
                    <div class="relative h-full w-full rounded-full bg-ink-900/90 overflow-hidden grid place-items-center">
                      <div id="cardAvatar" class="w-full h-full grid place-items-center text-white/70"></div>
                      <div id="cardHeadband" class="headband-overlay hidden"></div>
                    </div>
                  </div>
                  <div>
                    <div id="cardName" class="text-xl font-semibold leading-tight">—</div>
                    <div class="mt-1 text-sm text-ink-900/75">
                      <span id="cardHandle">@—</span>
                      <span class="mx-2 text-ink-900/35">•</span>
                      <span id="cardNick">—</span>
                    </div>
                  </div>
                </div>

                <div class="text-right">
                  <div class="text-xs text-ink-900/60">Ninja ID</div>
                  <div id="cardId" class="text-sm font-semibold">—</div>
                  <div class="mt-2 inline-flex items-center gap-2">
                    <span id="cardAura" class="text-[10px] rounded-full px-2 py-1 border border-ink-900/15 bg-white/55 text-ink-900/70">Aura</span>
                    <span id="cardArch" class="text-[10px] rounded-full px-2 py-1 border border-ink-900/15 bg-white/55 text-ink-900/70">Archetype</span>
                  </div>
                </div>
              </div>

              <div class="mt-5 grid grid-cols-3 gap-2 text-[11px]">
                <div class="rounded-2xl border border-ink-900/10 bg-white/55 px-3 py-3">
                  <div class="text-[10px] text-ink-900/55">Follow</div>
                  <div id="cardFollow" class="font-semibold">0/2</div>
                </div>
                <div class="rounded-2xl border border-ink-900/10 bg-white/55 px-3 py-3">
                  <div class="text-[10px] text-ink-900/55">Path</div>
                  <div id="cardPath" class="font-semibold">—</div>
                </div>
                <div class="rounded-2xl border border-ink-900/10 bg-white/55 px-3 py-3">
                  <div class="text-[10px] text-ink-900/55">Genres</div>
                  <div id="cardGenres" class="font-semibold truncate">—</div>
                </div>
              </div>

              <div class="mt-4 rounded-2xl border border-ink-900/10 bg-white/55 px-3 py-3 text-[11px] text-ink-900/70 leading-relaxed">
                <span class="font-semibold">تذكير:</span> يمكنك تعديل الاهتمامات والمتابعة لاحقًا — المهم أن “الختم” تم ✅
              </div>
            </div>
          </div>

          <div class="mt-5 flex items-center justify-between gap-3">
            <button id="resetAll" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/85 hover:bg-white/8 transition">
              بدء جديد
            </button>
            <button id="closeSuccess2" class="rounded-2xl border border-white/10 bg-white/8 px-4 py-3 text-sm font-semibold text-white/90 hover:bg-white/10 transition">
              ممتاز
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // State
    // -----------------------------
    const state = {
      sections: { account: true, ninjaid: false, avatar: false, follow: false, interests: false },
      requiredOk: { account: false, ninjaid: false, avatar: false },
      userCheck: { status: "idle", available: null, timer: null, last: "" },
      avatar: {
        mode: null,          // "archetype" | "upload"
        archetypeId: null,
        archetypeName: null,
        dataUrl: null,       // final image (for upload)
        headband: false,
        outline: false,
        aura: "water"
      },
      follow: [],
      interests: { genres: [], types: [], path: null },
      dir: document.documentElement.dir || "rtl",
      motionReduced: window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches
    };

    const TAKEN_USERNAMES = new Set([
      "shinobi", "shadowrunner", "scrollscribe", "inkweaver", "nightleaf", "stormstep", "silentblade",
      "support", "admin", "moderator", "staff"
    ]);

    const followPeople = [
      { id: "dojo_daily", name: "Dojo Daily", handle: "@dojo_daily", bio: "تقنيات قصيرة + تحديات يومية" },
      { id: "ink_notes", name: "Ink Notes", handle: "@ink_notes", bio: "مراجعات مانجا + سلاسل توصيات" },
      { id: "panel_scout", name: "Panel Scout", handle: "@panel_scout", bio: "يقتنص الكنوز المخفية" },
      { id: "frame_guard", name: "Frame Guard", handle: "@frame_guard", bio: "نقاشات هادئة + تنظيم مجتمع" },
      { id: "plot_strat", name: "Plot Strategist", handle: "@plot_strat", bio: "تحليلات قصصية أنيقة" },
      { id: "heal_hub", name: "Healer Hub", handle: "@heal_hub", bio: "مساحة دعم + ترشيحات خفيفة" }
    ];

    const chips = {
      genres: ["Shōnen", "Seinen", "Mystery", "Fantasy", "Sci-Fi", "Slice of Life", "Comedy", "Drama"],
      types: ["Manga", "Manhwa", "Comics", "Anime", "Webtoon", "Light Novel"]
    };

    const archetypes = [
      { id: "stealth", name: "Stealth", vibe: "صمت + دقة", svg: svgPortrait("stealth") },
      { id: "strategist", name: "Strategist", vibe: "خطة + صبر", svg: svgPortrait("strategist") },
      { id: "healer", name: "Healer", vibe: "توازن + دعم", svg: svgPortrait("healer") },
      { id: "scout", name: "Scout", vibe: "سرعة + اكتشاف", svg: svgPortrait("scout") },
      { id: "guardian", name: "Guardian", vibe: "حماية + ثبات", svg: svgPortrait("guardian") },
      { id: "trickster", name: "Trickster", vibe: "خداع + ذكاء", svg: svgPortrait("trickster") }
    ];

    // -----------------------------
    // Elements
    // -----------------------------
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

    const inkSwipe = $("#inkSwipe");
    const speedlines = $("#speedlines");

    const form = $("#signupForm");
    const submitBtn = $("#submitBtn");
    const submitBtnMobile = $("#submitBtnMobile");
    const submitSpinner = $("#submitSpinner");
    const submitSpinnerMobile = $("#submitSpinnerMobile");

    const fullName = $("#fullName");
    const email = $("#email");
    const password = $("#password");
    const togglePw = $("#togglePw");

    const username = $("#username");
    const nickname = $("#nickname");
    const userStatusIcon = $("#userStatusIcon");
    const userStatusText = $("#userStatusText");
    const userStatusTag = $("#userStatusTag");

    const pwBar = $("#pwBar");
    const pwLabel = $("#pwLabel");
    const pwScore = $("#pwScore");
    const accountBubble = $("#accountBubble");
    const accountBubbleText = $("#accountBubbleText");

    const cropCanvas = $("#cropCanvas");
    const ctx = cropCanvas.getContext("2d");
    const zoom = $("#zoom");
    const avatarUpload = $("#avatarUpload");
    const applyCrop = $("#applyCrop");

    const outlineSwitch = $("#outlineSwitch");
    const headbandSwitch = $("#headbandSwitch");
    const auraBtns = $$(".auraBtn");

    const avatarPreview = $("#avatarPreview");
    const avatarFrame = $("#avatarFrame");
    const headbandOverlayPreview = $("#headbandOverlayPreview");
    const avatarModeTag = $("#avatarModeTag");

    const miniAvatar = $("#miniAvatar");
    const miniAvatarFrame = $("#miniAvatarFrame");
    const miniHeadband = $("#miniHeadband");

    const previewName = $("#previewName");
    const previewHandle = $("#previewHandle");
    const previewArch = $("#previewArch");
    const previewAura = $("#previewAura");

    const miniName = $("#miniName");
    const miniUser = $("#miniUser");
    const miniArch = $("#miniArch");
    const miniAura = $("#miniAura");
    const miniId = $("#miniId");
    const miniPath = $("#miniPath");
    const miniFollow = $("#miniFollow");

    const sealStateDot = $("#sealStateDot");
    const sealStateText = $("#sealStateText");
    const progressCount = $("#progressCount");

    const ok_account = $("#ok_account");
    const ok_ninjaid = $("#ok_ninjaid");
    const ok_avatar = $("#ok_avatar");

    const err_fullName = $("#err_fullName");
    const err_email = $("#err_email");
    const err_password = $("#err_password");
    const err_username = $("#err_username");
    const err_avatar = $("#err_avatar");

    const accountNext = $("#accountNext");
    const ninjaidNext = $("#ninjaidNext");
    const avatarNext = $("#avatarNext");

    const followSearch = $("#followSearch");
    const followGrid = $("#followGrid");
    const followCountTag = $("#followCountTag");

    const genreChips = $("#genreChips");
    const typeChips = $("#typeChips");

    const dirBtn = $("#dirBtn");
    const motionSwitch = $("#motionSwitch");
    const motionSwitchMobile = $("#motionSwitchMobile");

    const successModal = $("#successModal");
    const closeSuccess = $("#closeSuccess");
    const closeSuccess2 = $("#closeSuccess2");
    const resetAll = $("#resetAll");
    const stamp = $("#stamp");

    // Success card
    const cardAvatarFrame = $("#cardAvatarFrame");
    const cardAvatar = $("#cardAvatar");
    const cardHeadband = $("#cardHeadband");
    const cardName = $("#cardName");
    const cardHandle = $("#cardHandle");
    const cardNick = $("#cardNick");
    const cardId = $("#cardId");
    const cardAura = $("#cardAura");
    const cardArch = $("#cardArch");
    const cardFollow = $("#cardFollow");
    const cardPath = $("#cardPath");
    const cardGenres = $("#cardGenres");

    // Crop state
    const crop = {
      img: null,
      dragging: false,
      lastX: 0,
      lastY: 0,
      offX: 0,
      offY: 0,
      scale: 1.2
    };

    // -----------------------------
    // Helpers: UI FX
    // -----------------------------
    function playInkSwipe(){
      if (getMotionMult() === 0) return;
      inkSwipe.classList.remove("play");
      void inkSwipe.offsetWidth;
      inkSwipe.classList.add("play");

      speedlines.classList.remove("play");
      void speedlines.offsetWidth;
      speedlines.classList.add("play");
    }

    function getMotionMult(){
      const v = getComputedStyle(document.documentElement).getPropertyValue("--motion-mult").trim();
      return Number(v || 1);
    }

    function setAura(aura){
      state.avatar.aura = aura;
      const map = {
        wind: ["#66F2D5", "#66B7FF"],
        fire: ["#FF7A5A", "#FFD166"],
        water: ["#66B7FF", "#66F2D5"],
        lightning: ["#FFD166", "#66B7FF"],
        earth: ["#A7D46F", "#FFD166"]
      };
      const [a,b] = map[aura] || map.water;
      document.documentElement.style.setProperty("--auraA", a);
      document.documentElement.style.setProperty("--auraB", b);

      // Update tags
      previewAura.textContent = "Aura: " + cap(aura);
      miniAura.textContent = "Aura: " + cap(aura);
      $("#previewAura").textContent = "Aura: " + cap(aura);
      updateMiniAvatarFrame();
      updateAvatarFrame();
      redrawCrop();
      updateSealProgress();
    }

    function cap(s){ return (s||"").slice(0,1).toUpperCase() + (s||"").slice(1); }

    // -----------------------------
    // Accordion
    // -----------------------------
    function setPanelOpen(section, open){
      const panel = $("#panel_" + section);
      const root = document.querySelector(`[data-section="${section}"]`);
      if (!panel || !root) return;

      state.sections[section] = open;

      const chevron = root.querySelector(".acc-chevron");
      const hint = $("#hint_" + section);

      if (open){
        panel.classList.add("open");
        panel.style.maxHeight = panel.scrollHeight + "px";
        chevron.style.transform = "rotate(180deg)";
        if (hint) hint.textContent = "إغلاق";
      } else {
        panel.style.maxHeight = "0px";
        panel.classList.remove("open");
        chevron.style.transform = "rotate(0deg)";
        if (hint) hint.textContent = "افتح";
      }
    }

    function togglePanel(section){
      playInkSwipe();
      setPanelOpen(section, !state.sections[section]);
    }

    function ensurePanelHeight(section){
      const panel = $("#panel_" + section);
      if (!panel) return;
      if (state.sections[section]){
        panel.style.maxHeight = panel.scrollHeight + "px";
      }
    }

    $$(".acc-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const wrap = btn.closest("[data-section]");
        togglePanel(wrap.dataset.section);
      });
    });

    window.addEventListener("resize", ()=>{
      ["account","ninjaid","avatar","follow","interests"].forEach(ensurePanelHeight);
    });

    // Default open only Account
    setPanelOpen("account", true);
    setPanelOpen("ninjaid", false);
    setPanelOpen("avatar", false);
    setPanelOpen("follow", false);
    setPanelOpen("interests", false);

    // Quick open
    $$(".quickOpen").forEach(b=>{
      b.addEventListener("click", ()=>{
        const target = b.dataset.open;
        setPanelOpen(target, true);
        const el = document.querySelector(`[data-section="${target}"]`);
        el.scrollIntoView({ behavior: getMotionMult() ? "smooth" : "auto", block: "start" });
        playInkSwipe();
      });
    });

    // -----------------------------
    // Validation: Account
    // -----------------------------
    function validateEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(v.trim());
    }

    function strengthScore(pw){
      const v = pw || "";
      let score = 0;
      if (v.length >= 8) score++;
      if (/[A-Z]/.test(v) || /[أ-ي]/.test(v)) score++; // Arabic letters count as variety too
      if (/[0-9]/.test(v)) score++;
      if (/[^A-Za-z0-9\u0600-\u06FF]/.test(v)) score++; // symbol
      return Math.min(4, score);
    }

    function updatePwUI(){
      const s = strengthScore(password.value);
      const pct = [0, 25, 50, 75, 100][s];
      pwBar.style.width = pct + "%";
      pwScore.textContent = `${s}/4`;

      const labels = ["ضعيفة جدًا", "ضعيفة", "مقبولة", "جيدة", "قوية"];
      pwLabel.textContent = "قوة كلمة المرور: " + labels[s];

      // subtle color using opacity classes
      pwBar.className = "h-full rounded-full transition-[width] duration-300 " +
        (s <= 1 ? "bg-seal-700/70" : s === 2 ? "bg-white/40" : s === 3 ? "bg-emerald-400/60" : "bg-emerald-400");
    }

    function validateAccount(showErrors=false){
      const nameOk = fullName.value.trim().length >= 2;
      const emailOk = validateEmail(email.value);
      const pwOk = password.value.length >= 8 && strengthScore(password.value) >= 3;

      if (showErrors){
        err_fullName.classList.toggle("hidden", nameOk);
        err_email.classList.toggle("hidden", emailOk);
        err_password.classList.toggle("hidden", pwOk);

        fullName.classList.toggle("invalid", !nameOk);
        email.classList.toggle("invalid", !emailOk);
        password.classList.toggle("invalid", !pwOk);

        if (!nameOk || !emailOk || !pwOk){
          accountBubble.classList.remove("hidden");
          accountBubbleText.textContent =
            (!nameOk ? "اكتب اسمًا واضحًا." : "") +
            (!emailOk ? (nameOk ? "" : " ") + "البريد يحتاج صيغة صحيحة." : "") +
            (!pwOk ? ((nameOk||emailOk) ? " " : "") + "كلمة المرور تحتاج قوة أعلى." : "");
        } else {
          accountBubble.classList.add("hidden");
        }
      }

      state.requiredOk.account = nameOk && emailOk && pwOk;
      ok_account.classList.toggle("hidden", !state.requiredOk.account);
      updateSealProgress();
      return state.requiredOk.account;
    }

    fullName.addEventListener("input", ()=>{
      validateAccount(false);
      updateMini();
    });
    email.addEventListener("input", ()=>{
      validateAccount(false);
      updateMini();
    });
    password.addEventListener("input", ()=>{
      updatePwUI();
      validateAccount(false);
    });

    togglePw.addEventListener("click", ()=>{
      const isPw = password.type === "password";
      password.type = isPw ? "text" : "password";
      togglePw.textContent = isPw ? "إخفاء" : "إظهار";
    });

    accountNext.addEventListener("click", ()=>{
      playInkSwipe();
      const ok = validateAccount(true);
      if (ok){
        setPanelOpen("account", false);
        setPanelOpen("ninjaid", true);
        $("#panel_ninjaid").closest("[data-section]").scrollIntoView({ behavior: getMotionMult()? "smooth" : "auto", block: "start" });
      } else {
        $("#panel_account").closest("[data-section]").scrollIntoView({ behavior: getMotionMult()? "smooth" : "auto", block: "start" });
      }
    });

    updatePwUI();

    // -----------------------------
    // Validation: Username async
    // -----------------------------
    function normalizeHandle(v){
      return v.trim().replace(/^@+/, "").toLowerCase();
    }

    function setUserStatus(status, available=null, msg=""){
      state.userCheck.status = status;
      state.userCheck.available = available;

      if (status === "idle"){
        userStatusIcon.innerHTML = `<span class="text-[10px] text-white/60">…</span>`;
        userStatusText.textContent = msg || "اكتب اسمًا للتحقق";
        userStatusTag.classList.add("hidden");
      }
      if (status === "checking"){
        userStatusIcon.innerHTML = `
          <svg class="animate-spin" width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>`;
        userStatusText.textContent = msg || "جارٍ التحقق…";
        userStatusTag.classList.remove("hidden");
        userStatusTag.textContent = "ASYNC";
        userStatusTag.className = "text-[10px] rounded-full px-2 py-0.5 border border-white/12 bg-white/6 text-white/70";
      }
      if (status === "ok"){
        userStatusIcon.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        userStatusText.textContent = msg || "متاح";
        userStatusTag.classList.remove("hidden");
        userStatusTag.textContent = "متاح";
        userStatusTag.className = "text-[10px] rounded-full px-2 py-0.5 border border-emerald-400/25 bg-emerald-500/12 text-emerald-200";
      }
      if (status === "bad"){
        userStatusIcon.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>`;
        userStatusText.textContent = msg || "غير متاح";
        userStatusTag.classList.remove("hidden");
        userStatusTag.textContent = "محجوز";
        userStatusTag.className = "text-[10px] rounded-full px-2 py-0.5 border border-seal-600/25 bg-seal-700/14 text-seal-600";
      }
    }

    function validateNinjaId(showErrors=false){
      const u = normalizeHandle(username.value);
      const has = u.length >= 3 && /^[a-z0-9._-]+$/.test(u);
      const available = state.userCheck.available === true;
      const done = has && available;

      if (showErrors){
        err_username.classList.toggle("hidden", done);
        username.classList.toggle("invalid", !done);
      } else {
        if (!has && username.value.trim().length){
          username.classList.add("invalid");
        } else {
          username.classList.remove("invalid");
        }
      }

      state.requiredOk.ninjaid = done;
      ok_ninjaid.classList.toggle("hidden", !state.requiredOk.ninjaid);
      updateMini();
      updateSealProgress();
      return done;
    }

    function scheduleUserCheck(){
      const raw = username.value;
      const u = normalizeHandle(raw);

      state.userCheck.last = u;
      state.userCheck.available = null;

      // basic immediate rules
      if (!u){
        setUserStatus("idle", null, "اكتب اسمًا للتحقق");
        validateNinjaId(false);
        updateMini();
        return;
      }

      if (u.length < 3 || !/^[a-z0-9._-]+$/.test(u)){
        setUserStatus("bad", false, "صيغة غير مناسبة (a-z / 0-9 / . _ -)");
        validateNinjaId(false);
        updateMini();
        return;
      }

      setUserStatus("checking", null, "جارٍ التحقق…");
      validateNinjaId(false);
      updateMini();

      clearTimeout(state.userCheck.timer);
      state.userCheck.timer = setTimeout(()=>{
        // simulate latency
        const isTaken = TAKEN_USERNAMES.has(u) || u.includes("admin") || u.includes("support");
        // deterministic-ish extra: short names more likely taken
        const moreLikelyTaken = (u.length <= 4) && (["ninja","dojo","ink","manga"].some(k=>u.includes(k)));
        const available = !(isTaken || moreLikelyTaken);

        setUserStatus(available ? "ok" : "bad", available, available ? "متاح — يمكنك استخدامه" : "محجوز — جرّب إضافة رقم");
        validateNinjaId(false);
        updateMini();
      }, 650);
    }

    username.addEventListener("input", ()=>{
      scheduleUserCheck();
    });

    ninjaidNext.addEventListener("click", ()=>{
      playInkSwipe();
      const ok = validateNinjaId(true);
      if (ok){
        setPanelOpen("ninjaid", false);
        setPanelOpen("avatar", true);
        $("#panel_avatar").closest("[data-section]").scrollIntoView({ behavior: getMotionMult()? "smooth" : "auto", block: "start" });
      } else {
        $("#panel_ninjaid").closest("[data-section]").scrollIntoView({ behavior: getMotionMult()? "smooth" : "auto", block: "start" });
      }
    });

    nickname.addEventListener("input", updateMini);

    // -----------------------------
    // Archetype grid
    // -----------------------------
    function renderArchetypeGrid(){
      const grid = $("#archetypeGrid");
      grid.innerHTML = "";
      archetypes.forEach(a=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "group text-left rounded-2xl border border-white/10 bg-white/4 hover:bg-white/6 transition p-3";
        btn.dataset.id = a.id;

        btn.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-semibold text-white/90">${a.name}</div>
            <span class="text-[10px] badge rounded-full px-2 py-0.5 text-white/65">SVG</span>
          </div>
          <div class="mt-1 text-[11px] text-white/55">${a.vibe}</div>
          <div class="mt-3 rounded-xl border border-white/10 bg-ink-900/35 overflow-hidden p-2 grid place-items-center">
            <div class="w-full max-w-[120px] aspect-square">${a.svg}</div>
          </div>
        `;

        btn.addEventListener("click", ()=>{
          playInkSwipe();
          state.avatar.mode = "archetype";
          state.avatar.archetypeId = a.id;
          state.avatar.archetypeName = a.name;
          state.avatar.dataUrl = null;

          // visual selected
          $$("#archetypeGrid button").forEach(b=>b.classList.remove("ring-2","ring-white/40"));
          btn.classList.add("ring-2","ring-white/40");

          updateAvatarPreviewFromArchetype();
          validateAvatar(false);
          updateSealProgress();
        });

        grid.appendChild(btn);
      });
    }

    function updateAvatarPreviewFromArchetype(){
      const a = archetypes.find(x=>x.id === state.avatar.archetypeId);
      if (!a) return;

      avatarModeTag.textContent = "Archetype";
      avatarPreview.innerHTML = `<div class="w-full h-full grid place-items-center">${a.svg}</div>`;
      miniAvatar.innerHTML = `<div class="w-full h-full grid place-items-center">${a.svg}</div>`;
      cardAvatar.innerHTML = `<div class="w-full h-full grid place-items-center">${a.svg}</div>`;

      previewArch.textContent = "Archetype: " + a.name;
      miniArch.textContent = a.name;
      $("#previewArch").textContent = "Archetype: " + a.name;
      updateAvatarFrame();
      updateMiniAvatarFrame();
    }

    // -----------------------------
    // Avatar upload + crop
    // -----------------------------
    function clearCanvas(){
      ctx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
    }

    function drawAuraBack(){
      const w = cropCanvas.width, h = cropCanvas.height;
      const g = ctx.createLinearGradient(0,0,w,h);
      const a = getComputedStyle(document.documentElement).getPropertyValue("--auraA").trim() || "#66B7FF";
      const b = getComputedStyle(document.documentElement).getPropertyValue("--auraB").trim() || "#66F2D5";
      g.addColorStop(0, hexToRgba(a, .22));
      g.addColorStop(1, hexToRgba(b, .18));
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // subtle paper-ish vignette
      const vg = ctx.createRadialGradient(w*0.5,h*0.4,40, w*0.5,h*0.5, w*0.72);
      vg.addColorStop(0, "rgba(255,255,255,.08)");
      vg.addColorStop(1, "rgba(7,10,18,.24)");
      ctx.fillStyle = vg;
      ctx.fillRect(0,0,w,h);
    }

    function hexToRgba(hex, a){
      const h = hex.replace("#","").trim();
      const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
      const r = parseInt(full.slice(0,2),16);
      const g = parseInt(full.slice(2,4),16);
      const b = parseInt(full.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }

    function redrawCrop(){
      clearCanvas();
      drawAuraBack();

      const w = cropCanvas.width, h = cropCanvas.height;

      // If no image: draw placeholder
      if (!crop.img){
        ctx.save();
        // crop guide
        const r = Math.min(w,h)*0.34;
        ctx.globalAlpha = .9;
        ctx.strokeStyle = "rgba(255,255,255,.18)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(w/2, h/2, r, 0, Math.PI*2);
        ctx.stroke();

        // grid
        ctx.globalAlpha = .25;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(w/2 - r, h/2);
        ctx.lineTo(w/2 + r, h/2);
        ctx.moveTo(w/2, h/2 - r);
        ctx.lineTo(w/2, h/2 + r);
        ctx.stroke();

        ctx.globalAlpha = .75;
        ctx.fillStyle = "rgba(255,255,255,.72)";
        ctx.font = "12px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText("ارفع صورة ثم اسحب/كبّر", w/2, h/2 + r + 22);
        ctx.restore();
        return;
      }

      // draw clipped avatar circle
      const radius = Math.min(w,h) * 0.34;

      ctx.save();
      ctx.beginPath();
      ctx.arc(w/2, h/2, radius, 0, Math.PI*2);
      ctx.closePath();
      ctx.clip();

      const img = crop.img;
      const sc = crop.scale;
      const iw = img.width * sc;
      const ih = img.height * sc;

      const x = (w/2 - iw/2) + crop.offX;
      const y = (h/2 - ih/2) + crop.offY;

      ctx.drawImage(img, x, y, iw, ih);

      if (state.avatar.outline){
        // Simple "ink outline" mock:
        // draw a darker, high-contrast layer slightly offset and multiply it
        ctx.save();
        ctx.globalAlpha = 0.35;
        ctx.globalCompositeOperation = "multiply";
        ctx.filter = "grayscale(100%) contrast(240%) brightness(90%)";
        // multi-offset to emulate edge thickening
        const offs = [[-2,0],[2,0],[0,-2],[0,2],[-1,-1],[1,1],[-1,1],[1,-1]];
        offs.forEach(([dx,dy])=>{
          ctx.drawImage(img, x+dx, y+dy, iw, ih);
        });
        ctx.restore();
        ctx.filter = "none";
      }

      ctx.restore();

      // frame ring
      const grad = ctx.createLinearGradient(0,0,w,h);
      const A = getComputedStyle(document.documentElement).getPropertyValue("--auraA").trim() || "#66B7FF";
      const B = getComputedStyle(document.documentElement).getPropertyValue("--auraB").trim() || "#66F2D5";
      grad.addColorStop(0, hexToRgba(A, .85));
      grad.addColorStop(1, hexToRgba(B, .70));
      ctx.strokeStyle = grad;
      ctx.lineWidth = 10;
      ctx.shadowColor = hexToRgba(A, .25);
      ctx.shadowBlur = 18;
      ctx.beginPath();
      ctx.arc(w/2, h/2, radius+4, 0, Math.PI*2);
      ctx.stroke();
      ctx.shadowBlur = 0;

      // crop guide on top
      ctx.save();
      ctx.globalAlpha = .18;
      ctx.strokeStyle = "rgba(255,255,255,.8)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.arc(w/2, h/2, radius, 0, Math.PI*2);
      ctx.stroke();

      // speed-ish diagonal highlight
      ctx.globalAlpha = .10;
      ctx.strokeStyle = "rgba(255,255,255,.9)";
      ctx.lineWidth = 2;
      for (let i=-w; i<w*2; i+=24){
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i+w, h);
        ctx.stroke();
      }
      ctx.restore();

      // headband hint
      if (state.avatar.headband){
        drawHeadbandOnCanvas(ctx, w, h, radius);
      }
    }

    function drawHeadbandOnCanvas(context, w, h, radius){
      context.save();
      context.globalAlpha = 0.9;
      const bandY = h/2 - radius*0.72;
      const bandH = radius*0.42;
      const bandW = radius*1.75;
      const bandX = w/2 - bandW/2;

      roundRect(context, bandX, bandY, bandW, bandH, bandH/2);
      context.fillStyle = "rgba(11,16,32,.40)";
      context.fill();

      // metal plate (blank)
      const plateW = bandW*0.42;
      const plateH = bandH*0.72;
      const plateX = w/2 - plateW/2;
      const plateY = bandY + (bandH - plateH)/2;

      roundRect(context, plateX, plateY, plateW, plateH, 12);
      context.fillStyle = "rgba(255,255,255,.14)";
      context.fill();
      context.strokeStyle = "rgba(255,255,255,.18)";
      context.lineWidth = 1;
      context.stroke();

      // tiny rivets
      context.fillStyle = "rgba(255,255,255,.18)";
      const r = 2.2;
      [[plateX+10, plateY+10],[plateX+plateW-10, plateY+10],[plateX+10, plateY+plateH-10],[plateX+plateW-10, plateY+plateH-10]]
        .forEach(([cx,cy])=>{
          context.beginPath();
          context.arc(cx, cy, r, 0, Math.PI*2);
          context.fill();
        });

      context.restore();
    }

    function roundRect(context, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      context.beginPath();
      context.moveTo(x+rr, y);
      context.arcTo(x+w, y, x+w, y+h, rr);
      context.arcTo(x+w, y+h, x, y+h, rr);
      context.arcTo(x, y+h, x, y, rr);
      context.arcTo(x, y, x+w, y, rr);
      context.closePath();
    }

    function applyCropToAvatar(){
      if (!crop.img) return;

      const out = document.createElement("canvas");
      out.width = 256;
      out.height = 256;
      const o = out.getContext("2d");

      // aura background
      const A = getComputedStyle(document.documentElement).getPropertyValue("--auraA").trim() || "#66B7FF";
      const B = getComputedStyle(document.documentElement).getPropertyValue("--auraB").trim() || "#66F2D5";
      const bg = o.createLinearGradient(0,0,256,256);
      bg.addColorStop(0, hexToRgba(A, .22));
      bg.addColorStop(1, hexToRgba(B, .16));
      o.fillStyle = bg;
      o.fillRect(0,0,256,256);

      // clip circle
      const radius = 88;
      o.save();
      o.beginPath();
      o.arc(128,128,radius,0,Math.PI*2);
      o.closePath();
      o.clip();

      const img = crop.img;
      const sc = crop.scale * (256 / cropCanvas.width);
      const iw = img.width * sc;
      const ih = img.height * sc;

      const x = (128 - iw/2) + crop.offX * (256 / cropCanvas.width);
      const y = (128 - ih/2) + crop.offY * (256 / cropCanvas.width);

      o.drawImage(img, x, y, iw, ih);

      if (state.avatar.outline){
        o.save();
        o.globalAlpha = 0.35;
        o.globalCompositeOperation = "multiply";
        o.filter = "grayscale(100%) contrast(240%) brightness(90%)";
        const offs = [[-2,0],[2,0],[0,-2],[0,2],[-1,-1],[1,1],[-1,1],[1,-1]];
        offs.forEach(([dx,dy])=>{
          o.drawImage(img, x+dx, y+dy, iw, ih);
        });
        o.restore();
        o.filter = "none";
      }

      o.restore();

      // aura ring
      const ring = o.createLinearGradient(0,0,256,256);
      ring.addColorStop(0, hexToRgba(A, .90));
      ring.addColorStop(1, hexToRgba(B, .75));
      o.strokeStyle = ring;
      o.lineWidth = 12;
      o.shadowColor = hexToRgba(A, .25);
      o.shadowBlur = 18;
      o.beginPath();
      o.arc(128,128,radius+6,0,Math.PI*2);
      o.stroke();
      o.shadowBlur = 0;

      if (state.avatar.headband){
        drawHeadbandOnCanvas(o, 256, 256, radius);
      }

      state.avatar.dataUrl = out.toDataURL("image/png");
      state.avatar.mode = "upload";
      avatarModeTag.textContent = "Upload";
      updateAvatarPreviewFromDataUrl();
      validateAvatar(false);
      updateSealProgress();
    }

    function updateAvatarPreviewFromDataUrl(){
      const url = state.avatar.dataUrl;
      if (!url) return;
      const imgTag = `<img alt="avatar" src="${url}" class="w-full h-full object-cover" />`;

      avatarPreview.innerHTML = imgTag;
      miniAvatar.innerHTML = imgTag;
      cardAvatar.innerHTML = imgTag;

      previewArch.textContent = "Archetype: Custom";
      miniArch.textContent = "Custom";
      $("#previewArch").textContent = "Archetype: Custom";
      updateAvatarFrame();
      updateMiniAvatarFrame();
    }

    function validateAvatar(showErrors=false){
      const ok = (state.avatar.mode === "archetype" && !!state.avatar.archetypeId) ||
                 (state.avatar.mode === "upload" && !!state.avatar.dataUrl);

      if (showErrors){
        err_avatar.classList.toggle("hidden", ok);
      }
      state.requiredOk.avatar = ok;
      ok_avatar.classList.toggle("hidden", !ok);
      updateSealProgress();
      return ok;
    }

    avatarNext.addEventListener("click", ()=>{
      playInkSwipe();
      const ok = validateAvatar(true);
      if (ok){
        setPanelOpen("avatar", false);
        // Optional: open follow or interests lightly
        setPanelOpen("follow", true);
        $("#panel_follow").closest("[data-section]").scrollIntoView({ behavior: getMotionMult()? "smooth" : "auto", block: "start" });
      } else {
        $("#panel_avatar").closest("[data-section]").scrollIntoView({ behavior: getMotionMult()? "smooth" : "auto", block: "start" });
      }
    });

    avatarUpload.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          crop.img = img;
          crop.offX = 0;
          crop.offY = 0;

          // initial scale to fill circle roughly
          const base = Math.max(cropCanvas.width / img.width, cropCanvas.height / img.height);
          crop.scale = Math.max(1, base) * parseFloat(zoom.value);
          redrawCrop();

          // set mode (not final until apply)
          avatarModeTag.textContent = "Upload (pending)";
          state.avatar.mode = "upload";
          state.avatar.dataUrl = null;
          validateAvatar(false);
          updateSealProgress();

          // ensure avatar panel open
          setPanelOpen("avatar", true);
          ensurePanelHeight("avatar");
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    zoom.addEventListener("input", ()=>{
      const z = parseFloat(zoom.value);
      crop.scale = (crop.img ? Math.max(cropCanvas.width/crop.img.width, cropCanvas.height/crop.img.height) : 1) * z;
      redrawCrop();
    });

    applyCrop.addEventListener("click", ()=>{
      playInkSwipe();
      applyCropToAvatar();
    });

    // drag handlers
    cropCanvas.addEventListener("pointerdown", (e)=>{
      if (!crop.img) return;
      crop.dragging = true;
      cropCanvas.setPointerCapture(e.pointerId);
      crop.lastX = e.clientX;
      crop.lastY = e.clientY;
    });
    cropCanvas.addEventListener("pointermove", (e)=>{
      if (!crop.dragging) return;
      const dx = e.clientX - crop.lastX;
      const dy = e.clientY - crop.lastY;
      crop.lastX = e.clientX;
      crop.lastY = e.clientY;
      crop.offX += dx;
      crop.offY += dy;
      redrawCrop();
    });
    cropCanvas.addEventListener("pointerup", ()=>{
      crop.dragging = false;
    });
    cropCanvas.addEventListener("pointercancel", ()=>{
      crop.dragging = false;
    });

    outlineSwitch.addEventListener("click", ()=>{
      state.avatar.outline = !state.avatar.outline;
      outlineSwitch.classList.toggle("on", state.avatar.outline);
      playInkSwipe();
      redrawCrop();
      // re-apply if already custom
      if (state.avatar.mode === "upload" && state.avatar.dataUrl){
        applyCropToAvatar();
      }
    });

    headbandSwitch.addEventListener("click", ()=>{
      state.avatar.headband = !state.avatar.headband;
      headbandSwitch.classList.toggle("on", state.avatar.headband);
      headbandOverlayPreview.classList.toggle("hidden", !state.avatar.headband);
      miniHeadband.classList.toggle("hidden", !state.avatar.headband);
      cardHeadband.classList.toggle("hidden", !state.avatar.headband);
      playInkSwipe();
      redrawCrop();
      // re-apply if already custom
      if (state.avatar.mode === "upload" && state.avatar.dataUrl){
        applyCropToAvatar();
      }
    });

    auraBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        auraBtns.forEach(b=>b.classList.remove("ring-2","ring-white/40"));
        btn.classList.add("ring-2","ring-white/40");
        setAura(btn.dataset.aura);
      });
    });

    // default aura selection
    auraBtns.find(b=>b.dataset.aura==="water")?.classList.add("ring-2","ring-white/40");
    setAura("water");

    function updateAvatarFrame(){
      // aura variables already applied globally; frame uses CSS
      previewAura.textContent = "Aura: " + cap(state.avatar.aura);
      $("#previewAura").textContent = "Aura: " + cap(state.avatar.aura);
    }
    function updateMiniAvatarFrame(){
      miniAura.textContent = "Aura: " + cap(state.avatar.aura);
      $("#miniAvatarFrame"); // uses same aura vars
    }

    // -----------------------------
    // Follow (optional)
    // -----------------------------
    function renderFollowGrid(filter=""){
      const q = (filter||"").toLowerCase().trim();
      followGrid.innerHTML = "";

      const selectedCount = state.follow.length;
      followCountTag.textContent = `${selectedCount}/2`;
      miniFollow.textContent = `${selectedCount}/2`;

      const list = followPeople.filter(p=>{
        if (!q) return true;
        return (p.name + " " + p.handle + " " + p.bio).toLowerCase().includes(q);
      });

      list.forEach(p=>{
        const selected = state.follow.includes(p.id);
        const disabled = !selected && selectedCount >= 2;

        const card = document.createElement("button");
        card.type = "button";
        card.className =
          "text-left rounded-2xl border border-white/10 bg-white/4 hover:bg-white/6 transition p-4 flex items-start justify-between gap-3 " +
          (disabled ? "opacity-45 cursor-not-allowed" : "");
        card.disabled = disabled;

        card.innerHTML = `
          <div class="min-w-0">
            <div class="flex items-center gap-2">
              <div class="h-9 w-9 rounded-2xl bg-ink-900/40 border border-white/10 grid place-items-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
                  <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.6"/>
                  <path d="M5 20c1.6-3 4.2-4.5 7-4.5S17.4 17 19 20" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="font-semibold text-white/90 truncate">${p.name}</div>
                <div class="text-xs text-white/60 truncate">${p.handle}</div>
              </div>
            </div>
            <div class="mt-2 text-xs text-white/55 leading-relaxed">${p.bio}</div>
          </div>
          <div class="shrink-0">
            <div class="switch ${selected ? "on" : ""}" aria-hidden="true"></div>
          </div>
        `;

        card.addEventListener("click", ()=>{
          playInkSwipe();
          if (state.follow.includes(p.id)){
            state.follow = state.follow.filter(id=>id!==p.id);
          } else {
            if (state.follow.length >= 2) return;
            state.follow.push(p.id);
          }
          renderFollowGrid(followSearch.value);
          updateMini();
        });

        followGrid.appendChild(card);
      });

      // update mini follow
      $("#miniFollow").textContent = `${state.follow.length}/2`;
      $("#cardFollow").textContent = `${state.follow.length}/2`;
      updateSealProgress();
    }

    followSearch.addEventListener("input", ()=>{
      renderFollowGrid(followSearch.value);
    });

    renderFollowGrid("");

    // -----------------------------
    // Interests chips
    // -----------------------------
    function chipButton(label, type){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "rounded-full border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/8 transition";
      b.textContent = label;

      b.addEventListener("click", ()=>{
        playInkSwipe();
        const arr = state.interests[type];
        const has = arr.includes(label);
        if (has){
          state.interests[type] = arr.filter(x=>x!==label);
          b.classList.remove("ring-2","ring-white/40","bg-white/10");
        } else {
          state.interests[type].push(label);
          b.classList.add("ring-2","ring-white/40","bg-white/10");
        }
        updateMini();
      });

      return b;
    }

    function renderChips(){
      chips.genres.forEach(g=>genreChips.appendChild(chipButton(g, "genres")));
      chips.types.forEach(t=>typeChips.appendChild(chipButton(t, "types")));
    }
    renderChips();

    $$('input[name="path"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        playInkSwipe();
        state.interests.path = r.value;
        updateMini();
      });
    });

    // -----------------------------
    // Direction + Motion toggles
    // -----------------------------
    function setDir(dir){
      state.dir = dir;
      document.documentElement.dir = dir;
      // Keep email/password ltr fields; rest follows dir
      playInkSwipe();
    }

    dirBtn.addEventListener("click", ()=>{
      setDir(document.documentElement.dir === "rtl" ? "ltr" : "rtl");
    });

    function setReducedMotion(on){
      state.motionReduced = !!on;
      document.body.classList.toggle("reduce-motion", state.motionReduced);
      motionSwitch.classList.toggle("on", state.motionReduced);
      motionSwitchMobile.classList.toggle("on", state.motionReduced);
    }

    // initial motion switch: if system reduce motion -> on
    setReducedMotion(state.motionReduced);

    motionSwitch.addEventListener("click", ()=> setReducedMotion(!state.motionReduced));
    motionSwitchMobile.addEventListener("click", ()=> setReducedMotion(!state.motionReduced));

    // -----------------------------
    // Mini preview updates
    // -----------------------------
    function updateMini(){
      const name = fullName.value.trim() || "اسمك هنا";
      const u = normalizeHandle(username.value) || "username";
      const id = buildNinjaId(name, u);

      previewName.textContent = name === "اسمك هنا" ? "—" : name;
      previewHandle.textContent = "@"+u;

      miniName.textContent = name;
      miniUser.textContent = "@"+u;
      miniId.textContent = id;

      // Archetype
      miniArch.textContent = state.avatar.archetypeName || (state.avatar.dataUrl ? "Custom" : "—");
      $("#previewArch").textContent = "Archetype: " + (state.avatar.archetypeName || (state.avatar.dataUrl ? "Custom" : "—"));
      previewArch.textContent = "Archetype: " + (state.avatar.archetypeName || (state.avatar.dataUrl ? "Custom" : "—"));

      // Path
      miniPath.textContent = state.interests.path || "—";

      // Follow
      miniFollow.textContent = `${state.follow.length}/2`;

      updateSealProgress();
    }

    function buildNinjaId(name, handle){
      // simple deterministic ID: 2 letters + 4 digits from hash
      const s = (name + "|" + handle).trim();
      let h = 0;
      for (let i=0; i<s.length; i++){
        h = (h*31 + s.charCodeAt(i)) >>> 0;
      }
      const digits = String(h % 10000).padStart(4,"0");
      const letters = (handle || "nn").slice(0,2).toUpperCase().padEnd(2,"N");
      return `${letters}-${digits}`;
    }

    // -----------------------------
    // Required progress + seal state
    // -----------------------------
    function updateSealProgress(){
      const okCount = ["account","ninjaid","avatar"].reduce((n,k)=>n + (state.requiredOk[k] ? 1 : 0), 0);
      progressCount.textContent = String(okCount);

      const allOk = okCount === 3;
      sealStateDot.className = "h-2 w-2 rounded-full " + (allOk ? "bg-emerald-400" : okCount === 0 ? "bg-white/25" : "bg-white/50");
      sealStateText.textContent = allOk ? "جاهز للختم" : (okCount === 0 ? "غير مكتمل" : "قريب…");

      // Update headband overlays (preview)
      headbandOverlayPreview.classList.toggle("hidden", !state.avatar.headband);
      miniHeadband.classList.toggle("hidden", !state.avatar.headband);
      cardHeadband.classList.toggle("hidden", !state.avatar.headband);

      // Update mini avatar frame by mode
      if (!state.avatar.mode){
        avatarModeTag.textContent = "—";
      }

      // sync follow tag
      followCountTag.textContent = `${state.follow.length}/2`;
    }

    // -----------------------------
    // Submit flow (Ink swipe + Seal stamp)
    // -----------------------------
    function setSubmitting(on){
      if (submitBtn){
        submitBtn.disabled = on;
        submitSpinner.classList.toggle("hidden", !on);
      }
      if (submitBtnMobile){
        submitBtnMobile.disabled = on;
        submitSpinnerMobile.classList.toggle("hidden", !on);
      }
    }

    function openFirstError(){
      // Order: account -> ninjaid -> avatar
      if (!validateAccount(true)){
        setPanelOpen("account", true);
        setPanelOpen("ninjaid", false);
        setPanelOpen("avatar", false);
        document.querySelector('[data-section="account"]').scrollIntoView({ behavior: getMotionMult()? "smooth":"auto", block:"start" });
        playInkSwipe();
        return false;
      }
      if (!validateNinjaId(true)){
        setPanelOpen("account", false);
        setPanelOpen("ninjaid", true);
        setPanelOpen("avatar", false);
        document.querySelector('[data-section="ninjaid"]').scrollIntoView({ behavior: getMotionMult()? "smooth":"auto", block:"start" });
        playInkSwipe();
        return false;
      }
      if (!validateAvatar(true)){
        setPanelOpen("account", false);
        setPanelOpen("ninjaid", false);
        setPanelOpen("avatar", true);
        document.querySelector('[data-section="avatar"]').scrollIntoView({ behavior: getMotionMult()? "smooth":"auto", block:"start" });
        playInkSwipe();
        return false;
      }
      return true;
    }

    function showSuccess(){
      // Fill success card
      const name = fullName.value.trim();
      const handle = normalizeHandle(username.value);
      const id = buildNinjaId(name, handle);

      cardName.textContent = name || "—";
      cardHandle.textContent = "@"+(handle||"—");
      cardNick.textContent = nickname.value.trim() ? ("“" + nickname.value.trim() + "”") : "—";
      cardId.textContent = id;
      cardAura.textContent = "Aura: " + cap(state.avatar.aura);
      cardArch.textContent = "Archetype: " + (state.avatar.archetypeName || (state.avatar.dataUrl ? "Custom" : "—"));
      cardFollow.textContent = `${state.follow.length}/2`;
      cardPath.textContent = state.interests.path || "—";
      cardGenres.textContent = state.interests.genres.length ? state.interests.genres.slice(0,3).join(", ") : "—";

      // avatar in card already synced
      successModal.classList.remove("hidden");

      // stamp animation
      stamp.classList.remove("play");
      void stamp.offsetWidth;
      stamp.classList.add("play");

      playInkSwipe();
    }

    function closeSuccessModal(){
      successModal.classList.add("hidden");
    }

    closeSuccess.addEventListener("click", closeSuccessModal);
    closeSuccess2.addEventListener("click", closeSuccessModal);

    resetAll.addEventListener("click", ()=>{
      // reset form
      form.reset();
      setUserStatus("idle", null, "اكتب اسمًا للتحقق");
      state.requiredOk = { account:false, ninjaid:false, avatar:false };
      state.follow = [];
      state.interests = { genres:[], types:[], path:null };
      state.avatar = { mode:null, archetypeId:null, archetypeName:null, dataUrl:null, headband:false, outline:false, aura:"water" };

      // switches
      outlineSwitch.classList.remove("on");
      headbandSwitch.classList.remove("on");
      headbandOverlayPreview.classList.add("hidden");
      miniHeadband.classList.add("hidden");
      cardHeadband.classList.add("hidden");

      // archetype selection visuals
      $$("#archetypeGrid button").forEach(b=>b.classList.remove("ring-2","ring-white/40"));

      // chips visuals
      [...genreChips.children, ...typeChips.children].forEach(c=>{
        c.classList.remove("ring-2","ring-white/40","bg-white/10");
      });

      // preview resets
      avatarPreview.innerHTML = `<span class="text-xs">اختر Avatar</span>`;
      miniAvatar.innerHTML = `<span class="text-[10px]">Avatar</span>`;
      cardAvatar.innerHTML = "";
      avatarModeTag.textContent = "—";

      crop.img = null;
      crop.offX = 0; crop.offY = 0;
      zoom.value = 1.2;
      redrawCrop();

      renderFollowGrid("");
      setAura("water");

      // accordions
      setPanelOpen("account", true);
      setPanelOpen("ninjaid", false);
      setPanelOpen("avatar", false);
      setPanelOpen("follow", false);
      setPanelOpen("interests", false);

      updatePwUI();
      validateAccount(false);
      validateNinjaId(false);
      validateAvatar(false);
      updateMini();
      closeSuccessModal();
      playInkSwipe();
    });

    function submitFlow(){
      if (!openFirstError()) return;

      // simulate save + seal stamp
      setSubmitting(true);
      playInkSwipe();
      // UI-only delay
      setTimeout(()=>{
        setSubmitting(false);
        showSuccess();
      }, 800);
    }

    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      submitFlow();
    });

    submitBtnMobile.addEventListener("click", ()=>{
      submitFlow();
    });

    // -----------------------------
    // Init
    // -----------------------------
    function svgPortrait(kind){
      // abstract portraits — no recognizable IP
      // Use simple shapes: mask-like, strokes, and chakra-like gradients
      const palette = {
        stealth: ["#66B7FF","#121A33","#F6EBD2"],
        strategist: ["#FFD166","#1B2750","#F6EBD2"],
        healer: ["#A7D46F","#121A33","#F6EBD2"],
        scout: ["#66F2D5","#1B2750","#F6EBD2"],
        guardian: ["#FF7A5A","#121A33","#F6EBD2"],
        trickster: ["#C7A14A","#1B2750","#F6EBD2"],
      }[kind] || ["#66B7FF","#121A33","#F6EBD2"];

      const [c1,c2,c3] = palette;

      return `
        <svg viewBox="0 0 120 120" class="w-full h-full" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${kind}">
          <defs>
            <linearGradient id="g_${kind}" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="${c1}" stop-opacity=".95"/>
              <stop offset="1" stop-color="${c2}" stop-opacity=".95"/>
            </linearGradient>
            <radialGradient id="r_${kind}" cx=".35" cy=".3" r=".8">
              <stop offset="0" stop-color="${c3}" stop-opacity=".38"/>
              <stop offset="1" stop-color="${c2}" stop-opacity="0"/>
            </radialGradient>
            <filter id="f_${kind}" x="-30%" y="-30%" width="160%" height="160%">
              <feGaussianBlur stdDeviation="0.6"/>
            </filter>
          </defs>

          <rect x="10" y="10" width="100" height="100" rx="26" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.10)"/>
          <path d="M30 76c6 18 54 18 60 0" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="3" stroke-linecap="round"/>
          <path d="M34 50c10-18 42-18 52 0" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="3" stroke-linecap="round"/>

          <g filter="url(#f_${kind})">
            <path d="M60 26c18 0 32 14 32 32s-14 40-32 40-32-22-32-40 14-32 32-32Z" fill="url(#g_${kind})" opacity=".88"/>
            <path d="M60 30c14 0 24 10 24 24 0 12-6 28-24 28S36 66 36 54c0-14 10-24 24-24Z" fill="url(#r_${kind})" opacity=".85"/>
          </g>

          <path d="M34 54c8 8 44 8 52 0" fill="none" stroke="rgba(7,10,18,.35)" stroke-width="6" stroke-linecap="round"/>
          <path d="M40 54c6 6 34 6 40 0" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="3" stroke-linecap="round"/>

          <circle cx="46" cy="58" r="3" fill="rgba(255,255,255,.35)"/>
          <circle cx="74" cy="58" r="3" fill="rgba(255,255,255,.35)"/>

          <path d="M26 38l16-8M94 38l-16-8" stroke="rgba(255,255,255,.18)" stroke-width="3" stroke-linecap="round"/>
          <path d="M26 86l14 10M94 86l-14 10" stroke="rgba(255,255,255,.12)" stroke-width="3" stroke-linecap="round"/>
        </svg>
      `;
    }

    renderArchetypeGrid();
    redrawCrop();
    updateMini();

    // Seed initial placeholders
    setUserStatus("idle", null, "اكتب اسمًا للتحقق");
    validateAccount(false);
    validateNinjaId(false);
    validateAvatar(false);

    // Keep accordion heights accurate once fonts settle
    setTimeout(()=>["account","ninjaid","avatar","follow","interests"].forEach(ensurePanelHeight), 50);

    // -----------------------------
    // Extra: update avatar preview when account/id changes
    // -----------------------------
    function syncPreviewText(){
      const name = fullName.value.trim() || "—";
      const u = normalizeHandle(username.value) || "—";
      previewName.textContent = name === "—" ? "—" : name;
      previewHandle.textContent = "@"+u;
      updateMini();
    }
    fullName.addEventListener("input", syncPreviewText);
    username.addEventListener("input", syncPreviewText);

    // -----------------------------
    // Minor UX: auto-open next required if user clicks inside closed panel
    // -----------------------------
    ["ninjaid","avatar","follow","interests"].forEach(sec=>{
      const panel = $("#panel_"+sec);
      panel?.addEventListener("focusin", ()=>{
        if (!state.sections[sec]) setPanelOpen(sec, true);
      });
    });

    // Make sure avatar headband overlay reflects switch
    function syncHeadbandUI(){
      headbandOverlayPreview.classList.toggle("hidden", !state.avatar.headband);
      miniHeadband.classList.toggle("hidden", !state.avatar.headband);
      cardHeadband.classList.toggle("hidden", !state.avatar.headband);
    }
    syncHeadbandUI();
  </script>
</body>
</html>
