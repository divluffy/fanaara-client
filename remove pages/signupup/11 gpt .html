<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mecha HUD • Multi-Step Registration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      /* 2 primary + 1 accent */
      --p1: 0 229 255;     /* cyan */
      --p2: 173 88 255;    /* violet */
      --acc: 255 167 38;   /* amber */

      --bg0: 5 8 12;
      --glass: 12 16 22;

      --mx: 0px; /* parallax */
      --my: 0px;
      --scan: 0px;
    }

    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(var(--p2)/.14), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(var(--p1)/.12), transparent 55%),
        radial-gradient(900px 900px at 50% 110%, rgba(var(--acc)/.08), transparent 55%),
        rgb(var(--bg0));
      color: rgba(255,255,255,.92);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }

    /* ===== Background layers (AR grid + scanline + subtle noise) ===== */
    .bg-wrap{position:fixed; inset:0; z-index:-10; overflow:hidden;}
    .bg-layer{position:absolute; inset:-20%; transform:translate3d(calc(var(--mx) * .20), calc(var(--my) * .20), 0);}

    .gridA, .gridB{
      position:absolute; inset:0;
      background-size: 48px 48px, 48px 48px, 220px 220px;
      background-image:
        linear-gradient(to right, rgba(var(--p1)/.10) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(var(--p1)/.08) 1px, transparent 1px),
        radial-gradient(circle at 30% 20%, rgba(var(--p2)/.16), transparent 55%);
      opacity:.55;
      filter: drop-shadow(0 0 10px rgba(var(--p1)/.06));
      transform: translate3d(calc(var(--mx) * .25), calc(var(--my) * .15), 0) rotate(-0.8deg);
      animation: gridDrift 14s linear infinite;
      mask-image: radial-gradient(circle at 50% 45%, rgba(0,0,0,1) 0%, rgba(0,0,0,.75) 55%, transparent 85%);
    }
    .gridB{
      background-size: 86px 86px, 86px 86px, 360px 360px;
      background-image:
        linear-gradient(to right, rgba(var(--p2)/.09) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(var(--p2)/.06) 1px, transparent 1px),
        radial-gradient(circle at 75% 65%, rgba(var(--p1)/.10), transparent 55%);
      opacity:.45;
      transform: translate3d(calc(var(--mx) * .10), calc(var(--my) * .28), 0) rotate(1.2deg);
      animation: gridDrift2 18s linear infinite;
    }
    @keyframes gridDrift{
      0%{background-position: 0 0, 0 0, 0 0;}
      100%{background-position: 220px 140px, 180px 220px, 0 0;}
    }
    @keyframes gridDrift2{
      0%{background-position: 0 0, 0 0, 0 0;}
      100%{background-position: -260px 220px, -240px 300px, 0 0;}
    }

    .scanlines{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.02) 1px,
          transparent 3px,
          transparent 7px
        );
      opacity:.22;
      mix-blend-mode: overlay;
      transform: translateY(var(--scan));
      animation: scanMove 6.5s linear infinite;
      pointer-events:none;
    }
    @keyframes scanMove{
      0%{transform:translateY(-18px)}
      100%{transform:translateY(18px)}
    }

    .noise{
      position:absolute; inset:-10%;
      opacity:.16;
      pointer-events:none;
      mix-blend-mode: overlay;
      filter:url(#hudNoise);
    }

    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 45%, transparent 0%, rgba(0,0,0,.35) 58%, rgba(0,0,0,.65) 92%);
      pointer-events:none;
    }

    /* ===== Glass / HUD frame ===== */
    .glass{
      background: linear-gradient(180deg, rgba(var(--glass)/.58), rgba(10, 12, 18, .38));
      border: 1px solid rgba(255,255,255,.09);
      box-shadow:
        0 18px 60px rgba(0,0,0,.50),
        inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(16px) saturate(155%);
      -webkit-backdrop-filter: blur(16px) saturate(155%);
    }
    .hud-outline{
      position:relative;
    }
    .hud-outline:before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:inherit;
      background:
        linear-gradient(90deg, rgba(var(--p1)/.22), transparent 30%, transparent 70%, rgba(var(--p2)/.20)),
        linear-gradient(180deg, rgba(255,255,255,.08), transparent 35%, rgba(255,255,255,.06));
      opacity:.55;
      mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000);
      -webkit-mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000);
      mask-composite: exclude;
      -webkit-mask-composite: xor;
      padding:1px;
      pointer-events:none;
    }

    .brackets{
      position:absolute; inset:10px;
      pointer-events:none;
      opacity:.85;
    }
    .brackets i{
      position:absolute; width:18px; height:18px;
      border-color: rgba(var(--p1)/.55);
      filter: drop-shadow(0 0 10px rgba(var(--p1)/.14));
    }
    .brackets i:nth-child(1){top:0; right:0; border-top:1px solid; border-right:1px solid;}
    .brackets i:nth-child(2){top:0; left:0; border-top:1px solid; border-left:1px solid; border-color: rgba(var(--p2)/.55);}
    .brackets i:nth-child(3){bottom:0; right:0; border-bottom:1px solid; border-right:1px solid; border-color: rgba(var(--p2)/.45);}
    .brackets i:nth-child(4){bottom:0; left:0; border-bottom:1px solid; border-left:1px solid; border-color: rgba(var(--p1)/.45);}

    .hud-label{
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
    }
    .hud-micro{
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,.62);
    }

    /* Inputs */
    .hud-input{
      width:100%;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      outline: none;
      border-radius: 12px;
      padding: 12px 12px;
      color: rgba(255,255,255,.92);
      transition: .18s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .hud-input:focus{
      border-color: rgba(var(--p1)/.45);
      box-shadow: 0 0 0 3px rgba(var(--p1)/.14), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .hud-input.invalid{
      border-color: rgba(var(--acc)/.70);
      box-shadow: 0 0 0 3px rgba(var(--acc)/.14);
      animation: fieldWarn .36s ease;
    }
    @keyframes fieldWarn{
      0%{transform:translateX(0)}
      25%{transform:translateX(6px)}
      55%{transform:translateX(-5px)}
      100%{transform:translateX(0)}
    }

    /* Minimal glitch transition */
    .glitch-layer{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      mix-blend-mode: screen;
      background:
        linear-gradient(90deg, transparent 0 12%, rgba(var(--p1)/.18) 12% 13%, transparent 13% 22%, rgba(var(--p2)/.16) 22% 23%, transparent 23% 60%, rgba(var(--acc)/.12) 60% 61%, transparent 61% 100%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 2px, transparent 2px 9px);
      transform: translate3d(0,0,0);
      filter: blur(.2px);
    }
    .is-transitioning .glitch-layer{
      animation: glitchFlash .22s steps(2) both;
    }
    @keyframes glitchFlash{
      0%{opacity:0; transform:translateX(0)}
      20%{opacity:.9; transform:translateX(-6px)}
      60%{opacity:.6; transform:translateX(7px)}
      100%{opacity:0; transform:translateX(0)}
    }

    .snap-slide{
      transition: transform .42s cubic-bezier(.2,.9,.1,1), opacity .22s ease;
      will-change: transform, opacity;
    }
    .snap-out{opacity:.0; transform: translateX(-12px) scale(.995);}
    .snap-in{opacity:1; transform: translateX(0) scale(1);}

    .shake{
      animation: panelShake .28s ease both;
    }
    @keyframes panelShake{
      0%{transform:translateX(0)}
      20%{transform:translateX(-10px)}
      45%{transform:translateX(8px)}
      70%{transform:translateX(-6px)}
      100%{transform:translateX(0)}
    }

    /* Timeline HUD */
    .timeline{
      position:relative;
    }
    .timeline:before{
      content:"";
      position:absolute;
      top:16px; bottom:16px;
      right: 18px;
      width:1px;
      background: linear-gradient(180deg, rgba(var(--p1)/.0), rgba(var(--p1)/.22), rgba(var(--p2)/.22), rgba(var(--p2)/.0));
      opacity:.9;
    }
    .tl-item{
      position:relative;
      padding-right: 54px;
    }
    .tl-node{
      position:absolute;
      right: 6px;
      top: 10px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .tl-num{
      font-size: 11px;
      letter-spacing:.14em;
      color: rgba(255,255,255,.82);
      transform: translateY(.5px);
    }
    .tl-title{
      font-size: 13px;
      letter-spacing:.06em;
      color: rgba(255,255,255,.86);
    }
    .tl-sub{
      font-size: 11px;
      color: rgba(255,255,255,.58);
    }

    /* tiny circular progress ring */
    .ring{
      position:absolute;
      inset:-5px;
      pointer-events:none;
      opacity:.95;
    }
    .ring circle{
      fill:none;
      stroke-width: 2.4;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    .ring .track{ stroke: rgba(255,255,255,.10); }
    .ring .prog{ stroke: rgba(var(--p1)/.75); filter: drop-shadow(0 0 10px rgba(var(--p1)/.25)); }
    .tl-item[data-state="done"] .ring .prog{ stroke: rgba(var(--p2)/.78); filter: drop-shadow(0 0 10px rgba(var(--p2)/.25)); }
    .tl-item[data-state="current"] .ring .prog{
      animation: ringPulse 1.2s ease-in-out infinite;
    }
    @keyframes ringPulse{
      0%,100%{opacity:.65}
      50%{opacity:1}
    }

    /* HUD spinner */
    .hud-spinner{
      width: 34px; height:34px;
      border-radius:999px;
      border: 2px solid rgba(255,255,255,.12);
      border-top-color: rgba(var(--p1)/.75);
      border-right-color: rgba(var(--p2)/.55);
      animation: spin .7s linear infinite;
      filter: drop-shadow(0 0 10px rgba(var(--p1)/.20));
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== Background HUD Modules (per step) ===== */
    .modules{position:absolute; inset:0; pointer-events:none;}
    .module{
      position:absolute;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.12));
      backdrop-filter: blur(8px) saturate(140%);
      box-shadow: 0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      opacity: 0;
      transform: translate3d(0, 10px, 0) scale(.99);
      transition: opacity .35s ease, transform .45s cubic-bezier(.2,.9,.1,1);
      overflow:hidden;
    }
    .module.on{
      opacity: .92;
      transform: translate3d(0, 0, 0) scale(1);
    }
    .module .cap{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px 6px 12px;
    }
    .module .body{padding: 8px 12px 12px 12px;}
    .module .line{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(var(--p1)/.35), rgba(var(--p2)/.22), transparent);
      opacity:.75;
    }

    /* Step1 Login module (right, animated labels) */
    .m-login{ top: 16px; left: 16px; width: 280px; }
    @media(min-width:1024px){ .m-login{ top: 22px; left: 22px; width: 320px; } }
    .label-ticker{
      display:flex;
      gap: 12px;
      white-space:nowrap;
      opacity:.78;
      animation: ticker 6.5s linear infinite;
    }
    @keyframes ticker{
      0%{transform:translateX(0)}
      100%{transform:translateX(45%)}
    }

    /* Step2 Bio module (fake graph) */
    .m-bio{ bottom: 18px; left: 18px; width: 320px; }
    @media(min-width:1024px){ .m-bio{ bottom: 26px; left: 26px; width: 360px; } }
    .graph path{
      stroke: rgba(var(--p1)/.65);
      stroke-width:2.2;
      fill:none;
      filter: drop-shadow(0 0 10px rgba(var(--p1)/.15));
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 6 10;
      animation: dash 2.2s linear infinite;
    }
    .graph .grid{
      stroke: rgba(255,255,255,.08);
      stroke-width:1;
      stroke-dasharray: 2 7;
    }
    @keyframes dash{
      to{stroke-dashoffset:-32}
    }

    /* Step3 Avatar module (radar ring + target lock) */
    .m-avatar{ top: 50%; left: 50%; width: 290px; height: 290px; transform: translate(-50%, -50%) scale(.99); }
    .m-avatar.on{ transform: translate(-50%, -50%) scale(1); }
    .radar{
      position:absolute; inset:0;
      opacity:.9;
    }
    .radar:before{
      content:"";
      position:absolute; inset:16px;
      border-radius:999px;
      border: 1px solid rgba(var(--p1)/.18);
      box-shadow: inset 0 0 0 1px rgba(var(--p2)/.08);
    }
    .sweep{
      position:absolute; inset:16px;
      border-radius:999px;
      background: conic-gradient(from 0deg, rgba(var(--p1)/.00), rgba(var(--p1)/.20), rgba(var(--p1)/.00) 42deg);
      mask: radial-gradient(circle, transparent 0 60%, #000 62% 100%);
      animation: sweep 2.8s linear infinite;
      mix-blend-mode: screen;
      opacity:.75;
    }
    @keyframes sweep{to{transform:rotate(360deg)}}
    .target{
      position:absolute; inset:0;
      display:grid; place-items:center;
      opacity:.95;
    }
    .lock{
      width: 92px; height:92px;
      border-radius: 18px;
      border: 1px solid rgba(var(--acc)/.38);
      box-shadow: 0 0 0 3px rgba(var(--acc)/.10), 0 0 24px rgba(var(--acc)/.14);
      transform: rotate(45deg);
      animation: lockPulse 1.6s ease-in-out infinite;
    }
    @keyframes lockPulse{
      0%,100%{transform:rotate(45deg) scale(.98); opacity:.75}
      50%{transform:rotate(45deg) scale(1.02); opacity:1}
    }

    /* Step4 Follow module (feed scrolling illusion) */
    .m-follow{ top: 18px; right: 18px; width: 300px; height: 210px; }
    @media(min-width:1024px){ .m-follow{ top: 26px; right: 26px; width: 360px; height: 240px; } }
    .feed{
      position:relative;
      height: 150px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .feed .rows{
      position:absolute; inset:0;
      display:grid;
      gap: 10px;
      padding: 12px;
      animation: feedScroll 6s linear infinite;
    }
    @keyframes feedScroll{
      0%{transform:translateY(0)}
      100%{transform:translateY(-50%)}
    }
    .feed .row{
      height: 16px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(var(--p2)/.12), rgba(var(--p1)/.10), rgba(255,255,255,.06));
      opacity:.9;
    }
    .feed:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.65), transparent 28%, transparent 72%, rgba(0,0,0,.70));
      pointer-events:none;
    }

    /* Step5 Interest module (tag cloud orbit) */
    .m-interest{ bottom: 18px; right: 18px; width: 320px; height: 220px; }
    @media(min-width:1024px){ .m-interest{ bottom: 26px; right: 26px; width: 380px; height: 240px; } }
    .orbit{
      position:relative;
      height: 165px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    .orb{
      position:absolute;
      top:50%; left:50%;
      width: 230px; height:230px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      border: 1px solid rgba(var(--p1)/.14);
      box-shadow: inset 0 0 0 1px rgba(var(--p2)/.08);
      opacity:.9;
    }
    .tag{
      position:absolute;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing:.16em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.78);
      box-shadow: 0 10px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      transform: translate(-50%, -50%);
      opacity:.92;
      white-space:nowrap;
    }
    .orbit .tag{
      animation: orbitSpin 8s linear infinite;
      transform-origin: 0 0;
    }
    .orbit .tag:nth-child(2){animation-duration:10s}
    .orbit .tag:nth-child(3){animation-duration:9s}
    .orbit .tag:nth-child(4){animation-duration:11s}
    .orbit .tag:nth-child(5){animation-duration:12s}
    @keyframes orbitSpin{
      from{filter: drop-shadow(0 0 0 rgba(0,0,0,0));}
      to{transform: translate(-50%,-50%) rotate(360deg);}
    }

    /* Chips */
    .chip{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.84);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      transition: .16s ease;
      user-select:none;
    }
    .chip:hover{ border-color: rgba(var(--p1)/.35); }
    .chip.on{
      border-color: rgba(var(--p1)/.55);
      background: linear-gradient(90deg, rgba(var(--p1)/.18), rgba(var(--p2)/.12));
      box-shadow: 0 0 0 3px rgba(var(--p1)/.10), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* Button */
    .hud-btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      transition: .16s ease;
    }
    .hud-btn:hover{
      border-color: rgba(var(--p1)/.45);
      box-shadow: 0 0 0 3px rgba(var(--p1)/.10), 0 12px 34px rgba(0,0,0,.42), inset 0 1px 0 rgba(255,255,255,.06);
      transform: translateY(-1px);
    }
    .hud-btn:active{ transform: translateY(0); }

    /* Bottom action bar */
    .actionbar{
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.42));
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
    }

    /* Success stamp */
    .stamp{
      position:relative;
      display:inline-grid;
      place-items:center;
      padding: 22px 26px;
      border-radius: 18px;
      border: 1px solid rgba(var(--acc)/.45);
      background:
        linear-gradient(180deg, rgba(var(--acc)/.12), rgba(0,0,0,.20));
      box-shadow:
        0 20px 70px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.06),
        0 0 0 4px rgba(var(--acc)/.10);
    }
    .stamp:before{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 24px;
      background:
        repeating-linear-gradient(90deg, rgba(var(--acc)/.00) 0 14px, rgba(var(--acc)/.10) 14px 15px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.00) 0 11px, rgba(255,255,255,.05) 11px 12px);
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: screen;
      filter: blur(.3px);
      mask: radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 0 55%, transparent 75%);
    }
  </style>
</head>

<body>
  <!-- SVG filter for subtle noise (no external assets) -->
  <svg width="0" height="0" style="position:absolute">
    <filter id="hudNoise">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" />
      <feColorMatrix type="matrix"
        values="1 0 0 0 0
                0 1 0 0 0
                0 0 1 0 0
                0 0 0 .18 0"/>
    </filter>
  </svg>

  <!-- Background -->
  <div class="bg-wrap" aria-hidden="true">
    <div class="bg-layer">
      <div class="gridA"></div>
      <div class="gridB"></div>
    </div>
    <div class="scanlines"></div>
    <div class="noise"></div>
    <div class="vignette"></div>
  </div>

  <div class="min-h-screen px-4 pt-6 pb-24 sm:pb-8 flex items-center justify-center">
    <div class="w-full max-w-5xl relative">
      <!-- Floating HUD modules -->
      <div class="modules" aria-hidden="true">
        <!-- Step 1 -->
        <div class="module m-login" data-module="1">
          <div class="cap">
            <div class="hud-micro">LOGIN MODULE</div>
            <div class="hud-micro" style="color:rgba(var(--p1)/.9)">SYNC</div>
          </div>
          <div class="line"></div>
          <div class="body space-y-3">
            <div class="hud-label">LINK STATUS</div>
            <div class="label-ticker">
              <span class="hud-micro">AUTH •</span>
              <span class="hud-micro" style="color:rgba(var(--p2)/.85)">HANDSHAKE •</span>
              <span class="hud-micro">ENCRYPT •</span>
              <span class="hud-micro" style="color:rgba(var(--acc)/.85)">TOKENIZE •</span>
              <span class="hud-micro">VERIFY •</span>
              <span class="hud-micro" style="color:rgba(var(--p2)/.85)">CACHE •</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="h-1.5 flex-1 rounded-full overflow-hidden bg-white/10">
                <div class="h-full w-2/3 rounded-full"
                     style="background:linear-gradient(90deg, rgba(var(--p1)/.75), rgba(var(--p2)/.55));"></div>
              </div>
              <div class="hud-micro">66%</div>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="module m-bio" data-module="2">
          <div class="cap">
            <div class="hud-micro">BIO MODULE</div>
            <div class="hud-micro" style="color:rgba(var(--p2)/.9)">SIGNAL</div>
          </div>
          <div class="line"></div>
          <div class="body">
            <div class="flex items-center justify-between">
              <div class="hud-label">PROFILE VECTOR</div>
              <div class="hud-micro">LIVE</div>
            </div>
            <svg class="graph mt-2" viewBox="0 0 360 110" width="100%" height="110" aria-hidden="true">
              <!-- grid -->
              <path class="grid" d="M10 10 H350 M10 40 H350 M10 70 H350 M10 100 H350" />
              <path class="grid" d="M10 10 V100 M70 10 V100 M130 10 V100 M190 10 V100 M250 10 V100 M310 10 V100 M350 10 V100" />
              <!-- signal -->
              <path d="M10 84 C40 80, 55 52, 80 54 C105 56, 114 88, 140 82 C168 76, 170 34, 205 38 C240 42, 236 86, 270 78 C305 70, 310 48, 350 52" />
            </svg>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="module m-avatar" data-module="3">
          <div class="cap">
            <div class="hud-micro">AVATAR LOCK</div>
            <div class="hud-micro" style="color:rgba(var(--acc)/.9)">TARGET</div>
          </div>
          <div class="line"></div>
          <div class="body relative" style="height:220px">
            <div class="radar">
              <div class="sweep"></div>
              <div class="target">
                <div class="lock"></div>
              </div>
              <svg viewBox="0 0 240 240" class="absolute inset-0" aria-hidden="true">
                <circle cx="120" cy="120" r="92" stroke="rgba(255,255,255,.10)" stroke-width="1.2" fill="none" />
                <circle cx="120" cy="120" r="62" stroke="rgba(var(--p1)/.16)" stroke-width="1.2" fill="none" />
                <circle cx="120" cy="120" r="32" stroke="rgba(var(--p2)/.14)" stroke-width="1.2" fill="none" />
                <line x1="120" y1="22" x2="120" y2="218" stroke="rgba(255,255,255,.08)" stroke-width="1" />
                <line x1="22" y1="120" x2="218" y2="120" stroke="rgba(255,255,255,.08)" stroke-width="1" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="module m-follow" data-module="4">
          <div class="cap">
            <div class="hud-micro">FOLLOW MODULE</div>
            <div class="hud-micro" style="color:rgba(var(--p1)/.9)">FEED</div>
          </div>
          <div class="line"></div>
          <div class="body space-y-3">
            <div class="hud-label">STREAM PREVIEW</div>
            <div class="feed">
              <div class="rows">
                <!-- duplicated pattern for looping illusion -->
                <div class="row w-10/12"></div><div class="row w-7/12"></div><div class="row w-11/12"></div><div class="row w-8/12"></div><div class="row w-9/12"></div><div class="row w-6/12"></div>
                <div class="row w-10/12"></div><div class="row w-7/12"></div><div class="row w-11/12"></div><div class="row w-8/12"></div><div class="row w-9/12"></div><div class="row w-6/12"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="module m-interest" data-module="5">
          <div class="cap">
            <div class="hud-micro">INTEREST ORBIT</div>
            <div class="hud-micro" style="color:rgba(var(--p2)/.9)">PRIORITY</div>
          </div>
          <div class="line"></div>
          <div class="body space-y-2">
            <div class="hud-label">TAG CLOUD</div>
            <div class="orbit">
              <div class="orb"></div>
              <div class="tag" style="top:52%;left:50%">MECHA</div>
              <div class="tag" style="top:52%;left:50%">MANGA</div>
              <div class="tag" style="top:52%;left:50%">ART</div>
              <div class="tag" style="top:52%;left:50%">LORE</div>
              <div class="tag" style="top:52%;left:50%">COSPLAY</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main panels -->
      <div class="relative grid lg:grid-cols-12 gap-4 items-stretch">
        <!-- Timeline -->
        <aside class="glass hud-outline rounded-2xl p-4 lg:col-span-4 relative overflow-hidden">
          <div class="brackets"><i></i><i></i><i></i><i></i></div>

          <div class="flex items-center justify-between">
            <div>
              <div class="hud-label">REGISTRATION SEQUENCE</div>
              <div class="mt-1 text-lg font-semibold tracking-wide"
                   style="text-shadow:0 0 18px rgba(var(--p1)/.16)">
                إنشاء مستخدم جديد
              </div>
            </div>
            <div class="hidden sm:flex items-center gap-2">
              <span class="hud-micro">NODE</span>
              <span id="nodeId" class="hud-micro" style="color:rgba(var(--p1)/.9)">A-17</span>
            </div>
          </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="hud-micro">SYSTEM</div>
            <div class="flex items-center gap-2">
              <div class="h-1.5 w-24 rounded-full overflow-hidden bg-white/10">
                <div id="sysBar" class="h-full rounded-full" style="width:32%;background:linear-gradient(90deg, rgba(var(--p2)/.55), rgba(var(--p1)/.65));"></div>
              </div>
              <div id="sysPct" class="hud-micro">32%</div>
            </div>
          </div>

          <div class="mt-4 timeline space-y-3" id="timeline">
            <!-- JS populates -->
          </div>

          <div class="mt-4 p-3 rounded-xl border border-white/10 bg-black/15">
            <div class="flex items-center justify-between">
              <div class="hud-label">COMPLETENESS</div>
              <div class="hud-micro" id="completePct">0%</div>
            </div>
            <div class="mt-2 h-2 rounded-full overflow-hidden bg-white/10">
              <div id="completeBar" class="h-full rounded-full" style="width:0%;background:linear-gradient(90deg, rgba(var(--p1)/.70), rgba(var(--p2)/.55), rgba(var(--acc)/.45));"></div>
            </div>
            <div class="mt-2 text-xs text-white/60 leading-relaxed">
              اكمل الحقول الأساسية + اختر Avatar + اتبع وحدة واحدة + اختر اهتمامات.
            </div>
          </div>
        </aside>

        <!-- Step content -->
        <main id="panel" class="glass hud-outline rounded-2xl p-4 lg:p-6 lg:col-span-8 relative overflow-hidden">
          <div class="brackets"><i></i><i></i><i></i><i></i></div>
          <div class="glitch-layer" aria-hidden="true"></div>

          <!-- Top status strip -->
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-3">
              <div class="w-2 h-2 rounded-full" style="background:rgba(var(--p1)/.9); box-shadow:0 0 18px rgba(var(--p1)/.35)"></div>
              <div class="hud-micro" id="stepTitle">STEP 01 • BASIC</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="hud-micro">SEC</div>
              <div class="hud-micro" style="color:rgba(var(--p2)/.9)">ENABLED</div>
              <span class="opacity-40">•</span>
              <div class="hud-micro">PING</div>
              <div class="hud-micro" id="ping" style="color:rgba(var(--p1)/.9)">18ms</div>
            </div>
          </div>

          <div class="mt-4">
            <!-- Loading overlay -->
            <div id="loadingOverlay" class="hidden absolute inset-0 z-20">
              <div class="absolute inset-0 bg-black/55 backdrop-blur-md"></div>
              <div class="absolute inset-0 grid place-items-center p-6">
                <div class="glass rounded-2xl p-5 w-full max-w-md border border-white/10">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="hud-label">DATA SCAN</div>
                      <div class="mt-1 text-base font-semibold tracking-wide">فحص البيانات…</div>
                    </div>
                    <div class="hud-spinner" aria-hidden="true"></div>
                  </div>
                  <div class="mt-4 h-2 rounded-full overflow-hidden bg-white/10">
                    <div id="scanBar" class="h-full rounded-full w-1/6"
                         style="background:linear-gradient(90deg, rgba(var(--p1)/.75), rgba(var(--p2)/.55));"></div>
                  </div>
                  <div class="mt-2 flex items-center justify-between">
                    <div class="hud-micro" id="scanMsg">SYNC • VALIDATE • HASH</div>
                    <div class="hud-micro" id="scanPct">14%</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Steps -->
            <section class="snap-slide snap-in" data-step="1">
              <div class="grid sm:grid-cols-2 gap-4">
                <div>
                  <div class="hud-label mb-2">Email</div>
                  <input id="email" class="hud-input" type="email" placeholder="pilot@domain.com" autocomplete="email" />
                  <div class="mt-2 text-xs text-white/55 leading-relaxed">
                    تلميح: سنستخدمه لتأمين الحساب + تفعيل الوصول.
                  </div>
                </div>
                <div>
                  <div class="hud-label mb-2">Password</div>
                  <input id="password" class="hud-input" type="password" placeholder="••••••••" autocomplete="new-password" />
                  <div class="mt-2 flex items-center justify-between">
                    <div class="hud-micro">STRENGTH</div>
                    <div class="hud-micro" id="pwScore">0</div>
                  </div>
                  <div class="mt-2 h-2 rounded-full overflow-hidden bg-white/10">
                    <div id="pwBar" class="h-full rounded-full" style="width:0%;background:linear-gradient(90deg, rgba(var(--acc)/.55), rgba(var(--p1)/.65), rgba(var(--p2)/.55));"></div>
                  </div>
                  <div class="mt-2 text-xs text-white/55" id="pwHint">
                    استخدم 10+ أحرف، رقم، ورمز واحد على الأقل.
                  </div>
                </div>
                <div class="sm:col-span-2">
                  <div class="hud-label mb-2">Confirm Password</div>
                  <input id="confirm" class="hud-input" type="password" placeholder="••••••••" autocomplete="new-password" />
                  <div class="mt-2 text-xs text-white/55" id="matchHint">—</div>
                </div>
              </div>
            </section>

            <section class="hidden snap-slide" data-step="2">
              <div class="grid sm:grid-cols-2 gap-4">
                <div>
                  <div class="hud-label mb-2">Display Name</div>
                  <input id="displayName" class="hud-input" type="text" placeholder="اسمك في المنصة" autocomplete="nickname" />
                  <div class="mt-2 text-xs text-white/55">تظهر في التعليقات والملف الشخصي.</div>
                </div>

                <div>
                  <div class="hud-label mb-2">Username</div>
                  <div class="relative">
                    <input id="username" class="hud-input pl-24" type="text" placeholder="luffy_mecha" autocomplete="off" />
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 hud-micro" id="userStatus" style="color:rgba(255,255,255,.55)">IDLE</div>
                  </div>
                  <div class="mt-2 text-xs text-white/55" id="userHint">
                    بدون مسافات. (محاكاة توفر الاسم تعمل تلقائيًا)
                  </div>
                </div>

                <div class="sm:col-span-2">
                  <div class="flex items-center justify-between mb-2">
                    <div class="hud-label">Bio</div>
                    <div class="hud-micro"><span id="bioCount">0</span>/160</div>
                  </div>
                  <textarea id="bio" class="hud-input" rows="4" maxlength="160" placeholder="سطرين عن نفسك… (مفضل)" ></textarea>
                  <div class="mt-2 text-xs text-white/55">
                    اجعلها قصيرة: اهتماماتك + نوع الأنمي/الكومكس المفضل.
                  </div>
                </div>
              </div>
            </section>

            <section class="hidden snap-slide" data-step="3">
              <div class="grid lg:grid-cols-2 gap-4 items-start">
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <div class="hud-label">Avatar Upload</div>
                    <button id="randAvatar" class="hud-btn px-3 py-2 rounded-xl text-xs">
                      Randomize
                    </button>
                  </div>

                  <div class="p-3 rounded-2xl border border-white/10 bg-black/15">
                    <div class="hud-micro mb-2">UPLOAD (optional)</div>
                    <input id="avatarUpload" type="file" accept="image/*" class="block w-full text-xs text-white/70
                      file:mr-3 file:rounded-xl file:border-0 file:px-4 file:py-2
                      file:bg-white/10 file:text-white/80 hover:file:bg-white/15" />
                    <div class="mt-3 flex items-center gap-3">
                      <div class="hud-micro">USE UPLOAD</div>
                      <button id="useUploadToggle" class="hud-btn px-3 py-2 rounded-xl text-xs">OFF</button>
                    </div>
                    <div class="mt-2 text-xs text-white/55">بدون صور خارجية — فقط رفع محلي منك.</div>
                  </div>

                  <div class="p-3 rounded-2xl border border-white/10 bg-black/15">
                    <div class="hud-micro mb-2">PREVIEW</div>
                    <div class="flex items-center gap-3">
                      <div id="avatarPreview" class="w-20 h-20 rounded-2xl border border-white/10 bg-black/20 grid place-items-center overflow-hidden">
                        <span class="hud-micro" style="opacity:.7">NO AV</span>
                      </div>
                      <div>
                        <div class="hud-label">LOCK STATUS</div>
                        <div class="mt-1 text-xs text-white/60" id="avatarLock">UNLOCKED</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <div class="hud-label mb-2">Select SVG Avatar (abstract • mecha-pilot vibe)</div>
                  <div id="avatarGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                  <div class="mt-3 text-xs text-white/55">
                    اختر واحدًا: خطوط هندسية + visor/helmet silhouette — بدون شخصيات معروفة.
                  </div>
                </div>
              </div>
            </section>

            <section class="hidden snap-slide" data-step="4">
              <div class="flex flex-wrap items-center gap-3 justify-between">
                <div>
                  <div class="hud-label">Follow Units</div>
                  <div class="text-xs text-white/55 mt-1">اختر وحدات/مجتمعات لتغذية البداية.</div>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                  <input id="followSearch" class="hud-input w-full sm:w-64" placeholder="بحث سريع…" />
                  <select id="followFilter" class="hud-input w-44">
                    <option value="all">كل الفئات</option>
                    <option value="mecha">Mecha</option>
                    <option value="manga">Manga</option>
                    <option value="art">Art</option>
                    <option value="lore">Lore</option>
                  </select>
                </div>
              </div>

              <div class="mt-4 grid sm:grid-cols-2 gap-3" id="followList"></div>

              <div class="mt-4 p-3 rounded-xl border border-white/10 bg-black/15 flex items-center justify-between">
                <div class="hud-micro">FOLLOWING</div>
                <div class="flex items-center gap-3">
                  <div class="hud-micro"><span id="followCount">0</span> UNITS</div>
                  <button id="followAll" class="hud-btn px-3 py-2 rounded-xl text-xs">Follow Top Picks</button>
                </div>
              </div>
            </section>

            <section class="hidden snap-slide" data-step="5">
              <div class="flex flex-wrap items-start gap-4 justify-between">
                <div>
                  <div class="hud-label">Interests</div>
                  <div class="text-xs text-white/55 mt-1">اختر 3+ ثم رتّب الأولوية (↑↓).</div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="hud-micro">SELECTED</div>
                  <div class="hud-micro" style="color:rgba(var(--p1)/.9)" id="interestCount">0</div>
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2" id="chipWrap"></div>

              <div class="mt-4 grid lg:grid-cols-2 gap-4">
                <div class="p-3 rounded-2xl border border-white/10 bg-black/15">
                  <div class="flex items-center justify-between">
                    <div class="hud-label">Priority Ranking</div>
                    <div class="hud-micro" id="rankHint">—</div>
                  </div>
                  <div class="mt-3 space-y-2" id="rankList"></div>
                </div>

                <div class="p-3 rounded-2xl border border-white/10 bg-black/15">
                  <div class="hud-label">Final Integrity</div>
                  <div class="mt-2 text-xs text-white/55 leading-relaxed">
                    سنقوم بتأمين بياناتك وإطلاق ملفك. تأكد أن كل شيء صحيح قبل الإنهاء.
                  </div>
                  <div class="mt-3">
                    <div class="flex items-center justify-between">
                      <div class="hud-micro">COMPLETENESS</div>
                      <div class="hud-micro" id="finalComplete">0%</div>
                    </div>
                    <div class="mt-2 h-2 rounded-full overflow-hidden bg-white/10">
                      <div id="finalBar" class="h-full rounded-full" style="width:0%;background:linear-gradient(90deg, rgba(var(--p1)/.70), rgba(var(--p2)/.55), rgba(var(--acc)/.45));"></div>
                    </div>
                    <div class="mt-3 text-xs text-white/55" id="finalTips">—</div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <!-- Desktop actions (hidden on mobile) -->
          <div class="hidden sm:flex mt-6 items-center justify-between">
            <button id="prevBtnDesk" class="hud-btn px-4 py-3 rounded-2xl text-sm">
              ◀ السابق
            </button>

            <div class="flex items-center gap-3">
              <div class="hud-micro">STEP</div>
              <div class="hud-micro" id="stepCounter">01/05</div>
            </div>

            <button id="nextBtnDesk" class="hud-btn px-5 py-3 rounded-2xl text-sm"
                    style="border-color:rgba(var(--p1)/.35)">
              التالي ▶
            </button>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Bottom action bar (mobile) -->
  <div class="fixed bottom-0 left-0 right-0 z-30 actionbar sm:hidden">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <button id="prevBtn" class="hud-btn px-4 py-3 rounded-2xl text-sm w-28">السابق</button>

      <div class="flex-1">
        <div class="flex items-center justify-between">
          <div class="hud-micro" id="mobileStepTitle">STEP 01</div>
          <div class="hud-micro" id="mobilePct">0%</div>
        </div>
        <div class="mt-2 h-2 rounded-full overflow-hidden bg-white/10">
          <div id="mobileBar" class="h-full rounded-full" style="width:0%;background:linear-gradient(90deg, rgba(var(--p1)/.70), rgba(var(--p2)/.55));"></div>
        </div>
      </div>

      <button id="nextBtn" class="hud-btn px-4 py-3 rounded-2xl text-sm w-28"
              style="border-color:rgba(var(--p1)/.35)">التالي</button>
    </div>
  </div>

  <!-- Success Overlay -->
  <div id="success" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-xl"></div>
    <div class="absolute inset-0 grid place-items-center p-6">
      <div class="glass hud-outline rounded-3xl p-6 sm:p-8 w-full max-w-2xl relative overflow-hidden">
        <div class="brackets"><i></i><i></i><i></i><i></i></div>
        <div class="glitch-layer" aria-hidden="true"></div>

        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="hud-label">AUTH RESULT</div>
            <div class="mt-1 text-2xl sm:text-3xl font-semibold tracking-wider"
                 style="text-shadow:0 0 24px rgba(var(--acc)/.20)">
              ACCESS GRANTED
            </div>
            <div class="mt-2 text-sm text-white/60 leading-relaxed">
              تم إنشاء الحساب وتفعيل بصمة الوصول. جاهز لبدء المهمة.
            </div>
          </div>
          <div class="stamp">
            <svg viewBox="0 0 160 160" width="110" height="110" aria-hidden="true">
              <defs>
                <linearGradient id="stampG" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="rgba(255,167,38,.85)" />
                  <stop offset="1" stop-color="rgba(0,229,255,.55)" />
                </linearGradient>
              </defs>
              <circle cx="80" cy="80" r="62" fill="none" stroke="url(#stampG)" stroke-width="4" />
              <circle cx="80" cy="80" r="48" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="2" stroke-dasharray="6 8" />
              <path d="M46 84 L72 104 L116 58" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
              <text x="80" y="132" text-anchor="middle" fill="rgba(255,255,255,.68)" font-size="10" style="letter-spacing:.18em">CLEARANCE</text>
            </svg>
          </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-end">
          <button id="resetBtn" class="hud-btn px-5 py-3 rounded-2xl text-sm">إنشاء حساب آخر</button>
          <button id="startBtn" class="hud-btn px-6 py-3 rounded-2xl text-sm"
                  style="border-color:rgba(var(--acc)/.55)">
            Start Mission ▶
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Data / Config =========
    const STEP_META = [
      { id: 1, code: "BASIC",    name: "الأساسيات",   sub: "هوية + أمان" },
      { id: 2, code: "GENERAL",  name: "الملف",       sub: "اسم + نبذة" },
      { id: 3, code: "AVATAR",   name: "الصورة",      sub: "Lock + اختيار" },
      { id: 4, code: "FOLLOW",   name: "المتابعة",    sub: "وحدات مقترحة" },
      { id: 5, code: "INTEREST", name: "الاهتمامات",  sub: "اختيار + ترتيب" },
    ];

    const reservedUsernames = new Set(["admin","root","system","pilot","mecha","luffy","moderator","support","null","undefined"]);
    const state = {
      step: 1,
      maxStepReached: 1,
      usernameStatus: "idle", // idle | checking | ok | taken
      avatar: { selectedId: null, useUpload: false, uploadUrl: null },
      follows: new Set(),
      interests: [],
    };

    // ========= DOM =========
    const elTimeline = document.getElementById("timeline");
    const elPanel = document.getElementById("panel");
    const elSteps = Array.from(elPanel.querySelectorAll("[data-step]"));
    const elModules = Array.from(document.querySelectorAll(".module"));
    const elStepTitle = document.getElementById("stepTitle");
    const elStepCounter = document.getElementById("stepCounter");
    const elMobileStepTitle = document.getElementById("mobileStepTitle");
    const elMobileBar = document.getElementById("mobileBar");
    const elMobilePct = document.getElementById("mobilePct");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const prevBtnDesk = document.getElementById("prevBtnDesk");
    const nextBtnDesk = document.getElementById("nextBtnDesk");

    const loadingOverlay = document.getElementById("loadingOverlay");
    const scanBar = document.getElementById("scanBar");
    const scanPct = document.getElementById("scanPct");
    const scanMsg = document.getElementById("scanMsg");

    const sysBar = document.getElementById("sysBar");
    const sysPct = document.getElementById("sysPct");
    const nodeId = document.getElementById("nodeId");
    const ping = document.getElementById("ping");

    const completeBar = document.getElementById("completeBar");
    const completePct = document.getElementById("completePct");
    const finalBar = document.getElementById("finalBar");
    const finalComplete = document.getElementById("finalComplete");
    const finalTips = document.getElementById("finalTips");

    // Step 1
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const confirm = document.getElementById("confirm");
    const pwBar = document.getElementById("pwBar");
    const pwScore = document.getElementById("pwScore");
    const pwHint = document.getElementById("pwHint");
    const matchHint = document.getElementById("matchHint");

    // Step 2
    const displayName = document.getElementById("displayName");
    const username = document.getElementById("username");
    const userStatus = document.getElementById("userStatus");
    const userHint = document.getElementById("userHint");
    const bio = document.getElementById("bio");
    const bioCount = document.getElementById("bioCount");

    // Step 3
    const avatarGrid = document.getElementById("avatarGrid");
    const avatarPreview = document.getElementById("avatarPreview");
    const avatarLock = document.getElementById("avatarLock");
    const avatarUpload = document.getElementById("avatarUpload");
    const useUploadToggle = document.getElementById("useUploadToggle");
    const randAvatar = document.getElementById("randAvatar");

    // Step 4
    const followList = document.getElementById("followList");
    const followSearch = document.getElementById("followSearch");
    const followFilter = document.getElementById("followFilter");
    const followCount = document.getElementById("followCount");
    const followAll = document.getElementById("followAll");

    // Step 5
    const chipWrap = document.getElementById("chipWrap");
    const rankList = document.getElementById("rankList");
    const interestCount = document.getElementById("interestCount");
    const rankHint = document.getElementById("rankHint");

    // Success
    const success = document.getElementById("success");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");

    // ========= Utility =========
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function randNode(){
      const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
      const a = letters[Math.floor(Math.random()*letters.length)];
      const b = String(Math.floor(10 + Math.random()*89));
      return `${a}\u2011${b}`; // A-17 style
    }
    function randPing(){
      const ms = Math.floor(12 + Math.random()*22);
      return `${ms}ms`;
    }

    // ========= AR parallax =========
    (() => {
      let targetX = 0, targetY = 0;
      window.addEventListener("mousemove", (e) => {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        targetX = (e.clientX - cx) / cx * 10;
        targetY = (e.clientY - cy) / cy * 10;
      }, { passive:true });

      function tick(){
        // smooth
        const curX = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--mx")) || 0;
        const curY = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--my")) || 0;
        const nx = curX + (targetX - curX) * 0.06;
        const ny = curY + (targetY - curY) * 0.06;
        document.documentElement.style.setProperty("--mx", nx + "px");
        document.documentElement.style.setProperty("--my", ny + "px");
        requestAnimationFrame(tick);
      }
      tick();
    })();

    // ========= Timeline Render =========
    function ringSvg(progress01){
      const r = 16;
      const c = 2 * Math.PI * r;
      const p = clamp(progress01, 0, 1);
      const dash = (c * p).toFixed(2);
      return `
        <svg class="ring" viewBox="0 0 44 44" aria-hidden="true">
          <circle class="track" cx="22" cy="22" r="${r}" />
          <circle class="prog"  cx="22" cy="22" r="${r}" stroke-dasharray="${dash} ${c.toFixed(2)}" />
        </svg>
      `;
    }

    function renderTimeline(){
      elTimeline.innerHTML = "";
      STEP_META.forEach((s) => {
        const isDone = s.id < state.step && s.id <= state.maxStepReached;
        const isCurrent = s.id === state.step;
        const isLocked = s.id > state.maxStepReached + 0; // future
        const stateStr = isCurrent ? "current" : (isDone ? "done" : "idle");
        const prog = isDone ? 1 : (isCurrent ? 0.62 : 0.12);

        const item = document.createElement("button");
        item.type = "button";
        item.className = "tl-item w-full text-right rounded-2xl p-3 border border-white/10 bg-black/10 hover:bg-black/15 transition disabled:opacity-40 disabled:cursor-not-allowed";
        item.dataset.step = String(s.id);
        item.dataset.state = stateStr;
        item.disabled = isLocked;

        item.innerHTML = `
          <div class="tl-node">
            ${ringSvg(prog)}
            <div class="tl-num">${String(s.id).padStart(2,"0")}</div>
          </div>
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="tl-title">${s.name}</div>
              <div class="tl-sub mt-1">${s.sub}</div>
            </div>
            <div class="hud-micro" style="color:${isCurrent ? "rgba(var(--p1)/.9)" : (isDone ? "rgba(var(--p2)/.85)" : "rgba(255,255,255,.45)")}">
              ${s.code}
            </div>
          </div>
        `;

        item.addEventListener("click", () => gotoStep(s.id, { fromClick:true }));
        elTimeline.appendChild(item);
      });
    }

    // ========= Modules per Step =========
    function updateModules(){
      elModules.forEach(m => {
        const on = Number(m.dataset.module) === state.step;
        m.classList.toggle("on", on);
      });
    }

    // ========= Step UI =========
    function showStep(step, { animate=true } = {}){
      const meta = STEP_META.find(x => x.id === step);
      elStepTitle.textContent = `STEP ${String(step).padStart(2,"0")} • ${meta.code}`;
      elStepCounter.textContent = `${String(step).padStart(2,"0")}/05`;
      elMobileStepTitle.textContent = `STEP ${String(step).padStart(2,"0")}`;
      prevBtn.disabled = step === 1;
      prevBtnDesk.disabled = step === 1;

      const nextLabel = step === 5 ? "إنهاء ▶" : "التالي";
      const nextLabelDesk = step === 5 ? "إنهاء ▶" : "التالي ▶";
      nextBtn.textContent = nextLabel;
      nextBtnDesk.textContent = nextLabelDesk;

      const active = elSteps.find(s => Number(s.dataset.step) === step);
      elSteps.forEach(s => {
        const isActive = s === active;
        if (isActive) {
          s.classList.remove("hidden");
        } else {
          s.classList.add("hidden");
        }
      });

      // snap + minimal glitch
      if (animate){
        elPanel.classList.add("is-transitioning");
        if (active){
          active.classList.remove("snap-in");
          active.classList.add("snap-out");
          // on next frame, bring it in
          requestAnimationFrame(() => {
            active.classList.remove("snap-out");
            active.classList.add("snap-in");
          });
        }
        setTimeout(() => elPanel.classList.remove("is-transitioning"), 240);
      }

      updateModules();
      updateCompleteness();
      renderTimeline();

      // Step5 final mirrors completeness
      if (step === 5){
        const pct = computeCompleteness().pct;
        finalComplete.textContent = `${pct}%`;
        finalBar.style.width = `${pct}%`;
        finalTips.textContent = computeCompleteness().tips.join(" • ") || "كل شيء يبدو جاهزًا.";
      }
    }

    // ========= Validation & Completeness =========
    function emailOk(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim()); }
    function usernameOk(v){ return /^[a-zA-Z0-9_]{3,20}$/.test(String(v||"").trim()); }

    function passwordStrength(pw){
      const s = String(pw || "");
      let score = 0;
      if (s.length >= 10) score += 30;
      if (s.length >= 14) score += 10;
      if (/[A-Z]/.test(s)) score += 12;
      if (/[a-z]/.test(s)) score += 12;
      if (/[0-9]/.test(s)) score += 18;
      if (/[^A-Za-z0-9]/.test(s)) score += 18;
      // penalties
      if (/(.)\1\1/.test(s)) score -= 10;
      if (s.length < 8) score -= 20;
      return clamp(score, 0, 100);
    }

    function setInvalid(el, on=true){
      if (!el) return;
      el.classList.toggle("invalid", on);
      if (on) setTimeout(() => el.classList.remove("invalid"), 900);
    }

    function computeCompleteness(){
      const tips = [];
      let points = 0;

      // Step 1 (20)
      const s1a = emailOk(email.value);
      const ps = passwordStrength(password.value);
      const s1b = ps >= 55;
      const s1c = confirm.value && confirm.value === password.value;
      const s1 = (s1a && s1b && s1c);
      points += s1 ? 20 : 0;
      if (!s1a) tips.push("أدخل Email صحيح");
      if (!s1b) tips.push("قوّي كلمة المرور");
      if (!s1c) tips.push("طابق كلمة المرور");

      // Step 2 (20)
      const s2a = String(displayName.value||"").trim().length >= 2;
      const s2b = usernameOk(username.value) && state.usernameStatus === "ok";
      const s2c = String(bio.value||"").trim().length >= 10; // optional-ish but rewarded
      const s2 = (s2a && s2b);
      points += s2 ? (s2c ? 20 : 16) : 0;
      if (!s2a) tips.push("اكتب Display Name");
      if (!s2b) tips.push("اختر Username متاح");
      if (!s2c) tips.push("أضف Bio قصيرة");

      // Step 3 (20)
      const hasSvg = !!state.avatar.selectedId;
      const hasUpload = !!state.avatar.uploadUrl && state.avatar.useUpload;
      const s3 = hasSvg || hasUpload;
      points += s3 ? 20 : 0;
      if (!s3) tips.push("اختر Avatar");

      // Step 4 (20)
      const s4 = state.follows.size >= 1;
      points += s4 ? 20 : 0;
      if (!s4) tips.push("اتبع وحدة واحدة");

      // Step 5 (20)
      const s5 = state.interests.length >= 3;
      points += s5 ? 20 : 0;
      if (!s5) tips.push("اختر 3+ اهتمامات");

      return { pct: clamp(points,0,100), tips };
    }

    function updateCompleteness(){
      const { pct } = computeCompleteness();
      completePct.textContent = `${pct}%`;
      completeBar.style.width = `${pct}%`;

      // system bar mirrors
      const sys = clamp(Math.floor(20 + pct*0.7), 20, 92);
      sysBar.style.width = `${sys}%`;
      sysPct.textContent = `${sys}%`;

      elMobileBar.style.width = `${pct}%`;
      elMobilePct.textContent = `${pct}%`;
    }

    function validateStep(step){
      let ok = true;

      if (step === 1){
        const eok = emailOk(email.value);
        const ps = passwordStrength(password.value);
        const cok = confirm.value === password.value && confirm.value.length > 0;

        if (!eok){ ok = false; setInvalid(email,true); }
        if (ps < 55){ ok = false; setInvalid(password,true); }
        if (!cok){ ok = false; setInvalid(confirm,true); }

        if (!ok) matchHint.textContent = "تحقق من البريد/القوة/التطابق.";
      }

      if (step === 2){
        const dn = String(displayName.value||"").trim().length >= 2;
        const uok = usernameOk(username.value) && state.usernameStatus === "ok";
        if (!dn){ ok = false; setInvalid(displayName,true); }
        if (!uok){ ok = false; setInvalid(username,true); }
      }

      if (step === 3){
        const hasSvg = !!state.avatar.selectedId;
        const hasUpload = !!state.avatar.uploadUrl && state.avatar.useUpload;
        if (!(hasSvg || hasUpload)){
          ok = false;
          avatarLock.textContent = "LOCK FAILED • اختر Avatar أو فعّل Upload.";
          avatarLock.style.color = "rgba(var(--acc)/.9)";
        }
      }

      if (step === 4){
        if (state.follows.size < 1){
          ok = false;
          // shake list
          followList.classList.add("shake");
          setTimeout(() => followList.classList.remove("shake"), 260);
        }
      }

      if (step === 5){
        if (state.interests.length < 3){
          ok = false;
          chipWrap.classList.add("shake");
          setTimeout(() => chipWrap.classList.remove("shake"), 260);
        }
      }

      if (!ok){
        elPanel.classList.add("shake");
        setTimeout(() => elPanel.classList.remove("shake"), 300);
      }
      return ok;
    }

    // ========= Simulated scanning on Next =========
    async function scanAndProceed(nextStep){
      loadingOverlay.classList.remove("hidden");
      scanBar.style.width = "12%";
      scanPct.textContent = "12%";
      scanMsg.textContent = "SYNC • VALIDATE • HASH";

      const marks = [
        {w: "28%", p:"28%", m:"ENCRYPT • SIGN • PACK"},
        {w: "46%", p:"46%", m:"CHECK • INDEX • RESOLVE"},
        {w: "68%", p:"68%", m:"CACHE • ROUTE • APPLY"},
        {w: "86%", p:"86%", m:"FINALIZE • COMMIT"},
        {w: "100%",p:"100%",m:"OK"},
      ];
      for (const t of marks){
        await sleep(120 + Math.random()*140);
        scanBar.style.width = t.w;
        scanPct.textContent = t.p;
        scanMsg.textContent = t.m;
      }
      await sleep(110);
      loadingOverlay.classList.add("hidden");
      gotoStep(nextStep, { animate:true, fromClick:false, scanned:true });
    }

    // ========= Navigation =========
    async function next(){
      if (!validateStep(state.step)) return;

      const nextStep = state.step + 1;
      if (state.step === 5){
        // final scan then success
        await scanAndProceed(6); // pseudo
        openSuccess();
        return;
      }

      // simulate scan each Next
      await scanAndProceed(nextStep);
    }

    function prev(){
      if (state.step <= 1) return;
      gotoStep(state.step - 1, { animate:true });
    }

    function gotoStep(step, { animate=true } = {}){
      if (step === 6) return; // pseudo for success
      // Allow going back freely; going forward only up to maxStepReached+1
      const canForward = step <= state.maxStepReached + 1;
      if (!canForward) return;

      state.step = step;
      state.maxStepReached = Math.max(state.maxStepReached, step);
      showStep(step, { animate });
    }

    // ========= Step 1 live UI =========
    function updatePwUI(){
      const s = passwordStrength(password.value);
      pwScore.textContent = String(s);
      pwBar.style.width = s + "%";

      let msg = "—";
      if (s < 30) msg = "ضعيفة: زوّد الطول + رقم + رمز.";
      else if (s < 55) msg = "متوسطة: أضف حروف كبيرة/رموز.";
      else if (s < 80) msg = "جيدة: تقريبًا جاهزة.";
      else msg = "ممتازة: تشفير قوي.";
      pwHint.textContent = msg;

      const match = confirm.value.length ? (confirm.value === password.value) : null;
      if (match === null) matchHint.textContent = "—";
      else if (match) { matchHint.textContent = "مطابقة ✓"; matchHint.style.color = "rgba(var(--p1)/.9)"; }
      else { matchHint.textContent = "غير مطابقة ✕"; matchHint.style.color = "rgba(var(--acc)/.9)"; }

      updateCompleteness();
    }

    password.addEventListener("input", updatePwUI);
    confirm.addEventListener("input", updatePwUI);
    email.addEventListener("input", updateCompleteness);

    // ========= Step 2 username availability simulation =========
    let userTimer = null;
    function setUserStatus(kind){
      state.usernameStatus = kind;
      if (kind === "idle"){
        userStatus.textContent = "IDLE";
        userStatus.style.color = "rgba(255,255,255,.55)";
        userHint.textContent = "بدون مسافات. (محاكاة توفر الاسم تعمل تلقائيًا)";
      }
      if (kind === "checking"){
        userStatus.textContent = "CHECK";
        userStatus.style.color = "rgba(var(--p2)/.85)";
        userHint.textContent = "فحص التوفر…";
      }
      if (kind === "ok"){
        userStatus.textContent = "OK";
        userStatus.style.color = "rgba(var(--p1)/.9)";
        userHint.textContent = "متاح ✓";
      }
      if (kind === "taken"){
        userStatus.textContent = "TAKEN";
        userStatus.style.color = "rgba(var(--acc)/.9)";
        userHint.textContent = "غير متاح ✕ جرّب إضافة رقم/شرطة سفلية.";
      }
      updateCompleteness();
    }

    function simulateUsernameCheck(){
      const v = String(username.value||"").trim();
      if (!v){
        setUserStatus("idle");
        return;
      }
      // normalize
      username.value = v.replace(/\s+/g,"");
      const val = username.value;
      if (!usernameOk(val)){
        setUserStatus("taken");
        userHint.textContent = "صيغة غير صحيحة: 3-20، حروف/أرقام/_ فقط.";
        return;
      }

      setUserStatus("checking");
      clearTimeout(userTimer);
      userTimer = setTimeout(() => {
        const lower = val.toLowerCase();
        const forcedTaken = reservedUsernames.has(lower);
        const randomTaken = Math.random() < 0.28;
        if (forcedTaken || randomTaken){
          setUserStatus("taken");
        } else {
          setUserStatus("ok");
        }
      }, 380 + Math.random()*520);
    }

    username.addEventListener("input", simulateUsernameCheck);
    displayName.addEventListener("input", updateCompleteness);
    bio.addEventListener("input", () => {
      bioCount.textContent = String((bio.value||"").length);
      updateCompleteness();
    });

    // ========= Step 3 SVG Avatars =========
    const AVATARS = [
      { id:"A1", name:"Visor", svg: (a,b)=>`
        <svg viewBox="0 0 120 120" width="90" height="90" aria-hidden="true">
          <defs>
            <linearGradient id="g${a}${b}" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(var(--p1)/.85)" />
              <stop offset="1" stop-color="rgba(var(--p2)/.70)" />
            </linearGradient>
          </defs>
          <path d="M18 54 Q60 18 102 54 L92 92 Q60 104 28 92 Z"
                fill="rgba(0,0,0,.35)" stroke="url(#g${a}${b})" stroke-width="2.2" />
          <path d="M34 60 H86" stroke="rgba(var(--acc)/.55)" stroke-width="2.2" stroke-linecap="round" />
          <path d="M42 68 H78" stroke="rgba(255,255,255,.18)" stroke-width="1.6" stroke-linecap="round" />
          <path d="M60 42 V90" stroke="rgba(255,255,255,.10)" stroke-width="1.2" />
        </svg>`},
      { id:"A2", name:"Helm", svg: (a,b)=>`
        <svg viewBox="0 0 120 120" width="90" height="90" aria-hidden="true">
          <path d="M30 96 Q20 60 36 36 Q60 16 84 36 Q100 60 90 96"
                fill="rgba(0,0,0,.32)" stroke="rgba(var(--p1)/.60)" stroke-width="2.2"/>
          <path d="M42 54 Q60 42 78 54 Q76 74 60 80 Q44 74 42 54 Z"
                fill="rgba(var(--p2)/.12)" stroke="rgba(var(--p2)/.55)" stroke-width="1.8"/>
          <path d="M50 60 H70" stroke="rgba(var(--acc)/.60)" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M24 66 H42 M78 66 H96" stroke="rgba(255,255,255,.12)" stroke-width="1.4" stroke-linecap="round"/>
        </svg>`},
      { id:"A3", name:"Pilot", svg: (a,b)=>`
        <svg viewBox="0 0 120 120" width="90" height="90" aria-hidden="true">
          <circle cx="60" cy="52" r="26" fill="rgba(0,0,0,.30)" stroke="rgba(var(--p2)/.55)" stroke-width="2"/>
          <path d="M22 104 Q60 80 98 104" fill="rgba(0,0,0,.22)" stroke="rgba(var(--p1)/.55)" stroke-width="2"/>
          <path d="M44 56 Q60 44 76 56" fill="none" stroke="rgba(var(--acc)/.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M38 46 L48 46 M72 46 L82 46" stroke="rgba(255,255,255,.14)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>`},
      { id:"A4", name:"Shard", svg: (a,b)=>`
        <svg viewBox="0 0 120 120" width="90" height="90" aria-hidden="true">
          <path d="M20 92 L60 18 L100 92 L76 102 L60 78 L44 102 Z"
                fill="rgba(0,0,0,.32)" stroke="rgba(var(--p1)/.55)" stroke-width="2.2" />
          <path d="M60 36 L78 72 L60 74 L42 72 Z" fill="rgba(var(--p2)/.14)" stroke="rgba(var(--p2)/.50)" stroke-width="1.8"/>
          <path d="M52 60 H68" stroke="rgba(var(--acc)/.62)" stroke-width="2.2" stroke-linecap="round"/>
        </svg>`},
      { id:"A5", name:"Core", svg: (a,b)=>`
        <svg viewBox="0 0 120 120" width="90" height="90" aria-hidden="true">
          <rect x="26" y="24" width="68" height="72" rx="18" fill="rgba(0,0,0,.30)" stroke="rgba(var(--p2)/.55)" stroke-width="2.2"/>
          <circle cx="60" cy="62" r="18" fill="rgba(var(--p1)/.10)" stroke="rgba(var(--p1)/.55)" stroke-width="2"/>
          <path d="M52 62 H68" stroke="rgba(var(--acc)/.60)" stroke-width="2.4" stroke-linecap="round"/>
          <path d="M60 44 V80" stroke="rgba(255,255,255,.10)" stroke-width="1.2"/>
        </svg>`},
      { id:"A6", name:"Edge", svg: (a,b)=>`
        <svg viewBox="0 0 120 120" width="90" height="90" aria-hidden="true">
          <path d="M24 48 Q60 14 96 48 L86 96 Q60 110 34 96 Z"
                fill="rgba(0,0,0,.30)" stroke="rgba(var(--p1)/.55)" stroke-width="2.2"/>
          <path d="M36 52 L60 44 L84 52" fill="none" stroke="rgba(var(--p2)/.55)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M44 66 H76" stroke="rgba(var(--acc)/.58)" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M38 76 H82" stroke="rgba(255,255,255,.12)" stroke-width="1.4" stroke-linecap="round"/>
        </svg>`},
    ];

    function renderAvatarGrid(){
      avatarGrid.innerHTML = "";
      AVATARS.forEach((a, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "hud-btn rounded-2xl p-3 text-right relative overflow-hidden";
        btn.dataset.avatarId = a.id;
        btn.innerHTML = `
          <div class="absolute inset-0 opacity-60"
               style="background:radial-gradient(120px 90px at 20% 10%, rgba(var(--p1)/.12), transparent 55%),
                             radial-gradient(120px 90px at 80% 90%, rgba(var(--p2)/.10), transparent 55%);"></div>
          <div class="relative flex items-center gap-3">
            <div class="w-20 h-20 rounded-2xl border border-white/10 bg-black/20 grid place-items-center">
              ${a.svg(idx, "x")}
            </div>
            <div class="flex-1">
              <div class="hud-label">${a.name}</div>
              <div class="mt-1 text-xs text-white/55">abstract pilot signature</div>
            </div>
            <div class="hud-micro" style="color:rgba(var(--p1)/.85)">${a.id}</div>
          </div>
        `;

        btn.addEventListener("click", () => selectAvatar(a.id));
        avatarGrid.appendChild(btn);
      });
      syncAvatarSelectionUI();
    }

    function selectAvatar(id){
      state.avatar.selectedId = id;
      avatarLock.textContent = `LOCKED • ${id}`;
      avatarLock.style.color = "rgba(var(--p1)/.9)";
      if (state.avatar.useUpload){
        // keep upload if user insisted; but selection still counts
      }
      renderAvatarPreview();
      syncAvatarSelectionUI();
      updateCompleteness();
    }

    function syncAvatarSelectionUI(){
      Array.from(avatarGrid.querySelectorAll("button")).forEach(btn => {
        const on = btn.dataset.avatarId === state.avatar.selectedId;
        btn.style.borderColor = on ? "rgba(var(--p1)/.45)" : "rgba(255,255,255,.12)";
        btn.style.boxShadow = on ? "0 0 0 3px rgba(var(--p1)/.10), 0 16px 44px rgba(0,0,0,.40), inset 0 1px 0 rgba(255,255,255,.06)" : "0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06)";
      });
    }

    function renderAvatarPreview(){
      avatarPreview.innerHTML = "";
      avatarPreview.className = "w-20 h-20 rounded-2xl border border-white/10 bg-black/20 grid place-items-center overflow-hidden";

      if (state.avatar.useUpload && state.avatar.uploadUrl){
        const img = document.createElement("img");
        img.src = state.avatar.uploadUrl;
        img.alt = "Uploaded avatar preview";
        img.className = "w-full h-full object-cover";
        avatarPreview.appendChild(img);
        return;
      }

      if (state.avatar.selectedId){
        const av = AVATARS.find(x => x.id === state.avatar.selectedId);
        const wrap = document.createElement("div");
        wrap.className = "scale-[.95]";
        wrap.innerHTML = av.svg("p","v");
        avatarPreview.appendChild(wrap);
        return;
      }

      const t = document.createElement("span");
      t.className = "hud-micro";
      t.style.opacity = ".7";
      t.textContent = "NO AV";
      avatarPreview.appendChild(t);
    }

    avatarUpload.addEventListener("change", () => {
      const file = avatarUpload.files && avatarUpload.files[0];
      if (!file) return;
      // release old url
      if (state.avatar.uploadUrl) URL.revokeObjectURL(state.avatar.uploadUrl);
      state.avatar.uploadUrl = URL.createObjectURL(file);
      // if toggle ON, show it
      if (state.avatar.useUpload){
        avatarLock.textContent = "LOCKED • UPLOAD";
        avatarLock.style.color = "rgba(var(--p2)/.9)";
      }
      renderAvatarPreview();
      updateCompleteness();
    });

    useUploadToggle.addEventListener("click", () => {
      state.avatar.useUpload = !state.avatar.useUpload;
      useUploadToggle.textContent = state.avatar.useUpload ? "ON" : "OFF";
      useUploadToggle.style.borderColor = state.avatar.useUpload ? "rgba(var(--p2)/.45)" : "rgba(255,255,255,.12)";
      if (state.avatar.useUpload){
        avatarLock.textContent = state.avatar.uploadUrl ? "LOCKED • UPLOAD" : "UPLOAD ON • أضف ملف";
        avatarLock.style.color = state.avatar.uploadUrl ? "rgba(var(--p2)/.9)" : "rgba(var(--acc)/.9)";
      } else {
        avatarLock.textContent = state.avatar.selectedId ? `LOCKED • ${state.avatar.selectedId}` : "UNLOCKED";
        avatarLock.style.color = state.avatar.selectedId ? "rgba(var(--p1)/.9)" : "rgba(255,255,255,.6)";
      }
      renderAvatarPreview();
      updateCompleteness();
    });

    randAvatar.addEventListener("click", () => {
      const pick = AVATARS[Math.floor(Math.random()*AVATARS.length)].id;
      selectAvatar(pick);
      // slight "re-sync" ping
      ping.textContent = randPing();
    });

    // ========= Step 4 Follow Cards =========
    const FOLLOW_ITEMS = [
      { id:"u_mecha_lab", name:"Mecha Lab", cat:"mecha", followers: 128420 },
      { id:"u_railgun", name:"Railgun Systems", cat:"mecha", followers: 90410 },
      { id:"u_manga_panel", name:"Manga Panelists", cat:"manga", followers: 211320 },
      { id:"u_ink_war", name:"Ink Wars", cat:"art", followers: 64210 },
      { id:"u_lore_core", name:"Lore Core", cat:"lore", followers: 170540 },
      { id:"u_mecha_sketch", name:"Mecha Sketch", cat:"art", followers: 58780 },
      { id:"u_script_room", name:"Script Room", cat:"lore", followers: 81230 },
      { id:"u_manga_fast", name:"Manga Fastcuts", cat:"manga", followers: 99700 },
      { id:"u_frame_by_frame", name:"Frame-By-Frame", cat:"art", followers: 76450 },
      { id:"u_gear_queue", name:"Gear Queue", cat:"mecha", followers: 43310 },
      { id:"u_arc_index", name:"Arc Index", cat:"lore", followers: 120880 },
      { id:"u_panel_rush", name:"Panel Rush", cat:"manga", followers: 156340 },
    ];

    function fmt(n){
      if (n >= 1e6) return (n/1e6).toFixed(1) + "M";
      if (n >= 1e3) return (n/1e3).toFixed(1) + "K";
      return String(n);
    }

    function sparkline(seed){
      // deterministic-ish points
      const pts = [];
      let v = 20 + (seed*7)%30;
      for (let i=0;i<10;i++){
        v += (Math.sin((seed+i)*1.7)*6) + (Math.random()*4-2);
        v = clamp(v, 10, 55);
        const x = 8 + i*13;
        const y = 70 - v;
        pts.push(`${x},${y.toFixed(1)}`);
      }
      return pts.join(" ");
    }

    function renderFollow(){
      const q = String(followSearch.value||"").toLowerCase().trim();
      const f = followFilter.value;

      const items = FOLLOW_ITEMS.filter(it => {
        const okQ = !q || it.name.toLowerCase().includes(q) || it.id.toLowerCase().includes(q);
        const okF = (f === "all") || it.cat === f;
        return okQ && okF;
      });

      followList.innerHTML = "";
      items.forEach((it, idx) => {
        const on = state.follows.has(it.id);
        const card = document.createElement("div");
        card.className = "hud-btn rounded-2xl p-3 relative overflow-hidden";
        card.innerHTML = `
          <div class="absolute inset-0 opacity-60"
               style="background:radial-gradient(180px 120px at 20% 20%, rgba(var(--p1)/.10), transparent 55%),
                             radial-gradient(180px 120px at 90% 80%, rgba(var(--p2)/.08), transparent 55%);"></div>
          <div class="relative flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="flex items-center justify-between gap-2">
                <div class="hud-label">${it.name}</div>
                <div class="hud-micro" style="color:rgba(var(--p2)/.85)">${it.cat.toUpperCase()}</div>
              </div>
              <div class="mt-1 text-xs text-white/55">${it.id}</div>

              <div class="mt-3 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="hud-micro">FOLLOWERS</div>
                  <div class="hud-micro" style="color:rgba(var(--p1)/.9)">${fmt(it.followers)}</div>
                </div>
                <svg viewBox="0 0 130 70" width="110" height="36" aria-hidden="true">
                  <polyline points="${sparkline(idx+3)}" fill="none" stroke="rgba(var(--p1)/.55)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <polyline points="8,55 125,55" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="1"/>
                </svg>
              </div>
            </div>
            <button type="button" class="hud-btn px-3 py-2 rounded-xl text-xs"
                    style="border-color:${on ? "rgba(var(--p1)/.55)" : "rgba(255,255,255,.12)"}"
                    data-follow="${it.id}">
              ${on ? "FOLLOWING" : "FOLLOW"}
            </button>
          </div>
        `;
        followList.appendChild(card);
      });

      // attach toggle handlers
      followList.querySelectorAll("button[data-follow]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = btn.dataset.follow;
          if (state.follows.has(id)) state.follows.delete(id);
          else state.follows.add(id);
          followCount.textContent = String(state.follows.size);
          renderFollow();
          updateCompleteness();
          e.stopPropagation();
        });
      });

      followCount.textContent = String(state.follows.size);
    }

    followSearch.addEventListener("input", renderFollow);
    followFilter.addEventListener("change", renderFollow);

    followAll.addEventListener("click", () => {
      // follow up to 3 visible items
      const q = String(followSearch.value||"").toLowerCase().trim();
      const f = followFilter.value;
      const visible = FOLLOW_ITEMS.filter(it => {
        const okQ = !q || it.name.toLowerCase().includes(q) || it.id.toLowerCase().includes(q);
        const okF = (f === "all") || it.cat === f;
        return okQ && okF;
      }).slice(0,3);

      visible.forEach(it => state.follows.add(it.id));
      renderFollow();
      updateCompleteness();
    });

    // ========= Step 5 Interests + Ranking =========
    const INTERESTS = [
      "mecha","space-opera","cyberpunk","isekai","slice-of-life","shonen","seinen","manga","webtoon","ink-art",
      "character-design","lore","soundtracks","animation","robots","kaiju","tactics","speed-lines","coloring","paneling"
    ];

    function renderChips(){
      chipWrap.innerHTML = "";
      INTERESTS.forEach(tag => {
        const on = state.interests.includes(tag);
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip px-3 py-2 rounded-full text-xs";
        b.classList.toggle("on", on);
        b.textContent = tag;
        b.addEventListener("click", () => toggleInterest(tag));
        chipWrap.appendChild(b);
      });
      interestCount.textContent = String(state.interests.length);
      rankHint.textContent = state.interests.length ? "UP/DOWN" : "—";
    }

    function renderRank(){
      rankList.innerHTML = "";
      if (!state.interests.length){
        rankList.innerHTML = `<div class="text-xs text-white/55">اختر Chips لتظهر هنا.</div>`;
        return;
      }
      state.interests.forEach((t, i) => {
        const row = document.createElement("div");
        row.className = "flex items-center justify-between gap-2 p-2 rounded-xl border border-white/10 bg-black/10";
        row.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="hud-micro" style="color:rgba(var(--p2)/.85)">#${i+1}</div>
            <div class="text-xs font-medium tracking-wide">${t}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="hud-btn px-3 py-2 rounded-xl text-xs" data-up="${t}">↑</button>
            <button class="hud-btn px-3 py-2 rounded-xl text-xs" data-down="${t}">↓</button>
            <button class="hud-btn px-3 py-2 rounded-xl text-xs" data-del="${t}" style="border-color:rgba(var(--acc)/.35)">×</button>
          </div>
        `;
        rankList.appendChild(row);
      });

      rankList.querySelectorAll("button[data-up]").forEach(b => b.addEventListener("click", () => moveInterest(b.dataset.up, -1)));
      rankList.querySelectorAll("button[data-down]").forEach(b => b.addEventListener("click", () => moveInterest(b.dataset.down, +1)));
      rankList.querySelectorAll("button[data-del]").forEach(b => b.addEventListener("click", () => toggleInterest(b.dataset.del)));
    }

    function toggleInterest(tag){
      const i = state.interests.indexOf(tag);
      if (i >= 0) state.interests.splice(i,1);
      else state.interests.push(tag);
      renderChips();
      renderRank();
      updateCompleteness();
      // mirror step5 panel fields
      if (state.step === 5){
        const pct = computeCompleteness().pct;
        finalComplete.textContent = `${pct}%`;
        finalBar.style.width = `${pct}%`;
        finalTips.textContent = computeCompleteness().tips.join(" • ") || "كل شيء يبدو جاهزًا.";
      }
    }

    function moveInterest(tag, dir){
      const i = state.interests.indexOf(tag);
      if (i < 0) return;
      const j = clamp(i + dir, 0, state.interests.length - 1);
      if (i === j) return;
      const [x] = state.interests.splice(i,1);
      state.interests.splice(j,0,x);
      renderRank();
    }

    // ========= Success =========
    function openSuccess(){
      // small glitch flash
      success.classList.remove("hidden");
      success.querySelector(".hud-outline").classList.add("is-transitioning");
      setTimeout(() => success.querySelector(".hud-outline").classList.remove("is-transitioning"), 260);
    }

    function resetAll(){
      state.step = 1;
      state.maxStepReached = 1;
      state.usernameStatus = "idle";
      state.avatar.selectedId = null;
      state.avatar.useUpload = false;
      if (state.avatar.uploadUrl) URL.revokeObjectURL(state.avatar.uploadUrl);
      state.avatar.uploadUrl = null;
      state.follows.clear();
      state.interests = [];

      email.value = "";
      password.value = "";
      confirm.value = "";
      displayName.value = "";
      username.value = "";
      bio.value = "";
      bioCount.textContent = "0";
      setUserStatus("idle");
      useUploadToggle.textContent = "OFF";
      useUploadToggle.style.borderColor = "rgba(255,255,255,.12)";
      avatarLock.textContent = "UNLOCKED";
      avatarLock.style.color = "rgba(255,255,255,.6)";
      renderAvatarPreview();
      renderAvatarGrid();
      renderFollow();
      renderChips();
      renderRank();
      updatePwUI();

      success.classList.add("hidden");
      nodeId.textContent = randNode();
      ping.textContent = randPing();
      showStep(1, { animate:false });
    }

    startBtn.addEventListener("click", () => {
      // demo: close success with micro-glitch
      success.querySelector(".hud-outline").classList.add("is-transitioning");
      setTimeout(() => {
        success.classList.add("hidden");
        success.querySelector(".hud-outline").classList.remove("is-transitioning");
      }, 240);
    });

    resetBtn.addEventListener("click", resetAll);

    // ========= Swipe navigation (mobile) =========
    (function enableSwipe(){
      let sx=0, sy=0, active=false;
      elPanel.addEventListener("touchstart", (e) => {
        // ignore if focused on input/textarea
        const t = e.target;
        if (t && (t.tagName === "INPUT" || t.tagName === "TEXTAREA" || t.tagName === "SELECT")) return;
        active = true;
        sx = e.touches[0].clientX;
        sy = e.touches[0].clientY;
      }, {passive:true});

      elPanel.addEventListener("touchend", (e) => {
        if (!active) return;
        active = false;
        const t = e.changedTouches[0];
        const dx = t.clientX - sx;
        const dy = t.clientY - sy;
        if (Math.abs(dx) < 60 || Math.abs(dy) > 40) return;
        // RTL: swipe right = next? keep intuitive: swipe left -> next
        if (dx < 0) next();
        else prev();
      }, {passive:true});
    })();

    // ========= Buttons =========
    prevBtn.addEventListener("click", prev);
    nextBtn.addEventListener("click", next);
    prevBtnDesk.addEventListener("click", prev);
    nextBtnDesk.addEventListener("click", next);

    // ========= Ambient system ticker =========
    setInterval(() => {
      ping.textContent = randPing();
      // subtle scanline jitter
      const s = (Math.sin(Date.now()/950) * 2.2);
      document.documentElement.style.setProperty("--scan", s + "px");
    }, 900);

    // ========= Init =========
    function init(){
      nodeId.textContent = randNode();
      ping.textContent = randPing();
      renderTimeline();
      renderAvatarGrid();
      renderAvatarPreview();
      renderFollow();
      renderChips();
      renderRank();
      setUserStatus("idle");
      updatePwUI();

      // default: show step1 module
      updateModules();
      showStep(1, { animate:false });
    }
    init();
  </script>
</body>
</html>
