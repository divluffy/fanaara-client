<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ShÅjo / Kawaii Motion Comic â€” Signup</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --accent: 255 108 199; /* default pink */
      --accent2: 122 255 235;
      --ink: 20 18 30;
      --paper: 255 255 255;
      --glass: 255 255 255 / .66;
      --shadow: 0 18px 45px rgba(15, 10, 35, .20);
      --soft: 0 12px 30px rgba(18, 12, 40, .14);
      --ring: 0 0 0 3px rgba(var(--accent)/.28), 0 0 0 9px rgba(var(--accent)/.12);
    }

    /* Typography (Arabic-friendly system stack) */
    html, body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Arabic", "Cairo", "Tajawal", "Geeza Pro", Arial, sans-serif;
      background: rgb(10 9 18);
      color: rgb(255 255 255);
      overflow-x: hidden;
    }

    /* View Transitions (if supported) */
    @keyframes vt-pop {
      from{ transform: translateY(10px) scale(.98); opacity: .0; filter: blur(6px); }
      to  { transform: translateY(0) scale(1); opacity: 1; filter: blur(0); }
    }
    ::view-transition-old(main){ animation: .25s ease both; opacity: .7; }
    ::view-transition-new(main){ animation: .5s cubic-bezier(.16,1,.3,1) both vt-pop; }

    /* Soft bloom / glass */
    .glass{
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(12px) saturate(1.2);
      -webkit-backdrop-filter: blur(12px) saturate(1.2);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
    }
    .paper{
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(700px 700px at 85% 10%, rgba(var(--accent)/.18), transparent 55%),
        radial-gradient(700px 700px at 50% 110%, rgba(var(--accent2)/.12), transparent 55%),
        rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
    }

    /* Manga panel vibe */
    .manga-panel{
      position: relative;
      border-radius: 22px;
      overflow: hidden;
      isolation: isolate;
    }
    .manga-panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(12px 12px at 18% 22%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(10px 10px at 72% 30%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(14px 14px at 40% 82%, rgba(255,255,255,.16), transparent 60%),
        linear-gradient(135deg, rgba(var(--accent)/.28), rgba(var(--accent2)/.18));
      filter: blur(14px);
      opacity: .9;
      z-index: -2;
    }
    .manga-panel::after{
      content:"";
      position:absolute; inset:0;
      background:
        /* halftone-ish */
        radial-gradient(circle at 2px 2px, rgba(255,255,255,.08) 1px, transparent 1.2px);
      background-size: 8px 8px;
      opacity: .26;
      mix-blend-mode: overlay;
      z-index: -1;
      pointer-events:none;
    }

    /* Chapter title sticker */
    .chapter{
      display: inline-flex;
      gap: .5rem;
      align-items: center;
      border-radius: 999px;
      padding: .45rem .85rem;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--soft);
    }
    .sticker-dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: linear-gradient(135deg, rgba(var(--accent)/1), rgba(var(--accent2)/1));
      box-shadow: 0 0 0 4px rgba(255,255,255,.10), 0 0 24px rgba(var(--accent)/.35);
    }

    /* Speech bubble */
    .bubble{
      position: relative;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      padding: .75rem .9rem;
      box-shadow: var(--soft);
    }
    .bubble::after{
      content:"";
      position:absolute;
      bottom: -8px;
      right: 18px;
      width: 14px; height: 14px;
      transform: rotate(45deg);
      background: rgba(255,255,255,.10);
      border-right: 1px solid rgba(255,255,255,.14);
      border-bottom: 1px solid rgba(255,255,255,.14);
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.18));
    }

    /* Buttons */
    .btn{
      border-radius: 16px;
      padding: .85rem 1rem;
      font-weight: 800;
      letter-spacing: .2px;
      transition: transform .18s cubic-bezier(.2,1,.2,1), filter .18s, background .18s, border-color .18s;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      box-shadow: var(--soft);
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-primary{
      background: linear-gradient(135deg, rgba(var(--accent)/.95), rgba(var(--accent2)/.70));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 16px 40px rgba(var(--accent)/.22), var(--soft);
    }
    .btn-primary:hover{ filter: brightness(1.03) saturate(1.08); }
    .btn-ghost{
      background: rgba(0,0,0,.18);
    }

    /* Inputs */
    .field{
      border-radius: 16px;
      padding: .82rem .95rem;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.0);
      transition: box-shadow .18s, border-color .18s, transform .18s;
      width: 100%;
    }
    .field:focus{
      border-color: rgba(var(--accent)/.40);
      box-shadow: 0 0 0 4px rgba(var(--accent)/.18);
    }
    .label{
      font-size: .88rem;
      opacity: .88;
      margin-bottom: .35rem;
      display: block;
    }

    /* Minimal hearts/stars icons */
    .mini-icon{
      width: 18px; height: 18px;
      opacity: .9;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.22));
    }

    /* Stagger in */
    @keyframes staggerIn{
      from{ opacity: 0; transform: translateY(10px) scale(.99); filter: blur(6px); }
      to  { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    .stagger > *{
      animation: staggerIn .55s cubic-bezier(.16,1,.3,1) both;
      animation-delay: calc(var(--i, 0) * 70ms);
    }

    /* Float/pulse */
    @keyframes floaty{
      0%,100%{ transform: translateY(0) }
      50%{ transform: translateY(-6px) }
    }
    .floaty{ animation: floaty 4.8s ease-in-out infinite; }

    @keyframes elasticPop{
      0%{ transform: scale(.92); opacity: .0; }
      60%{ transform: scale(1.03); opacity: 1; }
      100%{ transform: scale(1); }
    }
    .pop{ animation: elasticPop .55s cubic-bezier(.2,1,.2,1) both; }

    /* Glitter overlay (CSS-only, realistic-ish) */
    .glitter{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(12px 12px at 12% 20%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(10px 10px at 72% 24%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(9px 9px at 42% 68%, rgba(255,255,255,.28), transparent 60%),
        radial-gradient(12px 12px at 85% 72%, rgba(255,255,255,.24), transparent 60%),
        radial-gradient(8px 8px at 25% 78%, rgba(255,255,255,.20), transparent 60%),
        repeating-conic-gradient(from 20deg, rgba(255,255,255,.0) 0 12deg, rgba(255,255,255,.10) 12deg 13deg);
      opacity: .28;
      mix-blend-mode: overlay;
      filter: blur(.2px) saturate(1.2);
      animation: glitterShift 5.5s ease-in-out infinite;
    }
    @keyframes glitterShift{
      0%,100%{ transform: translate3d(0,0,0) scale(1); opacity: .25; }
      50%{ transform: translate3d(0,-6px,0) scale(1.02); opacity: .34; }
    }

    /* Step backgrounds (story-scene) */
    .scene{
      position:absolute; inset:0;
      z-index:-3;
      overflow:hidden;
    }
    .scene .layer{
      position:absolute; inset:-20%;
      opacity:.9;
      filter: blur(22px) saturate(1.2);
      transform: translateZ(0);
    }
    .step-1 .scene{
      background:
        radial-gradient(900px 500px at 18% 10%, rgba(var(--accent)/.40), transparent 60%),
        radial-gradient(750px 650px at 85% 20%, rgba(var(--accent2)/.30), transparent 60%),
        radial-gradient(700px 700px at 50% 110%, rgba(255,255,255,.10), transparent 60%),
        #0a0912;
    }
    .step-1 .scene .layer.one{
      background:
        radial-gradient(closest-side at 25% 40%, rgba(255,255,255,.18), transparent 65%),
        radial-gradient(closest-side at 65% 30%, rgba(255,255,255,.12), transparent 65%);
      opacity:.65;
    }
    .step-2 .scene{
      background:
        radial-gradient(800px 600px at 20% 10%, rgba(255, 163, 208, .28), transparent 60%),
        radial-gradient(900px 700px at 88% 22%, rgba(140, 210, 255, .22), transparent 60%),
        linear-gradient(180deg, rgba(20,14,35,.92), rgba(10,9,18,.98));
    }
    .step-3 .scene{
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(170, 255, 244, .18), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(255, 130, 210, .22), transparent 60%),
        linear-gradient(180deg, rgba(9,9,18,.88), rgba(8,8,14,.98));
    }
    .step-4 .scene{
      background:
        radial-gradient(900px 700px at 20% 10%, rgba(255, 210, 140, .18), transparent 60%),
        radial-gradient(900px 700px at 86% 20%, rgba(120, 255, 235, .16), transparent 60%),
        linear-gradient(180deg, rgba(10,9,18,.88), rgba(8,8,14,.98));
    }
    .step-5 .scene{
      background:
        radial-gradient(900px 700px at 22% 8%, rgba(160, 150, 255, .22), transparent 60%),
        radial-gradient(900px 700px at 85% 18%, rgba(255, 150, 220, .18), transparent 60%),
        linear-gradient(180deg, rgba(9,9,18,.88), rgba(8,8,14,.98));
    }

    /* Sakura petals (CSS layers) */
    .petals{
      position:absolute; inset:0; pointer-events:none; opacity:.75;
      filter: blur(.2px);
    }
    .petal{
      position:absolute; top:-12%;
      width: 18px; height: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(255,255,255,.25), transparent 55%),
        radial-gradient(circle at 60% 30%, rgba(255,170,210,.85), rgba(255,110,190,.55));
      border-radius: 60% 60% 60% 60% / 70% 70% 40% 40%;
      transform: rotate(18deg);
      box-shadow: 0 18px 30px rgba(0,0,0,.25);
      animation: fall linear infinite;
    }
    @keyframes fall{
      to{ transform: translateY(130vh) rotate(320deg); opacity: .0; }
    }

    /* Aura rings background (step 3) */
    .aura-rings{
      position:absolute; inset:0; pointer-events:none;
      opacity:.75;
    }
    .aura-rings::before,
    .aura-rings::after{
      content:"";
      position:absolute;
      width: 460px; height: 460px;
      border-radius: 999px;
      border: 2px solid rgba(var(--accent)/.22);
      box-shadow: 0 0 0 12px rgba(var(--accent)/.08), 0 0 80px rgba(var(--accent)/.20);
      filter: blur(.1px);
      animation: ringDrift 8s ease-in-out infinite;
    }
    .aura-rings::before{ right:-120px; top: -90px; }
    .aura-rings::after{
      left:-140px; bottom:-120px;
      border-color: rgba(var(--accent2)/.18);
      box-shadow: 0 0 0 14px rgba(var(--accent2)/.07), 0 0 80px rgba(var(--accent2)/.18);
      animation-duration: 10.5s;
    }
    @keyframes ringDrift{
      0%,100%{ transform: translateY(0) scale(1); opacity:.75; }
      50%{ transform: translateY(12px) scale(1.02); opacity:.9; }
    }

    /* Bokeh (step 4) */
    .bokeh{
      position:absolute; inset:0; pointer-events:none;
      opacity:.55;
      filter: blur(2px);
      background:
        radial-gradient(28px 28px at 15% 20%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(42px 42px at 80% 25%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(30px 30px at 40% 75%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(56px 56px at 65% 65%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(44px 44px at 22% 62%, rgba(255,255,255,.08), transparent 60%);
      animation: bokehPulse 7s ease-in-out infinite;
    }
    @keyframes bokehPulse{
      0%,100%{ transform: translateY(0); opacity:.52; }
      50%{ transform: translateY(-10px); opacity:.64; }
    }

    /* Constellation + ribbons (step 5) */
    .constellation{
      position:absolute; inset:0; pointer-events:none;
      opacity:.8;
      background:
        radial-gradient(2px 2px at 14% 28%, rgba(255,255,255,.70), transparent 55%),
        radial-gradient(2px 2px at 26% 18%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(2px 2px at 38% 38%, rgba(255,255,255,.60), transparent 55%),
        radial-gradient(2px 2px at 52% 22%, rgba(255,255,255,.62), transparent 55%),
        radial-gradient(2px 2px at 68% 35%, rgba(255,255,255,.62), transparent 55%),
        radial-gradient(2px 2px at 80% 20%, rgba(255,255,255,.60), transparent 55%),
        radial-gradient(2px 2px at 86% 48%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(2px 2px at 62% 70%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(2px 2px at 30% 72%, rgba(255,255,255,.55), transparent 55%);
    }
    .ribbons{
      position:absolute; inset:0; pointer-events:none;
      opacity:.65;
      filter: blur(.3px);
    }
    .ribbons::before, .ribbons::after{
      content:"";
      position:absolute; inset:-20%;
      background:
        conic-gradient(from 0deg at 30% 40%, rgba(var(--accent)/.0), rgba(var(--accent)/.22), rgba(var(--accent)/.0)),
        conic-gradient(from 180deg at 70% 60%, rgba(var(--accent2)/.0), rgba(var(--accent2)/.18), rgba(var(--accent2)/.0));
      transform: rotate(8deg);
      animation: ribbon 9s ease-in-out infinite;
    }
    .ribbons::after{
      transform: rotate(-12deg);
      animation-duration: 11s;
      opacity:.7;
    }
    @keyframes ribbon{
      0%,100%{ transform: translateY(0) rotate(8deg); }
      50%{ transform: translateY(-10px) rotate(10deg); }
    }

    /* Chat bubbles slow drift (step 4) */
    .bubble-float{
      position:absolute;
      width: 140px;
      animation: bubbleDrift 10s ease-in-out infinite;
      opacity:.9;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.25));
    }
    .bubble-float:nth-child(2){ width: 170px; animation-duration: 12.5s; opacity:.75; }
    .bubble-float:nth-child(3){ width: 120px; animation-duration: 9.5s; opacity:.7; }
    @keyframes bubbleDrift{
      0%,100%{ transform: translateY(0) translateX(0) scale(1); }
      50%{ transform: translateY(-12px) translateX(-8px) scale(1.02); }
    }

    /* Avatar selection */
    .avatar-card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: .7rem;
      position: relative;
      overflow: hidden;
      transition: transform .18s cubic-bezier(.2,1,.2,1), border-color .18s, box-shadow .18s;
    }
    .avatar-card:hover{ transform: translateY(-1px); }
    .avatar-card.selected{
      border-color: rgba(var(--accent)/.55);
      box-shadow: 0 0 0 4px rgba(var(--accent)/.16), 0 20px 45px rgba(0,0,0,.28);
    }
    .avatar-card .aura{
      position:absolute; inset: -10px;
      border-radius: 999px;
      border: 2px solid rgba(var(--accent)/.0);
      box-shadow: none;
      opacity: 0;
      transform: scale(.96);
      transition: opacity .2s, transform .2s, border-color .2s, box-shadow .2s;
      pointer-events:none;
    }
    .avatar-card.selected .aura{
      opacity: 1;
      transform: scale(1);
      border-color: rgba(var(--accent)/.35);
      box-shadow: 0 0 0 10px rgba(var(--accent)/.08), 0 0 48px rgba(var(--accent)/.22);
    }
    .spark{
      position:absolute;
      width: 6px; height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.9);
      box-shadow: 0 0 16px rgba(255,255,255,.75), 0 0 28px rgba(var(--accent)/.45);
      pointer-events:none;
      animation: sparkBurst .55s cubic-bezier(.16,1,.3,1) forwards;
    }
    @keyframes sparkBurst{
      from{ transform: translate(0,0) scale(1); opacity: 1; }
      to{ transform: translate(var(--dx), var(--dy)) scale(.2); opacity: 0; }
    }

    /* Heart stamp */
    .heart-stamp{
      position:absolute;
      right: -10px;
      top: -10px;
      width: 40px; height: 40px;
      transform: rotate(12deg) scale(.4);
      opacity: 0;
      filter: drop-shadow(0 18px 22px rgba(0,0,0,.25));
      animation: stamp .55s cubic-bezier(.16,1,.3,1) forwards;
      pointer-events:none;
    }
    @keyframes stamp{
      0%{ transform: rotate(12deg) scale(.35); opacity: 0; }
      55%{ transform: rotate(-8deg) scale(1.08); opacity: 1; }
      100%{ transform: rotate(-2deg) scale(1); opacity: 0; }
    }

    /* Chips */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      border-radius: 999px;
      padding: .55rem .75rem;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: var(--soft);
      cursor: pointer;
      user-select:none;
      transition: transform .18s cubic-bezier(.2,1,.2,1), box-shadow .18s, border-color .18s, background .18s;
      position: relative;
      overflow:hidden;
    }
    .chip::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(closest-side at 30% 20%, rgba(255,255,255,.22), transparent 60%),
                  linear-gradient(135deg, rgba(var(--accent)/.18), rgba(var(--accent2)/.10));
      opacity: 0;
      transition: opacity .18s;
    }
    .chip:hover{ transform: translateY(-1px); }
    .chip.selected{
      border-color: rgba(var(--accent)/.55);
      background: rgba(255,255,255,.10);
      box-shadow: 0 0 0 4px rgba(var(--accent)/.14), var(--soft);
    }
    .chip.selected::before{ opacity: 1; }
    .chip .shine{
      width: 8px; height: 8px; border-radius: 999px;
      background: linear-gradient(135deg, rgba(var(--accent)/1), rgba(var(--accent2)/1));
      box-shadow: 0 0 18px rgba(var(--accent)/.30);
      flex: 0 0 auto;
    }

    /* Sticky bottom bar w/ safe-area */
    .bottom-bar{
      padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
      background: linear-gradient(180deg, rgba(10,9,18,0), rgba(10,9,18,.65) 25%, rgba(10,9,18,.92));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Progress dots */
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.18);
      transition: transform .18s, background .18s, box-shadow .18s;
    }
    .dot.active{
      background: linear-gradient(135deg, rgba(var(--accent)/1), rgba(var(--accent2)/1));
      box-shadow: 0 0 0 5px rgba(var(--accent)/.14);
      transform: scale(1.05);
    }
    .dot.done{
      background: rgba(255,255,255,.45);
      box-shadow: 0 0 0 4px rgba(255,255,255,.10);
    }

    /* Carousel */
    .snap-x{
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .snap-x > *{ scroll-snap-align: start; }

    /* Confetti */
    .confetti{
      position:absolute; inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .confetti i{
      position:absolute;
      width: 10px; height: 14px;
      border-radius: 3px;
      opacity:.95;
      transform: translateY(-20vh) rotate(0deg);
      animation: confettiFall 1.2s cubic-bezier(.16,1,.3,1) forwards;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.22));
    }
    @keyframes confettiFall{
      to{
        transform: translateY(110vh) rotate(280deg);
        opacity: 0;
      }
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
      ::view-transition-old(main), ::view-transition-new(main){ animation: none !important; }
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Background Scene -->
  <div id="app" class="relative min-h-screen step-1">
    <div class="scene">
      <div class="layer one"></div>

      <!-- Canvas particles (optional, lightweight) -->
      <canvas id="fx" class="absolute inset-0 w-full h-full opacity-80"></canvas>

      <!-- Step 2 Sakura Petals -->
      <div id="petals" class="petals hidden" aria-hidden="true"></div>

      <!-- Step 3 Aura rings -->
      <div id="auraRings" class="aura-rings hidden" aria-hidden="true"></div>

      <!-- Step 4 Bokeh + drifting chat bubbles -->
      <div id="bokeh" class="bokeh hidden" aria-hidden="true"></div>
      <div id="chatDrift" class="hidden" aria-hidden="true">
        <div class="bubble-float" style="left:8%; top:20%;">
          <div class="bubble">âœ¨ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ù†ÙØ³ Ø§Ù„Ø°ÙˆÙ‚â€¦</div>
        </div>
        <div class="bubble-float" style="left:55%; top:32%;">
          <div class="bubble">ğŸ’¬ Ø±Ø³Ø§Ù„Ø© Ù„Ø·ÙŠÙØ©: â€œÙ‡Ù„Ø§!â€</div>
        </div>
        <div class="bubble-float" style="left:18%; top:58%;">
          <div class="bubble">ğŸ’– Ù…ØªØ§Ø¨Ø¹Ø©ØŸ Ù‚Ù„Ø¨ ØµØºÙŠØ± Ùˆâ€¦ ØªÙ…Øª!</div>
        </div>
      </div>

      <!-- Step 5 constellation + ribbons -->
      <div id="constellation" class="constellation hidden" aria-hidden="true"></div>
      <div id="ribbons" class="ribbons hidden" aria-hidden="true"></div>

      <!-- Glitter overlay -->
      <div class="glitter"></div>
    </div>

    <!-- Top header -->
    <header class="relative z-10 px-4 pt-5 pb-3 max-w-xl mx-auto">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl paper grid place-items-center">
            <!-- Minimal star logo -->
            <svg class="mini-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 2l2.2 6.3L21 9l-5.4 4 2 6.5L12 16l-5.6 3.5 2-6.5L3 9l6.8-.7L12 2z"
                    fill="rgba(255,255,255,.92)"/>
            </svg>
          </div>
          <div>
            <div class="text-sm opacity-80">ØªØ¬Ø±Ø¨Ø© â€œÙØµÙ„ Ù…Ø§Ù†ØºØ§ Ù…Ù„ÙˆÙ†â€</div>
            <div class="font-black tracking-tight text-lg">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ âœ¦ Kawaii Motion Comic</div>
          </div>
        </div>

        <div class="hidden sm:flex items-center gap-2">
          <span id="progressText" class="text-sm opacity-75"></span>
        </div>
      </div>

      <div class="mt-3 bubble">
        <div class="flex items-start gap-3">
          <svg class="mini-icon mt-0.5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 21s-7-4.5-9.5-9C.7 8 2.9 5 6.2 5c1.8 0 3.2 1 3.8 2 0 0 .9-2 3.8-2C17.1 5 19.3 8 21.5 12c-2.5 4.5-9.5 9-9.5 9z"
                  fill="rgba(255,255,255,.92)"/>
          </svg>
          <div class="leading-relaxed">
            <div id="chapterLine" class="chapter inline-flex pop" dir="ltr">
              <span class="sticker-dot"></span>
              <span class="font-black">Episode 01 â€” Hello, Senpai!</span>
              <span class="opacity-80 text-xs">Â·</span>
              <span class="opacity-80 text-xs">Glow + Sparkles</span>
            </div>
            <div id="chapterSub" class="mt-2 text-sm opacity-85">
              Ø§Ø¨Ø¯Ø£ ÙØµÙ„ÙÙƒ Ø§Ù„Ø£ÙˆÙ„â€¦ Ø³Ø·Ø±ÙŠÙ†ØŒ ÙˆÙ„Ù…Ø¹Ø© ØµØºÙŠØ±Ø©ØŒ Ø«Ù… Ù†Ø¯Ø®Ù„ Ø¹Ø§Ù„Ù…Ùƒ âœ¨
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main card -->
    <main id="main" class="relative z-10 px-4 pb-28 max-w-xl mx-auto" style="view-transition-name: main;">
      <section class="manga-panel glass p-4 sm:p-5">
        <!-- Step content -->
        <div id="steps">

          <!-- STEP 1 -->
          <section data-step="1" class="stagger">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-black tracking-tight">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª</h2>
              <span class="text-xs opacity-70">Step 1 / 5</span>
            </div>

            <div class="mt-4 grid gap-4">
              <div style="--i:0">
                <label class="label">Ø§Ù„Ø§Ø³Ù… (Nickname)</label>
                <input id="name" class="field" placeholder="Ù…Ø«Ø§Ù„: LuffyDev" autocomplete="nickname" />
              </div>

              <div style="--i:1">
                <label class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input id="email" type="email" class="field" placeholder="you@domain.com" autocomplete="email" />
              </div>

              <div style="--i:2">
                <label class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <div class="relative">
                  <input id="password" type="password" class="field pr-12" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
                  <button id="togglePw" type="button"
                          class="absolute left-2 top-1/2 -translate-y-1/2 btn btn-ghost py-2 px-3 text-sm">
                    Ø¥Ø¸Ù‡Ø§Ø±
                  </button>
                </div>
                <div class="mt-3">
                  <div class="flex items-center justify-between text-xs opacity-80">
                    <span>Ø§Ù„Ù‚ÙˆØ©</span>
                    <span id="pwLabel">â€”</span>
                  </div>
                  <div class="mt-2 h-2 rounded-full bg-white/10 overflow-hidden">
                    <div id="pwBar" class="h-full rounded-full" style="width:0%; background: linear-gradient(90deg, rgba(var(--accent)/1), rgba(var(--accent2)/1));"></div>
                  </div>
                  <div id="pwHint" class="mt-2 text-xs opacity-75">
                    ØªÙ„Ù…ÙŠØ­: Ø·ÙˆÙ‘Ù„Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ù‹Ø§ + Ø±Ù…Ø² + Ø±Ù‚Ù…â€¦ ÙˆØ®Ù„ÙŠÙ‡Ø§ Ø¨Ø·Ø§Ø¨Ø¹Ùƒ ğŸ’«
                  </div>
                </div>
              </div>

              <div style="--i:3" class="bubble">
                <div class="text-sm leading-relaxed">
                  <span class="font-black">Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø·ÙŠÙØ©:</span>
                  Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· Ù„ØªØ¬Ø±Ø¨Ø© Ù…Ø¬ØªÙ…Ø¹Ùƒ â€” Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø§Ù…Ø§ ğŸ™ˆ
                </div>
              </div>
            </div>
          </section>

          <!-- STEP 2 -->
          <section data-step="2" class="hidden stagger">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-black tracking-tight">Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ</h2>
              <span class="text-xs opacity-70">Step 2 / 5</span>
            </div>

            <div class="mt-4 grid gap-4">
              <div style="--i:0">
                <label class="label">Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø©</label>
                <textarea id="bio" class="field min-h-[104px] resize-none"
                          placeholder="Ø£ÙƒØªØ¨ Ø³Ø·Ø±ÙŠÙ†â€¦ Ù…Ø§Ø°Ø§ ØªØ­Ø¨ØŸ Ù…Ø§Ø°Ø§ ØªÙƒØ±Ù‡ØŸ Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„Ùƒ â€˜Ø£Ù†Øªâ€™ØŸ"></textarea>
              </div>

              <div class="grid grid-cols-2 gap-3" style="--i:1">
                <div>
                  <label class="label">Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                  <input id="country" class="field" placeholder="Ù…Ø«Ø§Ù„: ÙÙ„Ø³Ø·ÙŠÙ† / Ù…ØµØ± / Ø§Ù„Ù…ØºØ±Ø¨â€¦" autocomplete="country-name" />
                </div>
                <div>
                  <label class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                  <input id="city" class="field" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø¯Ø³ / Ø¹Ù…Ù‘Ø§Ù† / Ø§Ù„Ø±ÙŠØ§Ø¶â€¦" autocomplete="address-level2" />
                </div>
              </div>

              <div style="--i:2">
                <label class="label">Ù…Ø²Ø§Ø¬Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</label>
                <div class="grid grid-cols-3 gap-2">
                  <button type="button" class="btn mood" data-mood="calm">
                    ğŸŒ¿ Ù‡Ø§Ø¯Ø¦
                  </button>
                  <button type="button" class="btn mood" data-mood="hype">
                    âš¡ Ù…ØªØ­Ù…Ù‘Ø³
                  </button>
                  <button type="button" class="btn mood" data-mood="cozy">
                    â˜• ÙƒÙˆØ²ÙŠ
                  </button>
                </div>
                <div class="mt-2 text-xs opacity-75">
                  Ù‡Ø°Ø§ ÙŠØ¶Ø¨Ø· â€œØ§Ù„ÙÙŠØ¨â€ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹.
                </div>
              </div>

              <div style="--i:3" class="bubble">
                <div class="text-sm leading-relaxed">
                  <span class="font-black">Episode 02 vibe:</span>
                  Ø¨ØªÙ„Ø§Øª Ø³Ø§ÙƒÙˆØ±Ø§â€¦ ÙˆØ·Ø¨Ù‚Ø§Øª Blur Ø®ÙÙŠÙØ©. Ø®Ø° Ù†ÙØ³Ù‹Ø§ ğŸŒ¸
                </div>
              </div>
            </div>
          </section>

          <!-- STEP 3 -->
          <section data-step="3" class="hidden stagger">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-black tracking-tight">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø§Ù„Ø©</h2>
              <span class="text-xs opacity-70">Step 3 / 5</span>
            </div>

            <div class="mt-4 grid gap-4">
              <div style="--i:0" class="paper rounded-2xl p-4">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="font-black">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†</div>
                    <div class="text-xs opacity-75">ØºÙŠÙ‘Ø± Ø§Ù„Ù‡Ø§Ù„Ø©â€¦ ÙŠØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø´Ù‡Ø¯ ÙƒÙ„Ù‡.</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-xs opacity-75">Ù…Ø®ØµØµ</span>
                    <input id="auraPicker" type="color" class="w-10 h-10 rounded-xl overflow-hidden border border-white/20 bg-transparent" value="#ff6cc7" />
                  </div>
                </div>

                <div class="mt-3 grid grid-cols-6 gap-2" id="palette">
                  <!-- palette buttons inserted by JS -->
                </div>
              </div>

              <div style="--i:1" class="grid grid-cols-[1fr_auto] gap-3 items-center">
                <div class="bubble">
                  <div class="text-sm">
                    <span class="font-black">ØªÙ„Ù…ÙŠØ­:</span> Ø§Ø®ØªÙØ± Ù„ÙˆÙ†Ù‹Ø§ ÙŠØ¹Ø¨Ù‘Ø± Ø¹Ù†Ùƒ. â€œAuraâ€ ØªÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„Ù„Ù…Ø¹Ø§Ù†.
                  </div>
                </div>

                <div class="relative w-20 h-20 rounded-3xl paper grid place-items-center overflow-hidden">
                  <div id="auraPreview"
                       class="w-12 h-12 rounded-[20px]"
                       style="box-shadow: var(--ring); background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 45%), linear-gradient(135deg, rgba(var(--accent)/.95), rgba(var(--accent2)/.55));">
                  </div>
                </div>
              </div>

              <div style="--i:2">
                <label class="label">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª â€œØ£Ø³Ù…Ø§Ø¡ Ù‡Ø§Ù„Ø©â€ (ØªØªÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
                <div id="auraLabels" class="flex flex-wrap gap-2"></div>
              </div>

              <div style="--i:3" class="bubble">
                <div class="text-sm leading-relaxed">
                  <span class="font-black">Episode 03 vibe:</span>
                  Ø¯ÙˆØ§Ø¦Ø± Ø·Ø§Ù‚Ø©â€¦ ÙˆØªØºÙŠÙŠØ± ÙÙˆØ±ÙŠ Ù„Ù„Ù‡ÙˆÙŠØ© âœ¦
                </div>
              </div>
            </div>
          </section>

          <!-- STEP 4 -->
          <section data-step="4" class="hidden stagger">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-black tracking-tight">ØªØ§Ø¨Ø¹ ØµØ§Ù†Ø¹ÙŠÙ† Ù„Ø·ÙŠÙÙŠÙ†</h2>
              <span class="text-xs opacity-70">Step 4 / 5</span>
            </div>

            <div class="mt-4 grid gap-4">
              <!-- Featured carousel -->
              <div style="--i:0" class="paper rounded-2xl p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-black">Featured âœ¨</div>
                    <div class="text-xs opacity-75">Ø³Ø­Ø¨ Ø£ÙÙ‚ÙŠâ€¦ Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª.</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="carPrev" type="button" class="btn btn-ghost py-2 px-3 text-sm">â—€</button>
                    <button id="carNext" type="button" class="btn btn-ghost py-2 px-3 text-sm">â–¶</button>
                  </div>
                </div>
                <div id="carousel" class="mt-3 flex gap-3 overflow-x-auto snap-x pb-2">
                  <!-- cards injected -->
                </div>
              </div>

              <div style="--i:1">
                <label class="label">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
                <input id="celebritySearch" class="field" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…â€¦ Ù…Ø«Ù„: Nova / Rina / Kyo" />
              </div>

              <div style="--i:2" class="grid gap-2" id="celebrityList">
                <!-- list injected -->
              </div>

              <div style="--i:3" class="bubble">
                <div class="text-sm leading-relaxed">
                  <span class="font-black">ØªÙØ§Ø¹Ù„ Ø®Ø§Øµ:</span> Ø¹Ù†Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©â€¦ â€œHeart stampâ€ ØµØºÙŠØ± + Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ÙŠØ²ÙŠØ¯ ğŸ’–
                  <div class="mt-2 text-xs opacity-75">
                    Ø§Ù„Ù…ØªØ§Ø¨ÙØ¹ÙˆÙ† Ø§Ù„Ø¢Ù†: <span id="followCount" class="font-black">0</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- STEP 5 -->
          <section data-step="5" class="hidden stagger">
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-xl font-black tracking-tight">DNA Ø§Ù„ÙØ§Ù†Ø¯ÙˆÙ…</h2>
              <span class="text-xs opacity-70">Step 5 / 5</span>
            </div>

            <div class="mt-4 grid gap-4">
              <div style="--i:0" class="paper rounded-2xl p-4">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="font-black">Ø§Ø®ØªÙØ± Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ</div>
                    <div class="text-xs opacity-75">Ø§Ø¶ØºØ· Chipâ€¦ ÙŠÙ„Ù…Ø¹ ÙˆÙŠÙ†ØªÙ‚Ù„ Ø¨Ø³Ù„Ø§Ø³Ø© âœ¦ (layout animation)</div>
                  </div>
                  <div class="text-xs opacity-75">
                    Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…: <span id="interestProg" class="font-black">0</span>%
                  </div>
                </div>

                <div class="mt-3 grid gap-3">
                  <div>
                    <div class="text-sm font-black opacity-90 mb-2">Ø§Ù„ÙØ¦Ø§Øª</div>
                    <div class="flex flex-wrap gap-2" id="cats"></div>
                  </div>

                  <div>
                    <div class="text-sm font-black opacity-90 mb-2">Ù…ØªØ§Ø­</div>
                    <div id="chipPool" class="flex flex-wrap gap-2 min-h-[44px]"></div>
                  </div>

                  <div>
                    <div class="flex items-center justify-between">
                      <div class="text-sm font-black opacity-90">Ù…Ø®ØªØ§Ø± (Ø±ØªÙ‘Ø¨Ù‡ Ø¨Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)</div>
                      <div class="text-xs opacity-70">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„ÙØª Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… â†‘ â†“</div>
                    </div>
                    <div id="selectedChips" class="mt-2 flex flex-col gap-2 min-h-[56px]"></div>
                  </div>
                </div>
              </div>

              <div style="--i:1" class="bubble">
                <div class="text-sm leading-relaxed">
                  <span class="font-black">Episode 05 vibe:</span>
                  ÙƒÙˆÙƒØ¨Ø§Øª Ù†Ø¬ÙˆÙ… + Ø´Ø±Ø§Ø¦Ø· (Ribbons)â€¦ â€œÙ‡Ø°Ø§ Ø£Ù†Ø§â€ Ø¨Ù†Ø¹ÙˆÙ…Ø© ğŸŒŒ
                </div>
              </div>
            </div>
          </section>

          <!-- SUCCESS -->
          <section data-step="6" class="hidden">
            <div class="relative manga-panel paper p-5 overflow-hidden">
              <div class="absolute inset-0 opacity-80" aria-hidden="true"
                   style="background:
                     radial-gradient(900px 700px at 15% 10%, rgba(var(--accent)/.28), transparent 60%),
                     radial-gradient(900px 700px at 88% 25%, rgba(var(--accent2)/.22), transparent 60%),
                     radial-gradient(700px 500px at 50% 110%, rgba(255,255,255,.12), transparent 60%);"></div>

              <div id="confetti" class="confetti" aria-hidden="true"></div>

              <div class="relative z-10">
                <div class="chapter inline-flex" dir="ltr">
                  <span class="sticker-dot"></span>
                  <span class="font-black">Finale â€” Welcome Card</span>
                  <span class="opacity-80 text-xs">Â·</span>
                  <span class="opacity-80 text-xs">Colored Manga Page</span>
                </div>

                <h2 class="mt-3 text-2xl font-black tracking-tight">ØªÙ…Ù‘ Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ùƒ âœ¨</h2>
                <p class="mt-2 text-sm opacity-85 leading-relaxed">
                  Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø¨Ø·Ø§Ù‚Ø© ØªØ±Ø­ÙŠØ¨â€¦ ÙˆØ§Ø­ØªÙØ§Ù„ Ù„Ø·ÙŠÙ (confetti) â€” Ø«Ù… Ù†Ø¨Ø¯Ø£ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©.
                </p>

                <div class="mt-4 glass rounded-2xl p-4">
                  <div class="flex items-center justify-between">
                    <div class="font-black">Ù…Ù„Ø®Øµ</div>
                    <div class="text-xs opacity-75">ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹</div>
                  </div>
                  <div id="summary" class="mt-3 text-sm leading-relaxed opacity-90"></div>
                </div>

                <button id="startBtn" type="button" class="btn btn-primary w-full mt-4">
                  Ø§Ø¨Ø¯Ø£ âœ¦
                </button>

                <div class="mt-3 text-xs opacity-70">
                  Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ ØªØ¬Ø±ÙŠØ¨ÙŠ UI/UX (Ø¨Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ ÙØ¹Ù„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª).
                </div>
              </div>
            </div>
          </section>

        </div>
      </section>

      <!-- Step 3 Avatar section sits better after aura; but requirement says avatar is step 3.
           We'll place avatar as a modal-ish overlay triggered within step 3? No: keep strict steps:
           Step 3 is Avatar; requirement says Step 3 â€œChoose Your Auraâ€ + palette picker.
           Step 3 also must have Avatar upload + grid. We'll add inside Step 3 below palette. -->
      <section id="avatarAddon" class="hidden"></section>
    </main>

    <!-- Sticky bottom nav -->
    <div class="fixed bottom-0 left-0 right-0 z-20 bottom-bar">
      <div class="max-w-xl mx-auto px-4 pb-3 pt-2">
        <div class="flex items-center justify-between gap-3">
          <button id="backBtn" type="button" class="btn btn-ghost w-28">
            Ø±Ø¬ÙˆØ¹
          </button>

          <div class="flex items-center gap-2" aria-label="progress">
            <div class="dot active" data-dot="1"></div>
            <div class="dot" data-dot="2"></div>
            <div class="dot" data-dot="3"></div>
            <div class="dot" data-dot="4"></div>
            <div class="dot" data-dot="5"></div>
          </div>

          <button id="nextBtn" type="button" class="btn btn-primary w-28">
            Ø§Ù„ØªØ§Ù„ÙŠ
          </button>
        </div>

        <div id="error" class="mt-2 text-xs text-white/80 hidden">
          <span class="inline-flex items-center gap-2 bubble py-2 px-3">
            <span>âš ï¸</span>
            <span id="errorMsg">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Tiny helpers ----------
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const prefersReducedMotion = matchMedia('(prefers-reduced-motion: reduce)').matches;

    // ---------- App state ----------
    const state = {
      step: 1,
      name: '',
      email: '',
      password: '',
      bio: '',
      country: '',
      city: '',
      mood: '',
      aura: '#ff6cc7',
      auraName: '',
      avatar: { kind: 'preset', id: null, dataUrl: null, label: '' },
      followed: new Set(),
      category: 'Anime',
      interests: [], // ordered array
    };

    // ---------- Episode meta ----------
    const episodes = {
      1: { title: 'Episode 01 â€” Hello, Senpai!', tag: 'Glow + Sparkles', sub: 'Ø§Ø¨Ø¯Ø£ ÙØµÙ„ÙÙƒ Ø§Ù„Ø£ÙˆÙ„â€¦ Ø³Ø·Ø±ÙŠÙ†ØŒ ÙˆÙ„Ù…Ø¹Ø© ØµØºÙŠØ±Ø©ØŒ Ø«Ù… Ù†Ø¯Ø®Ù„ Ø¹Ø§Ù„Ù…Ùƒ âœ¨' },
      2: { title: 'Episode 02 â€” About You', tag: 'Sakura + Blur Layers', sub: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø³ÙŠØ·Ø©â€¦ ÙƒØ£Ù†Ù‡Ø§ ØµÙØ­Ø© Ù…Ø§Ù†ØºØ§ Ø¯Ø§ÙØ¦Ø© ğŸŒ¸' },
      3: { title: 'Episode 03 â€” Choose Your Aura', tag: 'Aura Rings + Palette', sub: 'Ø§Ù„Ù‡Ø§Ù„Ø© ØªØºÙŠÙ‘Ø± Ø§Ù„Ù‚ØµØ©â€¦ Ø§Ø®ØªØ± Ù„ÙˆÙ†Ùƒ Ùˆâ€ØµÙˆØ±ØªÙƒâ€ âœ¦' },
      4: { title: 'Episode 04 â€” Make Friends', tag: 'Bokeh + Chat Drift', sub: 'ØªØ§Ø¨Ø¹ ØµØ§Ù†Ø¹ÙŠÙ† Ù„Ø·ÙŠÙÙŠÙ†â€¦ ØµØ¯Ø§Ù‚Ø§Øª ØªØ¨Ø¯Ø£ Ø¨Ù‚Ù„Ø¨ ØµØºÙŠØ± ğŸ’–' },
      5: { title: 'Episode 05 â€” Your Fandom DNA', tag: 'Constellation + Ribbons', sub: 'Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ Ù†Ø¬ÙˆÙ…â€¦ Ø±ØªÙ‘Ø¨Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± Ù‡ÙˆÙŠØªÙƒ ğŸŒŒ' },
      6: { title: 'Finale â€” Welcome Card', tag: 'Confetti', sub: 'ØªÙ…! Ø¨Ø·Ø§Ù‚Ø© ØªØ±Ø­ÙŠØ¨â€¦ ÙˆÙ„Ù‚Ø·Ø© Ø£Ø®ÙŠØ±Ø© Ù…Ø¨Ù‡Ø±Ø© âœ¨' },
    };

    // ---------- DOM refs ----------
    const app = $('#app');
    const main = $('#main');
    const stepsRoot = $('#steps');
    const chapterLine = $('#chapterLine');
    const chapterSub = $('#chapterSub');
    const progressText = $('#progressText');

    const backBtn = $('#backBtn');
    const nextBtn = $('#nextBtn');
    const errorBox = $('#error');
    const errorMsg = $('#errorMsg');

    // Inputs
    const nameEl = $('#name');
    const emailEl = $('#email');
    const pwEl = $('#password');
    const togglePw = $('#togglePw');
    const pwBar = $('#pwBar');
    const pwLabel = $('#pwLabel');
    const pwHint = $('#pwHint');

    const bioEl = $('#bio');
    const countryEl = $('#country');
    const cityEl = $('#city');

    const auraPicker = $('#auraPicker');
    const palette = $('#palette');
    const auraLabels = $('#auraLabels');
    const auraPreview = $('#auraPreview');

    const followCountEl = $('#followCount');
    const celebSearch = $('#celebritySearch');
    const celebList = $('#celebrityList');
    const carousel = $('#carousel');
    const carPrev = $('#carPrev');
    const carNext = $('#carNext');

    const cats = $('#cats');
    const chipPool = $('#chipPool');
    const selectedChips = $('#selectedChips');
    const interestProg = $('#interestProg');

    const startBtn = $('#startBtn');
    const summaryEl = $('#summary');
    const confettiEl = $('#confetti');

    // Background layers toggles
    const petalsWrap = $('#petals');
    const auraRings = $('#auraRings');
    const bokeh = $('#bokeh');
    const chatDrift = $('#chatDrift');
    const constellation = $('#constellation');
    const ribbons = $('#ribbons');

    // ---------- Step 3 Avatar block (inject to keep the layout clean) ----------
    // Requirement says step 3 has upload + grid avatars + suggestions + preview.
    (function injectAvatarIntoStep3(){
      const step3 = $('[data-step="3"]');
      const block = document.createElement('div');
      block.className = 'mt-4 grid gap-4';
      block.innerHTML = `
        <div class="paper rounded-2xl p-4" style="--i:2">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black">Ø§Ù„Ø£ÙØ§ØªØ§Ø±</div>
              <div class="text-xs opacity-75">Ø§Ø®ØªØ± Avatar ØªØ¬Ø±ÙŠØ¯ÙŠâ€¦ Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).</div>
            </div>
            <label class="btn btn-ghost py-2 px-3 text-sm cursor-pointer">
              Ø±ÙØ¹
              <input id="avatarUpload" type="file" accept="image/*" class="hidden" />
            </label>
          </div>

          <div class="mt-3 grid grid-cols-[92px_1fr] gap-3 items-start">
            <div class="relative w-[92px] h-[92px] rounded-3xl paper overflow-hidden grid place-items-center">
              <div id="avatarPreview" class="w-[58px] h-[58px] rounded-[22px] overflow-hidden"
                   style="box-shadow: var(--ring); background: rgba(0,0,0,.25); display:grid; place-items:center;"></div>
              <div class="absolute inset-0 pointer-events-none" style="background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.20), transparent 55%);"></div>
            </div>

            <div class="bubble">
              <div class="text-sm leading-relaxed">
                <span class="font-black">ØªÙØ§Ø¹Ù„ Ø®Ø§Øµ:</span>
                Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ§ØªØ§Ø±â€¦ <span class="opacity-90">Aura ring + Sparkle burst</span> âœ¨
                <div class="mt-2 text-xs opacity-70">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (ØªØªÙˆÙ„Ø¯): <span id="avatarLabels"></span></div>
              </div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-4 gap-2" id="avatarGrid"></div>
        </div>
      `;
      step3.appendChild(block);
    })();

    const avatarGrid = $('#avatarGrid');
    const avatarPreviewEl = $('#avatarPreview');
    const avatarUpload = $('#avatarUpload');
    const avatarLabelsEl = $('#avatarLabels');

    // ---------- Palette + labels ----------
    const paletteColors = ['#ff6cc7','#7affeb','#a1f7ff','#ffbf66','#b59cff','#ff7a8a','#7ad0ff','#ffd3f2','#8dffb8','#fff099','#a9b7ff','#f7a9ff'];

    function setAccent(hex){
      state.aura = hex;
      // derive accent2 as a gentle complement-ish by rotating hue a bit
      const {r,g,b} = hexToRgb(hex);
      document.documentElement.style.setProperty('--accent', `${r} ${g} ${b}`);
      const alt = shiftHue(hex, 55);
      const altRgb = hexToRgb(alt);
      document.documentElement.style.setProperty('--accent2', `${altRgb.r} ${altRgb.g} ${altRgb.b}`);

      auraPicker.value = hex;
      auraPreview.style.boxShadow = getComputedStyle(document.documentElement).getPropertyValue('--ring');
      regenAuraLabels();
      regenAvatarLabels();
      // refresh particles palette
      fx.setTheme(hex, alt);
    }

    function hexToRgb(hex){
      const h = hex.replace('#','').trim();
      const full = h.length === 3 ? h.split('').map(x=>x+x).join('') : h;
      const n = parseInt(full, 16);
      return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
    }

    function rgbToHex(r,g,b){
      const to = (v)=> v.toString(16).padStart(2,'0');
      return `#${to(clamp(r,0,255))}${to(clamp(g,0,255))}${to(clamp(b,0,255))}`;
    }

    // Very small hue shift utility (approx via HSL)
    function shiftHue(hex, degrees){
      const {r,g,b} = hexToRgb(hex);
      const hsl = rgbToHsl(r,g,b);
      hsl.h = (hsl.h + degrees) % 360;
      const rgb = hslToRgb(hsl.h, hsl.s, hsl.l);
      return rgbToHex(rgb.r, rgb.g, rgb.b);
    }
    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0, s=0, l=(max+min)/2;
      if(max!==min){
        const d = max-min;
        s = l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h = (g-b)/d + (g<b?6:0); break;
          case g: h = (b-r)/d + 2; break;
          case b: h = (r-g)/d + 4; break;
        }
        h *= 60;
      }
      return {h,s,l};
    }
    function hslToRgb(h,s,l){
      const c = (1 - Math.abs(2*l - 1)) * s;
      const x = c * (1 - Math.abs((h/60) % 2 - 1));
      const m = l - c/2;
      let r=0,g=0,b=0;
      if(h<60){ r=c; g=x; b=0; }
      else if(h<120){ r=x; g=c; b=0; }
      else if(h<180){ r=0; g=c; b=x; }
      else if(h<240){ r=0; g=x; b=c; }
      else if(h<300){ r=x; g=0; b=c; }
      else { r=c; g=0; b=x; }
      return { r: Math.round((r+m)*255), g: Math.round((g+m)*255), b: Math.round((b+m)*255) };
    }

    function regenAuraLabels(){
      const base = [
        'Cotton Candy Pulse','Moonlight Mint','Sakura Neon','Pixel Bloom',
        'Soft Stardust','Skyline Glow','Kawaii Prism','Velvet Spark'
      ];
      const seed = (state.name + state.email + state.aura).split('').reduce((a,c)=>a + c.charCodeAt(0), 0);
      const pick = (i)=> base[(seed + i*7) % base.length];
      auraLabels.innerHTML = '';
      for(let i=0;i<5;i++){
        const b = document.createElement('button');
        b.type='button';
        b.className='chip';
        b.innerHTML = `<span class="shine"></span><span dir="ltr" class="font-black text-sm">${pick(i)}</span>`;
        b.addEventListener('click', ()=>{
          state.auraName = pick(i);
          $$('.chip', auraLabels).forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
        });
        auraLabels.appendChild(b);
      }
    }

    function regenAvatarLabels(){
      const adjectives = ['Gentle','Mischief','Cozy','Electric','Dreamy','Brave','Soft','Spark'];
      const nouns = ['Comet','Ribbon','Petal','Pixel','Star','Boba','Cloud','Aura'];
      const seed = (state.aura + state.mood + state.city).split('').reduce((a,c)=>a + c.charCodeAt(0), 0);
      const a = adjectives[seed % adjectives.length];
      const n = nouns[(seed*3) % nouns.length];
      const a2 = adjectives[(seed*5) % adjectives.length];
      const n2 = nouns[(seed*7) % nouns.length];
      avatarLabelsEl.innerHTML = `<span dir="ltr" class="font-black">${a} ${n}</span> Â· <span dir="ltr" class="font-black">${a2} ${n2}</span>`;
    }

    // Build palette buttons
    (function initPalette(){
      palette.innerHTML = '';
      paletteColors.forEach((hex)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-9 h-9 rounded-2xl border border-white/15 hover:border-white/30 transition pop';
        btn.style.background = `linear-gradient(135deg, ${hex}, ${shiftHue(hex, 40)})`;
        btn.title = hex;
        btn.addEventListener('click', ()=> setAccent(hex));
        palette.appendChild(btn);
      });
    })();

    auraPicker.addEventListener('input', (e)=> setAccent(e.target.value));

    // ---------- Step 1 Password strength ----------
    function scorePassword(pw){
      let score = 0;
      if(!pw) return 0;
      const len = pw.length;
      score += clamp((len - 6) * 8, 0, 35); // length
      if(/[A-Z]/.test(pw)) score += 15;
      if(/[a-z]/.test(pw)) score += 10;
      if(/[0-9]/.test(pw)) score += 15;
      if(/[^A-Za-z0-9]/.test(pw)) score += 20;
      // penalize repeats
      if(/(.)\1\1/.test(pw)) score -= 10;
      return clamp(score, 0, 100);
    }
    function updatePwUI(){
      const pw = pwEl.value;
      state.password = pw;
      const s = scorePassword(pw);
      pwBar.style.width = s + '%';
      let label = 'Ø¶Ø¹ÙŠÙØ©';
      let hint = 'Ø­Ø§ÙˆÙ„ ØªØ²ÙŠØ¯ Ø§Ù„Ø·ÙˆÙ„â€¦ ÙˆØ£Ø¶Ù Ø±Ù‚Ù… + Ø±Ù…Ø² âœ¨';
      if(s >= 80){ label = 'Ù…Ù…ØªØ§Ø²Ø©'; hint = 'ÙƒØ£Ù†Ù‡Ø§ â€œÙ‡Ø§Ù„Ø© Ù‚ÙˆÙŠØ©â€ â€” Ù…Ù…ØªØ§Ø² ğŸ’«'; }
      else if(s >= 55){ label = 'Ø¬ÙŠØ¯Ø©'; hint = 'Ø¨Ø§Ù‚ÙŠ Ù„Ù…Ø³Ø© Ø¨Ø³ÙŠØ·Ø©â€¦ Ø±Ù…Ø² Ø£Ùˆ Ø·ÙˆÙ„ Ø£ÙƒØ«Ø± âœ¦'; }
      else if(s >= 30){ label = 'Ù…ØªÙˆØ³Ø·Ø©'; hint = 'Ø£Ø¶Ù Ø±Ù‚Ù…/Ø±Ù…Ø² + Ø·ÙˆÙ„ Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ù‹Ø§ ğŸŒ™'; }
      pwLabel.textContent = label;
      pwHint.textContent = 'ØªÙ„Ù…ÙŠØ­: ' + hint;
    }

    pwEl.addEventListener('input', updatePwUI);
    togglePw.addEventListener('click', ()=>{
      const isPw = pwEl.type === 'password';
      pwEl.type = isPw ? 'text' : 'password';
      togglePw.textContent = isPw ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±';
    });

    // ---------- Step 2 mood buttons ----------
    function setMood(m){
      state.mood = m;
      $$('.mood').forEach(btn => {
        btn.classList.toggle('btn-primary', btn.dataset.mood === m);
        btn.classList.toggle('btn-ghost', btn.dataset.mood !== m);
      });
    }
    $$('.mood').forEach(btn => btn.addEventListener('click', ()=> setMood(btn.dataset.mood)));

    // ---------- Step 3 Avatars (generated SVG) ----------
    function makeAvatarSVG(seed, size=56){
      // Abstract: gradient blob + pattern lines; deterministic from seed
      const rnd = mulberry32(seed);
      const h1 = Math.floor(rnd()*360);
      const h2 = (h1 + 60 + Math.floor(rnd()*120)) % 360;
      const c1 = `hsl(${h1} 90% 70%)`;
      const c2 = `hsl(${h2} 90% 68%)`;
      const a = 0.65 + rnd()*0.25;
      const b = 0.55 + rnd()*0.30;
      const c = 0.60 + rnd()*0.25;

      const path = blobPath(rnd, 28, 28, 20, 8);
      const stripeRot = Math.floor(rnd()*90);
      const stripe = `
        <g opacity=".35" transform="rotate(${stripeRot} 28 28)">
          ${Array.from({length: 7}).map((_,i)=>`<rect x="${-10+i*10}" y="-10" width="4" height="80" rx="2" fill="rgba(255,255,255,.9)"/>`).join('')}
        </g>`;
      return `
        <svg width="${size}" height="${size}" viewBox="0 0 56 56" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="${c1}"/>
              <stop offset="1" stop-color="${c2}"/>
            </linearGradient>
            <radialGradient id="glow" cx=".25" cy=".2" r="1">
              <stop offset="0" stop-color="rgba(255,255,255,.75)"/>
              <stop offset=".5" stop-color="rgba(255,255,255,.18)"/>
              <stop offset="1" stop-color="rgba(255,255,255,0)"/>
            </radialGradient>
          </defs>
          <rect x="0" y="0" width="56" height="56" rx="20" fill="rgba(0,0,0,.22)"/>
          <path d="${path}" fill="url(#g)" opacity="${a}"/>
          <path d="${blobPath(rnd, 28, 28, 14, 7)}" fill="rgba(255,255,255,.25)" opacity="${b}"/>
          ${stripe}
          <circle cx="16" cy="14" r="18" fill="url(#glow)" opacity="${c}"/>
        </svg>
      `;
    }

    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }
    function blobPath(rnd, cx, cy, r, points){
      const step = (Math.PI * 2) / points;
      let d = '';
      for(let i=0;i<points;i++){
        const ang = i * step;
        const wobble = r * (0.75 + rnd()*0.45);
        const x = cx + Math.cos(ang) * wobble;
        const y = cy + Math.sin(ang) * wobble;
        d += (i===0 ? `M ${x.toFixed(2)} ${y.toFixed(2)}` : ` L ${x.toFixed(2)} ${y.toFixed(2)}`);
      }
      d += ' Z';
      return d;
    }

    function renderAvatars(){
      avatarGrid.innerHTML = '';
      const baseSeed = (state.name + state.aura).split('').reduce((a,c)=>a + c.charCodeAt(0), 0) || 1337;
      const labels = ['Nova','Rina','Kyo','Mika','Yuzu','Sora','Ami','Nami','Ena','Hana','Lune','Kiri'];
      for(let i=0;i<12;i++){
        const id = i;
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'avatar-card';
        card.dataset.avatarId = id;
        card.innerHTML = `
          <div class="aura"></div>
          <div class="grid place-items-center">${makeAvatarSVG(baseSeed + i*97)}</div>
          <div class="mt-1 text-[11px] opacity-80 font-bold" dir="ltr">${labels[i]}</div>
        `;
        card.addEventListener('click', ()=>{
          selectAvatarPreset(id, card, labels[i]);
        });
        avatarGrid.appendChild(card);
      }
      // default selection if none
      if(state.avatar.kind === 'preset' && state.avatar.id != null){
        const el = avatarGrid.querySelector(`[data-avatar-id="${state.avatar.id}"]`);
        if(el) selectAvatarPreset(state.avatar.id, el, state.avatar.label, false);
      } else {
        const first = avatarGrid.querySelector('[data-avatar-id="0"]');
        if(first) selectAvatarPreset(0, first, 'Nova', false);
      }
    }

    function selectAvatarPreset(id, card, label, burst=true){
      state.avatar = { kind: 'preset', id, dataUrl: null, label };
      $$('.avatar-card', avatarGrid).forEach(x=>x.classList.remove('selected'));
      card.classList.add('selected');

      // preview
      avatarPreviewEl.innerHTML = makeAvatarSVG( (state.name + state.aura + id).split('').reduce((a,c)=>a + c.charCodeAt(0), 0) || 2025, 58);

      // aura ring pulse + sparkle burst
      if(burst && !prefersReducedMotion){
        sparkleBurst(card);
      }
    }

    function sparkleBurst(target){
      const rect = target.getBoundingClientRect();
      const parentRect = target.getBoundingClientRect();
      const count = 12;
      for(let i=0;i<count;i++){
        const s = document.createElement('span');
        s.className = 'spark';
        const angle = (Math.PI*2) * (i/count);
        const dist = 26 + Math.random()*18;
        s.style.setProperty('--dx', `${Math.cos(angle)*dist}px`);
        s.style.setProperty('--dy', `${Math.sin(angle)*dist}px`);
        s.style.left = (parentRect.width/2 + (Math.random()*10-5)) + 'px';
        s.style.top = (parentRect.height/2 + (Math.random()*10-5)) + 'px';
        target.appendChild(s);
        s.addEventListener('animationend', ()=> s.remove(), {once:true});
      }
      // tiny bounce
      target.animate([{transform:'translateY(0) scale(1)'},{transform:'translateY(-2px) scale(1.01)'},{transform:'translateY(0) scale(1)'}],
        {duration: 420, easing: 'cubic-bezier(.16,1,.3,1)'});
    }

    avatarUpload?.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        state.avatar = { kind:'upload', id:null, dataUrl: reader.result, label:'Upload' };
        $$('.avatar-card', avatarGrid).forEach(x=>x.classList.remove('selected'));
        avatarPreviewEl.innerHTML = `
          <img src="${state.avatar.dataUrl}" alt="avatar" class="w-full h-full object-cover" />
        `;
        // sparkle on preview container
        const holder = avatarPreviewEl.parentElement;
        if(holder && !prefersReducedMotion) sparkleBurst(holder);
      };
      reader.readAsDataURL(file);
    });

    // ---------- Step 4 Celebrities + Follow interaction ----------
    const celebrities = [
      { id:'nova', name:'Nova Sketch', tag:'Illustrator', vibe:'Minimal ink + cute' },
      { id:'rina', name:'Rina Panel', tag:'Manga Editor', vibe:'Story beats' },
      { id:'kyo',  name:'Kyo Motion', tag:'Motion Artist', vibe:'Bouncy UI' },
      { id:'mika', name:'Mika Chibi Lab', tag:'Sticker Maker', vibe:'Tiny joy' },
      { id:'yuzu', name:'Yuzu ColorMesh', tag:'Colorist', vibe:'Dream gradients' },
      { id:'sora', name:'Sora Sound', tag:'Lo-fi Vibes', vibe:'Cozy loops' },
      { id:'ena',  name:'Ena Comics', tag:'Writer', vibe:'Slice of life' },
      { id:'hana', name:'Hana Sakura', tag:'Creator', vibe:'Soft bloom' },
      { id:'lune', name:'Lune Bokeh', tag:'Photomood', vibe:'Glow scenes' },
    ];

    function renderCelebs(filter=''){
      const q = filter.trim().toLowerCase();
      const list = celebrities.filter(c => (c.name + ' ' + c.tag + ' ' + c.vibe).toLowerCase().includes(q));
      celebList.innerHTML = '';
      list.forEach((c, idx)=>{
        const followed = state.followed.has(c.id);
        const row = document.createElement('div');
        row.className = 'paper rounded-2xl p-3 flex items-center justify-between gap-3 relative overflow-hidden';
        row.innerHTML = `
          <div class="min-w-0">
            <div class="font-black truncate" dir="ltr">${c.name}</div>
            <div class="text-xs opacity-75 truncate">${c.tag} Â· ${c.vibe}</div>
          </div>
          <button type="button" class="btn ${followed ? 'btn-primary' : 'btn-ghost'} py-2 px-3 text-sm shrink-0" data-follow="${c.id}">
            ${followed ? 'Ù…ØªØ§Ø¨ÙØ¹' : 'ØªØ§Ø¨ÙØ¹'}
          </button>
        `;
        const btn = row.querySelector('[data-follow]');
        btn.addEventListener('click', (e)=>{
          const id = btn.dataset.follow;
          const was = state.followed.has(id);
          if(was) state.followed.delete(id);
          else state.followed.add(id);

          // stamp heart + counter
          if(!was && !prefersReducedMotion){
            const stamp = document.createElement('div');
            stamp.className = 'heart-stamp';
            stamp.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 21s-7-4.5-9.5-9C.7 8 2.9 5 6.2 5c1.8 0 3.2 1 3.8 2 0 0 .9-2 3.8-2C17.1 5 19.3 8 21.5 12c-2.5 4.5-9.5 9-9.5 9z"
                      fill="rgba(255,255,255,.95)"/>
              </svg>
            `;
            row.appendChild(stamp);
            stamp.addEventListener('animationend', ()=> stamp.remove(), {once:true});
          }

          followCountEl.textContent = String(state.followed.size);
          renderCelebs(celebSearch.value);
          renderCarousel(); // update tags
        });
        celebList.appendChild(row);
      });

      followCountEl.textContent = String(state.followed.size);
    }

    celebSearch?.addEventListener('input', ()=> renderCelebs(celebSearch.value));

    // Featured carousel
    function renderCarousel(){
      const featured = celebrities.slice(0, 6);
      carousel.innerHTML = '';
      featured.forEach((c)=>{
        const isF = state.followed.has(c.id);
        const card = document.createElement('div');
        card.className = 'min-w-[220px] snap-start paper rounded-2xl p-3 flex flex-col gap-2 relative overflow-hidden';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="chapter inline-flex text-xs" dir="ltr">
              <span class="sticker-dot"></span>
              <span class="font-black">${c.tag}</span>
            </div>
            <span class="text-xs opacity-70">${isF ? 'ğŸ’–' : 'âœ¦'}</span>
          </div>
          <div class="font-black text-lg" dir="ltr">${c.name}</div>
          <div class="text-xs opacity-75">${c.vibe}</div>
          <button type="button" class="btn ${isF ? 'btn-primary' : 'btn-ghost'} py-2 px-3 text-sm mt-1" data-follow="${c.id}">
            ${isF ? 'Ù…ØªØ§Ø¨ÙØ¹' : 'ØªØ§Ø¨ÙØ¹'}
          </button>
        `;
        card.querySelector('[data-follow]').addEventListener('click', ()=>{
          const was = state.followed.has(c.id);
          if(was) state.followed.delete(c.id);
          else state.followed.add(c.id);

          followCountEl.textContent = String(state.followed.size);
          renderCarousel();
          renderCelebs(celebSearch.value);
        });
        carousel.appendChild(card);
      });
    }

    function scrollCarousel(dir){
      const card = carousel.firstElementChild;
      if(!card) return;
      const w = card.getBoundingClientRect().width + 12;
      carousel.scrollBy({ left: dir * w, behavior: 'smooth' });
    }
    carPrev?.addEventListener('click', ()=> scrollCarousel(-1));
    carNext?.addEventListener('click', ()=> scrollCarousel(1));

    // ---------- Step 5 Interests (chips + categories + priority reorder) ----------
    const interestData = {
      'Anime': ['ShÅjo', 'ShÅnen', 'Seinen', 'Slice of Life', 'Isekai', 'Mecha', 'Sports', 'Fantasy', 'Romance', 'Mystery'],
      'Comics': ['Webtoon', 'Manga', 'Indie', 'Superhero', 'Sci-Fi', 'Drama', 'Comedy', 'One-shots'],
      'Creators': ['Fanart', 'AMV', 'Motion Comics', 'Coloring', 'Writing', 'Cosplay', 'Editing', 'Memes'],
      'Culture': ['J-Pop', 'K-Pop', 'Lo-fi', 'Collectibles', 'Events', 'Roleplay', 'Voice Acting'],
    };

    const categoryList = Object.keys(interestData);

    function renderCategories(){
      cats.innerHTML = '';
      categoryList.forEach(cat=>{
        const b = document.createElement('button');
        b.type='button';
        b.className = 'chip ' + (state.category === cat ? 'selected' : '');
        b.innerHTML = `<span class="shine"></span><span class="font-black">${cat}</span>`;
        b.addEventListener('click', ()=>{
          state.category = cat;
          renderCategories();
          renderChipPool();
        });
        cats.appendChild(b);
      });
    }

    function makeChip(text){
      const el = document.createElement('div');
      el.className = 'chip';
      el.draggable = false;
      el.dataset.value = text;
      el.innerHTML = `<span class="shine"></span><span dir="ltr" class="font-black text-sm">${text}</span>`;
      return el;
    }

    function animateFLIP(moveEl, firstRect, lastRect){
      if(prefersReducedMotion) return;
      const dx = firstRect.left - lastRect.left;
      const dy = firstRect.top - lastRect.top;
      const sx = firstRect.width / lastRect.width;
      const sy = firstRect.height / lastRect.height;
      moveEl.animate([
        { transform: `translate(${dx}px, ${dy}px) scale(${sx}, ${sy})` },
        { transform: 'translate(0,0) scale(1,1)' }
      ], { duration: 520, easing: 'cubic-bezier(.16,1,.3,1)' });
    }

    function renderChipPool(){
      chipPool.innerHTML = '';
      const available = (interestData[state.category] || []).filter(x => !state.interests.includes(x));
      available.forEach((t)=>{
        const chip = makeChip(t);
        chip.addEventListener('click', ()=>{
          // smooth layout animation: pool -> selected
          const first = chip.getBoundingClientRect();
          state.interests.push(t);
          renderChipPool();
          renderSelectedChips(() => {
            const newEl = selectedChips.querySelector(`[data-value="${cssEscape(t)}"]`);
            if(newEl){
              const last = newEl.getBoundingClientRect();
              animateFLIP(newEl, first, last);
              newEl.classList.add('selected');
              // tiny shine wiggle
              if(!prefersReducedMotion){
                newEl.animate(
                  [{transform:'translateY(0) scale(1)'},{transform:'translateY(-2px) scale(1.02)'},{transform:'translateY(0) scale(1)'}],
                  {duration: 420, easing: 'cubic-bezier(.16,1,.3,1)'}
                );
              }
            }
            updateInterestProgress();
          });
        });
        chipPool.appendChild(chip);
      });
      updateInterestProgress();
    }

    function renderSelectedChips(after){
      selectedChips.innerHTML = '';
      if(state.interests.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-xs opacity-70 bubble';
        empty.textContent = 'Ø§Ø®ØªØ± Chip Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰â€¦ ÙˆØ³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©.';
        selectedChips.appendChild(empty);
        after?.();
        return;
      }

      state.interests.forEach((t, idx)=>{
        const row = document.createElement('div');
        row.className = 'paper rounded-2xl p-2 flex items-center justify-between gap-2';
        row.draggable = true;
        row.dataset.value = t;
        row.innerHTML = `
          <div class="flex items-center gap-2 min-w-0">
            <div class="w-8 h-8 rounded-2xl paper grid place-items-center font-black">${idx+1}</div>
            <div class="chip selected pointer-events-none">
              <span class="shine"></span>
              <span dir="ltr" class="font-black text-sm">${t}</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="btn btn-ghost py-2 px-3 text-sm" data-up="1">â†‘</button>
            <button type="button" class="btn btn-ghost py-2 px-3 text-sm" data-down="1">â†“</button>
            <button type="button" class="btn btn-ghost py-2 px-3 text-sm" data-remove="1">âœ•</button>
          </div>
        `;

        // up/down/remove
        row.querySelector('[data-up]').addEventListener('click', ()=>{
          if(idx === 0) return;
          swapInterests(idx, idx-1);
        });
        row.querySelector('[data-down]').addEventListener('click', ()=>{
          if(idx === state.interests.length-1) return;
          swapInterests(idx, idx+1);
        });
        row.querySelector('[data-remove]').addEventListener('click', ()=>{
          state.interests = state.interests.filter(x=>x!==t);
          renderChipPool();
          renderSelectedChips();
          updateInterestProgress();
        });

        // drag reorder
        row.addEventListener('dragstart', (e)=>{
          e.dataTransfer.setData('text/plain', t);
          e.dataTransfer.effectAllowed = 'move';
          row.classList.add('opacity-70');
        });
        row.addEventListener('dragend', ()=> row.classList.remove('opacity-70'));
        row.addEventListener('dragover', (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        row.addEventListener('drop', (e)=>{
          e.preventDefault();
          const fromVal = e.dataTransfer.getData('text/plain');
          if(!fromVal || fromVal === t) return;
          const from = state.interests.indexOf(fromVal);
          const to = state.interests.indexOf(t);
          if(from < 0 || to < 0) return;
          const next = state.interests.slice();
          next.splice(to, 0, next.splice(from, 1)[0]);
          state.interests = next;
          renderSelectedChips();
          updateInterestProgress();
        });

        selectedChips.appendChild(row);
      });

      after?.();
    }

    function swapInterests(i, j){
      const firstRects = $$('[data-value]', selectedChips).map(el => ({ key: el.dataset.value, rect: el.getBoundingClientRect() }));
      const arr = state.interests.slice();
      [arr[i], arr[j]] = [arr[j], arr[i]];
      state.interests = arr;
      renderSelectedChips(()=>{
        // FLIP animate rows after reorder
        if(prefersReducedMotion) return;
        const rows = $$('[data-value]', selectedChips);
        rows.forEach(el=>{
          const old = firstRects.find(x=>x.key === el.dataset.value)?.rect;
          if(old){
            const now = el.getBoundingClientRect();
            animateFLIP(el, old, now);
          }
        });
      });
      updateInterestProgress();
    }

    function updateInterestProgress(){
      const max = 10;
      const pct = clamp(Math.round((state.interests.length / max) * 100), 0, 100);
      interestProg.textContent = String(pct);
    }

    function cssEscape(s){
      // minimal
      return s.replace(/["\\]/g, '\\$&');
    }

    // ---------- Step navigation + validation ----------
    function showError(msg){
      errorMsg.textContent = msg;
      errorBox.classList.remove('hidden');
      if(!prefersReducedMotion){
        errorBox.animate([{transform:'translateY(6px)', opacity:0},{transform:'translateY(0)', opacity:1}],
          {duration: 260, easing:'cubic-bezier(.16,1,.3,1)'});
      }
    }
    function clearError(){ errorBox.classList.add('hidden'); }

    function validateStep(step){
      clearError();
      if(step === 1){
        state.name = nameEl.value.trim();
        state.email = emailEl.value.trim();
        state.password = pwEl.value;
        if(!state.name) return showError('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‹Ø§ Ù„Ø·ÙŠÙÙ‹Ø§ (Nickname).'), false;
        if(!/^\S+@\S+\.\S+$/.test(state.email)) return showError('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§.'), false;
        if(scorePassword(state.password) < 35) return showError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ù‹Ø§. Ù‚ÙˆÙ‘Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ù‹Ø§.'), false;
      }
      if(step === 2){
        state.bio = (bioEl?.value || '').trim();
        state.country = (countryEl?.value || '').trim();
        state.city = (cityEl?.value || '').trim();
        if(state.bio.length < 10) return showError('Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø© (10 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).'), false;
        if(!state.country) return showError('Ø§Ø®ØªØ± Ø¯ÙˆÙ„Ø©.'), false;
        if(!state.city) return showError('Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø©.'), false;
        if(!state.mood) return showError('Ø§Ø®ØªØ± Ù…Ø²Ø§Ø¬Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§.'), false;
      }
      if(step === 3){
        // Aura + avatar must be chosen
        if(!state.aura) return showError('Ø§Ø®ØªØ± Ù„ÙˆÙ† Ù‡Ø§Ù„Ø©.'), false;
        if(state.avatar.kind === 'preset' && state.avatar.id == null) return showError('Ø§Ø®ØªØ± Ø£ÙØ§ØªØ§Ø±Ù‹Ø§ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©.'), false;
        if(!state.auraName) {
          // not required, but nudge
          state.auraName = 'Kawaii Prism';
        }
      }
      if(step === 4){
        // Allow 0 follows, but encourage
        if(state.followed.size === 0) {
          // soft warning only
          // still pass
        }
      }
      if(step === 5){
        if(state.interests.length < 3) return showError('Ø§Ø®ØªØ± 3 Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ù†Ø§Ø¡ DNA.'), false;
      }
      return true;
    }

    function setStep(step){
      state.step = step;

      // Step classes (background)
      app.classList.remove('step-1','step-2','step-3','step-4','step-5');
      if(step <= 5) app.classList.add('step-' + step);

      // Show relevant step
      $$('[data-step]', stepsRoot).forEach(sec=>{
        const s = Number(sec.dataset.step);
        sec.classList.toggle('hidden', s !== step);
      });

      // Buttons
      backBtn.disabled = step === 1 || step === 6;
      backBtn.style.opacity = backBtn.disabled ? .55 : 1;

      nextBtn.classList.toggle('hidden', step === 6);
      backBtn.classList.toggle('hidden', step === 6);
      $$('.dot').forEach(d=>{
        const n = Number(d.dataset.dot);
        d.classList.toggle('active', n === step);
        d.classList.toggle('done', n < step);
      });

      // Episode text
      const ep = episodes[step] || episodes[1];
      chapterLine.innerHTML = `
        <span class="sticker-dot"></span>
        <span class="font-black">${ep.title}</span>
        <span class="opacity-80 text-xs">Â·</span>
        <span class="opacity-80 text-xs">${ep.tag}</span>
      `;
      chapterSub.textContent = ep.sub;
      progressText.textContent = step <= 5 ? `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${step} Ù…Ù† 5` : 'ØªÙ…!';

      // Background toggles per step
      petalsWrap.classList.toggle('hidden', step !== 2);
      auraRings.classList.toggle('hidden', step !== 3);
      bokeh.classList.toggle('hidden', step !== 4);
      chatDrift.classList.toggle('hidden', step !== 4);
      constellation.classList.toggle('hidden', step !== 5);
      ribbons.classList.toggle('hidden', step !== 5);

      // Render step-dependent content
      if(step === 2) ensurePetals();
      if(step === 3){
        regenAuraLabels();
        regenAvatarLabels();
        renderAvatars();
      }
      if(step === 4){
        renderCarousel();
        renderCelebs(celebSearch.value);
      }
      if(step === 5){
        renderCategories();
        renderChipPool();
        renderSelectedChips();
      }

      // Canvas particle mode
      fx.setMode(step);

      // Hide error on step change
      clearError();
    }

    function goTo(step){
      const doSwitch = () => setStep(step);
      if(document.startViewTransition && !prefersReducedMotion){
        document.startViewTransition(doSwitch);
      }else{
        doSwitch();
        // fallback micro animation
        main.animate([{opacity:.85, transform:'translateY(6px)'},{opacity:1, transform:'translateY(0)'}],
          {duration: 220, easing:'cubic-bezier(.16,1,.3,1)'});
      }
    }

    backBtn.addEventListener('click', ()=>{
      if(state.step > 1) goTo(state.step - 1);
    });

    nextBtn.addEventListener('click', ()=>{
      const ok = validateStep(state.step);
      if(!ok) return;

      if(state.step < 5) goTo(state.step + 1);
      else if(state.step === 5){
        // Build success summary
        buildSummary();
        goTo(6);
        fireConfetti();
      }
    });

    // Enter to next (nice on mobile)
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && state.step !== 6){
        const active = document.activeElement;
        const isTextArea = active && active.tagName === 'TEXTAREA';
        if(isTextArea) return;
        e.preventDefault();
        nextBtn.click();
      }
    });

    // ---------- Step 2 Petals generator ----------
    let petalsBuilt = false;
    function ensurePetals(){
      if(petalsBuilt) return;
      petalsBuilt = true;
      // generate 14 petals with varied duration/delay
      for(let i=0;i<14;i++){
        const p = document.createElement('div');
        p.className = 'petal';
        p.style.left = (Math.random()*100) + '%';
        p.style.animationDuration = (6.5 + Math.random()*5.5) + 's';
        p.style.animationDelay = (-Math.random()*6) + 's';
        p.style.opacity = (0.55 + Math.random()*0.35).toFixed(2);
        p.style.transform = `rotate(${Math.random()*360}deg)`;
        petalsWrap.appendChild(p);
      }
    }

    // ---------- Success summary + confetti ----------
    function buildSummary(){
      const avatarText = state.avatar.kind === 'upload' ? 'ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø©' : (state.avatar.label || `Preset #${state.avatar.id}`);
      const moodMap = { calm:'Ù‡Ø§Ø¯Ø¦ ğŸŒ¿', hype:'Ù…ØªØ­Ù…Ù‘Ø³ âš¡', cozy:'ÙƒÙˆØ²ÙŠ â˜•' };
      const follows = Array.from(state.followed).slice(0, 4).map(id => celebrities.find(x=>x.id===id)?.name || id);
      summaryEl.innerHTML = `
        <div class="grid gap-2">
          <div>ğŸ‘¤ <span class="font-black">${escapeHtml(state.name)}</span> Â· <span class="opacity-80">${escapeHtml(state.email)}</span></div>
          <div>ğŸ“ <span class="font-black">${escapeHtml(state.country)}</span> â€” <span class="font-black">${escapeHtml(state.city)}</span> Â· Ù…Ø²Ø§Ø¬: <span class="font-black">${moodMap[state.mood] || 'â€”'}</span></div>
          <div>âœ¦ Aura: <span class="font-black" dir="ltr">${escapeHtml(state.auraName || 'â€”')}</span> Â· <span class="opacity-80" dir="ltr">${escapeHtml(state.aura)}</span></div>
          <div>ğŸªª Avatar: <span class="font-black" dir="ltr">${escapeHtml(avatarText)}</span></div>
          <div>ğŸ’– Ù…ØªØ§Ø¨ÙØ¹ÙˆÙ†: <span class="font-black">${state.followed.size}</span> ${follows.length ? `<span class="opacity-80">(${follows.map(x=>`<span dir="ltr">${escapeHtml(x)}</span>`).join(' Â· ')})</span>` : ''}</div>
          <div>ğŸ§¬ Interests: <span class="font-black">${state.interests.length}</span> Â·
            <span class="opacity-80" dir="ltr">${state.interests.slice(0,6).map(escapeHtml).join(' Â· ')}</span>
          </div>
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    function fireConfetti(){
      if(prefersReducedMotion) return;
      confettiEl.innerHTML = '';
      const colors = [state.aura, shiftHue(state.aura, 55), '#ffffff', '#ffd3f2'];
      for(let i=0;i<24;i++){
        const piece = document.createElement('i');
        const c = colors[i % colors.length];
        piece.style.left = (Math.random()*100) + '%';
        piece.style.top = (-10 - Math.random()*20) + 'vh';
        piece.style.background = `linear-gradient(135deg, ${c}, ${shiftHue(c, 35)})`;
        piece.style.animationDelay = (Math.random()*0.20) + 's';
        piece.style.animationDuration = (1.05 + Math.random()*0.55) + 's';
        piece.style.transform = `translateY(-20vh) rotate(${Math.random()*80}deg)`;
        confettiEl.appendChild(piece);
      }
      setTimeout(()=> confettiEl.innerHTML = '', 1700);
    }

    startBtn?.addEventListener('click', ()=>{
      // Small â€œstartâ€ effect (demo)
      startBtn.blur();
      if(!prefersReducedMotion){
        startBtn.animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}],
          {duration: 420, easing:'cubic-bezier(.16,1,.3,1)'});
      }
      alert('ğŸ€ ØªÙ…! (Demo) â€” Ù‡Ù†Ø§ Ø¹Ø§Ø¯Ø©Ù‹ Ù†Ù†Ù‚Ù„Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.');
    });

    // ---------- Bind basic inputs to state ----------
    nameEl?.addEventListener('input', (e)=> { state.name = e.target.value; regenAuraLabels(); regenAvatarLabels(); });
    emailEl?.addEventListener('input', (e)=> { state.email = e.target.value; regenAuraLabels(); });
    bioEl?.addEventListener('input', (e)=> { state.bio = e.target.value; });
    countryEl?.addEventListener('input', (e)=> { state.country = e.target.value; });
    cityEl?.addEventListener('input', (e)=> { state.city = e.target.value; regenAvatarLabels(); });

    // ---------- Canvas particles engine ----------
    const fx = (function(){
      const canvas = $('#fx');
      const ctx = canvas.getContext('2d', { alpha: true });
      let w=0,h=0, dpr=1;
      let mode = 1; // 1 sparkles, 2 petals, 3 aura dust, 4 bokeh, 5 stars
      let particles = [];
      let theme = { a: '#ff6cc7', b:'#7affeb' };

      function resize(){
        dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const r = canvas.getBoundingClientRect();
        w = Math.floor(r.width * dpr);
        h = Math.floor(r.height * dpr);
        canvas.width = w;
        canvas.height = h;
      }

      function setTheme(a, b){
        theme = { a, b };
      }

      function setMode(step){
        mode = step;
        particles = [];
        const count = prefersReducedMotion ? 0 : (step===1 ? 48 : step===2 ? 36 : step===3 ? 40 : step===4 ? 30 : step===5 ? 42 : 0);
        for(let i=0;i<count;i++){
          particles.push(makeParticle(step));
        }
      }

      function makeParticle(step){
        const x = Math.random()*w;
        const y = Math.random()*h;
        const sp = 0.25 + Math.random()*0.75;
        const sz = (step===4 ? 12 : 6) + Math.random() * (step===4 ? 26 : 12);
        const a = 0.25 + Math.random()*0.65;
        const rot = Math.random()*Math.PI*2;
        return {
          x,y, vx:(Math.random()-.5)*sp, vy:(Math.random()-.5)*sp,
          sz, a, rot, vr:(Math.random()-.5)*0.02,
          seed: Math.random()*9999
        };
      }

      function drawStar(x,y,r,alpha){
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.translate(x,y);
        ctx.rotate(0.2);
        ctx.beginPath();
        for(let i=0;i<5;i++){
          ctx.lineTo(Math.cos((18+i*72)*Math.PI/180)*r, -Math.sin((18+i*72)*Math.PI/180)*r);
          ctx.lineTo(Math.cos((54+i*72)*Math.PI/180)*r*0.5, -Math.sin((54+i*72)*Math.PI/180)*r*0.5);
        }
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }

      function tick(){
        ctx.clearRect(0,0,w,h);

        if(particles.length){
          for(const p of particles){
            p.x += p.vx * dpr;
            p.y += p.vy * dpr;
            p.rot += p.vr;

            // wrap
            if(p.x < -50) p.x = w+50;
            if(p.x > w+50) p.x = -50;
            if(p.y < -80) p.y = h+80;
            if(p.y > h+80) p.y = -80;

            // draw by mode/step
            if(mode === 1){
              // sparkles
              const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.sz);
              g.addColorStop(0, 'rgba(255,255,255,'+(p.a*0.85)+')');
              g.addColorStop(1, 'rgba(255,255,255,0)');
              ctx.fillStyle = g;
              ctx.beginPath(); ctx.arc(p.x,p.y,p.sz,0,Math.PI*2); ctx.fill();

              ctx.fillStyle = `rgba(255,255,255,${p.a*0.85})`;
              drawStar(p.x, p.y, Math.max(2, p.sz*0.22), p.a*0.9);

            } else if(mode === 2){
              // petals (extra subtle)
              ctx.save();
              ctx.translate(p.x, p.y);
              ctx.rotate(p.rot);
              const grad = ctx.createLinearGradient(-p.sz, -p.sz, p.sz, p.sz);
              grad.addColorStop(0, hexToRgba(theme.a, 0.25 + p.a*0.3));
              grad.addColorStop(1, hexToRgba('#ffffff', 0.10 + p.a*0.15));
              ctx.fillStyle = grad;
              roundRect(-p.sz*0.5, -p.sz*0.35, p.sz*0.9, p.sz*0.6, p.sz*0.25);
              ctx.fill();
              ctx.restore();

            } else if(mode === 3){
              // aura dust
              const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.sz*1.4);
              g.addColorStop(0, hexToRgba(theme.b, 0.08 + p.a*0.15));
              g.addColorStop(1, 'rgba(0,0,0,0)');
              ctx.fillStyle = g;
              ctx.beginPath(); ctx.arc(p.x,p.y,p.sz*1.1,0,Math.PI*2); ctx.fill();

            } else if(mode === 4){
              // bokeh circles
              const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.sz);
              g.addColorStop(0, 'rgba(255,255,255,'+(0.08 + p.a*0.10)+')');
              g.addColorStop(1, 'rgba(255,255,255,0)');
              ctx.fillStyle = g;
              ctx.beginPath(); ctx.arc(p.x,p.y,p.sz,0,Math.PI*2); ctx.fill();

            } else if(mode === 5){
              // stars (constellation dust)
              ctx.fillStyle = `rgba(255,255,255,${0.18 + p.a*0.25})`;
              ctx.beginPath(); ctx.arc(p.x,p.y,Math.max(1.2, p.sz*0.08),0,Math.PI*2); ctx.fill();

              // occasional tiny line linking (very subtle)
              if((p.seed|0) % 17 === 0){
                ctx.strokeStyle = `rgba(255,255,255,${0.04 + p.a*0.05})`;
                ctx.lineWidth = 1 * dpr;
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                ctx.lineTo(p.x + (p.vx*70), p.y + (p.vy*70));
                ctx.stroke();
              }
            }
          }
        }

        requestAnimationFrame(tick);
      }

      function hexToRgba(hex, a){
        const {r,g,b} = hexToRgb(hex);
        return `rgba(${r},${g},${b},${a})`;
      }

      function roundRect(x,y,w,h,r){
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x+rr,y);
        ctx.arcTo(x+w,y,x+w,y+h,rr);
        ctx.arcTo(x+w,y+h,x,y+h,rr);
        ctx.arcTo(x,y+h,x,y,rr);
        ctx.arcTo(x,y,x+w,y,rr);
        ctx.closePath();
      }

      window.addEventListener('resize', ()=>{ resize(); setMode(state.step); }, {passive:true});
      resize();
      requestAnimationFrame(tick);

      return { setMode, setTheme };
    })();

    // ---------- Init ----------
    function init(){
      // Base accent
      setAccent(state.aura);

      // Defaults
      updatePwUI();
      setMood('calm');

      // Step 4 + 5 initial renders
      renderCarousel();
      renderCelebs('');

      renderCategories();
      renderChipPool();
      renderSelectedChips();

      // Step 3 avatar preview default
      regenAuraLabels();
      regenAvatarLabels();
      renderAvatars();

      // start
      setStep(1);
    }

    init();
  </script>
</body>
</html>
