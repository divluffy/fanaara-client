<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Anime Quest Signup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --motion: 1;
      --dur: 520ms;
      --ease: cubic-bezier(.2,.9,.2,1);
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }
    @media (prefers-reduced-motion: reduce){
      :root{ --motion: 0; }
    }

    /* ========= Background scenes ========= */
    #bg {
      background: radial-gradient(1200px 800px at 30% 20%, rgba(168,85,247,.18), transparent 55%),
                  radial-gradient(900px 700px at 80% 30%, rgba(34,211,238,.14), transparent 60%),
                  linear-gradient(180deg, #070a12, #050712 55%, #02030a);
      isolation: isolate;
    }
    #bg::before, #bg::after{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
    }
    /* film grain */
    #bg::before{
      opacity:.10;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }
    /* vignette */
    #bg::after{
      background: radial-gradient(1200px 800px at 50% 40%, transparent 35%, rgba(0,0,0,.72) 80%);
      opacity:.95;
    }

    #bg[data-scene="portal"] .scene-layer{ opacity: 1; }
    #bg[data-scene="neon"] .scene-layer{ opacity: 1; }
    #bg[data-scene="galaxy"] .scene-layer{ opacity: 1; }
    #bg[data-scene="sakura"] .scene-layer{ opacity: 1; }
    #bg[data-scene="city"] .scene-layer{ opacity: 1; }
    #bg[data-scene="dojo"] .scene-layer{ opacity: 1; }
    #bg[data-scene="dawn"] .scene-layer{ opacity: 1; }

    .scene-layer{
      position:absolute; inset:0;
      opacity:0;
      transition: opacity calc(var(--dur) * var(--motion)) var(--ease);
    }

    /* Portal */
    #portalLayer{
      background:
        radial-gradient(600px 600px at 50% 48%, rgba(124,58,237,.40), transparent 62%),
        radial-gradient(380px 380px at 50% 48%, rgba(34,211,238,.25), transparent 58%),
        conic-gradient(from 200deg at 50% 48%, rgba(99,102,241,.0), rgba(99,102,241,.25), rgba(34,211,238,.25), rgba(168,85,247,.25), rgba(99,102,241,.0));
      filter: blur(0.0px);
    }
    #portalLayer::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(circle at 50% 48%, rgba(255,255,255,.10), transparent 45%),
        repeating-conic-gradient(from 0deg at 50% 48%, rgba(255,255,255,.06) 0 2deg, rgba(255,255,255,0) 2deg 8deg);
      mask: radial-gradient(circle at 50% 48%, rgba(0,0,0,1) 0 48%, rgba(0,0,0,0) 68%);
      opacity:.65;
      transform: rotate(0deg);
      animation: spin calc(9s * var(--motion)) linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Neon city */
    #neonLayer{
      background:
        radial-gradient(900px 600px at 25% 20%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(800px 600px at 80% 30%, rgba(236,72,153,.16), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,.75), rgba(2,6,23,.92));
    }
    #neonLayer::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(0deg, rgba(2,6,23,.95), rgba(2,6,23,.25) 55%, rgba(2,6,23,.92)),
        repeating-linear-gradient(90deg, rgba(34,211,238,.08) 0 2px, rgba(0,0,0,0) 2px 18px),
        repeating-linear-gradient(0deg, rgba(236,72,153,.06) 0 2px, rgba(0,0,0,0) 2px 24px);
      opacity:.55;
      mix-blend-mode: screen;
    }

    /* Sakura */
    #sakuraLayer{
      background:
        radial-gradient(900px 650px at 20% 20%, rgba(244,114,182,.18), transparent 60%),
        radial-gradient(900px 650px at 80% 30%, rgba(250,204,21,.12), transparent 60%),
        linear-gradient(180deg, rgba(10,10,20,.78), rgba(2,6,23,.95));
    }
    #sakuraLayer::before{
      content:"";
      position:absolute; inset:0;
      opacity:.55;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cg fill='none' stroke='rgba(255,182,193,0.22)' stroke-width='2'%3E%3Cpath d='M110 30c15 25 15 45 0 70c-15-25-15-45 0-70z'/%3E%3Cpath d='M110 30c-25 15-45 15-70 0c25-15 45-15 70 0z' transform='rotate(72 110 110)'/%3E%3Cpath d='M110 30c-25 15-45 15-70 0c25-15 45-15 70 0z' transform='rotate(144 110 110)'/%3E%3Cpath d='M110 30c-25 15-45 15-70 0c25-15 45-15 70 0z' transform='rotate(216 110 110)'/%3E%3Cpath d='M110 30c-25 15-45 15-70 0c25-15 45-15 70 0z' transform='rotate(288 110 110)'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 220px 220px;
      background-position: 20px 10px;
      filter: blur(.2px);
    }

    /* City crowd */
    #cityLayer{
      background:
        radial-gradient(900px 650px at 25% 25%, rgba(59,130,246,.16), transparent 60%),
        radial-gradient(900px 650px at 80% 35%, rgba(16,185,129,.12), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,.72), rgba(2,6,23,.95));
    }
    #cityLayer::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(0deg, rgba(2,6,23,.96), rgba(2,6,23,.15) 55%, rgba(2,6,23,.94)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 2px, rgba(0,0,0,0) 2px 20px);
      opacity:.55;
      mask: linear-gradient(180deg, transparent, rgba(0,0,0,.9) 50%, rgba(0,0,0,1));
    }

    /* Dojo */
    #dojoLayer{
      background:
        radial-gradient(900px 650px at 20% 20%, rgba(245,158,11,.14), transparent 60%),
        radial-gradient(900px 650px at 80% 30%, rgba(147,197,253,.12), transparent 60%),
        linear-gradient(180deg, rgba(10,10,18,.72), rgba(2,6,23,.95));
    }
    #dojoLayer::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(135deg, rgba(255,255,255,.04) 0 10px, rgba(0,0,0,0) 10px 34px);
      opacity:.45;
      mask: radial-gradient(900px 650px at 50% 40%, rgba(0,0,0,1), rgba(0,0,0,0) 70%);
    }

    /* Dawn */
    #dawnLayer{
      background:
        radial-gradient(900px 650px at 40% 25%, rgba(250,204,21,.18), transparent 60%),
        radial-gradient(900px 650px at 75% 30%, rgba(168,85,247,.12), transparent 60%),
        linear-gradient(180deg, rgba(12,10,24,.72), rgba(2,6,23,.95));
    }
    #dawnLayer::before{
      content:"";
      position:absolute; inset:0;
      opacity:.55;
      background:
        radial-gradient(600px 300px at 50% 65%, rgba(255,255,255,.12), transparent 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 2px, rgba(0,0,0,0) 2px 18px);
      mask: radial-gradient(900px 650px at 50% 50%, rgba(0,0,0,1), rgba(0,0,0,0) 70%);
    }

    /* Galaxy uses canvas; layer adds glow */
    #galaxyLayer{
      background:
        radial-gradient(900px 650px at 30% 20%, rgba(99,102,241,.16), transparent 60%),
        radial-gradient(900px 650px at 80% 35%, rgba(34,211,238,.12), transparent 60%),
        linear-gradient(180deg, rgba(10,10,28,.72), rgba(2,6,23,.95));
    }
    #galaxyLayer::before{
      content:"";
      position:absolute; inset:-10%;
      background:
        radial-gradient(circle at 60% 30%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(circle at 40% 65%, rgba(255,255,255,.08), transparent 60%);
      opacity:.6;
      filter: blur(1px);
    }

    /* ========= Card / UI FX ========= */
    .sticker-card{
      position: relative;
      border-radius: 24px;
      background: rgba(15, 23, 42, .52);
      border: 1px solid rgba(148, 163, 184, .18);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      overflow: hidden;
      transform: translateZ(0);
    }
    .sticker-card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 200px at 20% 10%, rgba(34,211,238,.20), transparent 55%),
        radial-gradient(600px 260px at 85% 20%, rgba(236,72,153,.16), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      opacity:.85;
      pointer-events:none;
    }
    .sticker-card::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.16) 45%, transparent 55%);
      transform: translateX(0) rotate(10deg);
      opacity: .0;
      pointer-events:none;
      animation: shimmer calc(2.6s * var(--motion)) var(--ease) infinite;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-30%) rotate(10deg); opacity:.0; }
      25%{ opacity:.55; }
      55%{ opacity:.0; }
      100%{ transform: translateX(30%) rotate(10deg); opacity:.0; }
    }

    .holo-pill{
      background: linear-gradient(90deg, rgba(34,211,238,.20), rgba(168,85,247,.18), rgba(236,72,153,.16));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }

    .speech{
      position: relative;
      border-radius: 16px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.20);
      padding: 10px 12px;
    }
    .speech::after{
      content:"";
      position:absolute;
      bottom:-8px; inset-inline-start: 18px;
      width: 16px; height: 16px;
      background: rgba(2,6,23,.55);
      border-inline-start: 1px solid rgba(148,163,184,.20);
      border-bottom: 1px solid rgba(148,163,184,.20);
      transform: rotate(45deg);
    }

    .focus-glow:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(34,211,238,.18), 0 0 0 1px rgba(34,211,238,.25) inset;
    }

    /* Cinematic transitions */
    .cinematic-out{
      opacity: 0;
      transform: translateY(10px) scale(.98);
      filter: blur(1px);
      transition:
        opacity calc(220ms * var(--motion)) var(--ease),
        transform calc(220ms * var(--motion)) var(--ease),
        filter calc(220ms * var(--motion)) var(--ease);
    }
    .cinematic-in{
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
      transition:
        opacity calc(420ms * var(--motion)) var(--ease),
        transform calc(420ms * var(--motion)) var(--ease),
        filter calc(420ms * var(--motion)) var(--ease);
    }

    /* Speed lines overlay */
    #speedLines{
      position: fixed; inset: 0;
      pointer-events: none;
      opacity: 0;
      z-index: 40;
      background:
        repeating-linear-gradient(12deg, rgba(255,255,255,.0) 0 12px, rgba(255,255,255,.10) 12px 13px, rgba(255,255,255,.0) 13px 28px),
        radial-gradient(1200px 800px at 50% 50%, rgba(34,211,238,.14), transparent 55%);
      mix-blend-mode: screen;
      transform: translateX(0);
      transition: opacity calc(180ms * var(--motion)) var(--ease);
    }
    #speedLines.active{
      opacity: .75;
      animation: speed calc(420ms * var(--motion)) linear 1;
    }
    @keyframes speed{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-18px); }
    }

    /* Sparkles */
    .sparkle{
      position: fixed;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,255,255,0) 60%);
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 50;
      transform: translate(-50%,-50%) scale(0.9);
      opacity: 0;
      animation: sparklePop calc(700ms * var(--motion)) var(--ease) forwards;
    }
    @keyframes sparklePop{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.6); filter: blur(0px); }
      20%{ opacity:.95; }
      100%{ opacity:0; transform: translate(var(--tx), var(--ty)) scale(0.8); filter: blur(1px); }
    }

    /* Ink stamp */
    #stamp{
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      z-index: 60;
      opacity: 0;
    }
    #stamp .mark{
      transform: rotate(-10deg) scale(.75);
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      opacity: 0;
    }
    #stamp.show{
      opacity: 1;
    }
    #stamp.show .mark{
      opacity: 1;
      animation: stampIn calc(520ms * var(--motion)) var(--ease) 1;
    }
    @keyframes stampIn{
      0%{ transform: rotate(-18deg) scale(1.35); filter: blur(1px); }
      40%{ transform: rotate(-10deg) scale(.92); filter: blur(0px); }
      70%{ transform: rotate(-12deg) scale(1.03); }
      100%{ transform: rotate(-10deg) scale(1); }
    }

    /* Safe area spacing for fixed bar */
    .safe-bottom{
      padding-bottom: calc(12px + var(--safe-b));
    }
    .safe-top{
      padding-top: calc(12px + var(--safe-t));
    }

    /* Chips */
    .chip{
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.38);
      transition: transform calc(160ms * var(--motion)) var(--ease), background calc(160ms * var(--motion)) var(--ease), border-color calc(160ms * var(--motion)) var(--ease);
      user-select: none;
    }
    .chip:active{ transform: scale(.98); }
    .chip[data-on="true"]{
      background: rgba(34,211,238,.14);
      border-color: rgba(34,211,238,.35);
      box-shadow: inset 0 0 0 1px rgba(34,211,238,.12);
    }

    /* Tiny progress nodes */
    .node{
      width: 10px; height: 10px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.45);
    }
    .node.on{
      background: linear-gradient(180deg, rgba(34,211,238,.9), rgba(168,85,247,.6));
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(34,211,238,.10);
    }

    /* Canvas */
    #starCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity: 0;
      transition: opacity calc(var(--dur) * var(--motion)) var(--ease);
    }
    #bg[data-scene="galaxy"] #starCanvas{ opacity: .95; }

    /* Disable motion helper class */
    .no-motion *{
      animation: none !important;
      transition-duration: 0ms !important;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100 overflow-x-hidden">
  <!-- Background -->
  <div id="bg" class="fixed inset-0 -z-10" data-scene="portal" aria-hidden="true">
    <canvas id="starCanvas"></canvas>
    <div id="portalLayer" class="scene-layer"></div>
    <div id="neonLayer" class="scene-layer"></div>
    <div id="galaxyLayer" class="scene-layer"></div>
    <div id="sakuraLayer" class="scene-layer"></div>
    <div id="cityLayer" class="scene-layer"></div>
    <div id="dojoLayer" class="scene-layer"></div>
    <div id="dawnLayer" class="scene-layer"></div>
  </div>

  <div id="speedLines" aria-hidden="true"></div>

  <div id="stamp" aria-hidden="true">
    <div class="mark">
      <div class="rounded-2xl border border-rose-200/25 bg-rose-500/12 px-6 py-5 text-center">
        <div class="inline-flex items-center gap-2">
          <span class="text-2xl">ğŸˆ¶</span>
          <span class="text-2xl font-black tracking-wide">QUEST COMPLETE</span>
        </div>
        <div class="mt-1 text-sm text-rose-100/80">Ø®ØªÙ… Ø±Ø³Ù…ÙŠ â€¢ ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©</div>
      </div>
    </div>
  </div>

  <div class="relative min-h-screen flex flex-col">
    <!-- Header -->
    <header class="safe-top px-4 pt-3">
      <div class="mx-auto w-full max-w-md">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="inline-flex items-center gap-2">
              <div class="h-10 w-10 rounded-2xl border border-white/15 bg-white/5 grid place-items-center shadow-lg">
                <span class="text-lg">ğŸ—¡ï¸</span>
              </div>
              <div>
                <div class="text-sm text-slate-200/80">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ â€¢ Anime Quest</div>
                <div class="font-extrabold tracking-tight">Ù…Ù‡Ù…Ø© Ù‚ØµÙŠØ±Ø©... Ø¨Ø¯ÙˆÙ† Ù…Ù„Ù„</div>
              </div>
            </div>
          </div>

          <button id="motionBtn" class="holo-pill rounded-full px-3 py-1.5 text-xs font-bold text-slate-100/90 active:scale-[.99] transition"
                  type="button" aria-pressed="false">
            ğŸï¸ Ø§Ù„Ø­Ø±ÙƒØ©: ON
          </button>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-200/70">Quest Progress</span>
            <div class="flex items-center gap-1.5" aria-label="Quest Progress">
              <span class="node" id="node1"></span>
              <span class="node" id="node2"></span>
              <span class="node" id="node3"></span>
            </div>
          </div>

          <div class="speech text-xs text-slate-200/85 max-w-[60%]" id="hintBubble">
            Ø¬Ù‡Ù‘Ø² Ù†ÙØ³Ùƒ... Ø¨Ù†Ù‚Ù„Ùƒ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ âœ¨
          </div>
        </div>
      </div>
    </header>

    <!-- App -->
    <main class="flex-1 px-4 pb-28 pt-4">
      <div class="mx-auto w-full max-w-md">
        <div id="card" class="sticker-card p-5 cinematic-in">
          <!-- injected -->
        </div>

        <div class="mt-4 text-xs text-slate-200/60 px-1">
          ØªÙ„Ù…ÙŠØ­: Ø§Ø³Ø­Ø¨ <span id="swipeDirText">ÙŠÙ…ÙŠÙ†Ù‹Ø§</span> Ù„Ù„ØªÙ‚Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€¢ <span class="opacity-80">ÙˆØ¥Ù† ÙƒØ§Ù† Ø¬Ù‡Ø§Ø²Ùƒ ÙŠÙ‚Ù„Ù‘Ù„ Ø§Ù„Ø­Ø±ÙƒØ©ØŒ Ø³Ù†Ø­ØªØ±Ù… Ø°Ù„Ùƒ.</span>
        </div>
      </div>
    </main>

    <!-- Bottom Action Bar -->
    <div class="fixed inset-x-0 bottom-0 safe-bottom px-4">
      <div class="mx-auto w-full max-w-md">
        <div class="sticker-card px-4 py-3">
          <div class="flex items-center justify-between gap-3">
            <button id="backBtn"
              class="rounded-xl border border-white/15 bg-white/5 px-4 py-3 text-sm font-bold text-slate-100/90
                     active:scale-[.99] transition disabled:opacity-40 disabled:active:scale-100"
              type="button">
              Ø±Ø¬ÙˆØ¹
            </button>

            <div class="flex-1 text-center">
              <div class="text-xs text-slate-200/70" id="microCopy">Ù…Ù‡Ù…Ø© ØµØºÙŠØ±Ø©... Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.</div>
              <div class="text-[11px] text-slate-200/55" id="subCopy">Ù„Ù† Ù†ÙØ¸Ù‡Ø± Ø£Ø±Ù‚Ø§Ù… Ø®Ø·ÙˆØ§Øª. Ø¨Ø³ Ù†ØªØ­Ø±Ùƒ Ø¨Ø³Ø±Ø¹Ø© ğŸ˜¼</div>
            </div>

            <div class="flex items-center gap-2">
              <button id="skipBtn"
                class="hidden rounded-xl border border-white/15 bg-white/5 px-4 py-3 text-sm font-bold text-slate-100/90
                       active:scale-[.99] transition"
                type="button">
                ØªØ®Ø·Ù‘ÙŠ / Ù„Ø§Ø­Ù‚Ù‹Ø§
              </button>

              <button id="nextBtn"
                class="rounded-xl bg-white/10 px-4 py-3 text-sm font-black tracking-tight text-white
                       border border-white/20 active:scale-[.99] transition"
                type="button">
                Ù…ØªØ§Ø¨Ø¹Ø©
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    (() => {
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const card = $("#card");
      const bg = $("#bg");
      const speedLines = $("#speedLines");
      const stamp = $("#stamp");
      const hintBubble = $("#hintBubble");

      const nodeEls = [$("#node1"), $("#node2"), $("#node3")];
      const backBtn = $("#backBtn");
      const nextBtn = $("#nextBtn");
      const skipBtn = $("#skipBtn");
      const motionBtn = $("#motionBtn");
      const microCopy = $("#microCopy");
      const subCopy = $("#subCopy");

      const swipeDirText = $("#swipeDirText");

      const isRTL = document.documentElement.dir.toLowerCase() === "rtl";

      // Swipe hint text
      swipeDirText.textContent = isRTL ? "ÙŠÙ…ÙŠÙ†Ù‹Ø§" : "ÙŠØ³Ø§Ø±Ù‹Ø§";

      // State
      const state = {
        step: 0,
        name: "",
        email: "",
        password: "",
        aura: null,     // Fire/Water/Shadow/Star
        avatar: null,   // id
        bioWords: [],
        bioText: "",
        follows: [],    // ids
        interests: [],  // strings
        motionEnabled: null, // null => follow prefers
      };

      const mockSenpai = [
        { id:"sen1", name:"Kyo Blaze", role:"Shonen Mentor", vibe:"ğŸ”¥ ØªØ¯Ø±ÙŠØ¨ Ù‚Ø§Ø³ÙŠ" },
        { id:"sen2", name:"Mira Tide", role:"Isekai Guide", vibe:"ğŸŒŠ Ø®Ø·Ø· Ù‡Ø§Ø¯Ø¦Ø©" },
        { id:"sen3", name:"Noir Sable", role:"Shadow Rogue", vibe:"ğŸŒ‘ Ø£Ø³Ø±Ø§Ø±" },
        { id:"sen4", name:"Astra Nova", role:"Galaxy Idol", vibe:"â­ Ù‡Ø§Ù„Ø© Ù†Ø¬ÙˆÙ…" },
        { id:"sen5", name:"Rin Sketch", role:"Manga Artist", vibe:"âœï¸ Ø®Ø·ÙˆØ· Ø­Ø§Ø¯Ø©" },
        { id:"sen6", name:"Jin Byte", role:"Cyber Ninja", vibe:"ğŸ’¾ Ø³Ø±Ø¹Ø©" },
        { id:"sen7", name:"Yuna Bloom", role:"Slice-of-life", vibe:"ğŸŒ¸ Ù„Ø·Ø§ÙØ©" },
        { id:"sen8", name:"Eiji Lore", role:"Light Novel", vibe:"ğŸ“š Ù„ÙˆØ±" },
      ];

      const bioWordBank = ["Ø´ØºÙˆÙ", "Ù‡Ø§Ø¯Ø¦", "Ù…Ø¬Ù†ÙˆÙ†-Ù…Ù…ØªØ¹", "Ù…Ø­Ù„Ù„", "Ø¬Ø§Ù…Ø¹", "Ù…Ù†Ø§ÙØ³", "ÙÙ†Ø§Ù†", "ÙƒØ§ØªØ¨", "Ù…ØªØ§Ø¨Ø¹-Ù‚Ø¯ÙŠÙ…", "Ù…Ø³ØªÙƒØ´Ù"];
      const dnaChips = [
        "Anime", "Manga", "Manhwa", "Comics", "Light Novel",
        "Action", "Romance", "Comedy", "Horror", "Fantasy",
        "Sci-Fi", "Mystery", "Drama", "Sports", "Mecha",
        "Slice of Life", "Isekai", "Seinen", "Shoujo", "Music"
      ];

      const avatars = [
        { id:"av1", label:"Blade", svg: avatarSVG("blade") },
        { id:"av2", label:"Kitsune", svg: avatarSVG("kitsune") },
        { id:"av3", label:"Echo", svg: avatarSVG("echo") },
        { id:"av4", label:"Nova", svg: avatarSVG("nova") },
        { id:"av5", label:"Zen", svg: avatarSVG("zen") },
        { id:"av6", label:"Glitch", svg: avatarSVG("glitch") },
      ];

      const steps = [
        {
          id: "identity",
          scene: "portal",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù‡ÙˆÙŠØ©",
          subtitle: "Ø§Ø³Ù… + Ø¨Ø±ÙŠØ¯â€¦ ÙˆØ®Ù„Ø§Øµ. ÙˆØ¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ØªØŒ Ø£Ù†Ù‚Ù„Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.",
          skippable: false,
          render: () => `
            <div class="relative">
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>ğŸ§­</span><span>Quest: Identity</span>
              </div>

              <h1 class="mt-3 text-2xl font-black tracking-tight">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ ÙˆØ¨Ø±ÙŠØ¯Ùƒ</h1>
              <p class="mt-1 text-sm text-slate-200/70">Ù„Ø§ ØªÙ‚Ù„Ù‚ â€” Ù„Ù† Ù†Ø·ÙˆÙ‘Ù„Ù‡Ø§. Ø¥Ø¯Ø®Ø§Ù„ÙŠÙ† ÙˆØ¨Ø³.</p>

              <div class="mt-4 grid gap-3">
                <label class="block">
                  <div class="text-xs text-slate-200/70 mb-1">Ø§Ù„Ø§Ø³Ù…</div>
                  <input id="nameInput" class="focus-glow w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-4 text-sm text-slate-100 placeholder:text-slate-400/60"
                         placeholder="Ù…Ø«Ø§Ù„: dev.luffy" autocomplete="nickname" />
                </label>

                <label class="block">
                  <div class="text-xs text-slate-200/70 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
                  <input id="emailInput" class="focus-glow w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-4 text-sm text-slate-100 placeholder:text-slate-400/60"
                         placeholder="you@domain.com" inputmode="email" autocomplete="email" />
                  <div id="emailMsg" class="mt-1 text-[11px] text-slate-200/55"></div>
                </label>
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ø¨Ù…Ø¬Ø±Ø¯ Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ØµØ­ÙŠØ­ÙŠÙ†â€¦ <b>Ø³Ø£ÙØªØ­ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</b> âœ¨
              </div>
            </div>
          `,
          setup: () => {
            const nameInput = $("#nameInput");
            const emailInput = $("#emailInput");
            const emailMsg = $("#emailMsg");

            nameInput.value = state.name;
            emailInput.value = state.email;

            const onChange = () => {
              state.name = nameInput.value.trim();
              state.email = emailInput.value.trim();

              const okEmail = isValidEmail(state.email);
              emailMsg.textContent = state.email.length === 0
                ? " "
                : (okEmail ? "ØªÙ…Ø§Ù… âœ…" : "Ø­Ø³Ù‘Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø´ÙˆÙŠâ€¦");

              maybeAutoAdvance();
            };

            nameInput.addEventListener("input", onChange);
            emailInput.addEventListener("input", onChange);

            setTimeout(() => nameInput.focus(), 60);
          },
          canNext: () => state.name.length >= 2 && isValidEmail(state.email),
        },

        {
          id: "password",
          scene: "neon",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ù‚ÙÙ„ Ø§Ù„Ù†ÙŠÙˆÙ†",
          subtitle: "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©â€¦ ÙˆØ¨Ø´ÙƒÙ„ Ù„Ø·ÙŠÙ.",
          skippable: false,
          render: () => `
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>ğŸ”’</span><span>Quest: Password</span>
              </div>

              <h1 class="mt-3 text-2xl font-black tracking-tight">Ø£Ù†Ø´Ø¦ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</h1>
              <p class="mt-1 text-sm text-slate-200/70">Ø´Ø±ÙŠØ· Ø§Ù„Ù‚ÙˆØ© Ù‡Ù†Ø§ Ù„Ø·ÙŠÙâ€¦ Ù…Ø´ Ù…Ø²Ø¹Ø¬.</p>

              <div class="mt-4">
                <label class="block">
                  <div class="text-xs text-slate-200/70 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
                  <div class="relative">
                    <input id="passInput" type="password"
                      class="focus-glow w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-4 text-sm text-slate-100 placeholder:text-slate-400/60"
                      placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
                    <button id="togglePass" type="button"
                      class="absolute inset-y-0 left-2 my-auto h-10 rounded-xl border border-white/10 bg-white/5 px-3 text-xs font-bold text-slate-100/80 active:scale-[.99] transition">
                      Ø¥Ø¸Ù‡Ø§Ø±
                    </button>
                  </div>
                </label>

                <div class="mt-3">
                  <div class="flex items-center justify-between text-[11px] text-slate-200/65">
                    <span>Ù‚ÙˆØ© Ø§Ù„Ù‚ÙÙ„</span>
                    <span id="strengthLabel">â€¦</span>
                  </div>
                  <div class="mt-2 flex gap-2">
                    ${[0,1,2,3].map(i => `
                      <div class="h-2 flex-1 rounded-full border border-white/10 bg-white/5 overflow-hidden">
                        <div id="bar${i}" class="h-full w-0 bg-white/20"></div>
                      </div>
                    `).join("")}
                  </div>
                  <div class="mt-2 text-[11px] text-slate-200/55" id="passHint">
                    Ø¬Ø±Ù‘Ø¨: 8+ Ø£Ø­Ø±Ù + Ø±Ù‚Ù… + Ø±Ù…Ø²â€¦ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ†Ù‡ ÙŠØ¹Ø·ÙŠÙƒ Ù‡Ø§Ù„Ø© Ø£Ù‚ÙˆÙ‰)
                  </div>
                </div>
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ù„Ù…Ø§ ØªØµÙ„ Ù„Ù‚ÙˆØ© Ù…Ù†Ø§Ø³Ø¨Ø©â€¦ <b>Ø³Ø£ÙƒÙ…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</b> âš¡
              </div>
            </div>
          `,
          setup: () => {
            const passInput = $("#passInput");
            const togglePass = $("#togglePass");
            const strengthLabel = $("#strengthLabel");
            const passHint = $("#passHint");

            passInput.value = state.password;

            const renderStrength = () => {
              const {score, label} = passwordStrength(state.password);
              strengthLabel.textContent = label;

              const bars = [$("#bar0"), $("#bar1"), $("#bar2"), $("#bar3")];
              bars.forEach((b, i) => {
                const on = i < score;
                b.style.width = on ? "100%" : "0%";
                b.style.background = on
                  ? "linear-gradient(180deg, rgba(34,211,238,.85), rgba(168,85,247,.55))"
                  : "rgba(255,255,255,.10)";
              });

              passHint.textContent =
                score <= 1 ? "Ø®Ù„ÙŠÙ‡ Ø£Ø·ÙˆÙ„ Ø´ÙˆÙŠâ€¦" :
                score === 2 ? "Ù…Ù…ØªØ§Ø²! Ø¨Ø§Ù‚ÙŠ Ù„Ù…Ø³Ø©â€¦" :
                score === 3 ? "Ù‚ÙˆÙŠ Ø¬Ø¯Ù‹Ø§ âœ…" :
                "Ø£Ø³Ø·ÙˆØ±ÙŠ â­";
            };

            const onInput = () => {
              state.password = passInput.value;
              renderStrength();
              maybeAutoAdvance();
            };

            passInput.addEventListener("input", onInput);

            togglePass.addEventListener("click", () => {
              const isPw = passInput.type === "password";
              passInput.type = isPw ? "text" : "password";
              togglePass.textContent = isPw ? "Ø¥Ø®ÙØ§Ø¡" : "Ø¥Ø¸Ù‡Ø§Ø±";
              passInput.focus();
            });

            renderStrength();
            setTimeout(() => passInput.focus(), 60);
          },
          canNext: () => passwordStrength(state.password).score >= 2 && state.password.length >= 8,
        },

        {
          id: "aura",
          scene: "galaxy",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ù‡Ø§Ù„Ø© Ø§Ù„Ø£ÙØ§ØªØ§Ø±",
          subtitle: "Ø§Ø®ØªØ± Aura Ø«Ù… Avatar â€” Sparkle Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.",
          skippable: false,
          render: () => `
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>âœ¨</span><span>Quest: Aura & Avatar</span>
              </div>

              <h1 class="mt-3 text-2xl font-black tracking-tight">Ø§Ø®ØªØ± Ù‡Ø§Ù„ØªÙƒ + Ø£ÙØ§ØªØ§Ø±Ùƒ</h1>
              <p class="mt-1 text-sm text-slate-200/70">Ù„Ù…Ø³Ø© Ø£Ù†Ù…ÙŠ: Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯â€¦ Ø«Ù… Ø´ÙƒÙ„ ÙˆØ§Ø­Ø¯.</p>

              <div class="mt-4">
                <div class="text-xs text-slate-200/70 mb-2">Aura</div>
                <div class="grid grid-cols-2 gap-2">
                  ${["Fire","Water","Shadow","Star"].map(a => `
                    <button type="button" data-aura="${a}"
                      class="auraBtn rounded-2xl border border-white/15 bg-white/5 px-4 py-4 text-sm font-black tracking-tight text-slate-100/90 active:scale-[.99] transition">
                      ${a === "Fire" ? "ğŸ”¥ Fire" : a === "Water" ? "ğŸŒŠ Water" : a === "Shadow" ? "ğŸŒ‘ Shadow" : "â­ Star"}
                      <div class="mt-1 text-[11px] font-semibold text-slate-200/60">
                        ${a === "Fire" ? "Ø§Ù†Ø¯ÙØ§Ø¹" : a === "Water" ? "Ø§ØªØ²Ø§Ù†" : a === "Shadow" ? "ØºÙ…ÙˆØ¶" : "Ø¨Ø±ÙŠÙ‚"}
                      </div>
                    </button>
                  `).join("")}
                </div>
              </div>

              <div class="mt-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-slate-200/70">Avatar</div>
                  <div class="text-[11px] text-slate-200/55" id="avatarMsg">
                    Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯Ù‹Ø§â€¦ ÙˆØ³Ù†Ù†Ø·Ù„Ù‚
                  </div>
                </div>
                <div class="mt-2 grid grid-cols-3 gap-2">
                  ${avatars.map(av => `
                    <button type="button" data-avatar="${av.id}"
                      class="avatarBtn rounded-2xl border border-white/15 bg-white/5 p-3 text-center active:scale-[.99] transition">
                      <div class="mx-auto h-14 w-14 rounded-2xl border border-white/10 bg-white/5 grid place-items-center overflow-hidden">
                        ${av.svg}
                      </div>
                      <div class="mt-2 text-[11px] font-bold text-slate-100/80">${av.label}</div>
                    </button>
                  `).join("")}
                </div>
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ø§Ø®ØªØ± Ù‡Ø§Ù„ØªÙƒâ€¦ Ø«Ù… Ø§Ù„Ø£ÙØ§ØªØ§Ø±. <b>Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</b> Ù…Ø¹ Ø®Ø·ÙˆØ· Ø³Ø±Ø¹Ø© ğŸ
              </div>
            </div>
          `,
          setup: () => {
            const auraBtns = $$(".auraBtn");
            const avatarBtns = $$(".avatarBtn");
            const avatarMsg = $("#avatarMsg");

            const markAura = () => {
              auraBtns.forEach(btn => {
                const on = btn.dataset.aura === state.aura;
                btn.style.borderColor = on ? "rgba(34,211,238,.42)" : "rgba(255,255,255,.15)";
                btn.style.background = on ? "rgba(34,211,238,.10)" : "rgba(255,255,255,.05)";
                btn.style.boxShadow = on ? "inset 0 0 0 1px rgba(34,211,238,.12)" : "none";
              });
            };

            const markAvatar = () => {
              avatarBtns.forEach(btn => {
                const on = btn.dataset.avatar === state.avatar;
                btn.style.borderColor = on ? "rgba(236,72,153,.45)" : "rgba(255,255,255,.15)";
                btn.style.background = on ? "rgba(236,72,153,.09)" : "rgba(255,255,255,.05)";
                btn.style.boxShadow = on ? "inset 0 0 0 1px rgba(236,72,153,.10)" : "none";
              });

              avatarMsg.textContent = state.avatar
                ? "ØªÙ…Ø§Ù… âœ…"
                : "Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯Ù‹Ø§â€¦ ÙˆØ³Ù†Ù†Ø·Ù„Ù‚";
            };

            auraBtns.forEach(btn => btn.addEventListener("click", (e) => {
              state.aura = btn.dataset.aura;
              markAura();
              sparkleBurst(btn);
              maybeAutoAdvance();
            }));

            avatarBtns.forEach(btn => btn.addEventListener("click", () => {
              state.avatar = btn.dataset.avatar;
              markAvatar();
              sparkleBurst(btn);
              maybeAutoAdvance();
            }));

            markAura();
            markAvatar();
          },
          canNext: () => !!state.aura && !!state.avatar,
        },

        {
          id: "bio",
          scene: "sakura",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø¨Ø·Ø§Ù‚Ø© ØªØ¹Ø±ÙŠÙ Ø³Ø±ÙŠØ¹Ø©",
          subtitle: "Ø§Ø®ØªØ± 3 ÙƒÙ„Ù…Ø§Øª Ø¬Ø§Ù‡Ø²Ø© + Ù†Ø¨Ø°Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).",
          skippable: true,
          render: () => `
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>ğŸ’¬</span><span>Quest: Quick Bio</span>
              </div>

              <h1 class="mt-3 text-2xl font-black tracking-tight">Ø³Ø±ÙŠØ¹Ù‹Ø§â€¦ Ù…Ù† Ø£Ù†ØªØŸ</h1>
              <p class="mt-1 text-sm text-slate-200/70">Ø§Ø®ØªØ± 3 ÙƒÙ„Ù…Ø§Øª (Ø£Ùˆ Ø§ÙƒØªØ¨ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯). Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù…Ù…ÙƒÙ† â€œÙ„Ø§Ø­Ù‚Ù‹Ø§â€.</p>

              <div class="mt-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-slate-200/70">Ù£ ÙƒÙ„Ù…Ø§Øª</div>
                  <div class="text-[11px] text-slate-200/60" id="bioCount">${state.bioWords.length}/3</div>
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                  ${bioWordBank.map(w => `
                    <button type="button" class="chip rounded-full px-3 py-2 text-xs font-bold text-slate-100/85" data-word="${w}">
                      ${w}
                    </button>
                  `).join("")}
                </div>
              </div>

              <div class="mt-4">
                <div class="text-xs text-slate-200/70 mb-1">Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
                <textarea id="bioText" rows="3"
                  class="focus-glow w-full rounded-2xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-400/60"
                  placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„ + Ù†Ø¬Ù…Ø¹ Ù…Ø§Ù†ØºØ§ Ù‚Ø¯ÙŠÙ…Ø©â€¦"></textarea>
                <div class="mt-1 text-[11px] text-slate-200/55" id="bioMsg">ØªÙ‚Ø¯Ø± ØªØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ©.</div>
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª 3 ÙƒÙ„Ù…Ø§Øªâ€¦ ØºØ§Ù„Ø¨Ù‹Ø§ <b>Ø³Ø£Ù‚ØªØ±Ø­ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</b>. Ø£Ùˆ Ø§Ø¶ØºØ· â€œÙ…ØªØ§Ø¨Ø¹Ø©â€.
              </div>
            </div>
          `,
          setup: () => {
            const chips = $$(".chip");
            const bioCount = $("#bioCount");
            const bioText = $("#bioText");
            const bioMsg = $("#bioMsg");

            bioText.value = state.bioText || "";

            const refresh = () => {
              bioCount.textContent = `${state.bioWords.length}/3`;
              chips.forEach(ch => {
                const on = state.bioWords.includes(ch.dataset.word);
                ch.dataset.on = on ? "true" : "false";
              });
              bioMsg.textContent = state.bioWords.length === 3
                ? "Ø¬Ù…ÙŠÙ„! Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ âœ…"
                : (bioText.value.trim().length >= 12 ? "Ù†Ø¨Ø°Ø© Ù…Ù…ØªØ§Ø²Ø© âœ…" : "ØªÙ‚Ø¯Ø± ØªØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ©.");
            };

            chips.forEach(ch => ch.addEventListener("click", () => {
              const w = ch.dataset.word;
              if (state.bioWords.includes(w)) {
                state.bioWords = state.bioWords.filter(x => x !== w);
              } else {
                if (state.bioWords.length >= 3) return;
                state.bioWords = [...state.bioWords, w];
              }
              refresh();
              if (state.bioWords.length === 3) maybeAutoAdvance(420);
            }));

            bioText.addEventListener("input", () => {
              state.bioText = bioText.value;
              refresh();
            });

            refresh();
          },
          canNext: () => true, // optional
        },

        {
          id: "senpai",
          scene: "city",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø§ØªØ¨Ø¹ 3 Senpai",
          subtitle: "Ø§Ø®ØªØ± 3 Ù…Ù† 8 â€” Ø§Ù„ØªÙ‚Ø¯Ù… ÙŠÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ 3.",
          skippable: true,
          render: () => `
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>ğŸ§‘â€ğŸ«</span><span>Quest: Follow 3 Senpai</span>
              </div>

              <div class="mt-3 flex items-start justify-between gap-3">
                <div>
                  <h1 class="text-2xl font-black tracking-tight">Ø§ØªØ¨Ø¹ 3 Ø³Ù†Ø¨Ø§ÙŠ</h1>
                  <p class="mt-1 text-sm text-slate-200/70">Ù…Ø¬Ø±Ø¯ 3â€¦ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ù†Ù†Ø·Ù„Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
                </div>
                <div class="rounded-2xl border border-white/15 bg-white/5 px-3 py-2 text-center">
                  <div class="text-[11px] text-slate-200/65">ØªÙ…</div>
                  <div class="text-lg font-black" id="followCount">${Math.min(state.follows.length,3)}/3</div>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-1 gap-2">
                ${mockSenpai.map(s => `
                  <div class="rounded-2xl border border-white/12 bg-white/5 p-3 flex items-center gap-3">
                    <div class="h-12 w-12 rounded-2xl border border-white/10 bg-white/5 grid place-items-center overflow-hidden">
                      ${senpaiBadgeSVG(s.id)}
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="font-black truncate">${s.name}</div>
                      <div class="text-[11px] text-slate-200/65 truncate">${s.role} â€¢ ${s.vibe}</div>
                    </div>
                    <button type="button" data-senpai="${s.id}"
                      class="followBtn rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-xs font-black active:scale-[.99] transition">
                      Follow
                    </button>
                  </div>
                `).join("")}
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ù„Ù…Ø§ ØªÙˆØµÙ„ 3 Followâ€¦ <b>Ø³Ø£ÙƒÙ…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</b> ğŸƒâ€â™‚ï¸ğŸ’¨
              </div>
            </div>
          `,
          setup: () => {
            const followBtns = $$(".followBtn");
            const followCount = $("#followCount");

            const refresh = () => {
              followCount.textContent = `${Math.min(state.follows.length,3)}/3`;
              followBtns.forEach(btn => {
                const id = btn.dataset.senpai;
                const on = state.follows.includes(id);
                btn.textContent = on ? "Following" : "Follow";
                btn.style.borderColor = on ? "rgba(34,211,238,.42)" : "rgba(255,255,255,.15)";
                btn.style.background = on ? "rgba(34,211,238,.10)" : "rgba(255,255,255,.05)";
              });
            };

            followBtns.forEach(btn => btn.addEventListener("click", () => {
              const id = btn.dataset.senpai;
              const on = state.follows.includes(id);

              if (on) {
                state.follows = state.follows.filter(x => x !== id);
              } else {
                if (state.follows.length >= 3) {
                  // gentle: swap last
                  state.follows = [...state.follows.slice(0,2), id];
                } else {
                  state.follows = [...state.follows, id];
                }
                sparkleBurst(btn);
              }

              refresh();
              if (state.follows.length >= 3) maybeAutoAdvance(520);
            }));

            refresh();
          },
          canNext: () => true, // optional
        },

        {
          id: "dna",
          scene: "dojo",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Fandom DNA",
          subtitle: "Ø§Ø®ØªØ± 5 Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª chips.",
          skippable: true,
          render: () => `
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>ğŸ§¬</span><span>Quest: Fandom DNA</span>
              </div>

              <div class="mt-3 flex items-start justify-between gap-3">
                <div>
                  <h1 class="text-2xl font-black tracking-tight">Ø§Ø®ØªØ± DNA Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h1>
                  <p class="mt-1 text-sm text-slate-200/70">Ù¥ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª ÙÙ‚Ø·â€¦ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
                </div>
                <div class="rounded-2xl border border-white/15 bg-white/5 px-3 py-2 text-center">
                  <div class="text-[11px] text-slate-200/65">Ù…Ø®ØªØ§Ø±</div>
                  <div class="text-lg font-black" id="dnaCount">${Math.min(state.interests.length,5)}/5</div>
                </div>
              </div>

              <div class="mt-4 flex flex-wrap gap-2">
                ${dnaChips.map(c => `
                  <button type="button" class="chip rounded-full px-3 py-2 text-xs font-black text-slate-100/85" data-chip="${c}">
                    ${c}
                  </button>
                `).join("")}
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ø¹Ù†Ø¯ 5 Ø§Ø®ØªÙŠØ§Ø±Ø§Øªâ€¦ <b>Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</b> âš”ï¸
              </div>
            </div>
          `,
          setup: () => {
            const chips = $$(".chip");
            const dnaCount = $("#dnaCount");

            const refresh = () => {
              dnaCount.textContent = `${Math.min(state.interests.length,5)}/5`;
              chips.forEach(ch => {
                const val = ch.dataset.chip;
                const on = state.interests.includes(val);
                ch.dataset.on = on ? "true" : "false";
              });
            };

            chips.forEach(ch => ch.addEventListener("click", () => {
              const val = ch.dataset.chip;
              const on = state.interests.includes(val);

              if (on) {
                state.interests = state.interests.filter(x => x !== val);
              } else {
                if (state.interests.length >= 5) return;
                state.interests = [...state.interests, val];
                sparkleBurst(ch);
              }
              refresh();

              if (state.interests.length === 5) maybeAutoAdvance(520);
            }));

            refresh();
          },
          canNext: () => true, // optional
        },

        {
          id: "finish",
          scene: "dawn",
          title: "Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø§Ù„Ù†Ù‡Ø§ÙŠØ©",
          subtitle: "Quest Complete + Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„.",
          skippable: false,
          render: () => `
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/80">
                <span>ğŸ</span><span>Quest: Finish</span>
              </div>

              <h1 class="mt-3 text-2xl font-black tracking-tight">ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© ğŸ‰</h1>
              <p class="mt-1 text-sm text-slate-200/70">Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…. Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø§Ù†ØºØ§ ÙˆØ§Ù„Ø£Ù†Ù…ÙŠ.</p>

              <div class="mt-4 rounded-3xl border border-white/15 bg-white/5 p-4 overflow-hidden relative">
                <div class="absolute inset-0 opacity-60 pointer-events-none"
                  style="background: radial-gradient(600px 260px at 20% 10%, rgba(34,211,238,.14), transparent 60%), radial-gradient(600px 260px at 90% 25%, rgba(236,72,153,.12), transparent 60%);"></div>

                <div class="relative flex items-center gap-3">
                  <div class="h-16 w-16 rounded-3xl border border-white/15 bg-white/5 grid place-items-center overflow-hidden">
                    ${avatars.find(a => a.id === state.avatar)?.svg || avatarSVG("nova")}
                  </div>
                  <div class="min-w-0 flex-1">
                    <div class="text-lg font-black truncate">${escapeHTML(state.name || "Adventurer")}</div>
                    <div class="text-xs text-slate-200/70 truncate">${maskEmail(state.email)}</div>
                    <div class="mt-2 inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-3 py-1 text-xs text-slate-100/85">
                      <span>${auraEmoji(state.aura)}</span>
                      <span>Aura: <b>${state.aura || "â€”"}</b></span>
                    </div>
                  </div>
                </div>

                <div class="relative mt-4 grid gap-3">
                  <div class="rounded-2xl border border-white/12 bg-white/5 p-3">
                    <div class="text-xs text-slate-200/70 mb-1">Ù£ ÙƒÙ„Ù…Ø§Øª</div>
                    <div class="flex flex-wrap gap-2">
                      ${state.bioWords.length ? state.bioWords.map(w => `<span class="holo-pill rounded-full px-3 py-1 text-xs font-black">${escapeHTML(w)}</span>`).join("") :
                        `<span class="text-xs text-slate-200/55">â€” (ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§)</span>`}
                    </div>
                  </div>

                  <div class="rounded-2xl border border-white/12 bg-white/5 p-3">
                    <div class="text-xs text-slate-200/70 mb-1">Senpai</div>
                    <div class="text-sm font-bold text-slate-100/85">
                      ${state.follows.length
                        ? state.follows.map(id => escapeHTML(mockSenpai.find(s => s.id === id)?.name || id)).join(" â€¢ ")
                        : `<span class="text-xs text-slate-200/55">â€” (Ù„Ø§Ø­Ù‚Ù‹Ø§)</span>`}
                    </div>
                  </div>

                  <div class="rounded-2xl border border-white/12 bg-white/5 p-3">
                    <div class="text-xs text-slate-200/70 mb-1">Fandom DNA</div>
                    <div class="flex flex-wrap gap-2">
                      ${state.interests.length
                        ? state.interests.map(i => `<span class="rounded-full border border-white/12 bg-white/5 px-3 py-1 text-xs font-black">${escapeHTML(i)}</span>`).join("")
                        : `<span class="text-xs text-slate-200/55">â€” (Ø§Ø®ØªÙŠØ§Ø±Ø§ØªÙƒ Ù„Ø§Ø­Ù‚Ù‹Ø§)</span>`}
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4 speech text-xs text-slate-200/85">
                Ù†ØµÙŠØ­Ø©: Ù„Ø§Ø­Ù‚Ù‹Ø§ØŒ Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§ÙŠÙˆØŒ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯ÙŠÙ†Ø©ØŒ ÙˆØ±Ø¨Ø· Ø­Ø³Ø§Ø¨Ø§Øªâ€¦ Ø¨Ø¯ÙˆÙ† Ø¶ØºØ· ğŸ˜Œ
              </div>
            </div>
          `,
          setup: () => {
            // show stamp once
            showStamp();
          },
          canNext: () => true,
        },
      ];

      // Motion toggle init
      const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      function setMotionEnabled(on){
        state.motionEnabled = !!on;
        document.documentElement.style.setProperty("--motion", on ? "1" : "0");
        document.body.classList.toggle("no-motion", !on);
        motionBtn.setAttribute("aria-pressed", String(!on ? "true" : "false"));
        motionBtn.textContent = on ? "ğŸï¸ Ø§Ù„Ø­Ø±ÙƒØ©: ON" : "ğŸ§Š Ø§Ù„Ø­Ø±ÙƒØ©: OFF";
      }

      // If prefers reduce -> default OFF, else ON
      setMotionEnabled(!prefersReduced);

      motionBtn.addEventListener("click", () => {
        setMotionEnabled(!(state.motionEnabled));
      });

      // Render / navigation
      function updateProgress(){
        // 3 nodes: early/mid/late
        const total = steps.length - 1; // finish included
        const t = state.step / Math.max(1, total);
        const stage = t < 0.34 ? 1 : (t < 0.67 ? 2 : 3);
        nodeEls.forEach((n, i) => n.classList.toggle("on", i < stage));
      }

      function setScene(scene){
        bg.dataset.scene = scene;
        hintBubble.textContent = steps[state.step].subtitle || "Ø¬Ø§Ù‡Ø²â€¦";
        // update swipe hint based on RTL: forward is swipe right (RTL) / left (LTR)
        swipeDirText.textContent = isRTL ? "ÙŠÙ…ÙŠÙ†Ù‹Ø§" : "ÙŠØ³Ø§Ø±Ù‹Ø§";
        manageStars(scene);
      }

      function updateActionBar(){
        const stepDef = steps[state.step];

        backBtn.disabled = state.step === 0;
        skipBtn.classList.toggle("hidden", !stepDef.skippable);
        nextBtn.textContent = state.step === steps.length - 1 ? "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù" : "Ù…ØªØ§Ø¨Ø¹Ø©";

        microCopy.textContent =
          state.step === 0 ? "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ¨Ø±ÙŠØ¯Ùƒâ€¦ ÙˆØ³Ø£ØªØ§Ø¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§." :
          state.step === 1 ? "Ù‚ÙÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±â€¦ Ø®Ù„Ù‘ÙŠÙ‡ Ù‚ÙˆÙŠ." :
          state.step === 2 ? "Ù‡Ø§Ù„Ø© + Ø£ÙØ§ØªØ§Ø±â€¦ Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ† ÙÙ‚Ø·." :
          state.step === 3 ? "ØªÙ‚Ø¯Ø± ØªØªØ®Ø·Ù‘Ù‰ â€” Ø¨Ø³ 3 ÙƒÙ„Ù…Ø§Øª ØªÙƒÙÙŠ." :
          state.step === 4 ? "Ø§ØªØ¨Ø¹ 3 Ø³Ù†Ø¨Ø§ÙŠâ€¦ ÙˆØ§Ù†ØªÙ‡ÙŠÙ†Ø§." :
          state.step === 5 ? "Ø§Ø®ØªØ± 5 Chipsâ€¦ ÙˆØªÙ…." :
          "Ø£Ù†Øª Ø¬Ø§Ù‡Ø².";

        subCopy.textContent =
          stepDef.skippable ? "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙŠÙ…ÙƒÙ† â€œÙ„Ø§Ø­Ù‚Ù‹Ø§â€." : "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„.";
      }

      function render(transition=true){
        const stepDef = steps[state.step];
        updateProgress();
        setScene(stepDef.scene);
        updateActionBar();

        if (transition && state.motionEnabled){
          card.classList.remove("cinematic-in");
          card.classList.add("cinematic-out");
          speedLines.classList.add("active");

          setTimeout(() => {
            speedLines.classList.remove("active");
            card.innerHTML = stepDef.render();
            stepDef.setup?.();

            card.classList.remove("cinematic-out");
            card.classList.add("cinematic-in");
          }, 170);
        } else {
          card.innerHTML = stepDef.render();
          stepDef.setup?.();
          card.classList.add("cinematic-in");
        }
      }

      function goNext({auto=false} = {}){
        const stepDef = steps[state.step];
        if (state.step >= steps.length - 1) {
          // "Start exploring" action: just a playful reset or show micro effect
          sparkleBurst(nextBtn);
          return;
        }

        if (!auto && !stepDef.canNext()){
          gentleNudge();
          return;
        }

        if (auto && !stepDef.canNext()) return;

        state.step += 1;
        render(true);
      }

      function goBack(){
        if (state.step === 0) return;
        state.step -= 1;
        render(true);
      }

      function skip(){
        if (!steps[state.step].skippable) return;
        state.step += 1;
        render(true);
      }

      backBtn.addEventListener("click", goBack);
      nextBtn.addEventListener("click", () => goNext({auto:false}));
      skipBtn.addEventListener("click", skip);

      // Auto-advance helper
      let autoTimer = null;
      function maybeAutoAdvance(delay=320){
        const stepDef = steps[state.step];
        if (!stepDef.canNext) return;
        if (!stepDef.canNext()) return;

        clearTimeout(autoTimer);
        autoTimer = setTimeout(() => {
          // cinematic nudge
          goNext({auto:true});
        }, state.motionEnabled ? delay : 0);
      }

      function gentleNudge(){
        // No harsh errors. Just a tiny hint + small sparkle.
        hintBubble.textContent = "Ù‚Ø±ÙŠØ¨! Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„Ø¨Ø³ÙŠØ·â€¦ ğŸ˜‰";
        sparkleBurst(hintBubble);
        if (state.motionEnabled){
          card.animate(
            [{transform:"translateX(0)"},{transform:"translateX(-6px)"},{transform:"translateX(6px)"},{transform:"translateX(0)"}],
            {duration: 260, easing: "cubic-bezier(.2,.9,.2,1)"}
          );
        }
      }

      // Swipe (optional)
      let tx0 = null, ty0 = null, t0 = 0;
      const swipeArea = document.body;

      swipeArea.addEventListener("touchstart", (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        const t = e.touches[0];
        tx0 = t.clientX; ty0 = t.clientY; t0 = Date.now();
      }, {passive:true});

      swipeArea.addEventListener("touchend", (e) => {
        if (tx0 == null) return;
        const dt = Date.now() - t0;
        if (dt > 650) { tx0=null; ty0=null; return; }

        const t = e.changedTouches && e.changedTouches[0];
        if (!t) { tx0=null; ty0=null; return; }

        const dx = t.clientX - tx0;
        const dy = t.clientY - ty0;

        // prefer horizontal
        if (Math.abs(dx) < 70 || Math.abs(dx) < Math.abs(dy)) { tx0=null; ty0=null; return; }

        // RTL: swipe right => next, swipe left => back
        const forward = isRTL ? dx > 70 : dx < -70;
        const backward = isRTL ? dx < -70 : dx > 70;

        if (forward) goNext({auto:false});
        else if (backward) goBack();

        tx0=null; ty0=null;
      }, {passive:true});

      // ===== Validation / Utils =====
      function isValidEmail(email){
        return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email.trim());
      }

      function passwordStrength(pw){
        const s = String(pw || "");
        let score = 0;
        if (s.length >= 8) score++;
        if (/[A-Z]/.test(s) && /[a-z]/.test(s)) score++;
        if (/\d/.test(s)) score++;
        if (/[^A-Za-z0-9]/.test(s)) score++;

        // compress a bit for friendliness
        const friendly = Math.min(4, Math.max(0, score));
        const label =
          friendly <= 1 ? "Ø¶Ø¹ÙŠÙ" :
          friendly === 2 ? "Ø¬ÙŠØ¯" :
          friendly === 3 ? "Ù‚ÙˆÙŠ" : "Ø£Ø³Ø·ÙˆØ±ÙŠ";

        return {score: friendly, label};
      }

      function auraEmoji(a){
        if (a === "Fire") return "ğŸ”¥";
        if (a === "Water") return "ğŸŒŠ";
        if (a === "Shadow") return "ğŸŒ‘";
        if (a === "Star") return "â­";
        return "âœ¨";
      }

      function maskEmail(email){
        const e = String(email || "").trim();
        const at = e.indexOf("@");
        if (at <= 1) return e || "â€”";
        const name = e.slice(0, at);
        const dom = e.slice(at);
        return name.slice(0, 1) + "â€¢â€¢â€¢" + name.slice(-1) + dom;
      }

      function escapeHTML(s){
        return String(s ?? "").replace(/[&<>"']/g, m => ({
          "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
        }[m]));
      }

      // ===== FX =====
      function sparkleBurst(el){
        if (!state.motionEnabled) return;

        const rect = el.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;

        const count = 12;
        for (let i=0; i<count; i++){
          const sp = document.createElement("div");
          sp.className = "sparkle";
          const a = (Math.PI * 2) * (i / count) + (Math.random() * 0.35);
          const r = 30 + Math.random() * 44;
          const tx = cx + Math.cos(a)*r;
          const ty = cy + Math.sin(a)*r;
          sp.style.left = cx + "px";
          sp.style.top = cy + "px";
          sp.style.setProperty("--tx", (tx) + "px");
          sp.style.setProperty("--ty", (ty) + "px");
          document.body.appendChild(sp);
          setTimeout(() => sp.remove(), 850);
        }
      }

      let stampedOnce = false;
      function showStamp(){
        if (stampedOnce || !state.motionEnabled) return;
        stampedOnce = true;
        stamp.classList.add("show");
        setTimeout(() => stamp.classList.remove("show"), 900);
      }

      // ===== Avatars SVG =====
      function avatarSVG(kind){
        const common = `width="44" height="44" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"`;
        if (kind === "blade") return `
          <svg ${common}>
            <path d="M14 46c8-18 18-28 36-30-2 18-12 28-30 36" stroke="rgba(255,255,255,.78)" stroke-width="2.2" stroke-linecap="round"/>
            <path d="M26 38l12-12" stroke="rgba(34,211,238,.75)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="22" cy="42" r="3.5" fill="rgba(236,72,153,.65)"/>
          </svg>`;
        if (kind === "kitsune") return `
          <svg ${common}>
            <path d="M16 42c2-14 10-22 16-22s14 8 16 22c-8 6-24 6-32 0z" stroke="rgba(255,255,255,.78)" stroke-width="2.2" />
            <path d="M22 26l-6-10 12 6" stroke="rgba(34,211,238,.7)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M42 26l6-10-12 6" stroke="rgba(236,72,153,.65)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="28" cy="34" r="2" fill="rgba(255,255,255,.8)"/>
            <circle cx="36" cy="34" r="2" fill="rgba(255,255,255,.8)"/>
          </svg>`;
        if (kind === "echo") return `
          <svg ${common}>
            <circle cx="32" cy="32" r="18" stroke="rgba(255,255,255,.78)" stroke-width="2.2"/>
            <circle cx="32" cy="32" r="10" stroke="rgba(34,211,238,.7)" stroke-width="2.2" stroke-dasharray="3 4"/>
            <path d="M22 32h20" stroke="rgba(236,72,153,.65)" stroke-width="2.6" stroke-linecap="round"/>
          </svg>`;
        if (kind === "nova") return `
          <svg ${common}>
            <path d="M32 12l5 13 15 2-12 9 4 14-12-8-12 8 4-14-12-9 15-2 5-13z"
              stroke="rgba(255,255,255,.82)" stroke-width="2.2" fill="rgba(34,211,238,.10)"/>
            <circle cx="32" cy="32" r="3.2" fill="rgba(236,72,153,.7)"/>
          </svg>`;
        if (kind === "zen") return `
          <svg ${common}>
            <path d="M16 34c8-14 24-14 32 0" stroke="rgba(255,255,255,.78)" stroke-width="2.2" stroke-linecap="round"/>
            <path d="M18 40c10 10 18 10 28 0" stroke="rgba(34,211,238,.7)" stroke-width="2.2" stroke-linecap="round"/>
            <circle cx="24" cy="30" r="2" fill="rgba(236,72,153,.65)"/>
            <circle cx="40" cy="30" r="2" fill="rgba(236,72,153,.65)"/>
          </svg>`;
        if (kind === "glitch") return `
          <svg ${common}>
            <path d="M18 20h28v28H18z" stroke="rgba(255,255,255,.78)" stroke-width="2.2"/>
            <path d="M22 24h18" stroke="rgba(34,211,238,.75)" stroke-width="2.6" stroke-linecap="round"/>
            <path d="M22 32h12" stroke="rgba(236,72,153,.7)" stroke-width="2.6" stroke-linecap="round"/>
            <path d="M22 40h20" stroke="rgba(34,211,238,.75)" stroke-width="2.6" stroke-linecap="round"/>
          </svg>`;
        return `
          <svg ${common}>
            <circle cx="32" cy="32" r="18" stroke="rgba(255,255,255,.78)" stroke-width="2.2"/>
            <path d="M24 34c4 4 12 4 16 0" stroke="rgba(34,211,238,.75)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>`;
      }

      function senpaiBadgeSVG(seed){
        // deterministic-ish icon based on id
        const map = {
          sen1: ["rgba(251,146,60,.35)","rgba(34,211,238,.22)","M16 42c10-18 22-22 32-28-2 18-10 28-22 36"],
          sen2: ["rgba(34,211,238,.28)","rgba(168,85,247,.22)","M16 34c6-10 16-16 32-16-4 18-14 26-26 30"],
          sen3: ["rgba(148,163,184,.24)","rgba(236,72,153,.18)","M18 44c4-16 12-26 28-26 0 16-8 24-18 30"],
          sen4: ["rgba(168,85,247,.26)","rgba(250,204,21,.18)","M32 14l6 14 14 4-12 9 3 13-11-7-11 7 3-13-12-9 14-4 6-14z"],
          sen5: ["rgba(236,72,153,.22)","rgba(34,211,238,.14)","M18 42c10-4 14-18 28-22-2 12-8 20-20 26"],
          sen6: ["rgba(34,211,238,.22)","rgba(59,130,246,.16)","M18 22h28v20H18z"],
          sen7: ["rgba(244,114,182,.22)","rgba(250,204,21,.14)","M20 40c6-12 18-12 24 0-8 6-16 6-24 0"],
          sen8: ["rgba(250,204,21,.18)","rgba(148,163,184,.14)","M20 20h24v28H20z"],
        };
        const [c1,c2,shape] = map[seed] || map.sen4;
        return `
          <svg width="44" height="44" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="g${seed}" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="${c1}"/>
                <stop offset="1" stop-color="${c2}"/>
              </linearGradient>
            </defs>
            <rect x="10" y="10" width="44" height="44" rx="16" fill="url(#g${seed})" />
            <path d="${shape}" stroke="rgba(255,255,255,.78)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
      }

      // ===== Galaxy canvas =====
      const canvas = $("#starCanvas");
      const ctx = canvas.getContext("2d");
      let stars = [];
      let raf = null;

      function resizeCanvas(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        const rect = bg.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);

        // regenerate
        const count = Math.floor((rect.width * rect.height) / 18000);
        stars = Array.from({length: Math.max(60, Math.min(180, count))}, () => ({
          x: Math.random() * rect.width,
          y: Math.random() * rect.height,
          r: Math.random() * 1.6 + 0.2,
          a: Math.random() * 0.8 + 0.2,
          vx: (Math.random() - 0.5) * 0.25,
          vy: (Math.random() - 0.5) * 0.18
        }));
        drawStars(true);
      }

      function drawStars(staticOnly=false){
        const rect = bg.getBoundingClientRect();
        ctx.clearRect(0,0,rect.width,rect.height);

        // nebula haze
        const g = ctx.createRadialGradient(rect.width*0.3, rect.height*0.25, 0, rect.width*0.3, rect.height*0.25, rect.width*0.9);
        g.addColorStop(0, "rgba(99,102,241,0.10)");
        g.addColorStop(0.6, "rgba(34,211,238,0.06)");
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.fillRect(0,0,rect.width,rect.height);

        for (const s of stars){
          ctx.beginPath();
          ctx.fillStyle = `rgba(255,255,255,${s.a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();

          if (!staticOnly){
            s.x += s.vx;
            s.y += s.vy;
            if (s.x < -10) s.x = rect.width + 10;
            if (s.x > rect.width + 10) s.x = -10;
            if (s.y < -10) s.y = rect.height + 10;
            if (s.y > rect.height + 10) s.y = -10;
          }
        }
      }

      function animateStars(){
        if (!state.motionEnabled) return;
        drawStars(false);
        raf = requestAnimationFrame(animateStars);
      }

      function stopStars(){
        if (raf) cancelAnimationFrame(raf);
        raf = null;
      }

      function manageStars(scene){
        if (scene === "galaxy"){
          resizeCanvas();
          stopStars();
          if (state.motionEnabled) animateStars();
          else drawStars(true);
        } else {
          stopStars();
        }
      }

      window.addEventListener("resize", () => {
        if (bg.dataset.scene === "galaxy") resizeCanvas();
      });

      // Initial render
      render(false);

      // If user toggles motion during galaxy
      const _origSetMotionEnabled = setMotionEnabled;
      // patch by observing button state already set; we just ensure stars update on toggle:
      motionBtn.addEventListener("click", () => {
        setTimeout(() => {
          manageStars(bg.dataset.scene);
        }, 0);
      });

      // Helpful microcopy refresh on step changes (and keep it short)
      const obs = new MutationObserver(() => {
        hintBubble.textContent = steps[state.step].subtitle || "Ø¬Ø§Ù‡Ø²â€¦";
      });
      obs.observe(card, {childList:true, subtree:true});
    })();
  </script>
</body>
</html>
