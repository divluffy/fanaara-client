<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onboarding / Register Modal (Anime Social UX)</title>

  <!-- Font (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† ÙŠØ¹Ø·ÙŠ Ø·Ø§Ø¨Ø¹ Ø£Ù„Ø·Ù Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      /* Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø«ÙŠÙ… "Ø£ÙˆÙ„Ø§Ø¯" (Ø£Ø²Ø±Ù‚/ØªØ±ÙƒÙˆØ§Ø²) */
      --accent: #06b6d4;       /* cyan-500 */
      --accent2:#3b82f6;       /* blue-500 */
      --accentSoft:#cffafe;    /* cyan-100 */
      --accentSoft2:#dbeafe;   /* blue-100 */
      --ink:#0f172a;           /* slate-900 */
      --muted:#475569;         /* slate-600 */
    }

    [data-theme="girls"]{
      --accent: #ec4899;       /* pink-500 */
      --accent2:#8b5cf6;       /* violet-500 */
      --accentSoft:#fce7f3;    /* pink-100 */
      --accentSoft2:#ede9fe;   /* violet-100 */
    }

    html, body { height: 100%; }
    body { font-family: "Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø·ÙŠÙ Ù„Ù„Ø®Ø·ÙˆØ© */
    .fade-slide-in { animation: fadeSlideIn .35s ease both; }
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(12px) scale(.99); }
      to   { opacity: 1; transform: translateY(0)    scale(1); }
    }

    /* Ù„Ù…Ø³Ø© "Ø£Ù†Ù…ÙŠ" Ø¨Ø³ÙŠØ·Ø©: Ø³Ø¨Ø§Ø±ÙƒÙ„ */
    .sparkle {
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.9) 0 2px, transparent 3px),
        radial-gradient(circle at 80% 35%, rgba(255,255,255,.8) 0 2px, transparent 3px),
        radial-gradient(circle at 55% 75%, rgba(255,255,255,.7) 0 2px, transparent 3px);
      filter: blur(.1px);
      opacity: .55;
      pointer-events: none;
    }

    /* ØªÙ…Ø±ÙŠØ± Ù„Ø·ÙŠÙ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ùˆ Ø§Ø­ØªØ§Ø¬ */
    .nice-scroll::-webkit-scrollbar { width: 10px; }
    .nice-scroll::-webkit-scrollbar-thumb { background: rgba(15,23,42,.12); border-radius: 999px; }
    .nice-scroll::-webkit-scrollbar-track { background: transparent; }

    /* ØªÙ…ÙŠÙŠØ² focus Ù„Ø·ÙŠÙ */
    :focus-visible { outline: 3px solid rgba(59,130,246,.35); outline-offset: 2px; border-radius: 12px; }

    /* Progress Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… scale (ÙŠÙ…ØªØ¯ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ RTL) */
    #progressBar { transform-origin: right center; transform: scaleX(0); }

    /* Ø´Ø§Ø±Ø© ØµØºÙŠØ±Ø© */
    .badge {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .55rem; border-radius: 999px;
      font-size:.75rem; font-weight:700;
      background: rgba(15,23,42,.06);
      color: rgba(15,23,42,.72);
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50 text-slate-900">
  <!-- Ø®Ù„ÙÙŠØ© Ø­ÙŠÙˆÙŠØ© -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_15%_20%,rgba(99,102,241,.18),transparent_45%),radial-gradient(circle_at_85%_25%,rgba(236,72,153,.14),transparent_45%),radial-gradient(circle_at_60%_80%,rgba(34,197,94,.10),transparent_50%)]"></div>
    <div class="absolute inset-0 opacity-60 sparkle"></div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-slate-950/40 backdrop-blur-sm flex items-center justify-center p-4">
    <!-- Modal -->
    <section
      id="modal"
      data-theme="boys"
      class="relative w-full max-w-3xl bg-white/95 rounded-[28px] shadow-2xl ring-1 ring-slate-200 overflow-hidden"
      role="dialog"
      aria-modal="true"
      aria-label="ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
    >
      <!-- Ø²Ø®Ø§Ø±Ù -->
      <div class="pointer-events-none absolute -top-20 -right-20 w-64 h-64 rounded-full blur-3xl bg-[color:var(--accentSoft)] opacity-80"></div>
      <div class="pointer-events-none absolute -bottom-24 -left-24 w-72 h-72 rounded-full blur-3xl bg-[color:var(--accentSoft2)] opacity-70"></div>

      <!-- Header -->
      <header class="relative px-6 pt-6 pb-4 border-b border-slate-100">
        <div class="flex items-start justify-between gap-4">
          <div class="flex items-center gap-3">
            <!-- Logo -->
            <div class="w-12 h-12 rounded-2xl bg-[color:var(--accentSoft)] ring-1 ring-slate-200 flex items-center justify-center">
              <!-- Anime SVG Logo -->
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 2.5c2.9 0 5.4 1.2 7.1 3.2-1.3.1-2.6.6-3.6 1.5-1.4 1.2-2.3 3-2.3 5.1 0 2 .8 3.8 2.1 5.1 1.1 1 2.5 1.6 4 1.7-1.7 1.9-4.1 3.1-7.3 3.1-5.3 0-9.5-4-9.5-9.1S6.7 2.5 12 2.5Z" fill="rgba(15,23,42,.9)"/>
                <path d="M9.3 9.3c.6-.7 1.6-1.1 2.7-1.1 1.1 0 2.1.4 2.7 1.1" stroke="rgba(255,255,255,.9)" stroke-width="1.7" stroke-linecap="round"/>
                <path d="M8.2 13.7c1 .9 2.3 1.4 3.8 1.4s2.8-.5 3.8-1.4" stroke="rgba(255,255,255,.9)" stroke-width="1.7" stroke-linecap="round"/>
                <circle cx="8.2" cy="8.7" r="1.1" fill="rgba(255,255,255,.95)"/>
                <circle cx="15.8" cy="8.7" r="1.1" fill="rgba(255,255,255,.95)"/>
              </svg>
            </div>

            <div class="min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <h1 class="text-lg sm:text-xl font-extrabold tracking-tight text-slate-900" id="stepTitle"></h1>
                <span class="badge" id="stepCounter"></span>
              </div>
              <p class="text-sm text-slate-600 mt-1 leading-relaxed" id="stepDesc"></p>
            </div>
          </div>

          <button id="closeBtn" class="shrink-0 w-10 h-10 rounded-xl hover:bg-slate-100 active:bg-slate-200 transition flex items-center justify-center" aria-label="Ø¥ØºÙ„Ø§Ù‚">
            <!-- X icon -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" stroke="rgba(15,23,42,.85)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <!-- Stepper + Progress -->
        <div class="mt-5 flex flex-col gap-3">
          <div id="stepper" class="flex flex-row-reverse items-center justify-between gap-2"></div>

          <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="progressBar" class="h-full w-full bg-[color:var(--accent)] rounded-full transition-transform duration-500"></div>
          </div>
        </div>
      </header>

      <!-- Content -->
      <main class="relative px-6 py-6">
        <div id="stepContent" class="min-h-[360px] nice-scroll"></div>
      </main>

      <!-- Footer Nav -->
      <footer class="sticky bottom-0 px-6 py-4 bg-white/90 backdrop-blur border-t border-slate-100">
        <div class="flex items-center justify-between gap-3">
          <button id="backBtn"
            class="inline-flex items-center gap-2 px-4 py-2.5 rounded-2xl border border-slate-200 hover:bg-slate-50 active:bg-slate-100 transition disabled:opacity-45 disabled:cursor-not-allowed">
            <!-- Arrow (RTL back = right) -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10 6l6 6-6 6" stroke="rgba(15,23,42,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="font-bold">Ø§Ù„Ø³Ø§Ø¨Ù‚</span>
          </button>

          <div class="flex items-center gap-2">
            <button id="skipBtn"
              class="inline-flex items-center gap-2 px-4 py-2.5 rounded-2xl border border-slate-200 hover:bg-slate-50 active:bg-slate-100 transition">
              <span class="font-bold">ØªØ®Ø·ÙŠ</span>
              <!-- Cloud icon -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7.5 18.5h9.4c2.1 0 3.6-1.5 3.6-3.3 0-1.7-1.3-3.1-3-3.3-.3-3-2.7-5.4-6-5.4-3 0-5.5 2-6 4.8-1.7.2-3 1.6-3 3.4 0 1.9 1.6 3.8 4 3.8Z" stroke="rgba(15,23,42,.75)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>

            <button id="nextBtn"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-2xl bg-[color:var(--accent)] text-white hover:brightness-105 active:brightness-95 transition shadow-sm">
              <span class="font-extrabold" id="nextLabel">Ø§Ù„ØªØ§Ù„ÙŠ</span>
              <!-- Arrow (RTL next = left) -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M14 6l-6 6 6 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="mt-2 text-xs text-slate-500 leading-relaxed" id="microHint"></div>
      </footer>

      <!-- Toast -->
      <div id="toast" class="pointer-events-none absolute top-4 left-4 z-20 hidden">
        <div class="pointer-events-auto bg-slate-900 text-white text-sm px-4 py-3 rounded-2xl shadow-lg">
          <span id="toastMsg"></span>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== Inline SVG Icons (Ù†Ø¬Ù…Ø©/ÙƒØªØ§Ø¨/Ù‚Ù†Ø§Ø¹/...) =====
    const ICONS = {
      star: `
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2.6l2.7 6 6.5.6-4.9 4.3 1.5 6.4-5.8-3.4-5.8 3.4 1.5-6.4-4.9-4.3 6.5-.6L12 2.6Z"
            fill="rgba(255,255,255,.95)"/>
        </svg>
      `,
      book: `
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 4.5h9.5c1.4 0 2.5 1.1 2.5 2.5v12.5c0-1.1-1-2-2.3-2H7c-1.2 0-2.2.9-2.2 2V7c0-1.4 1.1-2.5 2.5-2.5Z"
            stroke="rgba(15,23,42,.75)" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M7.2 7.5h8.8M7.2 10.5h8.8" stroke="rgba(15,23,42,.55)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      `,
      mask: `
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 7.5c2.6 2.4 6 3.6 7 3.6s4.4-1.2 7-3.6v6.2c0 4-3.1 7.2-7 7.2s-7-3.2-7-7.2V7.5Z"
            stroke="rgba(15,23,42,.75)" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M8.2 12.5c.9-1 2.1-1.5 3.8-1.5s2.9.5 3.8 1.5" stroke="rgba(15,23,42,.55)" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M9 15.8c.8.8 1.8 1.2 3 1.2s2.2-.4 3-1.2" stroke="rgba(15,23,42,.55)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      `,
      sparkles: `
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2l1.3 4.2L18 7.5l-4.7 1.3L12 13l-1.3-4.2L6 7.5l4.7-1.3L12 2Z" fill="rgba(255,255,255,.95)"/>
          <path d="M19.5 12.5l.8 2.6 2.7.8-2.7.8-.8 2.6-.8-2.6-2.7-.8 2.7-.8.8-2.6Z" fill="rgba(255,255,255,.9)"/>
        </svg>
      `,
      bolt: `
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M13 2L5 14h7l-1 8 8-12h-7l1-8Z" fill="rgba(255,255,255,.95)"/>
        </svg>
      `
    };

    // ===== Suggestions / Data =====
    const COUNTRIES = ["ÙÙ„Ø³Ø·ÙŠÙ†", "Ø§Ù„Ø£Ø±Ø¯Ù†", "Ù…ØµØ±", "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", "Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª", "Ø§Ù„Ù…ØºØ±Ø¨", "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "ØªÙˆÙ†Ø³", "Ø§Ù„Ø¹Ø±Ø§Ù‚", "Ø³ÙˆØ±ÙŠØ§", "Ù„Ø¨Ù†Ø§Ù†", "Ù‚Ø·Ø±", "Ø§Ù„ÙƒÙˆÙŠØª", "Ø¹ÙÙ…Ø§Ù†", "Ø§Ù„ÙŠÙ…Ù†", "ØªØ±ÙƒÙŠØ§", "ÙØ±Ù†Ø³Ø§", "Ø£Ù„Ù…Ø§Ù†ÙŠØ§", "Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©", "Ø£Ø®Ø±Ù‰"];

    const ANIME_GENRES = [
      "Shonen", "Isekai", "Romance", "Slice of Life", "Seinen", "Sports", "Mystery",
      "Fantasy", "Sci-Fi", "Horror", "Comedy", "Drama", "Mecha", "Music", "Psychological"
    ];

    const MUST_HAVE = [
      "ÙˆÙ† Ø¨ÙŠØ³", "Ù†Ø§Ø±ÙˆØªÙˆ", "Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¹Ù…Ø§Ù„Ù‚Ø©", "Ù‚Ø§ØªÙ„ Ø§Ù„Ø´ÙŠØ§Ø·ÙŠÙ†", "Ø¬ÙˆØ¬ÙˆØªØ³Ùˆ ÙƒØ§ÙŠØ³Ù†",
      "Ø¯ÙØªØ± Ø§Ù„Ù…ÙˆØª", "Ù‡Ù†ØªØ± Ã— Ù‡Ù†ØªØ±", "ÙÙˆÙ„Ù…ØªØ§Ù„ Ø£Ù„ÙƒÙŠÙ…ÙŠØ³Øª", "Ù‡Ø§ÙŠÙƒÙŠÙˆ!!", "Your Name"
    ];

    const MANGA_COMICS = [
      "Ù…Ø§Ù†Ø¬Ø§ Ø´ÙˆØ¬Ùˆ", "Ù…Ø§Ù†Ø¬Ø§ Ø´ÙˆÙ†ÙŠÙ†", "Ø³ÙŠÙ†ÙŠÙ†", "ÙˆÙŠØ¨ ØªÙˆÙ†", "Ù…Ø§Ù†Ù‡Ùˆ/Ù…Ø§Ù†Ù‡ÙˆØ§",
      "ÙƒÙˆÙ…ÙŠÙƒØ³ Ù…Ø§Ø±ÙÙ„", "ÙƒÙˆÙ…ÙŠÙƒØ³ DC", "Indie Comics", "Ù„Ø§ÙŠØª Ù†ÙˆÙÙ„", "Ø¯ÙˆØ¬ÙŠÙ†Ø´ÙŠ"
    ];

    const FEED_TYPES = [
      { key:"short", label:"Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø³Ø±ÙŠØ¹Ø©", desc:"Ù„Ù‚Ø·Ø§Øª Ù‚ØµÙŠØ±Ø©â€¦ ØªÙˆØµÙ„ Ù„Ùƒ Ø§Ù„Ø²Ø¨Ø¯Ø©." },
      { key:"talk",  label:"Ù†Ù‚Ø§Ø´Ø§Øª",       desc:"Ø£Ø³Ø¦Ù„Ø© + ØªØ­Ù„ÙŠÙ„Ø§Øª + Ù†Ø¸Ø±ÙŠØ§Øª." },
      { key:"art",   label:"Fanart",       desc:"ÙÙ† ÙˆØ¥Ù„Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠ Ù„Ø·ÙŠÙ." },
      { key:"memes", label:"Ù…ÙŠÙ…Ø²",         desc:"Ø¶Ø­Ùƒ Ø®ÙÙŠÙ Ø¨Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠØ¯." },
      { key:"news",  label:"Ø£Ø®Ø¨Ø§Ø±",        desc:"Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ø³Ø±Ø¹Ø©." },
    ];

    const VIBES = [
      { key:"calm", label:"Ù‡Ø§Ø¯Ø¦ âœ¨", desc:"ØªÙˆØµÙŠØ§Øª Ù†Ø§Ø¹Ù…Ø© ÙˆÙ…Ø­ØªÙˆÙ‰ Ù…Ø±ÙŠØ­." },
      { key:"hype", label:"Ø­Ù…Ø§Ø³ÙŠ ğŸ”¥", desc:"ØªØ±Ù†Ø¯Ø§ØªØŒ Ù…Ø¹Ø§Ø±ÙƒØŒ ØªØ­Ø¯ÙŠØ§Øª." },
      { key:"myst", label:"ØºØ§Ù…Ø¶ ğŸ­", desc:"ØºÙ…ÙˆØ¶ ÙˆØªØ­Ù„ÙŠÙ„ ÙˆÙ‚Ø·Ø¹ Ø£Ø¯Ù„Ø©." },
      { key:"fun",  label:"ÙƒÙˆÙ…ÙŠØ¯ÙŠ ğŸ˜‚", desc:"Ù…ÙŠÙ…Ø² ÙˆØ¶Ø­Ùƒ ÙˆØªÙØ§Ø¹Ù„ Ø³Ø±ÙŠØ¹." }
    ];

    const AVATARS = [
      { id:"a1", emoji:"ğŸ¦Š" }, { id:"a2", emoji:"ğŸ¼" }, { id:"a3", emoji:"ğŸ²" }, { id:"a4", emoji:"ğŸ±" },
      { id:"a5", emoji:"ğŸ¦" }, { id:"a6", emoji:"ğŸ¦„" }, { id:"a7", emoji:"ğŸ™" }, { id:"a8", emoji:"ğŸ¦‰" }
    ];

    const SUGGESTED_ACCOUNTS = [
      { id:"u1", name:"Ø³ÙÙŠÙ†Ø¨Ø§ÙŠ_Ø³ÙˆØ´ÙŠØ§Ù„", handle:"@senpai.social", tags:["Ù†Ù‚Ø§Ø´Ø§Øª","ØªØ±Ù†Ø¯"] },
      { id:"u2", name:"Ù…Ø§Ù†Ø¬Ø§_Ù„Ø§ÙˆÙ†Ø¬",   handle:"@manga.lounge",  tags:["Ù…Ø§Ù†Ø¬Ø§","ÙˆÙŠØ¨ ØªÙˆÙ†"] },
      { id:"u3", name:"ÙØ§Ù†_Ø¢Ø±Øª_Ø¯ÙŠÙ„ÙŠ",  handle:"@fanart.daily",  tags:["Fanart","Ø¥Ù„Ù‡Ø§Ù…"] },
      { id:"u4", name:"Ø³Ø¨ÙˆÙŠÙ„Ø±_ÙØ±ÙŠ",    handle:"@spoiler.free",  tags:["Ø¨Ø¯ÙˆÙ† Ø­Ø±Ù‚","ØªÙˆØµÙŠØ§Øª"] },
      { id:"u5", name:"Ù†Ø¸Ø±ÙŠØ§Øª_Ø£ÙˆØªØ§ÙƒÙˆ", handle:"@otaku.theory",  tags:["ØªØ­Ù„ÙŠÙ„","Ù†Ø¸Ø±ÙŠØ§Øª"] },
    ];

    // ===== State =====
    const state = {
      step: 1,
      goal: "",
      email: "",
      password: "",
      displayName: "",
      age16: "yes", // yes/no
      country: "ÙÙ„Ø³Ø·ÙŠÙ†",
      theme: "boys", // boys/girls
      vibe: "calm",
      avatar: "a1",
      uploadedImage: "",

      animeGenres: [],
      mustHave: [],

      mangaInterests: [],
      feedType: "talk",

      follows: new Set(),

      spoiler: "hide", // hide/click/show
      homeDefault: "discover" // following/discover/trending
    };

    // ===== Steps Meta =====
    const STEPS = [
      {
        title: "Ø§Ø®ØªØ± Ù‡Ø¯ÙÙƒâ€¦ Ø¹Ø´Ø§Ù† Ù†ÙˆØµÙ„ Ù„Ùƒ Ø§Ù„Ù„ÙŠ ØªØ­Ø¨Ù‡",
        desc: "Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ÙŠØ¶Ø¨Ø· ØªÙˆØµÙŠØ§ØªÙƒ ÙˆØ§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ù† Ø£ÙˆÙ„ ÙŠÙˆÙ….",
        hint: "Ù†ØµÙŠØ­Ø©: ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ù‡Ø¯ÙÙƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª."
      },
      {
        title: "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø³Ø±Ø¹Ø©",
        desc: "Ù‡Ø°Ø§ ÙÙ‚Ø· Ù„Ø­ÙØ¸ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.",
        hint: "Ø¨Ø¯ÙˆÙ† ØªØ­Ù‚Ù‚â€¦ Ø§ÙƒØªØ¨ Ø£ÙŠ Ø´ÙŠØ¡ Ø§Ù„Ø¢Ù† Ù„Ùˆ ØªØ­Ø¨ ÙˆØªÙƒÙ…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§."
      },
      {
        title: "Ø¨ÙŠØ§Ù†Ø§Øª Ø®ÙÙŠÙØ© Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„Ø·ÙŠÙ",
        desc: "Ø§Ø³Ù… Ø¹Ø±Ø¶ Ø¨Ø³ÙŠØ· + ØªØ£ÙƒÙŠØ¯ +16 ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ù†Ø±ØªÙ‘Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨.",
        hint: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù‚Ù‚â€”ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„."
      },
      {
        title: "Ø§Ø®ØªÙØ± Ø§Ù„Ø«ÙŠÙ… ÙˆØ§Ù„Ù€ vibe",
        desc: "Ø§Ù„Ø«ÙŠÙ… ÙŠØºÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø²Ø®Ø§Ø±Ùâ€¦ ÙˆØ§Ù„Ù€ vibe ÙŠØ¶Ø¨Ø· Ù…Ø²Ø§Ø¬ Ø§Ù„Ù€ feed.",
        hint: "Ø¬Ø±Ù‘Ø¨ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… ÙˆØ´ÙˆÙ Ø§Ù„ÙØ±Ù‚ ÙÙˆØ±Ù‹Ø§."
      },
      {
        title: "Ø£ÙØ§ØªØ§Ø± Ø£Ù†Ù…ÙŠ Ø³Ø±ÙŠØ¹",
        desc: "ØµÙˆØ±Ø© Ù„Ø·ÙŠÙØ© = ØªÙØ§Ø¹Ù„ Ø£Ø³Ø±Ø¹â€¦ Ø§Ø®ØªØ± Ø£ÙØ§ØªØ§Ø± Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ.",
        hint: "ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ø£ÙØ§ØªØ§Ø±Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª."
      },
      {
        title: "Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø£Ù†Ù…ÙŠâ€¦ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØªØ¨Ø¯Ø£ Ø§Ù„Ù…ØªØ¹Ø©",
        desc: "Ø§Ø®ØªØ± Genres ØªØ­Ø¨Ù‡Ø§ + 3 Ø£Ø´ÙŠØ§Ø¡ Ù…Ø§ ØªÙ‚Ø¯Ø± ØªØªØ±ÙƒÙ‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).",
        hint: "ØªÙ„Ù…ÙŠØ­: Ø­ØªÙ‰ Ù„Ùˆ Ø§Ø®ØªØ±Øª ÙƒØ«ÙŠØ±â€¦ Ù…Ø§ ÙÙŠ Ù…Ø´ÙƒÙ„Ø©."
      },
      {
        title: "Ù…Ø§Ù†Ø¬Ø§/ÙƒÙˆÙ…ÙŠÙƒØ³ + Ù†ÙˆØ¹ Ø§Ù„Ù€ feed",
        desc: "Ø®Ù„Ù‘Ø· Ù…Ø§Ù†Ø¬Ø§ ÙˆÙƒÙˆÙ…ÙŠÙƒØ³â€¦ ÙˆØ§Ø®ØªØ± Ø´ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù„ÙŠ ØªØ­Ø¨ ØªØ´ÙˆÙÙ‡ ÙŠÙˆÙ…ÙŠÙ‹Ø§.",
        hint: "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù€ feed ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ù†Ù‚Ù„Ù„ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡."
      },
      {
        title: "ØªØ§Ø¨Ø¹ Ø­Ø³Ø§Ø¨Ø§Øª ØªÙ‚ØªØ±Ø­Ù‡Ø§ Ù„Ùƒ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ",
        desc: "Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø³ÙŠØ·Ø© ØªØ¹Ø·ÙŠÙƒ Ù…Ø¬ØªÙ…Ø¹ Ø³Ø±ÙŠØ¹ ÙˆØªÙØ§Ø¹Ù„ Ù…Ù† Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø©.",
        hint: "Ù…ØªØ§Ø¨Ø¹Ø©/Ø¥Ù„ØºØ§Ø¡â€¦ Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©."
      },
      {
        title: "ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø¨ÙˆÙŠÙ„Ø± ÙˆØ§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        desc: "Ø­Ø¯Ø¯ Ø¹Ù„Ø§Ù‚ØªÙƒ Ø¨Ø§Ù„Ø­Ø±Ù‚â€¦ ÙˆØ§Ø®ØªØ± Ø£ÙŠÙ† ØªØ¨Ø¯Ø£ ÙƒÙ„ Ù…Ø±Ø© ØªÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.",
        hint: "ØªÙ‚Ø¯Ø± ØªØ¨Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©."
      },
      {
        title: "Ø¬Ø§Ù‡Ø²! Ø®Ù„Ù‘Ù†Ø§ Ù†Ø¨Ø¯Ø£ Ø¨Ø´ÙƒÙ„ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ",
        desc: "Ø´ÙƒÙ‘Ù„Ù†Ø§ ØªØ¬Ø±Ø¨ØªÙƒ Ø¹Ù„Ù‰ Ø°ÙˆÙ‚Ùƒâ€¦ Ø¨Ù‚ÙŠ Ø²Ø± ÙˆØ§Ø­Ø¯ ÙˆØªØ¯Ø®Ù„ Ø¹Ø§Ù„Ù…Ùƒ.",
        hint: "Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ù„Ø®Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡."
      }
    ];

    // ===== Helpers =====
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function toast(msg){
      const t = $("#toast");
      $("#toastMsg").textContent = msg;
      t.classList.remove("hidden");
      setTimeout(() => t.classList.add("hidden"), 1800);
    }

    function clampStep(n){
      return Math.max(1, Math.min(10, n));
    }

    function setTheme(theme){
      state.theme = theme;
      $("#modal").setAttribute("data-theme", theme);
    }

    function isSelectedArray(arr, val){ return arr.includes(val); }
    function toggleArray(key, val){
      const arr = state[key];
      const i = arr.indexOf(val);
      if (i >= 0) arr.splice(i, 1);
      else arr.push(val);
    }

    function toggleFollow(id){
      if (state.follows.has(id)) state.follows.delete(id);
      else state.follows.add(id);
    }

    function progressScale(){
      // 1..10 -> 0.1..1.0
      return state.step / 10;
    }

    // ===== Render Pieces =====
    function stepperHTML(){
      // RTL: Ù†Ø¶Ø¹ 1 ÙŠÙ…ÙŠÙ† Ùˆ10 ÙŠØ³Ø§Ø±ØŒ Ù„Ø°Ø§ flex-row-reverse
      const items = [];
      for (let i=1; i<=10; i++){
        const active = i === state.step;
        const done = i < state.step;

        items.push(`
          <button
            class="group relative shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full grid place-items-center transition
              ${active ? "bg-[color:var(--accent)] text-white shadow-sm" :
                done ? "bg-slate-900 text-white" :
                "bg-white text-slate-600 ring-1 ring-slate-200 hover:bg-slate-50"}
            "
            data-action="goto"
            data-step="${i}"
            aria-label="Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø®Ø·ÙˆØ© ${i}"
            title="Ø§Ù„Ø®Ø·ÙˆØ© ${i}"
          >
            <span class="text-[11px] sm:text-xs font-extrabold">${i}</span>
            ${active ? `
              <span class="absolute -bottom-2.5 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-[color:var(--accent2)]"></span>
            ` : ""}
          </button>
        `);
      }
      return items.join(`
        <div class="hidden sm:block h-[2px] flex-1 bg-slate-100 rounded-full mx-1"></div>
      `);
    }

    function chipBtn({label, key, value, selected, icon=""}){
      return `
        <button
          class="inline-flex items-center gap-2 px-3.5 py-2 rounded-2xl border text-sm font-bold transition
            ${selected
              ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)] text-slate-900"
              : "bg-white border-slate-200 text-slate-700 hover:bg-slate-50"}
          "
          data-action="toggle"
          data-key="${key}"
          data-value="${value}"
          type="button"
        >
          ${icon ? `<span class="w-5 h-5 grid place-items-center rounded-xl bg-[color:var(--accent)]">${icon}</span>` : ""}
          <span>${label}</span>
        </button>
      `;
    }

    function cardOption({title, desc, icon, key, value, selected}){
      return `
        <button
          class="text-right w-full p-4 rounded-3xl border transition relative overflow-hidden
            ${selected
              ? "border-[color:var(--accent)] bg-[color:var(--accentSoft)]"
              : "border-slate-200 bg-white hover:bg-slate-50"}
          "
          data-action="set"
          data-key="${key}"
          data-value="${value}"
          type="button"
        >
          <div class="flex items-start gap-3">
            <div class="w-11 h-11 rounded-2xl bg-[color:var(--accent)] grid place-items-center shadow-sm">
              ${icon}
            </div>
            <div class="min-w-0">
              <div class="font-extrabold text-slate-900">${title}</div>
              <div class="text-sm text-slate-600 mt-1 leading-relaxed">${desc}</div>
            </div>
          </div>

          <div class="pointer-events-none absolute -top-10 -left-10 w-28 h-28 rounded-full blur-2xl bg-white/70 ${selected ? "opacity-80":"opacity-40"}"></div>
        </button>
      `;
    }

    // ===== Render Steps =====
    function renderStep1(){
      const options = [
        { value:"recommendations", title:"ØªÙˆØµÙŠØ§Øª", desc:"Ù…Ø­ØªÙˆÙ‰ ÙŠÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ¯ÙˆØ± ÙƒØ«ÙŠØ±.", icon: ICONS.star },
        { value:"friends",        title:"Ø£ØµØ¯Ù‚Ø§Ø¡",  desc:"ØªÙ„Ø§Ù‚ÙŠ Ù†Ø§Ø³ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¬Ø© Ø¨Ø³Ø±Ø¹Ø©.",      icon: ICONS.sparkles },
        { value:"discussions",    title:"Ù…Ù†Ø§Ù‚Ø´Ø§Øª", desc:"Ù†Ø¸Ø±ÙŠØ§Øª ÙˆØªØ­Ù„ÙŠÙ„ ÙˆØ­Ù…Ø§Ø³â€”Ø¹Ù„Ù‰ Ù…Ø²Ø§Ø¬Ùƒ.",      icon: ICONS.mask },
        { value:"art",            title:"ÙÙ†",      desc:"Fanart ÙˆØ¥Ù„Ù‡Ø§Ù… ÙˆÙ…Ø¬ØªÙ…Ø¹ Ù…Ø¨Ø¯Ø¹ÙŠÙ†.",        icon: ICONS.bolt }
      ];

      return `
        <div class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            ${options.map(o => cardOption({
              title:o.title, desc:o.desc, icon:o.icon,
              key:"goal", value:o.value,
              selected: state.goal === o.value
            })).join("")}
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center gap-2">
              <span class="badge">âœ¨ Ø³Ø±ÙŠØ¹</span>
              <span class="text-sm text-slate-700 font-bold">Ø§Ø®ØªÙŠØ§Ø±Ùƒ ÙŠØºÙŠÙ‘Ø± Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderStep2(){
      return `
        <div class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="block">
              <span class="text-sm font-extrabold text-slate-800">Ø§Ù„Ø¨Ø±ÙŠØ¯</span>
              <div class="mt-2 flex items-center gap-2 p-3 rounded-2xl border border-slate-200 bg-white focus-within:border-[color:var(--accent)]">
                <span class="w-9 h-9 rounded-xl bg-slate-100 grid place-items-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M4.5 7.5l7.5 5 7.5-5" stroke="rgba(15,23,42,.7)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5.5 6.5h13c1.1 0 2 .9 2 2v9c0 1.1-.9 2-2 2h-13c-1.1 0-2-.9-2-2v-9c0-1.1.9-2 2-2Z" stroke="rgba(15,23,42,.7)" stroke-width="1.8" stroke-linejoin="round"/>
                  </svg>
                </span>
                <input id="emailInput" value="${escapeHtml(state.email)}" class="w-full bg-transparent outline-none text-slate-900 placeholder:text-slate-400"
                  placeholder="name@example.com" inputmode="email" />
              </div>
              <p class="mt-2 text-xs text-slate-500">Ø¨Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</p>
            </label>

            <label class="block">
              <span class="text-sm font-extrabold text-slate-800">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
              <div class="mt-2 flex items-center gap-2 p-3 rounded-2xl border border-slate-200 bg-white focus-within:border-[color:var(--accent)]">
                <span class="w-9 h-9 rounded-xl bg-slate-100 grid place-items-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M7.5 11v-2.3c0-2.6 2-4.7 4.5-4.7s4.5 2.1 4.5 4.7V11" stroke="rgba(15,23,42,.7)" stroke-width="1.8" stroke-linecap="round"/>
                    <path d="M6.5 11h11c1.1 0 2 .9 2 2v5c0 1.1-.9 2-2 2h-11c-1.1 0-2-.9-2-2v-5c0-1.1.9-2 2-2Z" stroke="rgba(15,23,42,.7)" stroke-width="1.8" stroke-linejoin="round"/>
                    <path d="M12 15.2v2" stroke="rgba(15,23,42,.7)" stroke-width="1.8" stroke-linecap="round"/>
                  </svg>
                </span>
                <input id="passInput" value="${escapeHtml(state.password)}" class="w-full bg-transparent outline-none text-slate-900 placeholder:text-slate-400"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password" />
              </div>
              <p class="mt-2 text-xs text-slate-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù†â€”Ù…Ø¬Ø±Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¨Ø¯Ø¦ÙŠ.</p>
            </label>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ›¡ï¸ Ø®ØµÙˆØµÙŠØ©</span>
                <span class="text-sm text-slate-700 font-bold">Ù…Ø§ Ù†Ø¹Ø±Ø¶ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ù„Ù†Ø§Ø³â€”Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.</span>
              </div>
              <button class="px-4 py-2 rounded-2xl border border-slate-200 hover:bg-slate-50 active:bg-slate-100 transition font-bold"
                data-action="autofill" type="button">ØªØ¬Ø±Ø¨Ø© ØªØ¹Ø¨Ø¦Ø© Ø³Ø±ÙŠØ¹Ø©</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderStep3(){
      const ageYes = state.age16 === "yes";
      return `
        <div class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="block">
              <span class="text-sm font-extrabold text-slate-800">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</span>
              <input id="nameInput"
                value="${escapeHtml(state.displayName)}"
                class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white outline-none focus:border-[color:var(--accent)]"
                placeholder="Ù…Ø«Ø§Ù„: Ù„ÙˆÙÙŠ_Ø§Ù„Ø£ÙˆØªØ§ÙƒÙˆ" />
              <p class="mt-2 text-xs text-slate-500">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ´ÙˆÙÙ‡ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª.</p>
            </label>

            <div class="block">
              <span class="text-sm font-extrabold text-slate-800">Ø§Ù„Ø¹Ù…Ø±</span>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <button type="button"
                  data-action="set" data-key="age16" data-value="yes"
                  class="px-4 py-3 rounded-2xl border font-extrabold transition
                    ${ageYes ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)]" : "bg-white border-slate-200 hover:bg-slate-50"}">
                  +16 âœ…
                  <div class="text-xs text-slate-600 mt-1 font-bold">Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø§Ø³Ø¨</div>
                </button>
                <button type="button"
                  data-action="set" data-key="age16" data-value="no"
                  class="px-4 py-3 rounded-2xl border font-extrabold transition
                    ${!ageYes ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)]" : "bg-white border-slate-200 hover:bg-slate-50"}">
                  Ø£Ù‚Ù„ Ù…Ù† 16 ğŸ§¸
                  <div class="text-xs text-slate-600 mt-1 font-bold">ÙˆØ¶Ø¹ Ø¢Ù…Ù† Ø£ÙƒØ«Ø±</div>
                </button>
              </div>
              <p class="mt-2 text-xs text-slate-500">Ø§Ø®ØªÙŠØ§Ø±Ùƒ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ù†Ø¶Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ§Ù„Ø³Ø¨ÙˆÙŠÙ„Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸŒ</span>
                <span class="text-sm text-slate-800 font-extrabold">Ø¨Ù„Ø¯Ùƒ</span>
              </div>
              <select id="countrySelect" class="px-4 py-2.5 rounded-2xl border border-slate-200 bg-white font-bold outline-none focus:border-[color:var(--accent)]">
                ${COUNTRIES.map(c => `<option ${c===state.country ? "selected":""}>${c}</option>`).join("")}
              </select>
            </div>
            <p class="mt-2 text-xs text-slate-500">Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙ‚Ø· Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„Ù„ØºØ©.</p>
          </div>
        </div>
      `;
    }

    function renderStep4(){
      const isBoys = state.theme === "boys";
      return `
        <div class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <button type="button" data-action="theme" data-value="boys"
              class="p-4 rounded-3xl border transition text-right overflow-hidden relative
              ${isBoys ? "border-[color:var(--accent)] bg-[color:var(--accentSoft)]" : "border-slate-200 bg-white hover:bg-slate-50"}">
              <div class="flex items-start gap-3">
                <div class="w-11 h-11 rounded-2xl bg-[color:var(--accent)] grid place-items-center shadow-sm">${ICONS.bolt}</div>
                <div>
                  <div class="font-extrabold text-slate-900">Ù†Ø³Ø®Ø© Ø£ÙˆÙ„Ø§Ø¯</div>
                  <div class="text-sm text-slate-600 mt-1">Ø·Ø§Ù‚Ø© + Ø³Ø±Ø¹Ø§Øª + Ø£Ù„ÙˆØ§Ù† Ø¨Ø§Ø±Ø¯Ø©.</div>
                </div>
              </div>
              <div class="pointer-events-none absolute -bottom-12 -left-12 w-44 h-44 rounded-full blur-3xl bg-white/70 opacity-70"></div>
            </button>

            <button type="button" data-action="theme" data-value="girls"
              class="p-4 rounded-3xl border transition text-right overflow-hidden relative
              ${!isBoys ? "border-[color:var(--accent)] bg-[color:var(--accentSoft)]" : "border-slate-200 bg-white hover:bg-slate-50"}">
              <div class="flex items-start gap-3">
                <div class="w-11 h-11 rounded-2xl bg-[color:var(--accent)] grid place-items-center shadow-sm">${ICONS.sparkles}</div>
                <div>
                  <div class="font-extrabold text-slate-900">Ù†Ø³Ø®Ø© Ø¨Ù†Ø§Øª</div>
                  <div class="text-sm text-slate-600 mt-1">Ø£Ù„ÙˆØ§Ù† Ø¯Ø§ÙØ¦Ø© + Ø²Ø®Ø§Ø±Ù Ù„Ø·ÙŠÙØ©.</div>
                </div>
              </div>
              <div class="pointer-events-none absolute -bottom-12 -left-12 w-44 h-44 rounded-full blur-3xl bg-white/70 opacity-70"></div>
            </button>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ§ vibe</span>
                <span class="text-sm text-slate-700 font-bold">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ù„ÙŠ ØªØ­Ø¨ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù€ feed</span>
              </div>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              ${VIBES.map(v => chipBtn({
                label: v.label,
                key: "vibe",
                value: v.key,
                selected: state.vibe === v.key
              })).join("")}
            </div>

            <div class="mt-3 text-xs text-slate-500">
              <span class="font-bold text-slate-700">Ù…Ù„Ø§Ø­Ø¸Ø©:</span>
              Ø§Ù„Ù€ vibe ÙŠØºÙŠÙ‘Ø± ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ø´ÙŠØ¡).
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-2xl bg-[color:var(--accentSoft)] ring-1 ring-slate-200 grid place-items-center">
                ${state.theme === "boys" ? ICONS.bolt : ICONS.sparkles}
              </div>
              <div class="min-w-0">
                <div class="font-extrabold text-slate-900">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø©</div>
                <div class="text-sm text-slate-600">Ø§Ù„Ø«ÙŠÙ…: <span class="font-extrabold">${state.theme === "boys" ? "Ø£ÙˆÙ„Ø§Ø¯" : "Ø¨Ù†Ø§Øª"}</span> â€” Ø§Ù„Ù€ vibe: <span class="font-extrabold">${labelForVibe(state.vibe)}</span></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderStep5(){
      const uploaded = state.uploadedImage;
      return `
        <div class="space-y-4">
          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ§‘â€ğŸ¤</span>
                <span class="text-sm text-slate-800 font-extrabold">Ø§Ø®ØªØ± Ø£ÙØ§ØªØ§Ø±</span>
              </div>
              <div class="flex items-center gap-2">
                <button type="button" data-action="randomAvatar"
                  class="px-4 py-2 rounded-2xl border border-slate-200 hover:bg-slate-50 active:bg-slate-100 transition font-bold">
                  Ø£ÙØ§ØªØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ ğŸ²
                </button>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-4 sm:grid-cols-8 gap-2">
              ${AVATARS.map(a => {
                const on = state.avatar === a.id;
                return `
                  <button type="button" data-action="set" data-key="avatar" data-value="${a.id}"
                    class="aspect-square rounded-2xl border grid place-items-center text-2xl transition
                      ${on ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)]" : "bg-white border-slate-200 hover:bg-slate-50"}">
                    ${a.emoji}
                  </button>
                `;
              }).join("")}
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ“·</span>
                <span class="text-sm text-slate-800 font-extrabold">Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø©</span>
              </div>
              <label class="px-4 py-2.5 rounded-2xl bg-[color:var(--accent)] text-white font-extrabold cursor-pointer hover:brightness-105 active:brightness-95 transition">
                Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
              </label>
            </div>

            <div class="mt-3 flex items-center gap-3">
              <div class="w-16 h-16 rounded-3xl ring-1 ring-slate-200 bg-slate-50 overflow-hidden grid place-items-center">
                ${uploaded ? `<img src="${uploaded}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" class="w-full h-full object-cover">`
                           : `<span class="text-slate-400 font-extrabold">Preview</span>`}
              </div>
              <div class="min-w-0">
                <div class="text-sm text-slate-700 font-bold">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙˆØ±Ù‹Ø§.</div>
                <div class="text-xs text-slate-500 mt-1">Ø¨Ø¯ÙˆÙ† ØªØ­Ù‚Ù‚â€”Ø­ØªÙ‰ Ù„Ùˆ ØªØ±ÙƒØªÙ‡Ø§ ÙØ§Ø±ØºØ© Ø¹Ø§Ø¯ÙŠ.</div>
              </div>
            </div>

            ${uploaded ? `
              <div class="mt-3">
                <button type="button" data-action="clearUpload"
                  class="px-4 py-2 rounded-2xl border border-slate-200 hover:bg-slate-50 active:bg-slate-100 transition font-bold">
                  Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© âœ–
                </button>
              </div>
            ` : ""}
          </div>
        </div>
      `;
    }

    function renderStep6(){
      return `
        <div class="space-y-4">
          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ¬</span>
                <span class="text-sm text-slate-800 font-extrabold">Genres Ø§Ù„Ø£Ù†Ù…ÙŠ</span>
              </div>
              <div class="text-xs text-slate-500 font-bold">Ø§Ù„Ù…Ø­Ø¯Ø¯: ${state.animeGenres.length}</div>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              ${ANIME_GENRES.map(g => chipBtn({
                label:g,
                key:"animeGenres",
                value:g,
                selected: isSelectedArray(state.animeGenres, g)
              })).join("")}
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ’</span>
                <span class="text-sm text-slate-800 font-extrabold">3 Ø¹Ù†Ø§ØµØ± â€œÙ„Ø§ Ø£Ù‚Ø¯Ø± Ø£ØªØ±ÙƒÙ‡Ø§â€</span>
              </div>
              <div class="text-xs text-slate-500 font-bold">Ø§Ù„Ù…Ø­Ø¯Ø¯: ${state.mustHave.length} (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            </div>

            <div class="mt-3 grid sm:grid-cols-2 gap-2">
              ${MUST_HAVE.map(item => {
                const on = isSelectedArray(state.mustHave, item);
                return `
                  <button type="button" data-action="toggle" data-key="mustHave" data-value="${escapeAttr(item)}"
                    class="p-3 rounded-3xl border text-right transition flex items-center justify-between gap-3
                      ${on ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)]" : "bg-white border-slate-200 hover:bg-slate-50"}">
                    <div class="min-w-0">
                      <div class="font-extrabold text-slate-900 truncate">${escapeHtml(item)}</div>
                      <div class="text-xs text-slate-600 mt-0.5">ÙŠØ¯Ø®Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ ØªÙˆØµÙŠØ§ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰.</div>
                    </div>
                    <div class="w-10 h-10 rounded-2xl bg-[color:var(--accent)] grid place-items-center shrink-0">
                      ${ICONS.star}
                    </div>
                  </button>
                `;
              }).join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderStep7(){
      return `
        <div class="space-y-4">
          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ“š</span>
                <span class="text-sm text-slate-800 font-extrabold">Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ù…Ø§Ù†Ø¬Ø§/ÙƒÙˆÙ…ÙŠÙƒØ³</span>
              </div>
              <div class="text-xs text-slate-500 font-bold">Ø§Ù„Ù…Ø­Ø¯Ø¯: ${state.mangaInterests.length}</div>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              ${MANGA_COMICS.map(x => chipBtn({
                label:x, key:"mangaInterests", value:x,
                selected: isSelectedArray(state.mangaInterests, x),
                icon: ICONS.book
              })).join("")}
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ“°</span>
                <span class="text-sm text-slate-800 font-extrabold">Ù†ÙˆØ¹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ feed Ø§Ù„Ù…ÙØ¶Ù„</span>
              </div>
            </div>

            <div class="mt-3 grid sm:grid-cols-2 gap-2">
              ${FEED_TYPES.map(ft => {
                const on = state.feedType === ft.key;
                return `
                  <button type="button"
                    data-action="set"
                    data-key="feedType"
                    data-value="${ft.key}"
                    class="p-4 rounded-3xl border text-right transition
                      ${on ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)]" : "bg-white border-slate-200 hover:bg-slate-50"}">
                    <div class="flex items-start gap-3">
                      <div class="w-11 h-11 rounded-2xl bg-[color:var(--accent)] grid place-items-center shadow-sm">
                        ${ft.key === "art" ? ICONS.sparkles : ft.key === "talk" ? ICONS.mask : ft.key === "news" ? ICONS.bolt : ICONS.star}
                      </div>
                      <div class="min-w-0">
                        <div class="font-extrabold text-slate-900">${ft.label}</div>
                        <div class="text-sm text-slate-600 mt-1 leading-relaxed">${ft.desc}</div>
                      </div>
                    </div>
                  </button>
                `;
              }).join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderStep8(){
      return `
        <div class="space-y-4">
          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ¤</span>
                <span class="text-sm text-slate-800 font-extrabold">Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</span>
              </div>
              <div class="text-xs text-slate-500 font-bold">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: ${state.follows.size}</div>
            </div>

            <div class="mt-3 space-y-2">
              ${SUGGESTED_ACCOUNTS.map(u => {
                const on = state.follows.has(u.id);
                return `
                  <div class="p-3 rounded-3xl border border-slate-200 bg-white flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3 min-w-0">
                      <div class="w-12 h-12 rounded-3xl bg-[color:var(--accentSoft)] ring-1 ring-slate-200 grid place-items-center text-2xl">
                        ${pickEmoji(u.id)}
                      </div>
                      <div class="min-w-0">
                        <div class="font-extrabold text-slate-900 truncate">${u.name}</div>
                        <div class="text-xs text-slate-500 font-bold truncate">${u.handle} â€¢ ${u.tags.join(" â€¢ ")}</div>
                      </div>
                    </div>

                    <button type="button"
                      data-action="follow"
                      data-id="${u.id}"
                      class="shrink-0 px-4 py-2 rounded-2xl font-extrabold transition
                        ${on ? "bg-slate-900 text-white hover:opacity-90" : "bg-[color:var(--accent)] text-white hover:brightness-105"}">
                      ${on ? "Following âœ“" : "Follow +"}
                    </button>
                  </div>
                `;
              }).join("")}
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center gap-2">
              <span class="badge">âš¡</span>
              <span class="text-sm text-slate-700 font-bold">ÙƒÙ„ Ù…ØªØ§Ø¨Ø¹Ø© ØªØ­Ø³Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙÙˆØ±Ù‹Ø§ (Ø­ØªÙ‰ ÙÙŠ Discover).</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderStep9(){
      return `
        <div class="space-y-4">
          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸš«</span>
                <span class="text-sm text-slate-800 font-extrabold">ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø¨ÙˆÙŠÙ„Ø±</span>
              </div>
            </div>

            <div class="mt-3 grid sm:grid-cols-3 gap-2">
              ${radioCard("spoiler","hide","Ø¥Ø®ÙØ§Ø¡ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§","ØªØ¹Ø±Ø¶ Ø§Ù„Ø³Ø¨ÙˆÙŠÙ„Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ ÙØªØ­Ù‡.","ğŸ«£")}
              ${radioCard("spoiler","click","Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·","Ø§Ù„Ø³Ø¨ÙˆÙŠÙ„Ø± ÙŠÙƒÙˆÙ† Ù…ØºÙ„Ù‚â€¦ ÙˆØªÙØªØ­Ù‡ Ø£Ù†Øª.","ğŸ‘†")}
              ${radioCard("spoiler","show","Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§","Ù„Ù„Ù†Ø§Ø³ Ø§Ù„Ù„ÙŠ Ù…Ø§ ÙŠÙ‡Ù…Ù‡Ù… Ø§Ù„Ø­Ø±Ù‚ ğŸ˜„","ğŸ˜ˆ")}
            </div>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="badge">ğŸ </span>
                <span class="text-sm text-slate-800 font-extrabold">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØªØ¨Ø¯Ø£ Ø¨Ù€</span>
              </div>
            </div>

            <div class="mt-3 grid sm:grid-cols-3 gap-2">
              ${radioCard("homeDefault","following","Following","ØªØ´ÙˆÙ Ø§Ù„Ù„ÙŠ ØªØªØ§Ø¨Ø¹Ù‡ Ø£ÙˆÙ„Ù‹Ø§.","â­")}
              ${radioCard("homeDefault","discover","Discover","Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù„Ù‰ Ø°ÙˆÙ‚Ùƒ.","ğŸ”")}
              ${radioCard("homeDefault","trending","Trending","Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØ§Ø¹Ù„Ù‹Ø§ Ø§Ù„Ø¢Ù†.","ğŸ”¥")}
            </div>
          </div>
        </div>
      `;
    }

    function renderStep10(){
      const summaryChips = [
        state.goal ? `Ù‡Ø¯ÙÙƒ: ${goalLabel(state.goal)}` : "Ù‡Ø¯ÙÙƒ: (ØºÙŠØ± Ù…Ø­Ø¯Ø¯)",
        `Ø§Ù„Ø«ÙŠÙ…: ${state.theme === "boys" ? "Ø£ÙˆÙ„Ø§Ø¯" : "Ø¨Ù†Ø§Øª"}`,
        `vibe: ${labelForVibe(state.vibe)}`,
        `Ø£Ù†Ù…ÙŠ Genres: ${state.animeGenres.length || 0}`,
        `Ù…Ø§Ù†Ø¬Ø§/ÙƒÙˆÙ…ÙŠÙƒØ³: ${state.mangaInterests.length || 0}`,
        `Ù…ØªØ§Ø¨Ø¹Ø©: ${state.follows.size}`
      ];

      return `
        <div class="space-y-4">
          <div class="p-5 rounded-[28px] border border-slate-200 bg-white overflow-hidden relative">
            <div class="absolute -top-12 -right-12 w-44 h-44 rounded-full blur-3xl bg-[color:var(--accentSoft)] opacity-80"></div>
            <div class="absolute -bottom-12 -left-12 w-44 h-44 rounded-full blur-3xl bg-[color:var(--accentSoft2)] opacity-70"></div>

            <div class="relative flex items-start gap-3">
              <div class="w-12 h-12 rounded-2xl bg-[color:var(--accent)] grid place-items-center shadow-sm">
                ${ICONS.sparkles}
              </div>
              <div class="min-w-0">
                <div class="text-xl font-extrabold text-slate-900">Ø£Ù†Øª Ø¬Ø§Ù‡Ø²â€¦ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨Ùƒ! âœ¨</div>
                <div class="text-sm text-slate-600 mt-1 leading-relaxed">
                  Ø¬Ù‡Ø²Ù†Ø§ Ù„Ùƒ ØªØ¬Ø±Ø¨Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø£Ù†Ù…ÙŠ/ÙƒÙˆÙ…ÙŠÙƒØ³ Ù…Ù…ØªØ¹Ø©: ØªÙˆØµÙŠØ§ØªØŒ Ù…Ø¬ØªÙ…Ø¹ØŒ ÙˆÙ…Ø­ØªÙˆÙ‰ ÙŠÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ Ù…Ù† Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø©.
                </div>
              </div>
            </div>

            <div class="relative mt-4 flex flex-wrap gap-2">
              ${summaryChips.map(t => `
                <span class="inline-flex items-center px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 text-sm font-extrabold text-slate-800">
                  ${escapeHtml(t)}
                </span>
              `).join("")}
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-3">
            <button type="button" data-action="finish"
              class="p-4 rounded-3xl bg-[color:var(--accent)] text-white font-extrabold hover:brightness-105 active:brightness-95 transition shadow-sm text-right">
              Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…
              <div class="text-sm opacity-95 font-bold mt-1">ÙŠØ­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø±Ø§ØªÙƒ ÙˆÙŠÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</div>
            </button>

            <button type="button" data-action="explore"
              class="p-4 rounded-3xl border border-slate-200 bg-white hover:bg-slate-50 active:bg-slate-100 transition font-extrabold text-right">
              Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù ğŸš€
              <div class="text-sm text-slate-600 font-bold mt-1">Ø§Ø¯Ø®Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù€ Discover ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹.</div>
            </button>
          </div>

          <div class="p-4 rounded-3xl border border-slate-200 bg-white">
            <div class="flex items-center gap-2">
              <span class="badge">ğŸ’¬</span>
              <span class="text-sm text-slate-700 font-bold">
                Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù‚Ù‚ Ù‡Ù†Ø§â€”Ù‡Ø°Ù‡ ÙˆØ§Ø¬Ù‡Ø© UX Ø¬Ø§Ù‡Ø²Ø©ØŒ ØªØ±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ù€ Next/Nest Ø¨Ø³Ù‡ÙˆÙ„Ø©.
              </span>
            </div>
          </div>
        </div>
      `;
    }

    // ===== UI Render Main =====
    function render(){
      // meta
      const meta = STEPS[state.step - 1];
      $("#stepTitle").textContent = meta.title;
      $("#stepDesc").textContent  = meta.desc;
      $("#microHint").textContent = meta.hint;
      $("#stepCounter").textContent = `Ø§Ù„Ø®Ø·ÙˆØ© ${state.step} / 10`;

      // stepper
      $("#stepper").innerHTML = stepperHTML();

      // progress (scaleX)
      $("#progressBar").style.transform = `scaleX(${progressScale()})`;

      // content
      const content = $("#stepContent");
      let html = "";
      if (state.step === 1) html = renderStep1();
      if (state.step === 2) html = renderStep2();
      if (state.step === 3) html = renderStep3();
      if (state.step === 4) html = renderStep4();
      if (state.step === 5) html = renderStep5();
      if (state.step === 6) html = renderStep6();
      if (state.step === 7) html = renderStep7();
      if (state.step === 8) html = renderStep8();
      if (state.step === 9) html = renderStep9();
      if (state.step === 10) html = renderStep10();

      content.innerHTML = html;

      // animate in
      content.classList.remove("fade-slide-in");
      void content.offsetWidth;
      content.classList.add("fade-slide-in");

      // footer buttons
      $("#backBtn").disabled = (state.step === 1);
      $("#skipBtn").classList.toggle("hidden", state.step === 10);
      $("#nextLabel").textContent = state.step === 10 ? "ØªÙ…" : "Ø§Ù„ØªØ§Ù„ÙŠ";
    }

    // ===== Actions =====
    function next(){
      if (state.step < 10) state.step++;
      else toast("Ø¬Ø§Ù‡Ø²! Ø§Ø®ØªØ± (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨) Ø£Ùˆ (Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù).");
      render();
    }
    function back(){
      state.step = clampStep(state.step - 1);
      render();
    }
    function skip(){
      state.step = clampStep(state.step + 1);
      render();
    }
    function gotoStep(n){
      state.step = clampStep(Number(n));
      render();
    }

    // ===== Small Utils =====
    function goalLabel(v){
      return ({ recommendations:"ØªÙˆØµÙŠØ§Øª", friends:"Ø£ØµØ¯Ù‚Ø§Ø¡", discussions:"Ù…Ù†Ø§Ù‚Ø´Ø§Øª", art:"ÙÙ†" }[v] || v);
    }
    function labelForVibe(v){
      const found = VIBES.find(x => x.key === v);
      return found ? found.label : v;
    }
    function pickEmoji(id){
      const map = { u1:"ğŸ§ ", u2:"ğŸ“–", u3:"ğŸ¨", u4:"ğŸ«§", u5:"ğŸ•µï¸" };
      return map[id] || "ğŸŒŸ";
    }

    function radioCard(key, value, title, desc, emoji){
      const on = state[key] === value;
      return `
        <button type="button"
          data-action="set"
          data-key="${key}"
          data-value="${value}"
          class="p-4 rounded-3xl border text-right transition
            ${on ? "bg-[color:var(--accentSoft)] border-[color:var(--accent)]" : "bg-white border-slate-200 hover:bg-slate-50"}">
          <div class="flex items-start gap-3">
            <div class="w-11 h-11 rounded-2xl bg-[color:var(--accent)] grid place-items-center text-xl shadow-sm">
              <span aria-hidden="true">${emoji}</span>
            </div>
            <div class="min-w-0">
              <div class="font-extrabold text-slate-900">${title}</div>
              <div class="text-sm text-slate-600 mt-1 leading-relaxed">${desc}</div>
            </div>
          </div>
        </button>
      `;
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(s).replaceAll('"',"&quot;");
    }

    // ===== Event Delegation =====
    $("#modal").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const action = btn.dataset.action;

      if (action === "goto") return gotoStep(btn.dataset.step);

      if (action === "set"){
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        state[key] = value;

        if (key === "age16") toast(value === "yes" ? "ØªÙ…Ø§Ù… âœ…" : "ÙˆØ¶Ø¹ Ø¢Ù…Ù† Ø£ÙƒØ«Ø± ğŸ§¸");
        render();
        return;
      }

      if (action === "toggle"){
        const key = btn.dataset.key;
        const value = btn.dataset.value;
        toggleArray(key, value);
        render();
        return;
      }

      if (action === "follow"){
        toggleFollow(btn.dataset.id);
        render();
        return;
      }

      if (action === "theme"){
        setTheme(btn.dataset.value);
        toast(state.theme === "boys" ? "Ø«ÙŠÙ… Ø£ÙˆÙ„Ø§Ø¯ âš¡" : "Ø«ÙŠÙ… Ø¨Ù†Ø§Øª âœ¨");
        render();
        return;
      }

      if (action === "randomAvatar"){
        const pick = AVATARS[Math.floor(Math.random()*AVATARS.length)];
        state.avatar = pick.id;
        toast("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ§ØªØ§Ø± ğŸ²");
        render();
        return;
      }

      if (action === "clearUpload"){
        state.uploadedImage = "";
        toast("ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©");
        render();
        return;
      }

      if (action === "autofill"){
        state.email = "luffy@anime.dev";
        state.password = "12345678";
        toast("ØªØ¹Ø¨Ø¦Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© âœ…");
        render();
        return;
      }

      if (action === "finish"){
        toast("ØªÙ… (Ù…Ø­Ø§ÙƒØ§Ø©) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…");
        // Ù‡Ù†Ø§ ØªØ±Ø¨Ø· Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ù€ API
        return;
      }

      if (action === "explore"){
        toast("ÙŠÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù ğŸš€");
        // Ù‡Ù†Ø§ ØªÙ†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù€ app route Ù„Ø§Ø­Ù‚Ù‹Ø§
        return;
      }
    });

    // Inputs
    $("#modal").addEventListener("input", async (e) => {
      if (e.target.id === "emailInput") state.email = e.target.value;
      if (e.target.id === "passInput") state.password = e.target.value;
      if (e.target.id === "nameInput") state.displayName = e.target.value;
      if (e.target.id === "countrySelect") state.country = e.target.value;
    });

    // Upload
    $("#modal").addEventListener("change", (e) => {
      if (e.target.id !== "uploadInput") return;
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        state.uploadedImage = String(reader.result || "");
        toast("ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© âœ…");
        render();
      };
      reader.readAsDataURL(file);
    });

    // Footer buttons
    $("#backBtn").addEventListener("click", back);
    $("#nextBtn").addEventListener("click", next);
    $("#skipBtn").addEventListener("click", skip);

    // Close
    $("#closeBtn").addEventListener("click", () => {
      // Ù…Ø¬Ø±Ø¯ Ø¥ØºÙ„Ø§Ù‚ UI (Ø¨Ø¯ÙˆÙ† ØªØ­Ù‚Ù‚)
      $("#overlay").classList.add("hidden");
      toast("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©");
    });

    // Keyboard: Esc to close
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") $("#overlay").classList.add("hidden");
    });

    // Init
    setTheme(state.theme);
    render();
  </script>
</body>
</html>
