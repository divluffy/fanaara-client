<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Isekai Fantasy Map â€“ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Ù„Ù…Ø³Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØµÙˆØ± Ø®Ø§Ø±Ø¬ÙŠØ© */
      .glow {
        filter: drop-shadow(0 0 10px rgba(147, 51, 234, 0.45));
      }
      .shake {
        animation: shake 240ms linear 0s 2;
      }
      @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(6px); }
        50% { transform: translateX(0); }
        75% { transform: translateX(-6px); }
        100% { transform: translateX(0); }
      }
      .sr-only-focusable:focus {
        position: static !important;
        width: auto !important;
        height: auto !important;
        margin: 0 !important;
        overflow: visible !important;
        clip: auto !important;
        white-space: normal !important;
      }
    </style>
  </head>

  <body class="min-h-screen bg-slate-950 text-slate-100">
    <!-- Ø®Ù„ÙÙŠØ© Ø®Ø±ÙŠØ·Ø© SVG -->
    <div class="fixed inset-0 -z-10">
      <svg class="h-full w-full" viewBox="0 0 1200 800" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <linearGradient id="bgG" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#0b1220" />
            <stop offset="0.55" stop-color="#120b2a" />
            <stop offset="1" stop-color="#06131a" />
          </linearGradient>

          <radialGradient id="mist" cx="50%" cy="45%" r="65%">
            <stop offset="0" stop-color="#a78bfa" stop-opacity="0.12" />
            <stop offset="0.55" stop-color="#22c55e" stop-opacity="0.06" />
            <stop offset="1" stop-color="#000000" stop-opacity="0" />
          </radialGradient>

          <pattern id="runes" width="120" height="120" patternUnits="userSpaceOnUse">
            <path d="M10 30 L30 10 L50 30 L30 50 Z" fill="none" stroke="#a78bfa" stroke-opacity="0.12" />
            <circle cx="85" cy="85" r="12" fill="none" stroke="#22c55e" stroke-opacity="0.10" />
            <path d="M70 25 Q85 5 100 25" fill="none" stroke="#38bdf8" stroke-opacity="0.10" />
          </pattern>

          <linearGradient id="river" x1="0" x2="1">
            <stop offset="0" stop-color="#38bdf8" stop-opacity="0.10" />
            <stop offset="1" stop-color="#a78bfa" stop-opacity="0.10" />
          </linearGradient>
        </defs>

        <rect width="1200" height="800" fill="url(#bgG)" />
        <rect width="1200" height="800" fill="url(#mist)" />
        <rect width="1200" height="800" fill="url(#runes)" opacity="0.9" />

        <!-- ØªØ¶Ø§Ø±ÙŠØ³/Ø·Ø±Ù‚ -->
        <path d="M90 680 C240 610, 290 520, 390 490 C520 450, 560 330, 700 300 C840 270, 920 180, 1110 130"
              fill="none" stroke="url(#river)" stroke-width="16" stroke-linecap="round" opacity="0.9"/>
        <path d="M90 680 C240 610, 290 520, 390 490 C520 450, 560 330, 700 300 C840 270, 920 180, 1110 130"
              fill="none" stroke="#a78bfa" stroke-opacity="0.18" stroke-width="3" stroke-linecap="round" stroke-dasharray="6 10"/>

        <!-- Ø¬Ø²Ø±/Ø¬Ø¨Ø§Ù„ Ø¨Ø³ÙŠØ·Ø© -->
        <g opacity="0.18">
          <path d="M170 200 Q240 120 320 190 Q260 260 170 200 Z" fill="#22c55e"/>
          <path d="M930 660 Q1000 590 1070 650 Q1010 720 930 660 Z" fill="#38bdf8"/>
          <path d="M650 520 Q720 460 800 520 Q740 590 650 520 Z" fill="#a78bfa"/>
        </g>
      </svg>
    </div>

    <a href="#stepTitle" class="sr-only sr-only-focusable">ØªØ®Ø·Ù‘ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</a>

    <main class="mx-auto max-w-6xl px-4 py-8">
      <header class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
          <p class="text-sm text-slate-300">Ø¥ÙŠØ³ÙŠÙƒØ§ÙŠ / Ø®Ø±ÙŠØ·Ø© / Ù…ØºØ§Ù…Ø±Ø©</p>
          <h1 class="text-2xl md:text-3xl font-black tracking-tight">
            Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø§Ù„Ù… â€” <span class="text-violet-300">Ø±Ø­Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
          </h1>
          <p class="mt-1 text-slate-300">
            ÙƒÙ„ Ø®Ø·ÙˆØ© â€œÙ…Ù†Ø¹Ø·Ùâ€ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©â€¦ Ø®Ù„Ù‘ØµÙ‡Ø§ Ø¹Ø´Ø§Ù† ØªÙØªØ­ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡Ø§.
          </p>
        </div>

        <div class="flex items-center gap-3">
          <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
            <div class="text-xs text-slate-300">ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ø±Ø­Ù„Ø©</div>
            <div class="mt-1 flex items-baseline gap-2">
              <div id="progressPercent" class="text-xl font-extrabold">0%</div>
              <div id="progressMeta" class="text-sm text-slate-300">0 / 8</div>
            </div>
          </div>
          <button id="resetBtn"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm hover:bg-white/10">
            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          </button>
        </div>
      </header>

      <section class="mt-8 grid gap-6 lg:grid-cols-[420px_1fr]">
        <!-- Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… -->
        <aside class="relative overflow-hidden rounded-3xl border border-white/10 bg-black/20 p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-extrabold">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h2>
            <span class="text-xs text-slate-300">Ø§Ø¶ØºØ· Ù…Ø±Ø­Ù„Ø© Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¹ÙˆØ¯Ø©</span>
          </div>

          <div class="relative mt-4 h-[420px] rounded-2xl border border-white/10 bg-white/5 overflow-hidden">
            <!-- Ø·Ø¨Ù‚Ø© Ø¶Ø¨Ø§Ø¨ -->
            <div class="absolute inset-0 bg-gradient-to-br from-violet-500/10 via-transparent to-emerald-500/10"></div>

            <!-- Ù…Ø³Ø§Ø±/Ø´Ø¨ÙƒØ© Ø¯Ø§Ø®Ù„ÙŠØ© SVG -->
            <svg class="absolute inset-0 h-full w-full" viewBox="0 0 420 420" aria-hidden="true">
              <defs>
                <linearGradient id="pathG" x1="0" x2="1" y1="1" y2="0">
                  <stop offset="0" stop-color="#22c55e" stop-opacity="0.25"/>
                  <stop offset="1" stop-color="#a78bfa" stop-opacity="0.25"/>
                </linearGradient>
              </defs>
              <path d="M35 375 C85 345, 95 300, 140 280 C195 255, 210 205, 250 185 C300 160, 320 120, 385 85"
                    fill="none" stroke="url(#pathG)" stroke-width="10" stroke-linecap="round"/>
              <path d="M35 375 C85 345, 95 300, 140 280 C195 255, 210 205, 250 185 C300 160, 320 120, 385 85"
                    fill="none" stroke="#ffffff" stroke-opacity="0.08" stroke-width="2" stroke-dasharray="6 8" stroke-linecap="round"/>

              <!-- Ù†Ø¬ÙˆÙ… ØµØºÙŠØ±Ø© -->
              <g fill="#fff" opacity="0.12">
                <circle cx="70" cy="60" r="2"/><circle cx="210" cy="40" r="1.8"/><circle cx="330" cy="55" r="1.6"/>
                <circle cx="390" cy="200" r="1.7"/><circle cx="40" cy="190" r="1.5"/><circle cx="115" cy="350" r="1.5"/>
              </g>
            </svg>

            <!-- Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Ø£Ø²Ø±Ø§Ø±) -->
            <div id="mapNodes" class="absolute inset-0">
              <!-- ÙŠÙÙ…Ù„Ø£ Ø¹Ø¨Ø± JS -->
            </div>

            <!-- Ø£Ø³Ø·ÙˆØ±Ø© -->
            <div class="absolute bottom-3 left-3 right-3 flex flex-wrap gap-2 text-xs text-slate-300">
              <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-3 py-1">
                <span class="h-2.5 w-2.5 rounded-full bg-slate-500"></span> ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø©
              </span>
              <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-3 py-1">
                <span class="h-2.5 w-2.5 rounded-full bg-violet-400"></span> Ø§Ù„Ø­Ø§Ù„ÙŠØ©
              </span>
              <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-3 py-1">
                <span class="h-2.5 w-2.5 rounded-full bg-emerald-400"></span> Ù…ÙƒØªÙ…Ù„Ø©
              </span>
            </div>
          </div>

          <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm text-slate-300">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                <div id="currentStepLabel" class="mt-1 text-lg font-extrabold">â€”</div>
                <div id="currentStepHint" class="mt-1 text-sm text-slate-300">â€”</div>
              </div>
              <div class="rounded-2xl border border-white/10 bg-black/20 px-3 py-2 text-xs text-slate-200">
                Tip: Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø¨Ù„ <span class="text-violet-300 font-semibold">Enter the World</span>
              </div>
            </div>
          </div>
        </aside>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ§Øª -->
        <section class="rounded-3xl border border-white/10 bg-black/20 p-5 md:p-6">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 id="stepTitle" class="text-xl md:text-2xl font-black">â€”</h2>
              <p id="stepSubtitle" class="mt-1 text-slate-300">â€”</p>
            </div>
            <div class="hidden md:block rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-slate-200">
              <span class="text-slate-300">Ù…Ø°ÙƒÙ‘Ø±Ø©:</span> Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø·ÙŠÙ + ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·
            </div>
          </div>

          <!-- Ø´Ø±ÙŠØ· Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ -->
          <div id="messageBar" class="mt-4 hidden rounded-2xl border border-rose-500/30 bg-rose-500/10 p-4">
            <div class="flex items-start gap-3">
              <div class="mt-0.5 h-2.5 w-2.5 rounded-full bg-rose-400"></div>
              <div>
                <div class="font-bold text-rose-200">Ù‚Ø¨Ù„ Ù…Ø§ Ù†ÙƒÙ…Ù„â€¦</div>
                <div id="messageText" class="mt-1 text-sm text-rose-100/90"></div>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„ÙÙˆØ±Ù… -->
          <form id="wizardForm" class="mt-6">
            <!-- STEP 1 -->
            <div class="stepPanel" data-step="0">
              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label class="text-sm text-slate-300">Ø§Ø³Ù… Ø§Ù„Ù…ØºØ§Ù…Ø±</label>
                  <input id="name" type="text" maxlength="24"
                    class="mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:border-violet-400/60"
                    placeholder="Ù…Ø«Ø§Ù„: Luffy_D" />
                  <p class="mt-2 text-xs text-slate-400">Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ù‚ØµÙŠØ±Ù‹Ø§â€¦ Ø±Ø­Ù„ØªÙƒ Ø³ØªÙØ¹Ø±Ù Ø¨Ù‡.</p>
                </div>

                <div>
                  <label class="text-sm text-slate-300">Class (Ø§Ù„ÙØ¦Ø©)</label>
                  <div class="mt-2 grid grid-cols-2 gap-2">
                    <label class="group cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="class" value="Mage" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">Mage</div>
                          <div class="text-xs text-slate-300">ØªØ¹ÙˆÙŠØ°Ø§Øª + Ù„ÙˆØ±</div>
                        </div>
                        <span class="text-violet-300">âœ¦</span>
                      </div>
                    </label>
                    <label class="group cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="class" value="Warrior" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">Warrior</div>
                          <div class="text-xs text-slate-300">Ø­Ù…Ø§Ø³ + Ø­Ù…Ø§ÙŠØ©</div>
                        </div>
                        <span class="text-emerald-300">âš”</span>
                      </div>
                    </label>
                    <label class="group cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="class" value="Artist" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">Artist</div>
                          <div class="text-xs text-slate-300">ÙÙ† + Ø¥Ù„Ù‡Ø§Ù…</div>
                        </div>
                        <span class="text-sky-300">âœ</span>
                      </div>
                    </label>
                    <label class="group cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="class" value="Reviewer" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">Reviewer</div>
                          <div class="text-xs text-slate-300">ØªØ­Ù„ÙŠÙ„ + Ù†Ù‚Ø§Ø´</div>
                        </div>
                        <span class="text-amber-300">âŒ</span>
                      </div>
                    </label>
                  </div>

                  <p class="mt-2 text-xs text-slate-400">Ù‡Ø°Ù‡ ÙÙ‚Ø· â€œÙ†ØºÙ…Ø©â€ Ù„Ù…Ù„ÙÙƒâ€¦ ÙˆØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="stepPanel hidden" data-step="1">
              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label class="text-sm text-slate-300">Email</label>
                  <input id="email" type="email" inputmode="email"
                    class="mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:border-violet-400/60"
                    placeholder="you@domain.com" />
                  <p class="mt-2 text-xs text-slate-400">Ù„Ù† Ù†Ø±Ø³Ù„ Ø¥Ù„Ø§ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠâ€¦ Ù„Ø§ Ø³Ø¨Ø§Ù….</p>
                </div>

                <div>
                  <label class="text-sm text-slate-300">Password</label>
                  <input id="password" type="password" minlength="8"
                    class="mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:border-violet-400/60"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                  <p class="mt-2 text-xs text-slate-400">ÙŠÙØ¶Ù‘Ù„ 8 Ø£Ø­Ø±Ù+ØŒ Ø®Ù„ÙŠÙ‡Ø§ Ù‚ÙˆÙŠØ© Ù…Ø«Ù„ ØªØ¹ÙˆÙŠØ°Ø©.</p>
                </div>
              </div>

              <div class="mt-5 rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="font-extrabold text-violet-200">Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØºØ§Ù…Ø±</div>
                    <ul class="mt-2 list-disc space-y-1 pr-6 text-sm text-slate-200/90">
                      <li>Ø£Ø­ØªØ±Ù… Ø§Ù„Ù†Ù‚Ø§Ø´â€¦ ÙˆØ£Ø­ÙØ¸ â€œØ³Ø¨ÙˆÙŠÙ„Ø±â€ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ±.</li>
                      <li>Ø£Ø¯Ø¹Ù… Ø§Ù„ÙÙ†Ù‘Ø§Ù†ÙŠÙ†â€¦ ÙˆØ£Ù†Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù„Ø£ØµØ­Ø§Ø¨Ù‡Ø§.</li>
                      <li>Ø£Ø¨Ø­Ø« Ø¹Ù† ÙØ±ÙŠÙ‚â€¦ Ù„Ø§ Ø¹Ù† Ù…Ø¹Ø±ÙƒØ©.</li>
                    </ul>
                  </div>
                  <div class="rounded-xl border border-white/10 bg-black/20 px-3 py-2 text-xs text-slate-300">
                    Quest: Ø§Ù‚Ø¨ÙÙ„ Ø§Ù„Ø¹Ù‡Ø¯
                  </div>
                </div>

                <label class="mt-4 flex cursor-pointer items-start gap-3">
                  <input id="oath" type="checkbox" class="mt-1 h-4 w-4 accent-violet-400" />
                  <span class="text-sm text-slate-200/90">
                    Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØºØ§Ù…Ø± ÙˆØ£Ø¹Ø¯ Ø£Ù† Ø£ÙƒÙˆÙ† Ø¹Ø¶ÙˆÙ‹Ø§ Ù…Ø­ØªØ±Ù…Ù‹Ø§.
                  </span>
                </label>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="stepPanel hidden" data-step="2">
              <div class="grid gap-4 md:grid-cols-2">
                <div>
                  <label class="text-sm text-slate-300">Ø§Ù„Ø¨Ù„Ø¯</label>
                  <input id="country" type="text"
                    class="mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:border-emerald-400/60"
                    placeholder="Ù…Ø«Ø§Ù„: ÙÙ„Ø³Ø·ÙŠÙ† / Ø§Ù„Ø£Ø±Ø¯Ù† / Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©..." />
                </div>

                <div>
                  <label class="text-sm text-slate-300">Ø§Ù„Ù„ØºØ©</label>
                  <select id="language"
                    class="mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:border-emerald-400/60">
                    <option value="">Ø§Ø®ØªØ±â€¦</option>
                    <option>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option>English</option>
                    <option>æ—¥æœ¬èª</option>
                    <option>FranÃ§ais</option>
                    <option>TÃ¼rkÃ§e</option>
                  </select>
                </div>

                <div class="md:col-span-2">
                  <label class="text-sm text-slate-300">Bio (Ù†Ø¨Ø°Ø©)</label>
                  <textarea id="bio" rows="4" maxlength="240"
                    class="mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:border-emerald-400/60"
                    placeholder="Ù‚ÙˆÙ„Ù†Ø§ Ù…ÙŠÙ† Ø£Ù†Øªâ€¦ ÙˆØ´Ùˆ Ø¨ØªØ­Ø¨ØŸ"></textarea>
                  <div class="mt-2 flex items-center justify-between text-xs text-slate-400">
                    <span>Ø§Ù„Ù†Ø¨Ø°Ø© ØªØ³Ø§Ø¹Ø¯Ù†Ø§ Ù†Ù‚ØªØ±Ø­ Ù„Ùƒ Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø§Ø³Ø¨.</span>
                    <span id="bioCount">0 / 240</span>
                  </div>
                </div>

                <div class="md:col-span-2">
                  <label class="text-sm text-slate-300">Ù‡Ø¯Ù Ø§Ù„Ø±Ø­Ù„Ø©</label>
                  <div class="mt-2 grid gap-2 md:grid-cols-3">
                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="goal" value="Ø£ØµØ¯Ù‚Ø§Ø¡" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">Ø£ØµØ¯Ù‚Ø§Ø¡</div>
                          <div class="text-xs text-slate-300">Ø³ÙŠØ±ÙØ± Ù…Ù† Ø§Ù„Ø±ÙØ§Ù‚</div>
                        </div>
                        <span>ğŸ¤</span>
                      </div>
                    </label>
                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="goal" value="Ù†Ù‚Ø§Ø´" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">Ù†Ù‚Ø§Ø´</div>
                          <div class="text-xs text-slate-300">ØªØ­Ù„ÙŠÙ„ + Ù†Ø¸Ø±ÙŠØ§Øª</div>
                        </div>
                        <span>ğŸ’¬</span>
                      </div>
                    </label>
                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
                      <input class="sr-only" type="radio" name="goal" value="ÙÙ†" />
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-extrabold">ÙÙ†</div>
                          <div class="text-xs text-slate-300">Ù„ÙˆØ­Ø§Øª + Fanart</div>
                        </div>
                        <span>ğŸ¨</span>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 4 -->
            <div class="stepPanel hidden" data-step="3">
              <div class="grid gap-5 md:grid-cols-[1fr_280px]">
                <div>
                  <label class="text-sm text-slate-300">Portrait Frame (Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©)</label>
                  <div id="frameOptions" class="mt-2 grid gap-2 md:grid-cols-2">
                    <!-- ÙŠÙÙ…Ù„Ø£ Ø¹Ø¨Ø± JS -->
                  </div>

                  <div class="mt-5 grid gap-4 md:grid-cols-2">
                    <div>
                      <label class="text-sm text-slate-300">Ù„ÙˆÙ† Ø±Ø¦ÙŠØ³ÙŠ</label>
                      <input id="colorPrimary" type="color" value="#a78bfa"
                        class="mt-2 h-12 w-full cursor-pointer rounded-2xl border border-white/10 bg-white/5 p-2" />
                    </div>
                    <div>
                      <label class="text-sm text-slate-300">Ù„ÙˆÙ† Ø«Ø§Ù†ÙˆÙŠ</label>
                      <input id="colorSecondary" type="color" value="#22c55e"
                        class="mt-2 h-12 w-full cursor-pointer rounded-2xl border border-white/10 bg-white/5 p-2" />
                    </div>
                  </div>

                  <div class="mt-5">
                    <label class="text-sm text-slate-300">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙØ§ØªØ§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="avatarFile" type="file" accept="image/*"
                      class="mt-2 block w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-slate-200 file:mr-3 file:rounded-xl file:border-0 file:bg-white/10 file:px-4 file:py-2 file:text-slate-100 hover:file:bg-white/20" />
                    <p class="mt-2 text-xs text-slate-400">Ù„Ùˆ Ù…Ø§ Ø±ÙØ¹Øªâ€¦ Ø¨Ù†Ø¹Ù…Ù„ Ù„Ùƒ Ø±Ù…Ø² Ø¨Ø³ÙŠØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±.</p>
                  </div>
                </div>

                <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
                  <div class="text-sm text-slate-300">Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
                  <div class="mt-3 flex items-center justify-center">
                    <div id="avatarPreviewWrap"
                      class="relative h-44 w-44 rounded-full border border-white/10 bg-black/30 p-2">
                      <div id="avatarFrame"
                        class="absolute inset-0 rounded-full glow"
                        style="border: 3px solid rgba(167,139,250,0.7);"></div>

                      <div class="absolute inset-[14px] overflow-hidden rounded-full border border-white/10 bg-gradient-to-br from-white/5 to-black/30">
                        <img id="avatarPreviewImg" alt="Avatar preview" class="hidden h-full w-full object-cover" />
                        <div id="avatarFallback" class="grid h-full w-full place-items-center text-center">
                          <div>
                            <div class="text-3xl font-black text-violet-200" id="avatarInitials">??</div>
                            <div class="mt-1 text-xs text-slate-300">Spirit Sigil</div>
                          </div>
                        </div>
                      </div>

                      <div id="frameGlyph"
                        class="pointer-events-none absolute -bottom-1 left-1/2 -translate-x-1/2 rounded-full border border-white/10 bg-black/50 px-3 py-1 text-xs text-slate-200">
                        â€”
                      </div>
                    </div>
                  </div>

                  <div class="mt-4 text-xs text-slate-400">
                    Ø§Ù„Ø¥Ø·Ø§Ø± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ÙŠÙ†Ø¹ÙƒØ³ÙˆØ§ Ø¹Ù„Ù‰ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ùƒ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø§Ù„Ù….
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 5 -->
            <div class="stepPanel hidden" data-step="4">
              <div class="grid gap-6">
                <div>
                  <div class="flex items-end justify-between gap-3">
                    <div>
                      <div class="text-sm text-slate-300">Ø§Ø®ØªØ± Ø¹ÙˆØ§Ù„Ù… / Genres</div>
                      <div class="text-xs text-slate-400">Ø§Ø®ØªÙŠØ§Ø± Ø­Ø±â€¦ Ø¨Ø³ Ù†ÙØ¶Ù‘Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ§Ø­Ø¯.</div>
                    </div>
                    <div class="text-xs text-slate-300">
                      Ø§Ù„Ù…Ø®ØªØ§Ø±: <span id="genresCount" class="font-bold text-emerald-200">0</span>
                    </div>
                  </div>
                  <div id="genresWrap" class="mt-3 flex flex-wrap gap-2">
                    <!-- Ø¹Ø¨Ø± JS -->
                  </div>
                </div>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
                    <div>
                      <div class="text-sm text-slate-300">Ø§Ø®ØªØ± 3 Ø³Ù„Ø§Ø³Ù„ Ù…ÙØ¶Ù„Ø©</div>
                      <div class="text-xs text-slate-400">Ø¨Ø§Ù„Ø¶Ø¨Ø· 3 Ø¹Ø´Ø§Ù† Ù†Ø¶Ø¨Ø· Ù„Ùƒ Ø§Ù„Ù€ feed.</div>
                    </div>
                    <div class="text-xs text-slate-300">
                      Ø§Ù„Ù…Ø®ØªØ§Ø±: <span id="seriesCount" class="font-bold text-violet-200">0</span> / 3
                    </div>
                  </div>

                  <div id="seriesWrap" class="mt-3 grid gap-2 md:grid-cols-2">
                    <!-- Ø¹Ø¨Ø± JS -->
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 6 -->
            <div class="stepPanel hidden" data-step="5">
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-end justify-between gap-3">
                  <div>
                    <div class="text-lg font-extrabold">Party Members (Ù…ØªØ§Ø¨Ø¹Ø©)</div>
                    <div class="text-sm text-slate-300">Ø§Ø®ØªØ± <span class="text-emerald-200 font-bold">3 Ø­Ø³Ø§Ø¨Ø§Øª</span> Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡.</div>
                  </div>
                  <div class="text-xs text-slate-300">
                    Ø§Ù„Ù…Ø®ØªØ§Ø±: <span id="partyCount" class="font-bold text-emerald-200">0</span>
                  </div>
                </div>

                <div id="partyWrap" class="mt-4 grid gap-2 md:grid-cols-2">
                  <!-- Ø¹Ø¨Ø± JS -->
                </div>
              </div>
            </div>

            <!-- STEP 7 -->
            <div class="stepPanel hidden" data-step="6">
              <div class="grid gap-4">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                  <div class="text-lg font-extrabold">Starter Pack</div>
                  <p class="mt-1 text-sm text-slate-300">
                    Ø§Ø®ØªØ± â€œØ­Ø²Ù…Ø© Ø¨Ø¯Ø§ÙŠØ©â€ â€” Ù…Ø­ØªÙˆÙ‰ Ù…Ù‚ØªØ±Ø­ Ø¨ÙŠØ¸Ù‡Ø± Ù„Ùƒ ÙÙˆØ±Ù‹Ø§ ÙÙŠ Ø§Ù„Ù€ feed.
                  </p>

                  <div id="starterWrap" class="mt-4 grid gap-3 md:grid-cols-3">
                    <!-- Ø¹Ø¨Ø± JS -->
                  </div>
                </div>

                <div class="rounded-2xl border border-white/10 bg-black/20 p-4 text-sm text-slate-200/90">
                  <span class="font-bold text-violet-200">ØªÙ„Ù…ÙŠØ­:</span>
                  ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ ÙˆØ­Ø²Ù…Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§â€¦ Ø¨Ø³ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¢Ù† ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ù†Ø¹Ø·ÙŠÙƒ Ø§ÙØªØªØ§Ø­ÙŠØ© Ù‚ÙˆÙŠØ©.
                </div>
              </div>
            </div>

            <!-- STEP 8 (Review) -->
            <div class="stepPanel hidden" data-step="7">
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="text-lg font-extrabold">Review â€” Ø¯ÙØªØ± Ø§Ù„Ø±Ø­Ù„Ø©</div>
                    <div class="text-sm text-slate-300">ØªØ£ÙƒØ¯ Ù…Ù† ÙƒÙ„ Ø´ÙŠØ¡ Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©.</div>
                  </div>
                  <div class="rounded-xl border border-white/10 bg-black/20 px-3 py-2 text-xs text-slate-300">
                    Final Check
                  </div>
                </div>

                <div id="reviewWrap" class="mt-4 grid gap-3 md:grid-cols-2">
                  <!-- Ø¹Ø¨Ø± JS -->
                </div>

                <div class="mt-4 rounded-2xl border border-white/10 bg-black/20 p-4">
                  <div class="text-sm text-slate-300">Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ø®ÙŠØ±Ø©</div>
                  <p class="mt-1 text-sm text-slate-200/90">
                    Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ <span class="font-bold text-violet-200">Enter the World</span> Ø£Ù†Øª ØªØ¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù…Ø¬ØªÙ…Ø¹.
                  </p>
                </div>
              </div>
            </div>

            <!-- Navigation -->
            <div class="mt-6 flex flex-col-reverse gap-3 md:flex-row md:items-center md:justify-between">
              <button id="backBtn" type="button"
                class="rounded-2xl border border-white/10 bg-white/5 px-5 py-3 text-sm hover:bg-white/10">
                Ø±Ø¬ÙˆØ¹
              </button>

              <div class="flex flex-col gap-3 md:flex-row md:items-center">
                <div id="saveHint" class="hidden md:block text-xs text-slate-400">
                  ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©.
                </div>
                <button id="nextBtn" type="button"
                  class="rounded-2xl bg-violet-500/80 px-6 py-3 text-sm font-bold hover:bg-violet-500">
                  Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
              </div>
            </div>
          </form>
        </section>
      </section>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

      <div class="relative mx-auto mt-20 w-[92%] max-w-xl rounded-3xl border border-white/10 bg-slate-950/90 p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm text-slate-300">ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</div>
            <h3 class="mt-1 text-2xl font-black text-emerald-200">Ù†Ø¬Ø­Øª! Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… âœ¦</h3>
            <p id="successText" class="mt-2 text-sm text-slate-200/90">
              â€”
            </p>
          </div>
          <button id="closeModalBtn"
            class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-sm hover:bg-white/10">
            âœ•
          </button>
        </div>

        <div class="mt-5 grid gap-3 md:grid-cols-2">
          <button id="ctaCreatePost"
            class="rounded-2xl bg-emerald-500/80 px-5 py-3 font-bold hover:bg-emerald-500">
            Create Post (Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ù…Ù†Ø´ÙˆØ±)
          </button>
          <button id="ctaExplore"
            class="rounded-2xl border border-white/10 bg-white/5 px-5 py-3 font-bold hover:bg-white/10">
            Explore (Ø§Ø³ØªÙƒØ´Ù Ø§Ù„Ø®Ù„Ø§ØµØ§Øª)
          </button>
        </div>

        <div class="mt-4 text-xs text-slate-400">
          (Ù‡Ø°Ù‡ Ù…Ø¬Ø±Ø¯ ÙˆØ§Ø¬Ù‡Ø© HTML Demo â€” Ø§Ø±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ù€ Next.js/Nest.js Ø¨Ø³Ù‡ÙˆÙ„Ø©.)
        </div>
      </div>
    </div>

    <script>
      // ====== Data ======
      const steps = [
        { title: "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù… + Class", subtitle: "Ø£ÙˆÙ„ Ø­Ø¬Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚â€¦ Ø­Ø¯Ù‘Ø¯ Ù‡ÙˆÙŠØªÙƒ." },
        { title: "Email / Password + Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØºØ§Ù…Ø±", subtitle: "ØªÙˆÙ‚ÙŠØ¹Ùƒ Ø§Ù„Ø³Ø­Ø±ÙŠâ€¦ ÙˆØ§Ø­ØªØ±Ø§Ù… Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø¹Ø§Ù„Ù…." },
        { title: "ØªÙØ§ØµÙŠÙ„ + Ù‡Ø¯Ù Ø§Ù„Ø±Ø­Ù„Ø©", subtitle: "Ù…Ù† Ø£ÙŠÙ† Ø£ØªÙŠØªØŸ ÙˆØ¥Ù„Ù‰ Ø£ÙŠÙ† ØªÙ…Ø¶ÙŠØŸ" },
        { title: "Ø§Ù„Ø£ÙØ§ØªØ§Ø±", subtitle: "Ø¥Ø·Ø§Ø± + Ø£Ù„ÙˆØ§Ù† + Ø±ÙØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)." },
        { title: "Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª", subtitle: "Ø§Ø®ØªÙØ± Genresâ€¦ Ø«Ù… 3 Ø³Ù„Ø§Ø³Ù„ Ù…ÙØ¶Ù„Ø©." },
        { title: "Party Members", subtitle: "Ø§Ø¨Ø¯Ø£ Ø¨ÙØ±ÙŠÙ‚â€¦ Ø§Ø®ØªØ± 3 Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù…ØªØ§Ø¨Ø¹ØªÙ‡Ø§ (Ø­Ø¯ Ø£Ø¯Ù†Ù‰)." },
        { title: "Starter Pack", subtitle: "Ø­Ø²Ù…Ø© Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„ÙŠØ© ØªÙ‚ØªØ±Ø­ Ù„Ùƒ Ø¨Ø¯Ø§ÙŠØ© Ù‚ÙˆÙŠØ©." },
        { title: "Review + Enter the World", subtitle: "ØªØ£ÙƒØ¯â€¦ Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©." },
      ];

      // Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (absolute Ø¯Ø§Ø®Ù„ 420x420)
      const nodePositions = [
        { x: 35,  y: 375 },
        { x: 110, y: 315 },
        { x: 140, y: 280 },
        { x: 210, y: 230 },
        { x: 250, y: 185 },
        { x: 305, y: 145 },
        { x: 350, y: 110 },
        { x: 385, y: 85  },
      ];

      const genres = [
        "Isekai", "Fantasy", "Shounen", "Seinen", "Romance", "Mystery",
        "Horror", "Comedy", "Drama", "Slice of Life", "Mecha", "Sci-Fi"
      ];

      const seriesList = [
        "One Piece", "Naruto", "Attack on Titan", "Jujutsu Kaisen",
        "Fullmetal Alchemist", "Steins;Gate", "Re:Zero", "Mushoku Tensei",
        "Demon Slayer", "Bleach", "Death Note", "Hunter x Hunter"
      ];

      const partyMembers = [
        { handle: "@RuneArchivist", bio: "Ù„ÙˆØ± + Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ø¹ÙˆØ§Ù„Ù…" },
        { handle: "@BladeVanguard",  bio: "Ù‚ØªØ§Ù„ Ù…Ø­ØªØ±Ù… Ø¨Ø¯ÙˆÙ† Ø³Ù…Ù‘ÙŠØ©" },
        { handle: "@PanelPainter",   bio: "Fanart ÙŠÙˆÙ…ÙŠ" },
        { handle: "@LoreReviewer",   bio: "ØªØ­Ù„ÙŠÙ„ Ø­Ù„Ù‚Ø§Øª + Ù†Ø¸Ø±ÙŠØ§Øª" },
        { handle: "@SpoilerShield",  bio: "ØªØ­Ø°ÙŠØ± Ø³Ø¨ÙˆÙŠÙ„Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§" },
        { handle: "@CosplayCrafter", bio: "ÙƒÙˆØ³Ø¨Ù„Ø§ÙŠ + ØªØµÙ…ÙŠÙ…" },
        { handle: "@MangaScout",     bio: "Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ø§Ù†ØºØ§ Ø¹Ù…ÙŠÙ‚Ø©" },
        { handle: "@ChillCafe",      bio: "Ø³Ù„Ø§ÙŠØ³ Ø£ÙˆÙ Ù„Ø§ÙŠÙ ÙˆÙ‡Ø¯ÙˆØ¡" },
      ];

      const starterPacks = [
        {
          id: "pack-quests",
          title: "Daily Isekai Quests",
          desc: "ØªØ­Ø¯ÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ© + Ø£Ø³Ø¦Ù„Ø© Ø®ÙÙŠÙØ© ØªØ´Ø¹Ù„ Ø§Ù„Ù†Ù‚Ø§Ø´."
        },
        {
          id: "pack-art",
          title: "Art & Fanart Spotlight",
          desc: "ÙÙ†Ù‘Ø§Ù†ÙŠÙ† + Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø¨Ø³ÙŠØ·Ø© + Ø±Ø¯ÙˆØ¯ Ù…Ø­ØªØ±Ù…Ø©."
        },
        {
          id: "pack-reviews",
          title: "Deep Reviews & Theories",
          desc: "Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…Ø·ÙˆÙ‘Ù„Ø© + Ù†Ø¸Ø±ÙŠØ§Øª + ØªØµÙˆÙŠØªØ§Øª."
        }
      ];

      const frameOptions = [
        { id: "rune",   title: "Rune Circle",   glyph: "âœ¦", style: "ring" },
        { id: "crest",  title: "Golden Crest",  glyph: "âŒ", style: "crest" },
        { id: "forest", title: "Forest Warden", glyph: "â–", style: "leaf" },
        { id: "void",   title: "Void Prism",    glyph: "â—ˆ", style: "prism" },
      ];

      // ====== State ======
      const state = {
        step: 0,
        completedMax: 0,
        data: {
          name: "",
          class: "",
          email: "",
          password: "",
          oath: false,
          country: "",
          language: "",
          bio: "",
          goal: "",
          frame: "rune",
          colorPrimary: "#a78bfa",
          colorSecondary: "#22c55e",
          avatarFileName: "",
          genres: [],
          series: [],
          party: [],
          starterPack: "",
        }
      };

      // ====== DOM refs ======
      const mapNodes = document.getElementById("mapNodes");
      const currentStepLabel = document.getElementById("currentStepLabel");
      const currentStepHint = document.getElementById("currentStepHint");
      const stepTitle = document.getElementById("stepTitle");
      const stepSubtitle = document.getElementById("stepSubtitle");
      const panels = [...document.querySelectorAll(".stepPanel")];

      const nextBtn = document.getElementById("nextBtn");
      const backBtn = document.getElementById("backBtn");
      const resetBtn = document.getElementById("resetBtn");

      const messageBar = document.getElementById("messageBar");
      const messageText = document.getElementById("messageText");

      const progressPercent = document.getElementById("progressPercent");
      const progressMeta = document.getElementById("progressMeta");

      // Step 3 helpers
      const bioEl = document.getElementById("bio");
      const bioCount = document.getElementById("bioCount");

      // Avatar
      const frameOptionsWrap = document.getElementById("frameOptions");
      const colorPrimaryEl = document.getElementById("colorPrimary");
      const colorSecondaryEl = document.getElementById("colorSecondary");
      const avatarFileEl = document.getElementById("avatarFile");
      const avatarPreviewImg = document.getElementById("avatarPreviewImg");
      const avatarFallback = document.getElementById("avatarFallback");
      const avatarInitials = document.getElementById("avatarInitials");
      const avatarFrame = document.getElementById("avatarFrame");
      const frameGlyph = document.getElementById("frameGlyph");

      // Interests
      const genresWrap = document.getElementById("genresWrap");
      const genresCount = document.getElementById("genresCount");
      const seriesWrap = document.getElementById("seriesWrap");
      const seriesCount = document.getElementById("seriesCount");

      // Party
      const partyWrap = document.getElementById("partyWrap");
      const partyCount = document.getElementById("partyCount");

      // Starter
      const starterWrap = document.getElementById("starterWrap");

      // Review
      const reviewWrap = document.getElementById("reviewWrap");

      // Modal
      const successModal = document.getElementById("successModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const successText = document.getElementById("successText");
      const ctaCreatePost = document.getElementById("ctaCreatePost");
      const ctaExplore = document.getElementById("ctaExplore");

      // ====== Utils ======
      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
      function isEmail(v) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
      }

      function showMessage(msg) {
        messageText.textContent = msg;
        messageBar.classList.remove("hidden");
        messageBar.classList.add("shake");
        setTimeout(() => messageBar.classList.remove("shake"), 500);
      }
      function clearMessage() {
        messageBar.classList.add("hidden");
        messageText.textContent = "";
      }

      function setActiveRadioStyles(groupName) {
        const radios = [...document.querySelectorAll(`input[name="${groupName}"]`)];
        radios.forEach(r => {
          const card = r.closest("label");
          if (!card) return;
          if (r.checked) {
            card.classList.add("border-violet-400/60", "bg-white/10");
            card.classList.remove("border-white/10", "bg-white/5");
          } else {
            card.classList.remove("border-violet-400/60", "bg-white/10");
            card.classList.add("border-white/10", "bg-white/5");
          }
        });
      }

      function setActiveChoiceCardStyles(container, selectorChecked) {
        const cards = [...container.querySelectorAll("label")];
        cards.forEach(card => {
          const input = card.querySelector("input");
          const active = input && input.checked;
          card.classList.toggle("border-emerald-400/60", active && selectorChecked === "emerald");
          card.classList.toggle("border-violet-400/60", active && selectorChecked === "violet");
          card.classList.toggle("bg-white/10", active);
          card.classList.toggle("border-white/10", !active);
          card.classList.toggle("bg-white/5", !active);
        });
      }

      // ====== Renderers ======
      function renderMapNodes() {
        mapNodes.innerHTML = "";
        steps.forEach((s, i) => {
          const pos = nodePositions[i];
          const btn = document.createElement("button");
          btn.type = "button";
          btn.setAttribute("data-node", String(i));
          btn.className = "absolute -translate-x-1/2 -translate-y-1/2 text-right focus:outline-none";
          btn.style.left = `${pos.x}px`;
          btn.style.top = `${pos.y}px`;

          btn.innerHTML = `
            <div class="flex items-center gap-2">
              <div data-dot class="h-10 w-10 rounded-full border border-white/10 bg-white/5 grid place-items-center">
                <span data-icon class="text-sm font-black text-slate-200"> ${i+1} </span>
              </div>
              <div class="hidden sm:block">
                <div class="text-xs font-bold text-slate-200">${escapeHtml(s.title)}</div>
              </div>
            </div>
          `;

          btn.addEventListener("click", () => {
            // Ù…Ø³Ù…ÙˆØ­ Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙ‚Ø· Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (i <= state.completedMax) goToStep(i);
          });

          mapNodes.appendChild(btn);
        });
      }

      function updateMapNodesUI() {
        const nodes = [...mapNodes.querySelectorAll("button[data-node]")];
        nodes.forEach(node => {
          const i = Number(node.getAttribute("data-node"));
          const dot = node.querySelector("[data-dot]");
          const icon = node.querySelector("[data-icon]");

          const isCurrent = i === state.step;
          const isCompleted = i < state.step || i <= state.completedMax && i !== state.step && i < state.step ? true : i < state.step;

          // Ù‚ÙÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
          const locked = i > state.completedMax + 1; // Ù…Ø§ ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚ÙØ² Ù„Ù„Ø£Ù…Ø§Ù… (Ø¥Ù„Ø§ Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙƒØªÙ…Ù„)
          node.style.opacity = locked ? "0.55" : "1";
          node.style.cursor = (i <= state.completedMax) ? "pointer" : (i === state.step ? "default" : "not-allowed");

          dot.className = "h-10 w-10 rounded-full border grid place-items-center transition-all";
          if (isCurrent) {
            dot.classList.add("border-violet-400/60", "bg-violet-500/20", "glow");
            icon.textContent = "âœ¦";
            icon.className = "text-sm font-black text-violet-100";
          } else if (i < state.step) {
            dot.classList.add("border-emerald-400/60", "bg-emerald-500/15");
            icon.textContent = "âœ“";
            icon.className = "text-sm font-black text-emerald-200";
          } else {
            dot.classList.add("border-white/10", "bg-white/5");
            icon.textContent = String(i + 1);
            icon.className = "text-sm font-black text-slate-200";
          }
        });
      }

      function updateHeader() {
        const s = steps[state.step];
        stepTitle.textContent = s.title;
        stepSubtitle.textContent = s.subtitle;
        currentStepLabel.textContent = s.title;
        currentStepHint.textContent = s.subtitle;

        const total = steps.length;
        const done = state.step; // ÙƒÙ… Ø®Ø·ÙˆØ© Ø£Ù†Ù‡ÙŠØª Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const pct = Math.round((done / (total - 1)) * 100);
        progressPercent.textContent = `${clamp(pct, 0, 100)}%`;
        progressMeta.textContent = `${state.step + 1} / ${total}`;

        backBtn.disabled = state.step === 0;
        backBtn.classList.toggle("opacity-60", backBtn.disabled);
        backBtn.classList.toggle("cursor-not-allowed", backBtn.disabled);

        nextBtn.textContent = state.step === steps.length - 1 ? "Enter the World" : "Ø§Ù„ØªØ§Ù„ÙŠ";
      }

      function showStepPanel() {
        panels.forEach(p => p.classList.add("hidden"));
        const active = panels.find(p => Number(p.dataset.step) === state.step);
        if (active) active.classList.remove("hidden");
      }

      function goToStep(i) {
        clearMessage();
        state.step = clamp(i, 0, steps.length - 1);
        state.completedMax = Math.max(state.completedMax, state.step - 1); // Ø§Ù„Ù…ÙƒØªÙ…Ù„ Ø­ØªÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        updateHeader();
        showStepPanel();
        updateMapNodesUI();
        renderReviewIfNeeded();
        syncSelectedStyles();
        scrollToTopOfCard();
      }

      function scrollToTopOfCard() {
        const el = document.getElementById("stepTitle");
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function syncSelectedStyles() {
        setActiveRadioStyles("class");
        setActiveRadioStyles("goal");

        // Starter packs styles
        setActiveChoiceCardStyles(starterWrap, "emerald");
        // Frames styles
        setActiveChoiceCardStyles(frameOptionsWrap, "violet");
      }

      // ====== Step-specific render ======
      function renderFrameOptions() {
        frameOptionsWrap.innerHTML = frameOptions.map(f => `
          <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 hover:bg-white/10">
            <input class="sr-only" type="radio" name="frame" value="${escapeHtml(f.id)}" ${state.data.frame === f.id ? "checked" : ""} />
            <div class="flex items-center justify-between">
              <div>
                <div class="font-extrabold">${escapeHtml(f.title)}</div>
                <div class="text-xs text-slate-300">Frame ID: ${escapeHtml(f.id)}</div>
              </div>
              <div class="text-violet-200 text-lg">${escapeHtml(f.glyph)}</div>
            </div>
          </label>
        `).join("");

        frameOptionsWrap.addEventListener("change", (e) => {
          if (e.target && e.target.name === "frame") {
            state.data.frame = e.target.value;
            updateAvatarFrame();
            syncSelectedStyles();
          }
        });
      }

      function renderGenres() {
        genresWrap.innerHTML = genres.map(g => {
          const active = state.data.genres.includes(g);
          return `
            <button type="button" data-genre="${escapeHtml(g)}"
              class="rounded-full border px-4 py-2 text-sm transition
              ${active ? "border-emerald-400/60 bg-emerald-500/15 text-emerald-100" : "border-white/10 bg-white/5 text-slate-200 hover:bg-white/10"}">
              ${escapeHtml(g)}
            </button>
          `;
        }).join("");
        genresCount.textContent = String(state.data.genres.length);

        genresWrap.onclick = (e) => {
          const btn = e.target.closest("button[data-genre]");
          if (!btn) return;
          const g = btn.getAttribute("data-genre");
          const idx = state.data.genres.indexOf(g);
          if (idx >= 0) state.data.genres.splice(idx, 1);
          else state.data.genres.push(g);
          renderGenres();
        };
      }

      function renderSeries() {
        seriesWrap.innerHTML = seriesList.map(s => {
          const checked = state.data.series.includes(s);
          return `
            <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-white/10 bg-black/20 px-4 py-3 hover:bg-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" data-series="${escapeHtml(s)}" class="h-4 w-4 accent-violet-400" ${checked ? "checked" : ""} />
                <div>
                  <div class="font-bold">${escapeHtml(s)}</div>
                  <div class="text-xs text-slate-400">Tap to ${checked ? "remove" : "select"}</div>
                </div>
              </div>
              <span class="text-xs text-slate-300">Fav</span>
            </label>
          `;
        }).join("");

        seriesCount.textContent = String(state.data.series.length);

        seriesWrap.onchange = (e) => {
          const cb = e.target.closest("input[type='checkbox'][data-series]");
          if (!cb) return;
          const s = cb.getAttribute("data-series");

          const already = state.data.series.includes(s);

          if (cb.checked && !already) {
            if (state.data.series.length >= 3) {
              cb.checked = false;
              showMessage("ØªÙ‚Ø¯Ø± ØªØ®ØªØ§Ø± 3 Ø³Ù„Ø§Ø³Ù„ ÙÙ‚Ø·. Ø´ÙŠÙ„ ÙˆØ§Ø­Ø¯ Ø£ÙˆÙ„Ø§Ù‹.");
              return;
            }
            state.data.series.push(s);
          } else if (!cb.checked && already) {
            state.data.series = state.data.series.filter(x => x !== s);
          }

          seriesCount.textContent = String(state.data.series.length);

          // Disable unchecked if reached 3
          const all = [...seriesWrap.querySelectorAll("input[type='checkbox'][data-series]")];
          const reached = state.data.series.length >= 3;
          all.forEach(x => {
            if (!x.checked) x.disabled = reached;
            x.closest("label").classList.toggle("opacity-60", x.disabled);
          });
        };

        // Apply disable rules on render
        const all = [...seriesWrap.querySelectorAll("input[type='checkbox'][data-series]")];
        const reached = state.data.series.length >= 3;
        all.forEach(x => {
          if (!x.checked) x.disabled = reached;
          x.closest("label").classList.toggle("opacity-60", x.disabled);
        });
      }

      function renderParty() {
        partyWrap.innerHTML = partyMembers.map(m => {
          const checked = state.data.party.includes(m.handle);
          return `
            <label class="flex cursor-pointer items-center justify-between rounded-2xl border border-white/10 bg-black/20 px-4 py-3 hover:bg-white/5">
              <div class="flex items-center gap-3">
                <input type="checkbox" data-party="${escapeHtml(m.handle)}" class="h-4 w-4 accent-emerald-400" ${checked ? "checked" : ""} />
                <div>
                  <div class="font-bold">${escapeHtml(m.handle)}</div>
                  <div class="text-xs text-slate-400">${escapeHtml(m.bio)}</div>
                </div>
              </div>
              <span class="text-xs text-slate-300">Follow</span>
            </label>
          `;
        }).join("");

        partyCount.textContent = String(state.data.party.length);

        partyWrap.onchange = (e) => {
          const cb = e.target.closest("input[type='checkbox'][data-party]");
          if (!cb) return;
          const h = cb.getAttribute("data-party");
          if (cb.checked) {
            if (!state.data.party.includes(h)) state.data.party.push(h);
          } else {
            state.data.party = state.data.party.filter(x => x !== h);
          }
          partyCount.textContent = String(state.data.party.length);
        };
      }

      function renderStarterPacks() {
        starterWrap.innerHTML = starterPacks.map(p => `
          <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 p-4 hover:bg-white/10">
            <input class="sr-only" type="radio" name="starter" value="${escapeHtml(p.id)}" ${state.data.starterPack === p.id ? "checked" : ""} />
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-extrabold">${escapeHtml(p.title)}</div>
                <div class="mt-1 text-sm text-slate-300">${escapeHtml(p.desc)}</div>
              </div>
              <div class="rounded-xl border border-white/10 bg-black/20 px-3 py-1 text-xs text-slate-200">
                Pack
              </div>
            </div>
          </label>
        `).join("");

        starterWrap.onchange = (e) => {
          if (e.target && e.target.name === "starter") {
            state.data.starterPack = e.target.value;
            syncSelectedStyles();
          }
        };
      }

      function updateAvatarFrame() {
        // Frame glyph + border style based on selected frame & colors
        const f = frameOptions.find(x => x.id === state.data.frame) || frameOptions[0];
        const cp = state.data.colorPrimary;
        const cs = state.data.colorSecondary;

        frameGlyph.textContent = `${f.glyph} ${f.title}`;

        // border with primary color
        avatarFrame.style.border = `3px solid ${hexToRgba(cp, 0.75)}`;
        avatarFrame.style.boxShadow = `0 0 0 6px ${hexToRgba(cs, 0.12)}, 0 0 24px ${hexToRgba(cp, 0.30)}`;

        // add a small "ornament" via background gradient
        if (f.style === "ring") {
          avatarFrame.style.background = `conic-gradient(from 0deg, ${hexToRgba(cp,0.10)}, ${hexToRgba(cs,0.10)}, ${hexToRgba(cp,0.10)})`;
        } else if (f.style === "crest") {
          avatarFrame.style.background = `radial-gradient(circle at 30% 30%, ${hexToRgba(cs,0.20)}, transparent 55%), radial-gradient(circle at 70% 70%, ${hexToRgba(cp,0.18)}, transparent 55%)`;
        } else if (f.style === "leaf") {
          avatarFrame.style.background = `linear-gradient(135deg, ${hexToRgba(cs,0.18)}, transparent 55%), linear-gradient(315deg, ${hexToRgba(cp,0.16)}, transparent 55%)`;
        } else if (f.style === "prism") {
          avatarFrame.style.background = `conic-gradient(from 90deg, ${hexToRgba(cs,0.16)}, transparent 40%, ${hexToRgba(cp,0.18)})`;
        }

        // initials
        avatarInitials.textContent = makeInitials(state.data.name || "??");
      }

      function hexToRgba(hex, a) {
        const h = (hex || "#000000").replace("#","");
        const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
        const n = parseInt(full, 16);
        const r = (n >> 16) & 255;
        const g = (n >> 8) & 255;
        const b = n & 255;
        return `rgba(${r},${g},${b},${a})`;
      }

      function makeInitials(name) {
        const clean = String(name).trim();
        if (!clean) return "??";
        const parts = clean.split(/[\s_\-]+/).filter(Boolean);
        const a = (parts[0] || "?")[0] || "?";
        const b = (parts[1] || parts[0] || "?")[0] || "?";
        return (a + b).toUpperCase();
      }

      function renderReviewIfNeeded() {
        if (state.step !== steps.length - 1) return;

        const d = state.data;
        const classVal = d.class || "â€”";
        const goalVal = d.goal || "â€”";
        const langVal = d.language || "â€”";
        const genresVal = d.genres.length ? d.genres.join(", ") : "â€”";
        const seriesVal = d.series.length ? d.series.join(", ") : "â€”";
        const partyVal = d.party.length ? d.party.join(", ") : "â€”";
        const pack = starterPacks.find(p => p.id === d.starterPack);
        const packVal = pack ? pack.title : "â€”";

        const card = (label, value) => `
          <div class="rounded-2xl border border-white/10 bg-black/20 p-4">
            <div class="text-xs text-slate-400">${escapeHtml(label)}</div>
            <div class="mt-1 font-bold text-slate-100 break-words">${escapeHtml(value)}</div>
          </div>
        `;

        reviewWrap.innerHTML = [
          card("Ø§Ø³Ù… + Class", `${d.name || "â€”"} â€” ${classVal}`),
          card("Email", d.email ? d.email : "â€”"),
          card("Ø¨Ù„Ø¯ + Ù„ØºØ©", `${d.country || "â€”"} â€” ${langVal}`),
          card("Ù‡Ø¯Ù Ø§Ù„Ø±Ø­Ù„Ø©", goalVal),
          card("Bio", d.bio ? d.bio : "â€”"),
          card("Genres", genresVal),
          card("3 Ø³Ù„Ø§Ø³Ù„ Ù…ÙØ¶Ù„Ø©", seriesVal),
          card("Party Members", partyVal),
          card("Starter Pack", packVal),
        ].join("");
      }

      // ====== Validation ======
      function readCurrentInputsIntoState() {
        // Step 1
        const name = (document.getElementById("name").value || "").trim();
        const cls = (document.querySelector('input[name="class"]:checked') || {}).value || "";

        // Step 2
        const email = (document.getElementById("email").value || "").trim();
        const password = document.getElementById("password").value || "";
        const oath = document.getElementById("oath").checked;

        // Step 3
        const country = (document.getElementById("country").value || "").trim();
        const language = document.getElementById("language").value || "";
        const bio = (document.getElementById("bio").value || "").trim();
        const goal = (document.querySelector('input[name="goal"]:checked') || {}).value || "";

        // Step 4
        const frame = (document.querySelector('input[name="frame"]:checked') || {}).value || state.data.frame;
        const colorPrimary = colorPrimaryEl.value || state.data.colorPrimary;
        const colorSecondary = colorSecondaryEl.value || state.data.colorSecondary;

        // Step 7
        const starter = (document.querySelector('input[name="starter"]:checked') || {}).value || "";

        state.data = {
          ...state.data,
          name, class: cls,
          email, password, oath,
          country, language, bio, goal,
          frame, colorPrimary, colorSecondary,
          starterPack: starter || state.data.starterPack,
        };
      }

      function validateStep(stepIdx) {
        readCurrentInputsIntoState();

        const d = state.data;

        if (stepIdx === 0) {
          if (!d.name || d.name.length < 2) return "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‹Ø§ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).";
          if (!d.class) return "Ø§Ø®ØªØ± Class Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.";
        }

        if (stepIdx === 1) {
          if (!d.email || !isEmail(d.email)) return "Ø§ÙƒØªØ¨ Email ØµØ­ÙŠØ­.";
          if (!d.password || d.password.length < 8) return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
          if (!d.oath) return "Ù„Ø§Ø²Ù… ØªÙ‚Ø¨Ù„ Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØºØ§Ù…Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.";
        }

        if (stepIdx === 2) {
          if (!d.country) return "Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ù„Ø¯.";
          if (!d.language) return "Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©.";
          if (!d.goal) return "Ø§Ø®ØªØ± Ù‡Ø¯Ù Ø§Ù„Ø±Ø­Ù„Ø©.";
          if (!d.bio || d.bio.length < 10) return "Ø§ÙƒØªØ¨ Bio Ù‚ØµÙŠØ±Ø© (10 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).";
        }

        if (stepIdx === 3) {
          // avatar optionalØŒ Ø¨Ø³ Ù†Ø·Ù„Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø·Ø§Ø± + Ø£Ù„ÙˆØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø©
          if (!d.frame) return "Ø§Ø®ØªØ± Ø¥Ø·Ø§Ø± Ù„Ù„Ø£ÙØ§ØªØ§Ø±.";
          if (!d.colorPrimary || !d.colorSecondary) return "Ø§Ø®ØªØ± Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¥Ø·Ø§Ø±.";
        }

        if (stepIdx === 4) {
          if (!d.genres.length) return "Ø§Ø®ØªÙØ± Genre ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
          if (d.series.length !== 3) return "Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø¨Ø§Ù„Ø¶Ø¨Ø· 3 Ø³Ù„Ø§Ø³Ù„ Ù…ÙØ¶Ù„Ø©.";
        }

        if (stepIdx === 5) {
          if (d.party.length < 3) return "Ø§Ø®ØªØ± 3 Ø­Ø³Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.";
        }

        if (stepIdx === 6) {
          if (!d.starterPack) return "Ø§Ø®ØªØ± Starter Pack ÙˆØ§Ø­Ø¯.";
        }

        if (stepIdx === 7) {
          // Final check
          const req = [
            [!!d.name, "Ø§Ù„Ø§Ø³Ù… Ù†Ø§Ù‚Øµ."],
            [!!d.class, "Class Ù†Ø§Ù‚Øµ."],
            [isEmail(d.email), "Email ØºÙŠØ± ØµØ­ÙŠØ­."],
            [d.password && d.password.length >= 8, "Password Ø¶Ø¹ÙŠÙØ©."],
            [d.oath, "Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØºØ§Ù…Ø± ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„."],
            [!!d.country, "Ø§Ù„Ø¨Ù„Ø¯ Ù†Ø§Ù‚Øµ."],
            [!!d.language, "Ø§Ù„Ù„ØºØ© Ù†Ø§Ù‚ØµØ©."],
            [!!d.goal, "Ù‡Ø¯Ù Ø§Ù„Ø±Ø­Ù„Ø© Ù†Ø§Ù‚Øµ."],
            [d.bio && d.bio.length >= 10, "Bio Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§."],
            [d.genres.length >= 1, "Genres Ù†Ø§Ù‚ØµØ©."],
            [d.series.length === 3, "Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† 3."],
            [d.party.length >= 3, "Party Members Ù„Ø§Ø²Ù… 3+."],
            [!!d.starterPack, "Starter Pack Ù†Ø§Ù‚Øµ."],
          ];
          const bad = req.find(x => !x[0]);
          if (bad) return bad[1];
        }

        return "";
      }

      // ====== Events ======
      nextBtn.addEventListener("click", () => {
        clearMessage();
        const err = validateStep(state.step);
        if (err) {
          showMessage(err);
          return;
        }

        // mark completed
        state.completedMax = Math.max(state.completedMax, state.step);

        if (state.step === steps.length - 1) {
          // Enter the World
          openSuccessModal();
          return;
        }

        goToStep(state.step + 1);
      });

      backBtn.addEventListener("click", () => {
        if (state.step === 0) return;
        clearMessage();
        goToStep(state.step - 1);
      });

      resetBtn.addEventListener("click", () => {
        clearMessage();
        // reset state
        state.step = 0;
        state.completedMax = 0;
        state.data = {
          name: "",
          class: "",
          email: "",
          password: "",
          oath: false,
          country: "",
          language: "",
          bio: "",
          goal: "",
          frame: "rune",
          colorPrimary: "#a78bfa",
          colorSecondary: "#22c55e",
          avatarFileName: "",
          genres: [],
          series: [],
          party: [],
          starterPack: "",
        };

        // reset UI fields
        document.getElementById("wizardForm").reset();
        avatarPreviewImg.src = "";
        avatarPreviewImg.classList.add("hidden");
        avatarFallback.classList.remove("hidden");
        bioCount.textContent = "0 / 240";
        genresCount.textContent = "0";
        seriesCount.textContent = "0";
        partyCount.textContent = "0";

        // rerender option lists
        renderFrameOptions();
        renderGenres();
        renderSeries();
        renderParty();
        renderStarterPacks();

        // update avatar
        updateAvatarFrame();

        goToStep(0);
      });

      // Step 1 styles
      document.addEventListener("change", (e) => {
        if (e.target && e.target.name === "class") setActiveRadioStyles("class");
        if (e.target && e.target.name === "goal") setActiveRadioStyles("goal");
      });

      // Bio counter
      bioEl.addEventListener("input", () => {
        const v = bioEl.value || "";
        bioCount.textContent = `${v.length} / 240`;
      });

      // Avatar updates
      document.getElementById("name").addEventListener("input", (e) => {
        state.data.name = e.target.value;
        updateAvatarFrame();
      });

      colorPrimaryEl.addEventListener("input", () => {
        state.data.colorPrimary = colorPrimaryEl.value;
        updateAvatarFrame();
      });
      colorSecondaryEl.addEventListener("input", () => {
        state.data.colorSecondary = colorSecondaryEl.value;
        updateAvatarFrame();
      });

      avatarFileEl.addEventListener("change", () => {
        const file = avatarFileEl.files && avatarFileEl.files[0];
        if (!file) {
          avatarPreviewImg.src = "";
          avatarPreviewImg.classList.add("hidden");
          avatarFallback.classList.remove("hidden");
          state.data.avatarFileName = "";
          return;
        }

        state.data.avatarFileName = file.name;

        const reader = new FileReader();
        reader.onload = () => {
          avatarPreviewImg.src = reader.result;
          avatarPreviewImg.classList.remove("hidden");
          avatarFallback.classList.add("hidden");
        };
        reader.readAsDataURL(file);
      });

      // Starter styles on change
      starterWrap.addEventListener("change", () => {
        setActiveChoiceCardStyles(starterWrap, "emerald");
      });

      // Frame styles on change
      frameOptionsWrap.addEventListener("change", () => {
        setActiveChoiceCardStyles(frameOptionsWrap, "violet");
      });

      // Modal
      function openSuccessModal() {
        readCurrentInputsIntoState();
        const d = state.data;
        const pack = starterPacks.find(p => p.id === d.starterPack);
        const packName = pack ? pack.title : "Starter Pack";

        successText.textContent =
          `ÙŠØ§ ${d.name || "Ù…ØºØ§Ù…Ø±"}! ØªÙ… ØªØ¬Ù‡ÙŠØ² ÙØ¦ØªÙƒ (${d.class || "â€”"})ØŒ ÙˆÙØªØ­Ù†Ø§ Ù„Ùƒ Ù…Ø³Ø§Ø± Ù…Ø­ØªÙˆÙ‰: ${packName}. Ø£ÙˆÙ„ Ø®Ø·ÙˆØ©ØŸ`;

        successModal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      }

      function closeSuccessModal() {
        successModal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }

      closeModalBtn.addEventListener("click", closeSuccessModal);
      successModal.addEventListener("click", (e) => {
        if (e.target === successModal.firstElementChild) closeSuccessModal();
      });

      ctaCreatePost.addEventListener("click", () => {
        // Demo action
        closeSuccessModal();
        alert("Demo: Create Post âœ…\n(Ø§Ø±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨ØµÙØ­Ø© /create ÙÙŠ Next.js)");
      });

      ctaExplore.addEventListener("click", () => {
        closeSuccessModal();
        alert("Demo: Explore âœ…\n(Ø§Ø±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨ØµÙØ­Ø© /explore ÙÙŠ Next.js)");
      });

      // ====== Init ======
      function init() {
        renderMapNodes();
        renderFrameOptions();
        renderGenres();
        renderSeries();
        renderParty();
        renderStarterPacks();

        // set initial colors in state
        state.data.colorPrimary = colorPrimaryEl.value;
        state.data.colorSecondary = colorSecondaryEl.value;
        updateAvatarFrame();

        goToStep(0);
      }

      init();
    </script>
  </body>
</html>
